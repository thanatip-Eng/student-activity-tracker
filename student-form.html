<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Submit Activity - Student Talent Development</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/form-style.css">
    <style>
        .skills-section {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        .skills-section h3 {
            color: #1a1a2e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .skills-counter {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
        }
        .skills-counter.warning { background: #f39c12; }
        .skills-counter.error { background: #e74c3c; }
        .domain-group {
            background: white;
            border-radius: 10px;
            margin-bottom: 12px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
        }
        .domain-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .domain-header:hover { opacity: 0.9; }
        .domain-header .toggle-icon { transition: transform 0.3s; }
        .domain-group.collapsed .domain-header .toggle-icon { transform: rotate(-90deg); }
        .domain-group.collapsed .sub-skills { display: none; }
        .sub-skills { padding: 10px; }
        .skill-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #f8f9ff;
            transition: all 0.3s;
        }
        .skill-item:hover { background: #e8f0ff; }
        .skill-item.selected {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 2px solid #28a745;
        }
        .skill-item.disabled { opacity: 0.5; pointer-events: none; }
        .skill-item input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .skill-info { flex: 1; }
        .skill-code { font-weight: 700; color: #667eea; }
        .skill-name { font-size: 0.9em; color: #333; }
        .skill-name-en { font-size: 0.8em; color: #666; }
        .skill-level-select {
            padding: 6px 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            min-width: 80px;
        }
        .skill-level-select:disabled { background: #f0f0f0; }
        .skills-note {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        .skills-note strong { color: #856404; }
        .ai-analysis-modal { max-width: 600px; }
        .ai-analysis-content { text-align: left; margin: 20px 0; }
        .ai-skill-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f0f8ff;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        .ai-skill-item .skill-detail { flex: 1; }
        .ai-skill-item .skill-code { font-weight: 700; color: #667eea; }
        .ai-skill-item .skill-level {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
        }
        .ai-skill-item .ai-reason { font-size: 0.85em; color: #666; margin-top: 5px; }
        .ai-note {
            background: #e8f5e9;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            font-size: 0.9em;
            color: #2e7d32;
        }
        .comparison-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .comparison-col h5 { font-size: 0.9em; color: #888; margin-bottom: 10px; }
        .your-skills .ai-skill-item { border-left-color: #f39c12; background: #fff8e1; }
        .ai-skills .ai-skill-item { border-left-color: #27ae60; background: #e8f5e9; }
        @media (max-width: 600px) { .comparison-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <img src="images/MainLogo.png" alt="Student Talent Development" class="logo-img">
                <div>
                    <h1>‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Submit Activity</h1>
                    <p>Student Talent Development System</p>
                </div>
            </div>
            <nav class="nav-links">
                <a href="index.html">üîç ‡∏î‡∏π‡∏ú‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô | My Results</a>
            </nav>
        </header>

        <section id="login-section" class="login-section">
            <div class="login-card">
                <h2>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ | Student Search</h2>
                <p>‡∏Å‡∏£‡∏≠‡∏Å Email ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Enter your Email to submit activity</p>
                <div class="login-form">
                    <input type="email" id="student-email" placeholder="Email (example@cmu.ac.th)">
                    <button onclick="loginStudent()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ | Search</button>
                </div>
                <p id="login-error" class="error-message"></p>
                <p class="login-note">üí° ‡πÉ‡∏ä‡πâ Email ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏ß‡πâ | Use your registered Email</p>
            </div>
        </section>

        <section id="form-section" class="form-section" style="display: none;">
            <div class="student-bar">
                <div class="student-info">
                    <span class="avatar" id="student-avatar">S</span>
                    <div>
                        <strong id="display-name">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ | Student</strong>
                        <span id="display-email">email@cmu.ac.th</span>
                    </div>
                </div>
                <button class="btn-logout" onclick="logoutStudent()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö | Logout</button>
            </div>

            <div class="form-card">
                <h2>üìã ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activity Submission Form</h2>
                
                <form id="activity-form" onsubmit="submitActivity(event)">
                    <div class="form-group">
                        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activity Name <span class="required">*</span></label>
                        <input type="text" id="activity-name" required placeholder="‡πÄ‡∏ä‡πà‡∏ô Workshop AI for Beginners">
                    </div>

                    <div class="form-group">
                        <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô/‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Organizer <span class="required">*</span></label>
                        <input type="text" id="activity-organizer" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏° | Start Date <span class="required">*</span></label>
                            <input type="date" id="start-date" required>
                        </div>
                        <div class="form-group">
                            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î | End Date <span class="required">*</span></label>
                            <input type="date" id="end-date" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ | Duration <span class="required">*</span></label>
                            <input type="number" id="duration" required min="1" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">
                        </div>
                        <div class="form-group">
                            <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢ | Unit</label>
                            <select id="duration-unit">
                                <option value="‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á | Hours</option>
                                <option value="‡∏ß‡∏±‡∏ô">‡∏ß‡∏±‡∏ô | Days</option>
                                <option value="‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå | Weeks</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activity Level <span class="required">*</span></label>
                        <div class="level-options">
                            <label class="level-option">
                                <input type="radio" name="activity-level" value="1" required onchange="updateSkillLevelLimits()">
                                <div class="level-card">
                                    <span class="level-number">1</span>
                                    <span class="level-title">‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å | Know</span>
                                    <span class="level-desc">‡∏ü‡∏±‡∏á‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢/‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ó‡∏§‡∏©‡∏é‡∏µ</span>
                                </div>
                            </label>
                            <label class="level-option">
                                <input type="radio" name="activity-level" value="2" onchange="updateSkillLevelLimits()">
                                <div class="level-card">
                                    <span class="level-number">2</span>
                                    <span class="level-title">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à | Understand</span>
                                    <span class="level-desc">Workshop/‡∏ù‡∏∂‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥</span>
                                </div>
                            </label>
                            <label class="level-option">
                                <input type="radio" name="activity-level" value="3" onchange="updateSkillLevelLimits()">
                                <div class="level-card">
                                    <span class="level-number">3</span>
                                    <span class="level-title">‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô | Apply</span>
                                    <span class="level-desc">‡πÇ‡∏Ñ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á/‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</span>
                                </div>
                            </label>
                            <label class="level-option">
                                <input type="radio" name="activity-level" value="4" onchange="updateSkillLevelLimits()">
                                <div class="level-card">
                                    <span class="level-number">4</span>
                                    <span class="level-title">‡∏ú‡∏π‡πâ‡∏ô‡∏≥ | Lead</span>
                                    <span class="level-desc">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î/‡∏™‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activity Description <span class="required">*</span></label>
                        <textarea id="description" required rows="4" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ..."></textarea>
                    </div>

                    <div class="skills-section">
                        <h3>
                            üéØ ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö | Skills Gained 
                            <span class="skills-counter" id="skills-counter">0/3</span>
                        </h3>
                        
                        <div class="skills-note">
                            <strong>üìå ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏µ‡πà‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ <strong>‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞</strong><br>
                            ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å | AI ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞
                        </div>
                        
                        <div id="skills-list"></div>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label>‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô (Link ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û/‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£) | Evidence Link</label>
                        <input type="url" id="evidence-link" placeholder="https://drive.google.com/...">
                    </div>

                    <div class="form-group">
                        <label>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô | Evidence Description</label>
                        <input type="text" id="evidence-desc" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®, Certificate">
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-submit">ü§ñ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡πâ‡∏ß‡∏¢ AI ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á</button>
                    </div>
                </form>
            </div>

            <div class="submissions-card">
                <h2>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô | My Submissions</h2>
                <div id="my-submissions" class="submissions-list">
                    <div class="empty-state">
                        <span class="icon">üì≠</span>
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
                    </div>
                </div>
            </div>
        </section>

        <div id="loading-overlay" class="loading-overlay">
            <div class="loading-box">
                <div class="spinner"></div>
                <p id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
            </div>
        </div>

        <div id="ai-modal" class="modal-overlay">
            <div class="modal ai-analysis-modal">
                <div class="modal-icon">ü§ñ</div>
                <h3>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å AI</h3>
                <div class="ai-analysis-content" id="ai-analysis-content"></div>
                <div class="ai-note">
                    üí° ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÉ‡∏´‡πâ Admin ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤<br>
                    Admin ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
                </div>
                <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                    <button onclick="confirmSubmission()" class="btn-primary" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%);">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á</button>
                    <button onclick="closeAIModal()" class="btn-secondary">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                </div>
            </div>
        </div>

        <div id="success-modal" class="modal-overlay">
            <div class="modal success-modal">
                <div class="modal-icon">‚úÖ</div>
                <h3>‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
                <p>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß</p>
                <p class="modal-note">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <strong>‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</strong></p>
                <button onclick="closeModal()" class="btn-primary">‡∏ï‡∏Å‡∏•‡∏á</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    
    <script>
        const CRITERIA_LIST = [
            { code: "1.1", nameTh: "‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå", nameEn: "Analytical Reasoning", domain: "Critical Thinking" },
            { code: "1.2", nameTh: "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö", nameEn: "Systematic Problem Solving", domain: "Critical Thinking" },
            { code: "1.3", nameTh: "‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡πÄ‡∏ä‡∏¥‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏™‡∏±‡∏á‡∏Ñ‡∏°", nameEn: "Systems Thinking", domain: "Critical Thinking" },
            { code: "2.1", nameTh: "‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠", nameEn: "Presentation Skills", domain: "Communication" },
            { code: "2.2", nameTh: "‡∏Å‡∏≤‡∏£‡∏ü‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à", nameEn: "Listening & Comprehension", domain: "Communication" },
            { code: "2.3", nameTh: "‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©", nameEn: "English Communication", domain: "Communication" },
            { code: "3.1", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÉ‡∏ô‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó", nameEn: "Role Understanding", domain: "Teamwork" },
            { code: "3.2", nameTh: "‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô", nameEn: "Task Management", domain: "Teamwork" },
            { code: "3.3", nameTh: "‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô", nameEn: "Collaborative Work", domain: "Teamwork" },
            { code: "4.1", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ", nameEn: "Learning Agility", domain: "Professional Growth" },
            { code: "4.2", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•", nameEn: "Digital Literacy", domain: "Professional Growth" },
            { code: "4.3", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠", nameEn: "Tool Proficiency", domain: "Professional Growth" },
            { code: "5.1", nameTh: "‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏¢‡∏∂‡∏î‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á", nameEn: "Human-Centered Design", domain: "Innovation" },
            { code: "5.2", nameTh: "‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£", nameEn: "Project Management", domain: "Innovation" },
            { code: "5.3", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏£‡∏∞‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏≤‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à", nameEn: "Business Awareness", domain: "Innovation" },
            { code: "6.1", nameTh: "‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•", nameEn: "Personal Growth", domain: "Self Development" },
            { code: "6.2", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß", nameEn: "Resilience", domain: "Self Development" },
            { code: "6.3", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏à", nameEn: "Empathy", domain: "Self Development" }
        ];

        const DOMAINS = [
            { id: 1, name: "Critical Thinking", nameTh: "‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡πÄ‡∏ä‡∏¥‡∏á‡∏ß‡∏¥‡∏û‡∏≤‡∏Å‡∏©‡πå", icon: "üß†" },
            { id: 2, name: "Communication", nameTh: "‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£", icon: "üí¨" },
            { id: 3, name: "Teamwork", nameTh: "‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡∏°", icon: "ü§ù" },
            { id: 4, name: "Professional Growth", nameTh: "‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û", icon: "üìà" },
            { id: 5, name: "Innovation", nameTh: "‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à", icon: "üí°" },
            { id: 6, name: "Self Development", nameTh: "‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡∏ô‡πÄ‡∏≠‡∏á", icon: "üå±" }
        ];

        const LEVEL_DESCRIPTIONS = {
            1: "‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å - ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÉ‡∏ä‡πâ",
            2: "‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à - ‡∏ù‡∏∂‡∏Å‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏à‡∏≥‡∏•‡∏≠‡∏á",
            3: "‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô - ‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏à‡∏£‡∏¥‡∏á",
            4: "‡∏ú‡∏π‡πâ‡∏ô‡∏≥ - ‡∏™‡∏≠‡∏ô/‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô"
        };

        let currentStudent = null;
        let selectedSkills = [];
        let pendingFormData = null;
        let aiAnalysisResult = null;
        const MAX_SKILLS = 3;

        function initializeSkillsList() {
            const container = document.getElementById('skills-list');
            let html = '';
            
            DOMAINS.forEach((domain, index) => {
                const domainCriteria = CRITERIA_LIST.filter(c => c.domain === domain.name);
                html += `
                    <div class="domain-group ${index > 0 ? 'collapsed' : ''}" id="domain-${domain.id}">
                        <div class="domain-header" onclick="toggleDomain(${domain.id})">
                            <span>${domain.icon} ${domain.id}. ${domain.nameTh}</span>
                            <span class="toggle-icon">‚ñº</span>
                        </div>
                        <div class="sub-skills">
                            ${domainCriteria.map(criteria => `
                                <div class="skill-item" id="skill-item-${criteria.code.replace('.', '-')}">
                                    <input type="checkbox" id="skill-${criteria.code.replace('.', '-')}" value="${criteria.code}" onchange="toggleSkill('${criteria.code}')">
                                    <div class="skill-info">
                                        <span class="skill-code">${criteria.code}</span>
                                        <span class="skill-name">${criteria.nameTh}</span>
                                        <span class="skill-name-en">${criteria.nameEn}</span>
                                    </div>
                                    <select class="skill-level-select" id="skill-level-${criteria.code.replace('.', '-')}" disabled onchange="updateSkillLevel('${criteria.code}')">
                                        <option value="1">Lv.1</option>
                                        <option value="2">Lv.2</option>
                                        <option value="3">Lv.3</option>
                                        <option value="4">Lv.4</option>
                                    </select>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function toggleDomain(domainId) {
            document.getElementById(`domain-${domainId}`).classList.toggle('collapsed');
        }

        function toggleSkill(code) {
            const checkbox = document.getElementById(`skill-${code.replace('.', '-')}`);
            const levelSelect = document.getElementById(`skill-level-${code.replace('.', '-')}`);
            const skillItem = document.getElementById(`skill-item-${code.replace('.', '-')}`);
            
            if (checkbox.checked) {
                if (selectedSkills.length >= MAX_SKILLS) {
                    checkbox.checked = false;
                    alert(`‚ö†Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${MAX_SKILLS} ‡∏ó‡∏±‡∏Å‡∏©‡∏∞`);
                    return;
                }
                const activityLevelEl = document.querySelector('input[name="activity-level"]:checked');
                const maxLevel = activityLevelEl ? parseInt(activityLevelEl.value) : 1;
                levelSelect.disabled = false;
                levelSelect.value = Math.min(2, maxLevel);
                skillItem.classList.add('selected');
                selectedSkills.push({ code: code, level: parseInt(levelSelect.value) });
            } else {
                levelSelect.disabled = true;
                skillItem.classList.remove('selected');
                selectedSkills = selectedSkills.filter(s => s.code !== code);
            }
            updateSkillsCounter();
            updateDisabledState();
        }

        function updateSkillLevel(code) {
            const levelSelect = document.getElementById(`skill-level-${code.replace('.', '-')}`);
            const skill = selectedSkills.find(s => s.code === code);
            if (skill) skill.level = parseInt(levelSelect.value);
        }

        function updateSkillsCounter() {
            const counter = document.getElementById('skills-counter');
            counter.textContent = `${selectedSkills.length}/${MAX_SKILLS}`;
            counter.classList.remove('warning', 'error');
            if (selectedSkills.length === MAX_SKILLS) counter.classList.add('warning');
        }

        function updateDisabledState() {
            CRITERIA_LIST.forEach(criteria => {
                const checkbox = document.getElementById(`skill-${criteria.code.replace('.', '-')}`);
                const skillItem = document.getElementById(`skill-item-${criteria.code.replace('.', '-')}`);
                if (selectedSkills.length >= MAX_SKILLS && !checkbox.checked) {
                    skillItem.classList.add('disabled');
                } else {
                    skillItem.classList.remove('disabled');
                }
            });
        }

        function updateSkillLevelLimits() {
            const activityLevelEl = document.querySelector('input[name="activity-level"]:checked');
            if (!activityLevelEl) return;
            const maxLevel = parseInt(activityLevelEl.value);
            
            CRITERIA_LIST.forEach(criteria => {
                const levelSelect = document.getElementById(`skill-level-${criteria.code.replace('.', '-')}`);
                for (let i = 1; i <= 4; i++) {
                    levelSelect.options[i-1].disabled = i > maxLevel;
                }
                if (parseInt(levelSelect.value) > maxLevel) {
                    levelSelect.value = maxLevel;
                    const skill = selectedSkills.find(s => s.code === criteria.code);
                    if (skill) skill.level = maxLevel;
                }
            });
        }

        async function loginStudent() {
            const email = document.getElementById('student-email').value.trim().toLowerCase();
            const errorEl = document.getElementById('login-error');
            
            if (!email || !email.includes('@')) {
                errorEl.textContent = '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Email ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...');
            
            try {
                const query = await db.collection('students').where('email', '==', email).limit(1).get();
                if (query.empty) {
                    errorEl.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
                    showLoading(false);
                    return;
                }
                
                currentStudent = { id: query.docs[0].id, ...query.docs[0].data() };
                sessionStorage.setItem('studentSession', JSON.stringify(currentStudent));
                
                document.getElementById('student-avatar').textContent = currentStudent.name?.charAt(0) || 'S';
                document.getElementById('display-name').textContent = currentStudent.name || '‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤';
                document.getElementById('display-email').textContent = currentStudent.email;
                
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('form-section').style.display = 'block';
                
                initializeSkillsList();
                await loadMySubmissions();
            } catch (error) {
                errorEl.textContent = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
            }
            showLoading(false);
        }

        function logoutStudent() {
            currentStudent = null;
            selectedSkills = [];
            sessionStorage.removeItem('studentSession');
            document.getElementById('login-section').style.display = 'flex';
            document.getElementById('form-section').style.display = 'none';
        }

        async function analyzeWithAI(formData) {
            const GEMINI_API_KEY = 'AIzaSyBBeBz8PZ_Jn2eGPCeKhrdFMFRjlGBxgzE';
            
            const prompt = `‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞) ‡∏ï‡∏≤‡∏° CMU Engineer Competency V4

‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: ${formData.activityName}
‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î: ${formData.activityOrganizer}
‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°: ${formData.activityLevel} (${LEVEL_DESCRIPTIONS[formData.activityLevel]})
‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤: ${formData.duration} ${formData.durationUnit}
‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${formData.description}

‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${formData.studentSelectedSkills.map(s => `${s.code} Lv.${s.level}`).join(', ') || '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å'}

‡∏ó‡∏±‡∏Å‡∏©‡∏∞ 18 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:
1.1-1.3: Critical Thinking (‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå, ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤, ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏ä‡∏¥‡∏á‡∏£‡∏∞‡∏ö‡∏ö)
2.1-2.3: Communication (‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠, ‡∏ü‡∏±‡∏á, ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)
3.1-3.3: Teamwork (‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó, ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô, ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô)
4.1-4.3: Professional Growth (‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ, ‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•, ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠)
5.1-5.3: Innovation (Human-Centered Design, ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£, ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à)
6.1-6.3: Self Development (‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï, ‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô, ‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏à)

‡∏Å‡∏é:
1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞
2. ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (${formData.activityLevel})
3. ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏™‡∏±‡πâ‡∏ô‡πÜ

‡∏ï‡∏≠‡∏ö JSON: {"skills":[{"code":"X.X","level":N,"reason":"‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•"}]}`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.3, maxOutputTokens: 1024 }
                    })
                });

                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                
                if (jsonMatch) {
                    const analysis = JSON.parse(jsonMatch[0]);
                    analysis.skills = analysis.skills.map(s => ({
                        ...s,
                        level: Math.min(s.level, formData.activityLevel)
                    })).slice(0, 3);
                    return analysis;
                }
            } catch (error) {
                console.error('AI error:', error);
            }
            
            return {
                skills: formData.studentSelectedSkills.slice(0, 3).map(s => ({
                    ...s, reason: '‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏£‡∏∞‡∏ö‡∏∏'
                }))
            };
        }

        async function submitActivity(event) {
            event.preventDefault();
            if (!currentStudent) return;
            
            showLoading(true, 'ü§ñ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡πâ‡∏ß‡∏¢ AI...');
            
            try {
                const formData = {
                    studentId: currentStudent.studentId,
                    studentName: currentStudent.name,
                    studentEmail: currentStudent.email,
                    activityName: document.getElementById('activity-name').value.trim(),
                    activityOrganizer: document.getElementById('activity-organizer').value.trim(),
                    startDate: document.getElementById('start-date').value,
                    endDate: document.getElementById('end-date').value,
                    duration: parseInt(document.getElementById('duration').value),
                    durationUnit: document.getElementById('duration-unit').value,
                    activityLevel: parseInt(document.querySelector('input[name="activity-level"]:checked').value),
                    description: document.getElementById('description').value.trim(),
                    evidenceLink: document.getElementById('evidence-link').value.trim(),
                    evidenceDescription: document.getElementById('evidence-desc').value.trim(),
                    studentSelectedSkills: [...selectedSkills]
                };
                
                const existingQuery = await db.collection('submissions')
                    .where('studentEmail', '==', currentStudent.email)
                    .where('activityName', '==', formData.activityName)
                    .get();
                
                if (!existingQuery.empty && existingQuery.docs[0].data().status === 'Pending Review') {
                    alert('‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
                    showLoading(false);
                    return;
                }
                
                aiAnalysisResult = await analyzeWithAI(formData);
                pendingFormData = formData;
                showLoading(false);
                showAIAnalysisModal(formData, aiAnalysisResult);
                
            } catch (error) {
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                showLoading(false);
            }
        }

        function showAIAnalysisModal(formData, aiResult) {
            const content = document.getElementById('ai-analysis-content');
            content.innerHTML = `
                <div class="comparison-row">
                    <div class="comparison-col your-skills">
                        <h5>üéØ ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</h5>
                        ${formData.studentSelectedSkills.length > 0 ? 
                            formData.studentSelectedSkills.map(skill => {
                                const criteria = CRITERIA_LIST.find(c => c.code === skill.code);
                                return `<div class="ai-skill-item">
                                    <div class="skill-detail">
                                        <span class="skill-code">${skill.code}</span>
                                        <span class="skill-name">${criteria?.nameTh || skill.code}</span>
                                    </div>
                                    <span class="skill-level">Lv.${skill.level}</span>
                                </div>`;
                            }).join('') 
                            : '<p style="color:#999;">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞</p>'
                        }
                    </div>
                    <div class="comparison-col ai-skills">
                        <h5>ü§ñ AI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h5>
                        ${aiResult.skills.map(skill => {
                            const criteria = CRITERIA_LIST.find(c => c.code === skill.code);
                            return `<div class="ai-skill-item">
                                <div class="skill-detail">
                                    <span class="skill-code">${skill.code}</span>
                                    <span class="skill-name">${criteria?.nameTh || skill.code}</span>
                                    <div class="ai-reason">üí° ${skill.reason || '-'}</div>
                                </div>
                                <span class="skill-level">Lv.${skill.level}</span>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            `;
            document.getElementById('ai-modal').classList.add('show');
        }

        async function confirmSubmission() {
            if (!pendingFormData || !aiAnalysisResult) return;
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            closeAIModal();
            
            try {
                await db.collection('submissions').add({
                    ...pendingFormData,
                    aiSuggestedSkills: aiAnalysisResult.skills,
                    status: 'Pending Review',
                    submittedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                document.getElementById('activity-form').reset();
                selectedSkills = [];
                initializeSkillsList();
                updateSkillsCounter();
                pendingFormData = null;
                aiAnalysisResult = null;
                
                document.getElementById('success-modal').classList.add('show');
                await loadMySubmissions();
            } catch (error) {
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            showLoading(false);
        }

        function closeAIModal() { document.getElementById('ai-modal').classList.remove('show'); }
        function closeModal() { document.getElementById('success-modal').classList.remove('show'); }

        async function loadMySubmissions() {
            const container = document.getElementById('my-submissions');
            try {
                const query = await db.collection('submissions')
                    .where('studentEmail', '==', currentStudent.email)
                    .orderBy('submittedAt', 'desc')
                    .get();
                
                if (query.empty) {
                    container.innerHTML = '<div class="empty-state"><span class="icon">üì≠</span><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p></div>';
                    return;
                }
                
                container.innerHTML = query.docs.map(doc => {
                    const data = doc.data();
                    const statusClass = data.status?.toLowerCase().includes('approved') ? 'approved' : 
                                        data.status?.toLowerCase().includes('rejected') ? 'rejected' : 'pending';
                    const statusText = statusClass === 'approved' ? '‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' : 
                                       statusClass === 'rejected' ? '‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‚è≥ ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
                    const date = data.submittedAt?.toDate?.() || new Date();
                    const skills = data.aiSuggestedSkills || [];
                    
                    return `<div class="submission-item status-${statusClass}">
                        <div class="submission-header">
                            <h4>${data.activityName}</h4>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="submission-meta">
                            <span>üìÖ ${data.startDate || '-'}</span>
                            <span>‚è±Ô∏è ${data.duration} ${data.durationUnit}</span>
                            <span>üìä Level ${data.activityLevel}</span>
                        </div>
                        ${skills.length > 0 ? `<div style="margin-top:8px;">
                            ${skills.map(s => `<span style="background:#e3f2fd;padding:2px 8px;border-radius:4px;font-size:0.8em;margin-right:4px;">${s.code} Lv.${s.level}</span>`).join('')}
                        </div>` : ''}
                        <div class="submission-date">‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${date.toLocaleDateString('th-TH')}</div>
                    </div>`;
                }).join('');
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><span class="icon">‚ö†Ô∏è</span><p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p></div>';
            }
        }

        function showLoading(show, text = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').classList.toggle('show', show);
        }

        document.getElementById('student-email').addEventListener('keypress', e => { if (e.key === 'Enter') loginStudent(); });

        document.addEventListener('DOMContentLoaded', async () => {
            const session = sessionStorage.getItem('studentSession');
            if (session) {
                try {
                    currentStudent = JSON.parse(session);
                    if (currentStudent.email) {
                        document.getElementById('student-avatar').textContent = currentStudent.name?.charAt(0) || 'S';
                        document.getElementById('display-name').textContent = currentStudent.name || '‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤';
                        document.getElementById('display-email').textContent = currentStudent.email;
                        document.getElementById('login-section').style.display = 'none';
                        document.getElementById('form-section').style.display = 'block';
                        initializeSkillsList();
                        await loadMySubmissions();
                    }
                } catch (e) { sessionStorage.removeItem('studentSession'); }
            }
        });
    </script>
</body>
</html>
