<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Migration Tool - Move Activities</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 30px;
            color: #fff;
        }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 30px; }
        .card {
            background: rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        .card h2 { color: #ffd700; margin-bottom: 15px; font-size: 1.2em; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 15px;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: #ffd700;
            outline: none;
        }
        .form-group select option { background: #1a1a2e; color: white; }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn-search { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-migrate { background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; }
        .btn-danger { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .result-box {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .activity-item {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        .activity-item.selected { border-left-color: #ffd700; background: rgba(255,215,0,0.1); }
        .activity-item h4 { color: #ffd700; margin-bottom: 8px; }
        .activity-item p { font-size: 0.9em; color: #ccc; margin-bottom: 5px; }
        .activity-item .id { font-size: 0.8em; color: #888; }
        
        .log-box {
            background: #000;
            border-radius: 10px;
            padding: 15px;
            font-family: monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-success { color: #2ecc71; }
        .log-error { color: #e74c3c; }
        .log-info { color: #3498db; }
        .log-warn { color: #f39c12; }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        .checkbox-label input { width: 20px; height: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Migration Tool</h1>
        <p style="text-align: center; margin-bottom: 30px; color: #ccc;">‡∏¢‡πâ‡∏≤‡∏¢ Activity ‡∏à‡∏≤‡∏Å <code>activities</code> ‚Üí <code>organizerActivities</code></p>
        
        <!-- Step 1: Search -->
        <div class="card">
            <h2>üìå Step 1: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Activity ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢</h2>
            <div class="form-group">
                <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ)</label>
                <input type="text" id="search-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô Unlock Digital Learning">
            </div>
            <button class="btn btn-search" onclick="searchActivities()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
            
            <div id="search-results" class="result-box" style="display: none;"></div>
        </div>
        
        <!-- Step 2: Configure -->
        <div class="card" id="config-section" style="display: none;">
            <h2>‚öôÔ∏è Step 2: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö organizerActivities</h2>
            <div class="form-group">
                <label>Organizer Email *</label>
                <input type="email" id="org-email" placeholder="‡πÄ‡∏ä‡πà‡∏ô aurakanya.p@cmu.ac.th">
            </div>
            <div class="form-group">
                <label>Role *</label>
                <select id="org-role">
                    <option value="organizer">üëë Organizer (‡∏ó‡∏µ‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î)</option>
                    <option value="staff">ü§ù Staff (‡∏ä‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô)</option>
                    <option value="participant">üë• Participant (‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Status *</label>
                <select id="org-status">
                    <option value="Draft">üìù Draft (‡∏£‡πà‡∏≤‡∏á)</option>
                    <option value="Pending">‚è≥ Pending (‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)</option>
                    <option value="Approved">‚úÖ Approved (‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß)</option>
                    <option value="Rejected">‚ùå Rejected (‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="delete-original">
                    ‡∏•‡∏ö document ‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô activities ‡∏´‡∏•‡∏±‡∏á‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                </label>
            </div>
            <button class="btn btn-migrate" onclick="migrateActivity()">üöÄ ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
        
        <!-- Log -->
        <div class="card">
            <h2>üìã Log</h2>
            <div id="log-box" class="log-box">
                <div class="log-info">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô...</div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    
    <script>
        let selectedActivity = null;
        let selectedDocId = null;
        
        function log(message, type = 'info') {
            const logBox = document.getElementById('log-box');
            const time = new Date().toLocaleTimeString();
            logBox.innerHTML += `<div class="log-${type}">[${time}] ${message}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }
        
        async function searchActivities() {
            const searchName = document.getElementById('search-name').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('search-results');
            
            if (!searchName) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤');
                return;
            }
            
            log(`üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: "${searchName}"`, 'info');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</p>';
            
            try {
                // Search in activities collection
                const snapshot = await db.collection('activities').get();
                
                const matches = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const name = (data.activityName || data.name || '').toLowerCase();
                    if (name.includes(searchName)) {
                        matches.push({ id: doc.id, data: data });
                    }
                });
                
                if (matches.length === 0) {
                    resultsDiv.innerHTML = '<p style="color: #f39c12;">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô</p>';
                    log('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', 'warn');
                    return;
                }
                
                log(`‚úÖ ‡∏û‡∏ö ${matches.length} ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°`, 'success');
                
                resultsDiv.innerHTML = matches.map(item => `
                    <div class="activity-item" id="item-${item.id}" onclick="selectActivity('${item.id}', ${JSON.stringify(item.data).replace(/"/g, '&quot;')})">
                        <h4>${item.data.activityName || item.data.name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠'}</h4>
                        <p>üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${item.data.activityDate || item.data.date || '-'}</p>
                        <p>üë• ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤: ${(item.data.studentIds || []).length || item.data.studentCount || 0} ‡∏Ñ‡∏ô</p>
                        <p>üéØ ‡∏ó‡∏±‡∏Å‡∏©‡∏∞: ${(item.data.skills || []).map(s => s.code || s).join(', ') || '-'}</p>
                        <p class="id">ID: ${item.id}</p>
                    </div>
                `).join('');
                
            } catch (e) {
                log('‚ùå Error: ' + e.message, 'error');
                resultsDiv.innerHTML = `<p style="color: #e74c3c;">Error: ${e.message}</p>`;
            }
        }
        
        function selectActivity(id, data) {
            // Deselect previous
            document.querySelectorAll('.activity-item').forEach(el => el.classList.remove('selected'));
            
            // Select new
            document.getElementById('item-' + id).classList.add('selected');
            selectedDocId = id;
            selectedActivity = data;
            
            log(`üìå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${data.activityName || data.name}`, 'info');
            
            // Show config section
            document.getElementById('config-section').style.display = 'block';
        }
        
        async function migrateActivity() {
            if (!selectedActivity || !selectedDocId) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Activity ‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }
            
            const email = document.getElementById('org-email').value.trim().toLowerCase();
            const role = document.getElementById('org-role').value;
            const status = document.getElementById('org-status').value;
            const deleteOriginal = document.getElementById('delete-original').checked;
            
            if (!email || !email.includes('@')) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Email ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }
            
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:\n\n"${selectedActivity.activityName || selectedActivity.name}"\n\n‚Üí organizerEmail: ${email}\n‚Üí role: ${role}\n‚Üí status: ${status}\n${deleteOriginal ? '‚Üí ‡∏à‡∏∞‡∏•‡∏ö document ‡πÄ‡∏î‡∏¥‡∏°' : ''}`)) {
                return;
            }
            
            log('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'info');
            
            try {
                // Prepare new document
                const roleSuffix = {
                    organizer: '(‡∏ó‡∏µ‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î)',
                    staff: '(Staff)',
                    participant: '(‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°)'
                };
                
                const newData = {
                    // Copy original data
                    ...selectedActivity,
                    
                    // Add/override required fields
                    organizerEmail: email,
                    organizerName: selectedActivity.organizerName || email.split('@')[0],
                    department: selectedActivity.department || '‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå',
                    activityNameBase: selectedActivity.activityName || selectedActivity.name,
                    activityName: `${selectedActivity.activityName || selectedActivity.name} ${roleSuffix[role]}`,
                    activityDate: selectedActivity.activityDate || selectedActivity.date,
                    role: role,
                    roleName: { organizer: '‡∏ó‡∏µ‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î | Organizer', staff: 'Staff | Staff', participant: '‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° | Participant' }[role],
                    activityLevel: { organizer: 4, staff: 2, participant: 2 }[role],
                    status: status,
                    skills: selectedActivity.skills || [],
                    studentIds: selectedActivity.studentIds || [],
                    migratedFrom: 'activities',
                    migratedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    originalDocId: selectedDocId
                };
                
                // Remove fields that don't belong
                delete newData.studentId;
                delete newData.name;
                delete newData.date;
                
                log('üìù ‡∏™‡∏£‡πâ‡∏≤‡∏á document ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô organizerActivities...', 'info');
                
                const docRef = await db.collection('organizerActivities').add(newData);
                log(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! New ID: ${docRef.id}`, 'success');
                
                if (deleteOriginal) {
                    log('üóëÔ∏è ‡∏•‡∏ö document ‡πÄ‡∏î‡∏¥‡∏°...', 'warn');
                    await db.collection('activities').doc(selectedDocId).delete();
                    log('‚úÖ ‡∏•‡∏ö document ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                }
                
                log('üéâ ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                alert('‚úÖ ‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                
                // Reset
                selectedActivity = null;
                selectedDocId = null;
                document.getElementById('search-results').style.display = 'none';
                document.getElementById('config-section').style.display = 'none';
                
            } catch (e) {
                log('‚ùå Error: ' + e.message, 'error');
                alert('Error: ' + e.message);
            }
        }
    </script>
</body>
</html>
