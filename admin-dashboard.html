<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Student Talent Development</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin-style.css">
    <style>
        /* Login Section Styles */
        .login-section {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }
        .login-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 40px 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }
        .login-card h2 { color: #1a1a2e; margin-bottom: 10px; font-size: 1.6em; }
        .login-card > p { color: #666; margin-bottom: 25px; }
        .login-form { display: flex; flex-direction: column; gap: 15px; }
        .login-form input {
            padding: 14px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
        }
        .login-form input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
        }
        .login-form input[type="password"] { letter-spacing: 3px; }
        .login-form button {
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .login-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        .error-message {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 10px;
            min-height: 20px;
        }
        .first-login-info {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            text-align: left;
            border: 1px solid #a5d6a7;
        }
        .first-login-info h4 {
            color: #2e7d32;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .first-login-info ul {
            margin: 0;
            padding-left: 20px;
            color: #555;
            font-size: 0.9em;
            line-height: 1.8;
        }
        .admin-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 12px 20px;
            margin-bottom: 20px;
            color: white;
        }
        .admin-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .admin-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
        }
        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Activity action buttons */
        .act-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .btn-act-edit, .btn-act-delete {
            padding: 5px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        .btn-act-edit {
            background: #3498db;
            color: white;
        }
        .btn-act-edit:hover { background: #2980b9; }
        .btn-act-delete {
            background: #e74c3c;
            color: white;
        }
        .btn-act-delete:hover { background: #c0392b; }
        
        /* Edit Activity Modal */
        .edit-modal-content {
            text-align: left;
        }
        .edit-modal-content .form-group {
            margin-bottom: 15px;
        }
        .edit-modal-content label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        .edit-modal-content input,
        .edit-modal-content select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95em;
        }
        .edit-skills-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
        }
        .edit-skill-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        .edit-skill-item:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <img src="images/MainLogo.png" alt="Student Talent Development" class="logo-img">
                <div>
                    <h1>Admin Dashboard</h1>
                    <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activity Review System</p>
                </div>
            </div>
            <nav class="nav-links">
                <a href="index.html">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å | Home</a>
                <a href="student-portal.html">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ | Search</a>
                <a href="student-form.html">üìù ‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Submit</a>
                <a href="organizer-form.html">üë®‚Äçüíº ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î | Organizer</a>
                <a href="data-management.html">üìä ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ | Manage</a>
                <a href="research-analytics.html">üî¨ ‡∏ß‡∏¥‡∏à‡∏±‡∏¢ | Research</a>
            </nav>
        </header>

        <!-- Login Section -->
        <section id="login-section" class="login-section">
            <div class="login-card">
                <h2>üîê Admin Login</h2>
                <p>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | Login to manage data</p>
                <div class="login-form">
                    <input type="email" id="admin-email" placeholder="Admin Email">
                    <input type="password" id="admin-password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô | Password (min 4 chars)" minlength="4">
                    <button onclick="loginAdmin()">üöÄ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö | Login</button>
                </div>
                <p id="login-error" class="error-message"></p>
                
                <div class="first-login-info">
                    <h4><span class="icon">üí°</span> ‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö | How to Login</h4>
                    <ul>
                        <li>Email ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢ Admin ‡∏Å‡πà‡∏≠‡∏ô</li>
                        <li>Your email must be added by an Admin first</li>
                        <li>‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å: ‡πÉ‡∏™‡πà Email + <strong>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</strong></li>
                        <li>‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Main Content (hidden until login) -->
        <section id="main-section" style="display: none;">
            <!-- Admin Bar -->
            <div class="admin-bar">
                <div class="admin-info">
                    <div class="admin-avatar" id="admin-avatar">A</div>
                    <div>
                        <strong id="admin-display-name">Admin</strong>
                        <br><small id="admin-display-email">admin@cmu.ac.th</small>
                    </div>
                </div>
                <button class="btn-logout" onclick="logoutAdmin()">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö | Logout</button>
            </div>

            <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-card pending">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-content">
                    <span class="stat-number" id="pending-count">0</span>
                    <span class="stat-label">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö | Pending</span>
                </div>
            </div>
            <div class="stat-card approved">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-content">
                    <span class="stat-number" id="approved-count">0</span>
                    <span class="stat-label">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß | Approved</span>
                </div>
            </div>
            <div class="stat-card rejected">
                <div class="stat-icon">‚ùå</div>
                <div class="stat-content">
                    <span class="stat-number" id="rejected-count">0</span>
                    <span class="stat-label">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ | Rejected</span>
                </div>
            </div>
            <div class="stat-card total">
                <div class="stat-icon">üìä</div>
                <div class="stat-content">
                    <span class="stat-number" id="total-count">0</span>
                    <span class="stat-label">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î | Total</span>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="student-search">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏®. | Search Student</button>
            <button class="tab" data-tab="activities-manage">üìö ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activities</button>
            <button class="tab" data-tab="student-submissions">üìù ‡∏ô‡∏®.‡πÅ‡∏à‡πâ‡∏á | Student</button>
            <button class="tab" data-tab="organizer-activities">üë®‚Äçüíº ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î | Organizer</button>
            <button class="tab" data-tab="transfer">üì§ ‡πÇ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | Transfer</button>
            <button class="tab" data-tab="organizers">üë• ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô | Organizers</button>
            <button class="tab" data-tab="admin-manage">üë§ Admin</button>
            <button class="tab" data-tab="export">üì• Export CSV</button>
        </div>

        <!-- Tab: Student Search -->
        <div id="tab-student-search" class="tab-content active">
            <div class="panel">
                <h2>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ | Search Student</h2>
                <p class="panel-desc">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ Email ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ | Search by Email or Student ID</p>
                
                <div class="search-box">
                    <input type="text" id="admin-student-search" placeholder="Email ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ | Email or Student ID">
                    <button class="btn-search" onclick="searchStudentAdmin()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ | Search</button>
                </div>
                
                <div id="student-search-result" class="student-search-result" style="display: none;">
                    <!-- Student Info -->
                    <div class="student-profile">
                        <div class="profile-header">
                            <div class="profile-avatar" id="result-avatar">S</div>
                            <div class="profile-info">
                                <h3 id="result-name">-</h3>
                                <p id="result-email">-</p>
                                <p id="result-student-id">-</p>
                                <p id="result-department">-</p>
                            </div>
                        </div>
                        
                        <!-- Stats -->
                        <div class="profile-stats">
                            <div class="profile-stat">
                                <span class="stat-num" id="result-total-activities">0</span>
                                <span class="stat-lbl">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activities</span>
                            </div>
                            <div class="profile-stat">
                                <span class="stat-num" id="result-approved">0</span>
                                <span class="stat-lbl">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ | Approved</span>
                            </div>
                            <div class="profile-stat">
                                <span class="stat-num" id="result-skills-passed">0</span>
                                <span class="stat-lbl">‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ú‡πà‡∏≤‡∏ô | Skills Passed</span>
                            </div>
                            <div class="profile-stat">
                                <span class="stat-num" id="result-total-score">0</span>
                                <span class="stat-lbl">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° | Total Score</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Competency Summary -->
                    <div class="result-section">
                        <h4>üìä Competency Summary</h4>
                        <div id="result-competency" class="competency-grid">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    
                    <!-- Activities List -->
                    <div class="result-section">
                        <h4>üìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activity List</h4>
                        <div id="result-activities" class="result-activities-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
                
                <div id="student-not-found" class="not-found-box" style="display: none;">
                    <span class="icon">üòï</span>
                    <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ | Student not found</p>
                </div>
            </div>
        </div>

        <!-- Tab: Activities Management -->
        <div id="tab-activities-manage" class="tab-content">
            <div class="panel">
                <div class="panel-header">
                    <h2>üìö ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activity Management</h2>
                    <button class="btn-add-organizer" onclick="openAddActivityModal()">
                        ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà | Add Activity
                    </button>
                </div>
                <p class="panel-desc">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö | Add/Edit/Delete activities in the system</p>
                
                <!-- Search Box -->
                <div class="search-box" style="margin-bottom: 20px;">
                    <input type="text" id="activity-search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°... | Search activity...">
                    <button class="btn-search" onclick="searchActivitiesAdmin()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ | Search</button>
                    <button class="btn-search" style="background: #27ae60;" onclick="loadAllActivitiesAdmin()">üìã ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î | All</button>
                </div>
                
                <!-- Activities Stats -->
                <div class="activity-manage-stats">
                    <div class="activity-stat-card">
                        <span class="activity-stat-number" id="total-activities-count">0</span>
                        <span class="activity-stat-label">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î | Total</span>
                    </div>
                    <div class="activity-stat-card has-skills">
                        <span class="activity-stat-number" id="with-skills-count">0</span>
                        <span class="activity-stat-label">‡∏°‡∏µ Skills | With Skills</span>
                    </div>
                </div>
                
                <!-- Activities Table -->
                <div class="table-container">
                    <table class="activity-table" id="activities-manage-table">
                        <thead>
                            <tr>
                                <th style="width: 30%;">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activity</th>
                                <th style="width: 15%;">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î | Organizer</th>
                                <th style="width: 12%;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà | Date</th>
                                <th style="width: 8%;">Level</th>
                                <th style="width: 25%;">Skills</th>
                                <th style="width: 10%;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="activities-manage-list">
                            <tr><td colspan="6" class="loading-cell">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" | Search or click "All"</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Student Submissions -->
        <div id="tab-student-submissions" class="tab-content">
            <div class="panel">
                <div class="panel-header">
                    <h2>üìù ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏à‡πâ‡∏á</h2>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all" data-type="student">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        <button class="filter-btn" data-filter="pending" data-type="student">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
                        <button class="filter-btn" data-filter="approved" data-type="student">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</button>
                        <button class="filter-btn" data-filter="rejected" data-type="student">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                    </div>
                </div>
                <div id="student-submissions-list" class="submissions-list">
                    <div class="loading-inline">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                </div>
            </div>
        </div>

        <!-- Tab: Organizer Activities -->
        <div id="tab-organizer-activities" class="tab-content">
            <div class="panel">
                <div class="panel-header">
                    <h2>üë®‚Äçüíº ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î</h2>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all" data-type="organizer">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        <button class="filter-btn" data-filter="pending" data-type="organizer">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                        <button class="filter-btn" data-filter="approved" data-type="organizer">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</button>
                        <button class="filter-btn" data-filter="rejected" data-type="organizer">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                    </div>
                </div>
                <div id="organizer-activities-list" class="submissions-list">
                    <div class="loading-inline">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                </div>
            </div>
        </div>

        <!-- Tab: Transfer Data -->
        <div id="tab-transfer" class="tab-content">
            <div class="panel">
                <h2>üì§ ‡πÇ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Master</h2>
                <p class="panel-desc">‡πÇ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏¢‡∏±‡∏á Activities ‡πÅ‡∏•‡∏∞ Participation Collection</p>
                
                <div class="transfer-stats">
                    <div class="transfer-stat">
                        <span class="transfer-number" id="transfer-ready">0</span>
                        <span class="transfer-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÇ‡∏≠‡∏ô</span>
                    </div>
                    <div class="transfer-stat">
                        <span class="transfer-number" id="transfer-done">0</span>
                        <span class="transfer-label">‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
                    </div>
                </div>
                
                <button id="transfer-btn" class="btn-transfer" onclick="transferToMaster()">
                    üöÄ ‡πÇ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
                
                <div id="transfer-log" class="transfer-log"></div>
            </div>
        </div>

        <!-- Tab: Organizers Management -->
        <div id="tab-organizers" class="tab-content">
            <div class="panel">
                <div class="panel-header">
                    <h2>üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Registered Organizers</h2>
                    <button class="btn-add-organizer" onclick="openAddOrganizerModal()">
                        ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà | Add New
                    </button>
                </div>
                <p class="panel-desc">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Organizer Portal | Anyone can register via Organizer Portal</p>
                
                <div class="organizers-stats">
                    <div class="org-stat">
                        <span class="org-stat-number" id="total-organizers">0</span>
                        <span class="org-stat-label">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î | Total</span>
                    </div>
                    <div class="org-stat">
                        <span class="org-stat-number" id="active-organizers">0</span>
                        <span class="org-stat-label">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß | Active</span>
                    </div>
                </div>

                <div id="organizers-list" class="organizers-list">
                    <div class="loading-inline">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... | Loading...</div>
                </div>
            </div>
        </div>

        <!-- Tab: Admin Management -->
        <div id="tab-admin-manage" class="tab-content">
            <div class="panel">
                <h2>üë§ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Admin | Admin Management</h2>
                <p class="panel-desc">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö Admin ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö | Add or remove system admins</p>
                
                <!-- Add New Admin -->
                <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 12px; padding: 20px; margin-bottom: 25px; border: 2px solid #a5d6a7;">
                    <h4 style="color: #2e7d32; margin-bottom: 15px;">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° Admin ‡πÉ‡∏´‡∏°‡πà | Add New Admin</h4>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Email <span style="color: #e74c3c;">*</span></label>
                            <input type="email" id="new-admin-email" placeholder="email@cmu.ac.th" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">‡∏ä‡∏∑‡πà‡∏≠ | Name</label>
                            <input type="text" id="new-admin-name" placeholder="(optional)" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                        </div>
                        <button onclick="addNewAdmin()" style="padding: 12px 25px; background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1em;">
                            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° | Add
                        </button>
                    </div>
                    <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
                        üí° Admin ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å | New admin will set password on first login
                    </p>
                </div>
                
                <!-- Admin List -->
                <div style="background: white; border-radius: 12px; border: 2px solid #e0e0e0;">
                    <div style="padding: 15px 20px; border-bottom: 2px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                        <h4 style="margin: 0; color: #333;">üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Admin | Admin List</h4>
                        <button onclick="loadAdminList()" style="padding: 8px 15px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">
                            üîÑ Refresh
                        </button>
                    </div>
                    <div id="admin-list-container" style="padding: 20px;">
                        <div style="text-align: center; color: #999; padding: 20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... | Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Export CSV -->
        <div id="tab-export" class="tab-content">
            <div class="panel">
                <h2>üì• Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô CSV | Export Data to CSV</h2>
                <p class="panel-desc">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö CSV | Download all data in CSV format</p>
                
                <div class="export-grid">
                    <div class="export-card">
                        <div class="export-icon">üë•</div>
                        <h4>‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ | Students</h4>
                        <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î | All student data</p>
                        <button class="btn-export" onclick="exportStudentsCSV()">
                            üì• Export Students
                        </button>
                    </div>
                    
                    <div class="export-card">
                        <div class="export-icon">üìö</div>
                        <h4>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activities</h4>
                        <p>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î | All activities</p>
                        <button class="btn-export" onclick="exportActivitiesCSV()">
                            üì• Export Activities
                        </button>
                    </div>
                    
                    <div class="export-card">
                        <div class="export-icon">üéØ</div>
                        <h4>‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° | Participation</h4>
                        <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Participation records</p>
                        <button class="btn-export" onclick="exportParticipationCSV()">
                            üì• Export Participation
                        </button>
                    </div>
                    
                    <div class="export-card">
                        <div class="export-icon">üìù</div>
                        <h4>‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Submissions</h4>
                        <p>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏à‡πâ‡∏á | Student submissions</p>
                        <button class="btn-export" onclick="exportSubmissionsCSV()">
                            üì• Export Submissions
                        </button>
                    </div>
                    
                    <div class="export-card">
                        <div class="export-icon">üë®‚Äçüíº</div>
                        <h4>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î | Organizer Activities</h4>
                        <p>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î | Organizer activities</p>
                        <button class="btn-export" onclick="exportOrganizerActivitiesCSV()">
                            üì• Export Organizer Activities
                        </button>
                    </div>
                    
                    <div class="export-card">
                        <div class="export-icon">üîê</div>
                        <h4>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Organizers</h4>
                        <p>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Organizer list</p>
                        <button class="btn-export" onclick="exportOrganizersCSV()">
                            üì• Export Organizers
                        </button>
                    </div>
                </div>
                
                <div class="export-all">
                    <button class="btn-export-all" onclick="exportAllCSV()">
                        üì¶ Export ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î | Export All Data
                    </button>
                </div>
                
                <!-- Data Repair Section -->
                <div class="repair-section">
                    <h3>üîß ‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | Data Repair</h3>
                    <p class="panel-desc">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ skills | Fix activities without skills</p>
                    
                    <div class="repair-actions">
                        <button class="btn-repair" onclick="scanActivitiesWithoutSkills()">
                            üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Scan Activities
                        </button>
                        <button class="btn-repair warning" onclick="showAddSkillsToActivity()">
                            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° Skills ‡πÉ‡∏´‡πâ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Add Skills to Activity
                        </button>
                    </div>
                    
                    <div id="repair-result" class="repair-result" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Add Organizer Modal -->
        <div id="add-organizer-modal" class="modal-overlay">
            <div class="modal" style="max-width: 500px;">
                <div class="modal-header">
                    <h3>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà</h3>
                    <button class="modal-close" onclick="closeAddOrganizerModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Email <span class="required">*</span></label>
                        <input type="email" id="new-org-email" placeholder="organizer@cmu.ac.th">
                    </div>
                    <div class="form-group">
                        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="required">*</span></label>
                        <input type="text" id="new-org-name" placeholder="‡∏î‡∏£.‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ">
                    </div>
                    <div class="form-group">
                        <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô/‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</label>
                        <input type="text" id="new-org-department" placeholder="‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå">
                    </div>
                    <div class="form-group">
                        <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
                        <input type="tel" id="new-org-phone" placeholder="08x-xxx-xxxx">
                    </div>
                    <p class="form-note">üí° ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å</p>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeAddOrganizerModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button class="btn-primary" onclick="addNewOrganizer()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î</button>
                </div>
            </div>
        </div>

        <!-- Detail Modal -->
        <div id="detail-modal" class="modal-overlay">
            <div class="modal detail-modal">
                <div class="modal-header">
                    <h3 id="modal-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
                    <button class="modal-close" onclick="closeDetailModal()">‚úï</button>
                </div>
                <div class="modal-body" id="modal-body">
                    <!-- Filled by JS -->
                </div>
                <div class="modal-footer" id="modal-footer">
                    <!-- Filled by JS -->
                </div>
            </div>
        </div>

        <!-- Reject Reason Modal -->
        <div id="reject-modal" class="modal-overlay">
            <div class="modal reject-modal">
                <div class="modal-header">
                    <h3>‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
                    <button class="modal-close" onclick="closeRejectModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <label>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò:</label>
                    <textarea id="reject-reason" rows="4" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•..."></textarea>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeRejectModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button class="btn-danger" onclick="confirmReject()">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                </div>
            </div>
        </div>

        <!-- Activity Management Modal -->
        <div id="activity-modal" class="modal-overlay">
            <div class="modal" style="max-width: 700px;">
                <div class="modal-header">
                    <h3 id="activity-modal-title">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Add Activity</h3>
                    <button class="modal-close" onclick="closeActivityModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-activity-id">
                    <input type="hidden" id="edit-activity-original-name">
                    
                    <div class="form-group">
                        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activity Name <span style="color:red">*</span></label>
                        <input type="text" id="act-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°">
                    </div>
                    
                    <div class="form-row" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div class="form-group">
                            <label>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î | Organizer</label>
                            <input type="text" id="act-organizer" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô">
                        </div>
                        <div class="form-group">
                            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà | Date</label>
                            <input type="date" id="act-date">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î | Description</label>
                        <textarea id="act-description" rows="2" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>üéØ ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö | Skills & Levels</label>
                        <p style="font-size:0.85em; color:#666; margin-bottom:10px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö (1-4) | Select skills and set levels</p>
                        <div id="activity-skills-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:8px; max-height:300px; overflow-y:auto; padding:10px; background:#f8f9fa; border-radius:8px;">
                            <!-- Skills will be populated by JS -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeActivityModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å | Cancel</button>
                    <button class="btn-primary" onclick="saveActivityAdmin()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å | Save</button>
                </div>
            </div>
        </div>

        </section><!-- End main-section -->

        <!-- Edit Student Activity Modal -->
        <div id="edit-student-activity-modal" class="modal-overlay">
            <div class="modal" style="max-width: 500px;">
                <div class="modal-header">
                    <h3>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Edit Activity</h3>
                </div>
                <div class="modal-body edit-modal-content">
                    <input type="hidden" id="edit-activity-id">
                    <input type="hidden" id="edit-activity-source">
                    <input type="hidden" id="edit-student-id">
                    
                    <div class="form-group">
                        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activity Name</label>
                        <input type="text" id="edit-activity-name" readonly style="background:#f5f5f5;">
                    </div>
                    
                    <div class="form-group">
                        <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ | Status</label>
                        <select id="edit-activity-status">
                            <option value="Approved">‚úÖ Approved (‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</option>
                            <option value="Pending Review">‚è≥ Pending (‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)</option>
                            <option value="Rejected">‚ùå Rejected (‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>üéØ ‡∏ó‡∏±‡∏Å‡∏©‡∏∞ | Skills (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3)</label>
                        <div class="edit-skills-list" id="edit-skills-list">
                            <!-- Skills checkboxes will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeEditActivityModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å | Cancel</button>
                    <button class="btn-primary" onclick="saveEditedActivity()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å | Save</button>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="delete-confirm-modal" class="modal-overlay">
            <div class="modal" style="max-width: 400px; text-align: center;">
                <div class="modal-icon" style="font-size: 3em;">‚ö†Ô∏è</div>
                <h3>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö | Confirm Delete</h3>
                <p id="delete-confirm-text" style="margin: 20px 0; color: #666;">
                    ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ?
                </p>
                <input type="hidden" id="delete-activity-id">
                <input type="hidden" id="delete-activity-source">
                <input type="hidden" id="delete-student-id-for-refresh">
                <div class="modal-footer" style="justify-content: center;">
                    <button class="btn-secondary" onclick="closeDeleteModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å | Cancel</button>
                    <button class="btn-danger" onclick="confirmDeleteActivity()">üóëÔ∏è ‡∏•‡∏ö | Delete</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay">
            <div class="loading-box">
                <div class="spinner"></div>
                <p id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    
    <script>
        // ============================================
        // CRITERIA DEFINITIONS
        // ============================================
        const CRITERIA_LIST = [
            { code: "1.1", name: "Analytical Reasoning", nameTh: "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå", domain: "Critical Thinking" },
            { code: "1.2", name: "Problem Solving", nameTh: "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö", domain: "Critical Thinking" },
            { code: "1.3", name: "Systems Thinking", nameTh: "‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡πÄ‡∏ä‡∏¥‡∏á‡∏£‡∏∞‡∏ö‡∏ö", domain: "Critical Thinking" },
            { code: "2.1", name: "Presentation", nameTh: "‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠", domain: "Communication" },
            { code: "2.2", name: "Listening", nameTh: "‡∏Å‡∏≤‡∏£‡∏ü‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à", domain: "Communication" },
            { code: "2.3", name: "English", nameTh: "‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©", domain: "Communication" },
            { code: "3.1", name: "Role Understanding", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÉ‡∏ô‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó", domain: "Teamwork" },
            { code: "3.2", name: "Task Management", nameTh: "‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô", domain: "Teamwork" },
            { code: "3.3", name: "Collaboration", nameTh: "‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô", domain: "Teamwork" },
            { code: "4.1", name: "Learning Agility", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ", domain: "Digital & Learning" },
            { code: "4.2", name: "Digital Literacy", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•", domain: "Digital & Learning" },
            { code: "4.3", name: "Tool Proficiency", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠", domain: "Digital & Learning" },
            { code: "5.1", name: "Human-Centered Design", nameTh: "‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏¢‡∏∂‡∏î‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á", domain: "Innovation" },
            { code: "5.2", name: "Project Management", nameTh: "‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£", domain: "Innovation" },
            { code: "5.3", name: "Business Awareness", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏£‡∏∞‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏≤‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à", domain: "Innovation" },
            { code: "6.1", name: "Personal Growth", nameTh: "‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•", domain: "Self Development" },
            { code: "6.2", name: "Resilience", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß", domain: "Self Development" },
            { code: "6.3", name: "Empathy", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏à", domain: "Self Development" }
        ];

        const DOMAINS = [
            { id: 1, name: "Critical Thinking", nameTh: "‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå", color: "#667eea" },
            { id: 2, name: "Communication", nameTh: "‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£", color: "#27ae60" },
            { id: 3, name: "Teamwork", nameTh: "‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡∏°", color: "#f39c12" },
            { id: 4, name: "Digital & Learning", nameTh: "‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ", color: "#e74c3c" },
            { id: 5, name: "Innovation", nameTh: "‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°", color: "#9b59b6" },
            { id: 6, name: "Self Development", nameTh: "‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡∏ô‡πÄ‡∏≠‡∏á", color: "#1abc9c" }
        ];

        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let studentSubmissions = [];
        let organizerActivities = [];
        let currentItem = null;
        let currentType = null;
        let studentFilter = 'all';
        let organizerFilter = 'all';

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            checkAdminSession();
            setupTabs();
            setupFilters();
            
            // Enter key for login
            document.getElementById('admin-password')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loginAdmin();
            });
        });

        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
                    
                    // Load organizers when tab is clicked
                    if (tab.dataset.tab === 'organizers') {
                        loadOrganizers();
                    }
                    
                    // Load admin list when tab is clicked
                    if (tab.dataset.tab === 'admin-manage') {
                        loadAdminList();
                    }
                    
                    // Load activities management when tab is clicked
                    if (tab.dataset.tab === 'activities-manage') {
                        if (allActivitiesCache.length === 0) {
                            loadAllActivitiesAdmin();
                        }
                    }
                });
            });
        }

        function setupFilters() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const type = btn.dataset.type;
                    const filter = btn.dataset.filter;
                    
                    // Update active state
                    btn.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    if (type === 'student') {
                        studentFilter = filter;
                        renderStudentSubmissions();
                    } else {
                        organizerFilter = filter;
                        renderOrganizerActivities();
                    }
                });
            });
        }

        // ============================================
        // EXTRACT SKILLS FROM ACTIVITY (various formats)
        // ============================================
        function extractSkillsAdmin(activity) {
            let skills = [];
            
            // Format 1: Check for skills array
            if (activity.skills && Array.isArray(activity.skills) && activity.skills.length > 0) {
                skills = [...activity.skills];
            } else if (typeof CRITERIA_LIST !== 'undefined') {
                // Format 2: Check for direct code format (e.g., "1.1": 2 or "1_1": 2)
                CRITERIA_LIST.forEach(criteria => {
                    const value = activity[criteria.code] || activity[criteria.code.replace('.', '_')];
                    if (value && value > 0) {
                        skills.push({
                            code: criteria.code,
                            level: parseInt(value)
                        });
                    }
                });
            }
            
            // For student view - limit to top 3 skills
            if (skills.length > 3) {
                skills.sort((a, b) => b.level - a.level);
                skills = skills.slice(0, 3);
            }
            
            return skills;
        }

        // ============================================
        // ADMIN STUDENT SEARCH
        // ============================================
        async function searchStudentAdmin() {
            const searchInput = document.getElementById('admin-student-search').value.trim().toLowerCase();
            
            if (!searchInput) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Email ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ | Please enter Email or Student ID');
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤... | Searching...');
            
            document.getElementById('student-search-result').style.display = 'none';
            document.getElementById('student-not-found').style.display = 'none';
            
            try {
                // Search by email first
                let studentDoc = null;
                let studentData = null;
                
                let query = await db.collection('students').where('email', '==', searchInput).limit(1).get();
                
                if (query.empty) {
                    // Try search by studentId
                    query = await db.collection('students').where('studentId', '==', searchInput).limit(1).get();
                }
                
                if (query.empty) {
                    // Try partial match - search all and filter
                    const allStudents = await db.collection('students').get();
                    for (const doc of allStudents.docs) {
                        const data = doc.data();
                        if (data.email?.toLowerCase().includes(searchInput) || 
                            data.studentId?.toLowerCase().includes(searchInput) ||
                            data.name?.toLowerCase().includes(searchInput)) {
                            studentDoc = doc;
                            studentData = data;
                            break;
                        }
                    }
                } else {
                    studentDoc = query.docs[0];
                    studentData = studentDoc.data();
                }
                
                if (!studentData) {
                    document.getElementById('student-not-found').style.display = 'block';
                    showLoading(false);
                    return;
                }
                
                // Load student activities
                const activities = await loadStudentActivitiesAdmin(studentData.studentId, studentData.email);
                
                // Calculate scores
                const scores = calculateScoresAdmin(activities);
                const domainScores = calculateDomainScoresAdmin(scores);
                
                // Display results
                displayStudentResult(studentData, activities, scores, domainScores);
                
            } catch (error) {
                console.error('Search error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î | Error: ' + error.message);
            }
            
            showLoading(false);
        }

        async function loadStudentActivitiesAdmin(studentId, email) {
            const activities = [];
            
            // Load from participation
            const participationQuery = await db.collection('participation')
                .where('studentId', '==', studentId)
                .get();
            
            for (const doc of participationQuery.docs) {
                const participation = doc.data();
                
                // Get activity details
                const activityQuery = await db.collection('activities')
                    .where('name', '==', participation.activityName)
                    .limit(1)
                    .get();
                
                let activityData = {
                    id: doc.id,
                    name: participation.activityName,
                    status: participation.status || 'Approved',
                    date: participation.date || '',
                    skills: [],
                    source: 'participation'
                };
                
                if (!activityQuery.empty) {
                    const activity = activityQuery.docs[0].data();
                    activityData.skills = extractSkillsAdmin(activity);
                }
                
                activities.push(activityData);
            }
            
            // Load from submissions
            const submissionsQuery = await db.collection('submissions')
                .where('studentEmail', '==', email)
                .get();
            
            for (const doc of submissionsQuery.docs) {
                const submission = doc.data();
                
                const exists = activities.find(a => 
                    a.name.toLowerCase() === submission.activityName?.toLowerCase()
                );
                
                if (!exists) {
                    activities.push({
                        id: doc.id,
                        name: submission.activityName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                        status: submission.status || 'Pending',
                        date: submission.activityDate || submission.startDate || '',
                        skills: submission.skills || [],
                        source: 'submission'
                    });
                }
            }
            
            return activities;
        }

        function calculateScoresAdmin(activities) {
            const scores = {};
            CRITERIA_LIST.forEach(c => scores[c.code] = 0);
            
            const approved = activities.filter(a => a.status?.toLowerCase().includes('approved'));
            approved.forEach(activity => {
                if (activity.skills) {
                    activity.skills.forEach(skill => {
                        if (skill.code && skill.level) {
                            scores[skill.code] = Math.max(scores[skill.code], skill.level);
                        }
                    });
                }
            });
            
            return scores;
        }

        function calculateDomainScoresAdmin(scores) {
            const domainScores = {};
            
            DOMAINS.forEach(domain => {
                const domainCriteria = CRITERIA_LIST.filter(c => c.domain === domain.name);
                const domainLevels = domainCriteria.map(c => scores[c.code] || 0);
                
                const total = domainLevels.reduce((a, b) => a + b, 0);
                const avg = domainLevels.length > 0 ? total / domainLevels.length : 0;
                
                domainScores[domain.name] = {
                    total,
                    avg: Math.round(avg * 10) / 10,
                    levels: domainLevels,
                    color: domain.color
                };
            });
            
            return domainScores;
        }

        // Store current searched student for refresh
        let currentSearchedStudent = null;

        function displayStudentResult(student, activities, scores, domainScores) {
            // Store for refresh after edit/delete
            currentSearchedStudent = student;
            
            // Update profile info
            document.getElementById('result-avatar').textContent = student.name?.charAt(0) || 'S';
            document.getElementById('result-name').textContent = student.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
            document.getElementById('result-email').textContent = student.email || '-';
            document.getElementById('result-student-id').textContent = `‡∏£‡∏´‡∏±‡∏™ | ID: ${student.studentId || '-'}`;
            document.getElementById('result-department').textContent = student.department || '';
            
            // Update stats
            const approved = activities.filter(a => a.status?.toLowerCase().includes('approved'));
            const totalScore = Object.values(scores).reduce((a, b) => a + b, 0);
            const skillsPassed = DOMAINS.filter(d => domainScores[d.name].avg >= 2).length;
            
            document.getElementById('result-total-activities').textContent = activities.length;
            document.getElementById('result-approved').textContent = approved.length;
            document.getElementById('result-skills-passed').textContent = `${skillsPassed}/6`;
            document.getElementById('result-total-score').textContent = totalScore;
            
            // Render competency grid
            const compContainer = document.getElementById('result-competency');
            compContainer.innerHTML = DOMAINS.map(domain => {
                const ds = domainScores[domain.name];
                const statusClass = ds.avg >= 3 ? 'excellent' : ds.avg >= 2 ? 'good' : ds.avg >= 1 ? 'developing' : 'none';
                const statusText = ds.avg >= 3 ? '‚≠ê Excellent' : ds.avg >= 2 ? '‚úÖ Passed' : ds.avg >= 1 ? 'üìà Developing' : '‚Äî';
                
                return `
                    <div class="comp-card" style="border-left: 4px solid ${domain.color}">
                        <div class="comp-header">
                            <span class="comp-name">${domain.name}</span>
                            <span class="comp-level ${statusClass}">Lv.${ds.avg}</span>
                        </div>
                        <div class="comp-status ${statusClass}">${statusText}</div>
                    </div>
                `;
            }).join('');
            
            // Render activities list with edit/delete buttons
            const actContainer = document.getElementById('result-activities');
            if (activities.length === 0) {
                actContainer.innerHTML = '<div class="empty-msg">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | No activities</div>';
            } else {
                actContainer.innerHTML = activities.map(act => {
                    const statusClass = act.status?.toLowerCase().includes('approved') ? 'approved' : 
                                       act.status?.toLowerCase().includes('rejected') ? 'rejected' : 'pending';
                    const statusText = act.status?.toLowerCase().includes('approved') ? '‚úÖ Approved' : 
                                      act.status?.toLowerCase().includes('rejected') ? '‚ùå Rejected' : '‚è≥ Pending';
                    
                    const skillsHtml = act.skills?.map(s => 
                        `<span class="skill-mini">${s.code}: Lv.${s.level}</span>`
                    ).join('') || '';
                    
                    // Create JSON string for skills (escape quotes)
                    const skillsJson = JSON.stringify(act.skills || []).replace(/"/g, '&quot;');
                    
                    return `
                        <div class="result-activity ${statusClass}">
                            <div class="act-main">
                                <span class="act-name">${act.name}</span>
                                <span class="act-status ${statusClass}">${statusText}</span>
                            </div>
                            <div class="act-meta">
                                <span>üìÖ ${act.date || '-'}</span>
                                <span>üìÅ ${act.source === 'submission' ? '‡∏ô‡∏®.‡πÅ‡∏à‡πâ‡∏á' : '‡∏£‡∏∞‡∏ö‡∏ö'}</span>
                            </div>
                            ${skillsHtml ? `<div class="act-skills">${skillsHtml}</div>` : ''}
                            <div class="act-actions">
                                <button class="btn-act-edit" onclick="openEditActivityModal('${act.id}', '${act.source}', '${act.name}', '${act.status || ''}', '${skillsJson}', '${student.studentId}')">
                                    ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                </button>
                                <button class="btn-act-delete" onclick="openDeleteModal('${act.id}', '${act.source}', '${act.name}', '${student.studentId}')">
                                    üóëÔ∏è ‡∏•‡∏ö
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('student-search-result').style.display = 'block';
        }

        // Enter key handler for student search
        document.getElementById('admin-student-search')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchStudentAdmin();
        });

        // ============================================
        // LOAD DATA
        // ============================================
        async function loadAllData() {
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            
            try {
                // Load student submissions
                const submissionsQuery = await db.collection('submissions')
                    .orderBy('submittedAt', 'desc')
                    .get();
                studentSubmissions = submissionsQuery.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Load organizer activities
                const activitiesQuery = await db.collection('organizerActivities')
                    .orderBy('updatedAt', 'desc')
                    .get();
                organizerActivities = activitiesQuery.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Update stats
                updateStats();
                
                // Render lists
                renderStudentSubmissions();
                renderOrganizerActivities();
                updateTransferStats();
                
            } catch (error) {
                console.error('Load error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            }
            
            showLoading(false);
        }

        function updateStats() {
            const allItems = [...studentSubmissions, ...organizerActivities];
            
            const pending = allItems.filter(i => i.status?.toLowerCase().includes('pending')).length;
            const approved = allItems.filter(i => i.status?.toLowerCase() === 'approved').length;
            const rejected = allItems.filter(i => i.status?.toLowerCase().includes('rejected')).length;
            
            document.getElementById('pending-count').textContent = pending;
            document.getElementById('approved-count').textContent = approved;
            document.getElementById('rejected-count').textContent = rejected;
            document.getElementById('total-count').textContent = allItems.length;
        }

        // ============================================
        // RENDER STUDENT SUBMISSIONS
        // ============================================
        function renderStudentSubmissions() {
            const container = document.getElementById('student-submissions-list');
            
            let filtered = studentSubmissions;
            if (studentFilter !== 'all') {
                filtered = studentSubmissions.filter(s => {
                    const status = s.status?.toLowerCase() || '';
                    if (studentFilter === 'pending') return status.includes('pending');
                    if (studentFilter === 'approved') return status === 'approved';
                    if (studentFilter === 'rejected') return status.includes('rejected');
                    return true;
                });
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="icon">üì≠</span>
                        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(item => {
                const statusClass = getStatusClass(item.status);
                const statusText = getStatusText(item.status);
                const date = item.submittedAt?.toDate?.() || new Date();
                
                return `
                    <div class="submission-card" onclick="showStudentDetail('${item.id}')">
                        <div class="submission-main">
                            <h4>${item.activityName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</h4>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="submission-info">
                            <span>üë§ ${item.studentName || '-'} (${item.studentId || '-'})</span>
                            <span>üìÖ ${item.startDate || '-'}</span>
                            <span>üìä Level ${item.activityLevel || '-'}</span>
                        </div>
                        <div class="submission-date">
                            ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${date.toLocaleDateString('th-TH')} ${date.toLocaleTimeString('th-TH')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // RENDER ORGANIZER ACTIVITIES
        // ============================================
        function renderOrganizerActivities() {
            const container = document.getElementById('organizer-activities-list');
            
            let filtered = organizerActivities;
            if (organizerFilter !== 'all') {
                filtered = organizerActivities.filter(a => {
                    const status = a.status?.toLowerCase() || '';
                    if (organizerFilter === 'pending') return status === 'pending';
                    if (organizerFilter === 'approved') return status === 'approved';
                    if (organizerFilter === 'rejected') return status.includes('rejected');
                    return true;
                });
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="icon">üì≠</span>
                        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(item => {
                const statusClass = getStatusClass(item.status);
                const statusText = getStatusText(item.status);
                
                // Get participant count from different possible fields
                const participantCount = item.studentCount || 
                                        (item.studentIds?.length) || 
                                        (item.studentEmails?.length) || 
                                        (item.participants?.length) || 0;
                
                // Get date from different possible fields
                const activityDate = item.activityDate || item.startDate || '-';
                
                return `
                    <div class="submission-card organizer-card" onclick="showOrganizerDetail('${item.id}')">
                        <div class="submission-main">
                            <h4>${item.activityName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</h4>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="submission-info">
                            <span>üë®‚Äçüíº ${item.organizerName || '-'}</span>
                            <span>üìÖ ${activityDate}</span>
                            <span>üë• ${participantCount} ‡∏Ñ‡∏ô</span>
                        </div>
                        <div class="submission-skills">
                            ${(item.skills || []).slice(0, 5).map(s => `
                                <span class="skill-mini">${s.code} Lv.${s.level}</span>
                            `).join('')}
                            ${(item.skills || []).length > 5 ? `<span class="skill-more">+${item.skills.length - 5}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // SHOW DETAIL MODALS
        // ============================================
        function showStudentDetail(id) {
            const item = studentSubmissions.find(s => s.id === id);
            if (!item) return;
            
            currentItem = item;
            currentType = 'student';
            
            document.getElementById('modal-title').textContent = 'üìù ' + (item.activityName || '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°');
            
            // AI suggested skills
            const aiSkills = item.aiSuggestedSkills || [];
            
            // Reflection section HTML
            const reflectionHtml = (item.role || item.activities || item.learnings) ? `
                <div class="detail-section">
                    <h4>üìù ‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏Ñ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h4>
                    <div class="reflection-display">
                        <div class="reflection-item">
                            <label>üë§ ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÉ‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</label>
                            <p>${item.role || '-'}</p>
                        </div>
                        <div class="reflection-item">
                            <label>‚ö° ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥:</label>
                            <p>${item.activities || '-'}</p>
                        </div>
                        <div class="reflection-item">
                            <label>üí° ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</label>
                            <p>${item.learnings || '-'}</p>
                        </div>
                    </div>
                </div>
            ` : (item.description ? `
                <div class="detail-section">
                    <h4>üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h4>
                    <p class="description-text">${item.description}</p>
                </div>
            ` : '');
            
            // AI Analysis section
            const aiAnalysisHtml = `
                <div class="detail-section">
                    <h4>ü§ñ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏±‡∏Å‡∏©‡∏∞</h4>
                    ${aiSkills.length > 0 ? `
                        <div class="ai-skills-display">
                            ${aiSkills.map(s => {
                                const criteria = CRITERIA_LIST.find(c => c.code === s.code);
                                return `<div class="ai-skill-badge">
                                    <div class="skill-main">
                                        <span class="skill-code">${s.code}</span>
                                        <span class="skill-name">${criteria?.nameTh || ''}</span>
                                        <span class="skill-level">Lv.${s.level}</span>
                                    </div>
                                    ${s.reason ? `<div class="skill-reason">üí° ${s.reason}</div>` : ''}
                                </div>`;
                            }).join('')}
                        </div>
                    ` : '<p style="color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å AI</p>'}
                </div>
            `;
            
            document.getElementById('modal-body').innerHTML = `
                <div class="detail-section">
                    <h4>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <span>${item.studentName || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                            <span>${item.studentId || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>Email</label>
                            <span>${item.studentEmail || '-'}</span>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                            <span>${item.activityName || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î</label>
                            <span>${item.activityOrganizer || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <span>${item.startDate || '-'} - ${item.endDate || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</label>
                            <span>${item.duration || '-'} ${item.durationUnit || ''}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                            <span class="activity-level-badge">Level ${item.activityLevel || '-'}</span>
                        </div>
                    </div>
                </div>
                
                ${reflectionHtml}
                
                ${item.evidenceLink ? `
                <div class="detail-section">
                    <h4>üìé ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</h4>
                    <a href="${item.evidenceLink}" target="_blank" class="evidence-link">
                        üîó ${item.evidenceDescription || '‡∏î‡∏π‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô'}
                    </a>
                </div>
                ` : ''}
                
                ${aiAnalysisHtml}
                
                <div class="detail-section">
                    <h4>üéØ ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Admin ‡∏Å‡∏≥‡∏´‡∏ô‡∏î) <span style="font-size:0.8em;color:#666;">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞</span></h4>
                    <div class="skills-editor" id="skills-editor">
                        ${renderSkillsEditor(item)}
                    </div>
                </div>
                
                <!-- AI Feedback for Research -->
                <div class="detail-section" id="ai-feedback-section" style="background:#f8f9fa;border-radius:10px;padding:15px;margin-top:15px;">
                    <h4 style="margin-bottom:10px;">üìä ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô AI (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏à‡∏±‡∏¢)</h4>
                    <div style="display:flex;gap:15px;flex-wrap:wrap;align-items:center;">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <span style="font-size:0.9em;">AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥:</span>
                            <select id="ai-accuracy-rating" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:0.9em;">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                                <option value="5">5 - ‡πÅ‡∏°‡πà‡∏ô‡∏°‡∏≤‡∏Å (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ)</option>
                                <option value="4">4 - ‡πÅ‡∏°‡πà‡∏ô (‡πÅ‡∏Å‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)</option>
                                <option value="3">3 - ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
                                <option value="2">2 - ‡πÑ‡∏°‡πà‡πÅ‡∏°‡πà‡∏ô</option>
                                <option value="1">1 - ‡∏ú‡∏¥‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            </select>
                        </label>
                        <label style="display:flex;align-items:center;gap:5px;cursor:pointer;">
                            <input type="checkbox" id="ai-modified-checkbox" style="width:18px;height:18px;">
                            <span style="font-size:0.9em;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏à‡∏≤‡∏Å AI</span>
                        </label>
                    </div>
                </div>
            `;
            
            // Footer buttons based on status
            let footerHtml = '';
            if (item.status?.toLowerCase().includes('pending')) {
                footerHtml = `
                    <button class="btn-danger" onclick="rejectItem()">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                    <button class="btn-success" onclick="approveStudentSubmission()">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                `;
            } else {
                footerHtml = `
                    <span class="status-badge ${getStatusClass(item.status)}">${getStatusText(item.status)}</span>
                    <button class="btn-secondary" onclick="closeDetailModal()">‡∏õ‡∏¥‡∏î</button>
                `;
            }
            document.getElementById('modal-footer').innerHTML = footerHtml;
            
            document.getElementById('detail-modal').classList.add('show');
        }

        function showOrganizerDetail(id) {
            const item = organizerActivities.find(a => a.id === id);
            if (!item) return;
            
            currentItem = item;
            currentType = 'organizer';
            
            document.getElementById('modal-title').textContent = 'üë®‚Äçüíº ' + (item.activityName || '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°');
            
            // Get participant count from different possible fields
            const participantCount = item.studentCount || 
                                    (item.studentIds?.length) || 
                                    (item.studentEmails?.length) || 
                                    (item.participants?.length) || 0;
            
            // Get date from different possible fields  
            const activityDate = item.activityDate || item.startDate || '-';
            
            document.getElementById('modal-body').innerHTML = `
                <div class="detail-section">
                    <h4>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î</label>
                            <span>${item.organizerName || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                            <span>${item.department || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>Email</label>
                            <span>${item.organizerEmail || '-'}</span>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                            <span>${item.activityName || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <span>${activityDate}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</label>
                            <span>${item.duration || '-'} ${item.durationUnit || ''}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
                            <span>Level ${item.activityLevel || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</label>
                            <span>${participantCount} ‡∏Ñ‡∏ô</span>
                        </div>
                    </div>
                    <div class="detail-item full">
                        <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                        <p class="description-text">${item.description || '-'}</p>
                    </div>
                    <div class="detail-item full">
                        <label>‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label>
                        <p class="description-text">${item.learningOutcomes || '-'}</p>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>üéØ ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≥‡∏´‡∏ô‡∏î</h4>
                    <div class="skills-display" style="margin-bottom: 15px; padding: 10px; background: rgba(102,126,234,0.1); border-radius: 10px;">
                        ${(item.skills || []).map(s => `
                            <span class="skill-tag" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                ${s.code} ${s.nameTh || ''} <strong>Lv.${s.level}</strong>
                            </span>
                        `).join('') || '<span class="no-skills">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏±‡∏Å‡∏©‡∏∞</span>'}
                    </div>
                </div>
                
                ${item.status?.toLowerCase() === 'pending' ? `
                <div class="detail-section">
                    <h4>‚úèÔ∏è ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Admin ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ) <span style="font-size:0.8em;color:#666;">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞</span></h4>
                    <div class="skills-editor" id="organizer-skills-editor">
                        ${renderOrganizerSkillsEditor(item)}
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</h4>
                    <textarea id="admin-note-to-organizer" rows="3" 
                        placeholder="‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î ‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÅ‡∏•‡πâ‡∏ß, ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞..."
                        style="width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;font-family:inherit;font-size:0.95em;resize:vertical;"
                    >${item.adminNote || ''}</textarea>
                </div>
                ` : (item.adminNote ? `
                <div class="detail-section">
                    <h4>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å Admin</h4>
                    <div style="background:#f8f9fa;padding:15px;border-radius:10px;border-left:4px solid #667eea;">
                        ${item.adminNote}
                    </div>
                </div>
                ` : '')}
                
                ${item.studentIds?.length > 0 ? `
                <div class="detail-section">
                    <h4>üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (${item.studentIds.length} ‡∏Ñ‡∏ô)</h4>
                    <div class="student-ids-list">
                        ${item.studentIds.join(', ')}
                    </div>
                </div>
                ` : ''}
            `;
            
            // Footer buttons based on status
            let footerHtml = '';
            if (item.status?.toLowerCase() === 'pending') {
                footerHtml = `
                    <button class="btn-danger" onclick="rejectItem()">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                    <button class="btn-success" onclick="approveOrganizerActivity()">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                `;
            } else {
                footerHtml = `
                    <span class="status-badge ${getStatusClass(item.status)}">${getStatusText(item.status)}</span>
                    <button class="btn-secondary" onclick="closeDetailModal()">‡∏õ‡∏¥‡∏î</button>
                `;
            }
            document.getElementById('modal-footer').innerHTML = footerHtml;
            
            document.getElementById('detail-modal').classList.add('show');
        }

        function renderSkillsEditor(item) {
            const maxLevel = item.activityLevel || 4;
            const aiSkills = item.aiSuggestedSkills || [];
            
            // Create a map of AI suggested skills for easy lookup
            const aiSkillMap = {};
            aiSkills.forEach(s => { aiSkillMap[s.code] = s.level; });
            
            // Schedule initialization after DOM update
            setTimeout(() => {
                updateAdminSkillCounter();
                initSkillCheckboxListeners();
            }, 100);
            
            return `
                <div class="skill-limit-note" style="background:#fff3cd;padding:10px;border-radius:8px;margin-bottom:15px;font-size:0.9em;">
                    <strong>üìå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞</strong> | ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô Level ${maxLevel}
                    <span id="admin-skill-counter" style="float:right;background:#667eea;color:white;padding:2px 10px;border-radius:15px;">0/3</span>
                </div>
                <div class="skill-editor-list">
                    ${CRITERIA_LIST.map(c => {
                        const isAISuggested = aiSkillMap.hasOwnProperty(c.code);
                        const aiLevel = aiSkillMap[c.code] || 2;
                        return `
                        <div class="skill-editor-item ${isAISuggested ? 'ai-suggested' : ''}" style="${isAISuggested ? 'background:#e8f5e9;border-left:3px solid #27ae60;' : ''}">
                            <label>
                                <input type="checkbox" class="skill-checkbox" data-code="${c.code}" 
                                    ${isAISuggested ? 'checked' : ''} onchange="updateAdminSkillCounter()">
                                <span>${c.code} ${c.nameTh}</span>
                                ${isAISuggested ? '<span style="background:#27ae60;color:white;padding:1px 6px;border-radius:10px;font-size:0.7em;margin-left:5px;">AI</span>' : ''}
                            </label>
                            <select class="skill-level-select" data-code="${c.code}" ${isAISuggested ? '' : 'disabled'}>
                                ${[1,2,3,4].map(l => `
                                    <option value="${l}" ${l > maxLevel ? 'disabled' : ''} ${l === aiLevel && isAISuggested ? 'selected' : ''}>Lv.${l}</option>
                                `).join('')}
                            </select>
                        </div>
                    `}).join('')}
                </div>
            `;
        }
        
        // Render skills editor for organizer activities (uses organizer's skills as default)
        function renderOrganizerSkillsEditor(item) {
            const maxLevel = item.activityLevel || 4;
            const organizerSkills = item.skills || [];
            
            // Create a map of organizer suggested skills for easy lookup
            const organizerSkillMap = {};
            organizerSkills.forEach(s => { organizerSkillMap[s.code] = s.level; });
            
            // Schedule initialization after DOM update
            setTimeout(() => {
                updateOrganizerSkillCounter();
                initOrganizerSkillCheckboxListeners();
            }, 100);
            
            return `
                <div class="skill-limit-note" style="background:#e8f4fd;padding:10px;border-radius:8px;margin-bottom:15px;font-size:0.9em;">
                    <strong>üìå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞</strong> | ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô Level ${maxLevel}
                    <span id="organizer-skill-counter" style="float:right;background:#667eea;color:white;padding:2px 10px;border-radius:15px;">0/3</span>
                </div>
                <div class="skill-editor-list">
                    ${CRITERIA_LIST.map(c => {
                        const isOrganizerSuggested = organizerSkillMap.hasOwnProperty(c.code);
                        const suggestedLevel = organizerSkillMap[c.code] || 2;
                        return `
                        <div class="skill-editor-item organizer-skill-item ${isOrganizerSuggested ? 'organizer-suggested' : ''}" style="${isOrganizerSuggested ? 'background:#e3f2fd;border-left:3px solid #2196f3;' : ''}">
                            <label>
                                <input type="checkbox" class="organizer-skill-checkbox" data-code="${c.code}" 
                                    ${isOrganizerSuggested ? 'checked' : ''} onchange="updateOrganizerSkillCounter()">
                                <span>${c.code} ${c.nameTh}</span>
                                ${isOrganizerSuggested ? '<span style="background:#2196f3;color:white;padding:1px 6px;border-radius:10px;font-size:0.7em;margin-left:5px;">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î</span>' : ''}
                            </label>
                            <select class="organizer-skill-level-select" data-code="${c.code}" ${isOrganizerSuggested ? '' : 'disabled'}>
                                ${[1,2,3,4].map(l => `
                                    <option value="${l}" ${l > maxLevel ? 'disabled' : ''} ${l === suggestedLevel && isOrganizerSuggested ? 'selected' : ''}>Lv.${l}</option>
                                `).join('')}
                            </select>
                        </div>
                    `}).join('')}
                </div>
            `;
        }
        
        function initOrganizerSkillCheckboxListeners() {
            document.querySelectorAll('.organizer-skill-checkbox').forEach(cb => {
                cb.addEventListener('change', function() {
                    const levelSelect = document.querySelector('.organizer-skill-level-select[data-code="' + this.dataset.code + '"]');
                    if (levelSelect) levelSelect.disabled = !this.checked;
                });
            });
        }
        
        function updateOrganizerSkillCounter() {
            const checkedCount = document.querySelectorAll('.organizer-skill-checkbox:checked').length;
            const counter = document.getElementById('organizer-skill-counter');
            if (counter) {
                counter.textContent = checkedCount + '/3';
                counter.style.background = checkedCount > 3 ? '#e74c3c' : (checkedCount === 3 ? '#f39c12' : '#667eea');
            }
            
            // Disable unchecked checkboxes if limit reached
            if (checkedCount >= 3) {
                document.querySelectorAll('.organizer-skill-checkbox:not(:checked)').forEach(cb => {
                    cb.disabled = true;
                    cb.closest('.organizer-skill-item').style.opacity = '0.5';
                });
            } else {
                document.querySelectorAll('.organizer-skill-checkbox').forEach(cb => {
                    cb.disabled = false;
                    cb.closest('.organizer-skill-item').style.opacity = '1';
                });
            }
        }
        
        function initSkillCheckboxListeners() {
            document.querySelectorAll('.skill-checkbox').forEach(cb => {
                cb.addEventListener('change', function() {
                    const levelSelect = document.querySelector('.skill-level-select[data-code="' + this.dataset.code + '"]');
                    if (levelSelect) levelSelect.disabled = !this.checked;
                });
            });
        }
        
        function updateAdminSkillCounter() {
            const checkedCount = document.querySelectorAll('.skill-checkbox:checked').length;
            const counter = document.getElementById('admin-skill-counter');
            if (counter) {
                counter.textContent = checkedCount + '/3';
                counter.style.background = checkedCount > 3 ? '#e74c3c' : (checkedCount === 3 ? '#f39c12' : '#667eea');
            }
            
            // Disable unchecked checkboxes if limit reached
            if (checkedCount >= 3) {
                document.querySelectorAll('.skill-checkbox:not(:checked)').forEach(cb => {
                    cb.disabled = true;
                    cb.closest('.skill-editor-item').style.opacity = '0.5';
                });
            } else {
                document.querySelectorAll('.skill-checkbox').forEach(cb => {
                    cb.disabled = false;
                    cb.closest('.skill-editor-item').style.opacity = '1';
                });
            }
        }

        function closeDetailModal() {
            document.getElementById('detail-modal').classList.remove('show');
            currentItem = null;
            currentType = null;
        }

        // ============================================
        // APPROVE / REJECT FUNCTIONS
        // ============================================
        async function approveStudentSubmission() {
            if (!currentItem) return;
            
            // Get selected skills
            const skills = [];
            document.querySelectorAll('.skill-checkbox:checked').forEach(cb => {
                const code = cb.dataset.code;
                const levelSelect = document.querySelector(`.skill-level-select[data-code="${code}"]`);
                skills.push({
                    code: code,
                    level: parseInt(levelSelect.value)
                });
            });
            
            if (skills.length === 0) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞');
                return;
            }
            
            if (skills.length > 3) {
                alert('‚ö†Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞ | Maximum 3 skills allowed');
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥...');
            
            try {
                // === Research Data Collection ===
                const aiAccuracyRating = document.getElementById('ai-accuracy-rating')?.value || null;
                const adminModified = document.getElementById('ai-modified-checkbox')?.checked || false;
                
                // Compare AI suggestions with approved skills
                const aiSkills = currentItem.aiSuggestedSkills || [];
                const aiSkillCodes = aiSkills.map(s => s.code);
                const approvedSkillCodes = skills.map(s => s.code);
                
                // Calculate skill match
                const matchedSkills = approvedSkillCodes.filter(code => aiSkillCodes.includes(code));
                const skillMatchRate = aiSkillCodes.length > 0 ? (matchedSkills.length / aiSkillCodes.length) : 0;
                
                // Calculate level accuracy
                let levelMatchCount = 0;
                skills.forEach(approved => {
                    const aiSkill = aiSkills.find(ai => ai.code === approved.code);
                    if (aiSkill && aiSkill.level === approved.level) {
                        levelMatchCount++;
                    }
                });
                const levelMatchRate = matchedSkills.length > 0 ? (levelMatchCount / matchedSkills.length) : 0;
                
                // Update submission status with research data
                await db.collection('submissions').doc(currentItem.id).update({
                    status: 'Approved',
                    approvedSkills: skills,
                    reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    
                    // Research logging
                    '_research.adminReview': {
                        aiAccuracyRating: aiAccuracyRating ? parseInt(aiAccuracyRating) : null,
                        adminModifiedSkills: adminModified,
                        skillMatchRate: skillMatchRate,
                        levelMatchRate: levelMatchRate,
                        matchedSkillCount: matchedSkills.length,
                        aiSkillCount: aiSkillCodes.length,
                        approvedSkillCount: approvedSkillCodes.length,
                        reviewTimestamp: new Date().toISOString()
                    }
                });
                
                // Add to participation
                await db.collection('participation').add({
                    studentId: currentItem.studentId,
                    activityName: currentItem.activityName,
                    status: 'Approved',
                    date: currentItem.startDate,
                    source: 'student-submission',
                    addedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Add/update activity
                const existingActivity = await db.collection('activities')
                    .where('name', '==', currentItem.activityName)
                    .get();
                
                if (existingActivity.empty) {
                    // Save with skills array for consistency
                    await db.collection('activities').add({
                        name: currentItem.activityName,
                        level: currentItem.activityLevel,
                        organizer: currentItem.activityOrganizer || '',
                        date: currentItem.startDate || '',
                        description: currentItem.description || '',
                        skills: skills,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    // Update existing activity skills if empty
                    const existingData = existingActivity.docs[0].data();
                    if (!existingData.skills || existingData.skills.length === 0) {
                        await db.collection('activities').doc(existingActivity.docs[0].id).update({
                            skills: skills
                        });
                    }
                }
                
                alert('‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß | Approved successfully');
                closeDetailModal();
                await loadAllData();
                
            } catch (error) {
                console.error('Approve error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        async function approveOrganizerActivity() {
            if (!currentItem) return;
            
            // Get selected skills from editor
            const skills = [];
            document.querySelectorAll('.organizer-skill-checkbox:checked').forEach(cb => {
                const code = cb.dataset.code;
                const levelSelect = document.querySelector(`.organizer-skill-level-select[data-code="${code}"]`);
                const criteria = CRITERIA_LIST.find(c => c.code === code);
                skills.push({
                    code: code,
                    level: parseInt(levelSelect.value),
                    nameTh: criteria?.nameTh || '',
                    nameEn: criteria?.nameEn || ''
                });
            });
            
            if (skills.length === 0) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞');
                return;
            }
            
            if (skills.length > 3) {
                alert('‚ö†Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞ | Maximum 3 skills allowed');
                return;
            }
            
            // Get admin note
            const adminNote = document.getElementById('admin-note-to-organizer')?.value?.trim() || '';
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥...');
            
            try {
                // Update status with approved skills and note
                await db.collection('organizerActivities').doc(currentItem.id).update({
                    status: 'Approved',
                    approvedSkills: skills,
                    originalSkills: currentItem.skills || [], // Keep original for reference
                    adminNote: adminNote,
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Add activity to master with approved skills
                const existingActivity = await db.collection('activities')
                    .where('name', '==', currentItem.activityName)
                    .get();
                
                if (existingActivity.empty) {
                    // Save with approved skills
                    await db.collection('activities').add({
                        name: currentItem.activityName,
                        organizer: currentItem.organizerName || currentItem.department || '',
                        date: currentItem.activityDate || currentItem.startDate || '',
                        level: currentItem.activityLevel || 2,
                        description: currentItem.description || '',
                        skills: skills, // Use approved skills
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    // Update existing activity skills
                    await db.collection('activities').doc(existingActivity.docs[0].id).update({
                        skills: skills
                    });
                }
                
                // Add students to participation with approved skills
                const studentIds = currentItem.studentIds || [];
                for (const studentId of studentIds) {
                    const existing = await db.collection('participation')
                        .where('studentId', '==', studentId)
                        .where('activityName', '==', currentItem.activityName)
                        .get();
                    
                    if (existing.empty) {
                        await db.collection('participation').add({
                            studentId: studentId,
                            activityName: currentItem.activityName,
                            status: 'Approved',
                            date: currentItem.activityDate || currentItem.startDate || '',
                            skills: skills, // Include approved skills
                            source: 'organizer',
                            addedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }
                
                alert('‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß | Approved successfully');
                closeDetailModal();
                await loadAllData();
                
            } catch (error) {
                console.error('Approve error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        function rejectItem() {
            document.getElementById('reject-reason').value = '';
            document.getElementById('reject-modal').classList.add('show');
        }

        function closeRejectModal() {
            document.getElementById('reject-modal').classList.remove('show');
        }

        async function confirmReject() {
            const reason = document.getElementById('reject-reason').value.trim();
            
            if (!reason) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•');
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò...');
            
            try {
                const collection = currentType === 'student' ? 'submissions' : 'organizerActivities';
                
                await db.collection(collection).doc(currentItem.id).update({
                    status: 'Rejected',
                    rejectReason: reason,
                    reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                closeRejectModal();
                closeDetailModal();
                await loadAllData();
                
            } catch (error) {
                console.error('Reject error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        // ============================================
        // TRANSFER TO MASTER
        // ============================================
        function updateTransferStats() {
            const approvedSubmissions = studentSubmissions.filter(s => 
                s.status === 'Approved' && !s.transferred
            );
            const approvedActivities = organizerActivities.filter(a => 
                a.status === 'Approved' && !a.transferred
            );
            
            const total = approvedSubmissions.length + approvedActivities.length;
            document.getElementById('transfer-ready').textContent = total;
            
            const doneSubmissions = studentSubmissions.filter(s => s.transferred).length;
            const doneActivities = organizerActivities.filter(a => a.transferred).length;
            document.getElementById('transfer-done').textContent = doneSubmissions + doneActivities;
        }

        async function transferToMaster() {
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            const logEl = document.getElementById('transfer-log');
            logEl.innerHTML = '';
            
            let successCount = 0;
            
            try {
                // Transfer approved student submissions
                const approvedSubmissions = studentSubmissions.filter(s => 
                    s.status === 'Approved' && !s.transferred
                );
                
                for (const sub of approvedSubmissions) {
                    await db.collection('submissions').doc(sub.id).update({
                        transferred: true,
                        transferredAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    logEl.innerHTML += `<div class="log-success">‚úÖ ${sub.activityName} (${sub.studentId})</div>`;
                    successCount++;
                }
                
                // Transfer approved organizer activities
                const approvedActivities = organizerActivities.filter(a => 
                    a.status === 'Approved' && !a.transferred
                );
                
                for (const act of approvedActivities) {
                    await db.collection('organizerActivities').doc(act.id).update({
                        transferred: true,
                        transferredAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    logEl.innerHTML += `<div class="log-success">‚úÖ ${act.activityName} (${act.studentCount} ‡∏Ñ‡∏ô)</div>`;
                    successCount++;
                }
                
                logEl.innerHTML += `<div class="log-complete">üéâ ‡πÇ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`;
                
                await loadAllData();
                
            } catch (error) {
                console.error('Transfer error:', error);
                logEl.innerHTML += `<div class="log-error">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</div>`;
            }
            
            showLoading(false);
        }

        // ============================================
        // HELPERS
        // ============================================
        function getStatusClass(status) {
            if (!status) return 'draft';
            const s = status.toLowerCase();
            if (s === 'approved') return 'approved';
            if (s.includes('rejected')) return 'rejected';
            if (s.includes('pending')) return 'pending';
            return 'draft';
        }

        function getStatusText(status) {
            if (!status) return 'üìù ‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á';
            const s = status.toLowerCase();
            if (s === 'approved') return '‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß';
            if (s.includes('rejected')) return '‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
            if (s.includes('pending')) return '‚è≥ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
            return 'üìù ‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á';
        }

        function showLoading(show, text = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') {
            const overlay = document.getElementById('loading-overlay');
            document.getElementById('loading-text').textContent = text;
            if (show) {
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }
        }

        // ============================================
        // ORGANIZERS MANAGEMENT
        // ============================================
        let allOrganizers = [];

        async function loadOrganizers() {
            const container = document.getElementById('organizers-list');
            
            try {
                const query = await db.collection('organizers').orderBy('email').get();
                
                allOrganizers = query.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Update stats
                document.getElementById('total-organizers').textContent = allOrganizers.length;
                document.getElementById('active-organizers').textContent = 
                    allOrganizers.filter(o => o.password).length;
                
                if (allOrganizers.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <span class="icon">üë•</span>
                            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                            <button class="btn-add-organizer" onclick="openAddOrganizerModal()">
                                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å
                            </button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = allOrganizers.map(org => `
                    <div class="organizer-card">
                        <div class="org-avatar">${(org.name || org.email).charAt(0).toUpperCase()}</div>
                        <div class="org-info">
                            <div class="org-name">${org.name || '-'}</div>
                            <div class="org-email">${org.email}</div>
                            ${org.department ? `<div class="org-dept">üè¢ ${org.department}</div>` : ''}
                            ${org.phone ? `<div class="org-phone">üìû ${org.phone}</div>` : ''}
                        </div>
                        <div class="org-status">
                            ${org.password 
                                ? '<span class="status-badge active">‚úÖ ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>' 
                                : '<span class="status-badge pending">‚è≥ ‡∏£‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>'}
                        </div>
                        <div class="org-actions">
                            ${org.password ? `
                                <button class="btn-small btn-reset" onclick="resetOrganizerPassword('${org.id}', '${org.email}')">
                                    üîÑ Reset Password
                                </button>
                            ` : ''}
                            <button class="btn-small btn-delete" onclick="deleteOrganizer('${org.id}', '${org.email}')">
                                üóëÔ∏è ‡∏•‡∏ö
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Load organizers error:', error);
                container.innerHTML = `<div class="error-state">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</div>`;
            }
        }

        function openAddOrganizerModal() {
            document.getElementById('new-org-email').value = '';
            document.getElementById('new-org-name').value = '';
            document.getElementById('new-org-department').value = '';
            document.getElementById('new-org-phone').value = '';
            document.getElementById('add-organizer-modal').classList.add('show');
        }

        function closeAddOrganizerModal() {
            document.getElementById('add-organizer-modal').classList.remove('show');
        }

        async function addNewOrganizer() {
            const email = document.getElementById('new-org-email').value.trim().toLowerCase();
            const name = document.getElementById('new-org-name').value.trim();
            const department = document.getElementById('new-org-department').value.trim();
            const phone = document.getElementById('new-org-phone').value.trim();
            
            if (!email || !email.includes('@')) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Email ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }
            
            if (!name) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•');
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î...');
            
            try {
                // Check if email already exists
                const existing = await db.collection('organizers')
                    .where('email', '==', email)
                    .get();
                
                if (!existing.empty) {
                    alert('‚ö†Ô∏è Email ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
                    showLoading(false);
                    return;
                }
                
                // Add new organizer
                await db.collection('organizers').add({
                    email: email,
                    name: name,
                    department: department,
                    phone: phone,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: 'admin'
                });
                
                alert('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                closeAddOrganizerModal();
                await loadOrganizers();
                
            } catch (error) {
                console.error('Add organizer error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        async function resetOrganizerPassword(id, email) {
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Reset Password ‡∏Ç‡∏≠‡∏á ${email}?\n\n‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ`)) {
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á Reset Password...');
            
            try {
                await db.collection('organizers').doc(id).update({
                    password: firebase.firestore.FieldValue.delete()
                });
                
                alert('‚úÖ Reset Password ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                await loadOrganizers();
                
            } catch (error) {
                console.error('Reset password error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        async function deleteOrganizer(id, email) {
            if (!confirm(`‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î ${email}?\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`)) {
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î...');
            
            try {
                await db.collection('organizers').doc(id).delete();
                
                alert('‚úÖ ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                await loadOrganizers();
                
            } catch (error) {
                console.error('Delete organizer error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        // ============================================
        // CSV EXPORT FUNCTIONS
        // ============================================
        function convertToCSV(data, headers) {
            if (!data || data.length === 0) return '';
            
            const csvHeaders = headers.join(',');
            const csvRows = data.map(row => {
                return headers.map(header => {
                    let value = row[header] || '';
                    // Handle arrays
                    if (Array.isArray(value)) {
                        value = JSON.stringify(value);
                    }
                    // Handle objects
                    if (typeof value === 'object' && value !== null) {
                        value = JSON.stringify(value);
                    }
                    // Escape quotes and wrap in quotes if contains comma
                    value = String(value).replace(/"/g, '""');
                    if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                        value = `"${value}"`;
                    }
                    return value;
                }).join(',');
            });
            
            return [csvHeaders, ...csvRows].join('\n');
        }

        function downloadCSV(csvContent, filename) {
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function exportStudentsCSV() {
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤...');
            
            try {
                const snapshot = await db.collection('students').get();
                const data = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    password: '***' // Hide password
                }));
                
                const headers = ['studentId', 'name', 'email', 'department', 'year', 'createdAt'];
                const csv = convertToCSV(data, headers);
                downloadCSV(csv, `students_${new Date().toISOString().slice(0,10)}.csv`);
                
                alert(`‚úÖ Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        async function exportActivitiesCSV() {
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...');
            
            try {
                const snapshot = await db.collection('activities').get();
                const data = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                const headers = ['name', 'organizer', 'date', 'level', 'status', 'description'];
                const csv = convertToCSV(data, headers);
                downloadCSV(csv, `activities_${new Date().toISOString().slice(0,10)}.csv`);
                
                alert(`‚úÖ Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        async function exportParticipationCSV() {
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°...');
            
            try {
                const snapshot = await db.collection('participation').get();
                const data = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                const headers = ['studentId', 'activityName', 'date', 'status', 'skills'];
                const csv = convertToCSV(data, headers);
                downloadCSV(csv, `participation_${new Date().toISOString().slice(0,10)}.csv`);
                
                alert(`‚úÖ Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        async function exportSubmissionsCSV() {
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...');
            
            try {
                const snapshot = await db.collection('submissions').get();
                const data = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                const headers = ['studentId', 'studentName', 'studentEmail', 'activityName', 'activityOrganizer', 'startDate', 'endDate', 'activityLevel', 'status', 'submittedAt'];
                const csv = convertToCSV(data, headers);
                downloadCSV(csv, `submissions_${new Date().toISOString().slice(0,10)}.csv`);
                
                alert(`‚úÖ Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        async function exportOrganizerActivitiesCSV() {
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î...');
            
            try {
                const snapshot = await db.collection('organizerActivities').get();
                const data = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                const headers = ['activityName', 'organizerName', 'organizerEmail', 'department', 'activityDate', 'status', 'studentIds', 'skills'];
                const csv = convertToCSV(data, headers);
                downloadCSV(csv, `organizer_activities_${new Date().toISOString().slice(0,10)}.csv`);
                
                alert(`‚úÖ Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        async function exportOrganizersCSV() {
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î...');
            
            try {
                const snapshot = await db.collection('organizers').get();
                const data = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    password: '***' // Hide password
                }));
                
                const headers = ['email', 'name', 'department', 'phone', 'createdAt'];
                const csv = convertToCSV(data, headers);
                downloadCSV(csv, `organizers_${new Date().toISOString().slice(0,10)}.csv`);
                
                alert(`‚úÖ Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        async function exportAllCSV() {
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...');
            
            try {
                // Export each collection
                await exportStudentsCSV();
                await exportActivitiesCSV();
                await exportParticipationCSV();
                await exportSubmissionsCSV();
                await exportOrganizerActivitiesCSV();
                await exportOrganizersCSV();
                
                alert('‚úÖ Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            } catch (error) {
                console.error('Export all error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        // ============================================
        // DATA REPAIR FUNCTIONS
        // ============================================
        async function scanActivitiesWithoutSkills() {
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...');
            const resultEl = document.getElementById('repair-result');
            
            try {
                const activitiesSnapshot = await db.collection('activities').get();
                const withSkills = [];
                const withoutSkills = [];
                
                activitiesSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const hasSkillsArray = data.skills && Array.isArray(data.skills) && data.skills.length > 0;
                    
                    // Check for old format (direct code keys like "1.1": 2)
                    let hasOldFormat = false;
                    CRITERIA_LIST.forEach(c => {
                        if (data[c.code] || data[c.code.replace('.', '_')]) {
                            hasOldFormat = true;
                        }
                    });
                    
                    if (hasSkillsArray || hasOldFormat) {
                        withSkills.push({ id: doc.id, name: data.name, hasArray: hasSkillsArray, hasOld: hasOldFormat });
                    } else {
                        withoutSkills.push({ id: doc.id, name: data.name });
                    }
                });
                
                resultEl.innerHTML = `
                    <h4>üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö | Scan Results</h4>
                    <div class="scan-stats">
                        <span class="scan-good">‚úÖ ‡∏°‡∏µ Skills: ${withSkills.length} ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</span>
                        <span class="scan-bad">‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ Skills: ${withoutSkills.length} ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</span>
                    </div>
                    ${withoutSkills.length > 0 ? `
                        <div class="scan-list">
                            <h5>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ Skills:</h5>
                            <ul>
                                ${withoutSkills.map(a => `
                                    <li>
                                        <span>${a.name}</span>
                                        <button class="btn-mini" onclick="editActivitySkills('${a.id}', '${a.name.replace(/'/g, "\\'")}')">
                                            ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                        </button>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : '<p class="scan-success">‚úÖ ‡∏ó‡∏∏‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏°‡∏µ Skills ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!</p>'}
                `;
                resultEl.style.display = 'block';
                
            } catch (error) {
                console.error('Scan error:', error);
                resultEl.innerHTML = `<p class="scan-error">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</p>`;
                resultEl.style.display = 'block';
            }
            
            showLoading(false);
        }

        let editingActivityId = null;

        function showAddSkillsToActivity() {
            const activityName = prompt('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° Skills:\nEnter activity name to add skills:');
            if (!activityName) return;
            
            // Search for activity
            db.collection('activities').where('name', '==', activityName).get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ä‡∏∑‡πà‡∏≠: ' + activityName);
                        return;
                    }
                    const doc = snapshot.docs[0];
                    editActivitySkills(doc.id, activityName);
                })
                .catch(err => alert('Error: ' + err.message));
        }

        function editActivitySkills(activityId, activityName) {
            editingActivityId = activityId;
            
            const skillsHtml = CRITERIA_LIST.map(c => `
                <label class="skill-checkbox-item">
                    <input type="checkbox" class="repair-skill-cb" data-code="${c.code}">
                    <span>${c.code} - ${c.name}</span>
                    <select class="repair-skill-level" data-code="${c.code}">
                        <option value="1">Lv.1</option>
                        <option value="2" selected>Lv.2</option>
                        <option value="3">Lv.3</option>
                        <option value="4">Lv.4</option>
                    </select>
                </label>
            `).join('');
            
            const resultEl = document.getElementById('repair-result');
            resultEl.innerHTML = `
                <h4>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Skills: ${activityName}</h4>
                <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°:</p>
                <div class="skills-edit-grid">
                    ${skillsHtml}
                </div>
                <div class="repair-buttons">
                    <button class="btn-repair" onclick="saveActivitySkills('${activityId}')">
                        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å | Save
                    </button>
                    <button class="btn-repair secondary" onclick="cancelEditSkills()">
                        ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å | Cancel
                    </button>
                </div>
            `;
            resultEl.style.display = 'block';
        }

        async function saveActivitySkills(activityId) {
            const skills = [];
            
            document.querySelectorAll('.repair-skill-cb:checked').forEach(cb => {
                const code = cb.dataset.code;
                const levelSelect = document.querySelector(`.repair-skill-level[data-code="${code}"]`);
                const level = parseInt(levelSelect.value);
                skills.push({ code, level });
            });
            
            if (skills.length === 0) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞ | Please select at least 1 skill');
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
            
            try {
                await db.collection('activities').doc(activityId).update({
                    skills: skills,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏û‡∏¥‡πà‡∏° ${skills.length} ‡∏ó‡∏±‡∏Å‡∏©‡∏∞`);
                cancelEditSkills();
                scanActivitiesWithoutSkills(); // Refresh scan
                
            } catch (error) {
                console.error('Save error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        function cancelEditSkills() {
            editingActivityId = null;
            document.getElementById('repair-result').style.display = 'none';
        }

        // Enable skill level select when checkbox is checked
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('skill-checkbox')) {
                const code = e.target.dataset.code;
                const levelSelect = document.querySelector(`.skill-level-select[data-code="${code}"]`);
                levelSelect.disabled = !e.target.checked;
            }
        });

        // ============================================
        // ACTIVITY MANAGEMENT FUNCTIONS
        // ============================================
        let allActivitiesCache = [];

        async function loadAllActivitiesAdmin() {
            const list = document.getElementById('activities-manage-list');
            if (!list) return;
            
            list.innerHTML = '<tr><td colspan="6" class="loading-cell">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... | Loading...</td></tr>';
            
            try {
                const snapshot = await db.collection('activities').get();
                allActivitiesCache = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    allActivitiesCache.push({ id: doc.id, ...data });
                });
                
                // Sort by name
                allActivitiesCache.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                
                // Stats are updated inside renderActivitiesAdminList
                renderActivitiesAdminList(allActivitiesCache);
                
            } catch (error) {
                console.error('Load activities error:', error);
                list.innerHTML = `<tr><td colspan="6" class="empty-cell">‚ùå Error: ${error.message}</td></tr>`;
            }
        }

        function searchActivitiesAdmin() {
            const searchTerm = document.getElementById('activity-search-input').value.trim().toLowerCase();
            if (!searchTerm) {
                loadAllActivitiesAdmin();
                return;
            }
            
            const filtered = allActivitiesCache.filter(a => 
                (a.name || '').toLowerCase().includes(searchTerm) ||
                (a.organizer || '').toLowerCase().includes(searchTerm)
            );
            
            renderActivitiesAdminList(filtered);
        }

        // extractSkillsAdmin is defined earlier around line 858
        // For activity management list, we use a separate function that shows all skills
        function extractAllSkillsAdmin(activity) {
            let skills = [];
            
            // Format 1: Check for skills array
            if (activity.skills && Array.isArray(activity.skills) && activity.skills.length > 0) {
                skills = [...activity.skills];
            } else if (typeof CRITERIA_LIST !== 'undefined') {
                // Format 2: Check for direct code format (e.g., "1.1": 2 or "1_1": 2)
                CRITERIA_LIST.forEach(criteria => {
                    const value = activity[criteria.code] || activity[criteria.code.replace('.', '_')];
                    if (value && value > 0) {
                        skills.push({
                            code: criteria.code,
                            level: parseInt(value)
                        });
                    }
                });
            }
            
            // Return ALL skills for admin view (display will show warning if > 3)
            return skills;
        }

        function renderActivitiesAdminList(activities) {
            const list = document.getElementById('activities-manage-list');
            
            if (!list) {
                console.warn('activities-manage-list element not found');
                return;
            }
            
            if (activities.length === 0) {
                list.innerHTML = `<tr><td colspan="6" class="empty-cell">üì≠ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | No activities found</td></tr>`;
                return;
            }
            
            // Count activities with/without skills
            let withSkills = 0;
            
            const html = activities.map((act, index) => {
                const skills = extractAllSkillsAdmin(act);
                const hasSkills = skills.length > 0;
                
                if (hasSkills) withSkills++;
                
                // Warning if more than 3 skills
                const overLimitWarning = skills.length > 3 
                    ? `<span class="skill-warning">‚ö†Ô∏è ${skills.length}</span>` 
                    : '';
                
                const skillsHtml = hasSkills 
                    ? skills.slice(0, 4).map(s => `<span class="skill-badge">${s.code}:${s.level}</span>`).join('') + 
                      (skills.length > 4 ? `<span class="skill-more">+${skills.length - 4}</span>` : '') +
                      overLimitWarning
                    : '<span class="no-skill">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ</span>';
                
                const rowClass = hasSkills ? '' : 'no-skills-row';
                
                return `
                    <tr class="${rowClass}">
                        <td class="activity-name-cell">
                            <span class="row-num">${index + 1}.</span>
                            ${act.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}
                        </td>
                        <td>${act.organizer || '-'}</td>
                        <td>${act.date || '-'}</td>
                        <td class="center">${act.level || '-'}</td>
                        <td class="skills-cell">${skillsHtml}</td>
                        <td class="actions-cell">
                            <button class="btn-table-edit" onclick="editActivityAdmin('${act.id}')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
                            <button class="btn-table-delete" onclick="deleteActivityAdmin('${act.id}', '${(act.name || '').replace(/'/g, "\\'")}')" title="‡∏•‡∏ö">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Update stats (with null check)
            const totalEl = document.getElementById('total-activities-count');
            const skillsEl = document.getElementById('with-skills-count');
            if (totalEl) totalEl.textContent = activities.length;
            if (skillsEl) skillsEl.textContent = withSkills;
            
            list.innerHTML = html;
        }

        function openAddActivityModal() {
            document.getElementById('activity-modal-title').textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Add Activity';
            document.getElementById('edit-activity-id').value = '';
            document.getElementById('edit-activity-original-name').value = '';
            document.getElementById('act-name').value = '';
            document.getElementById('act-organizer').value = '';
            document.getElementById('act-date').value = '';
            document.getElementById('act-description').value = '';
            
            // Populate skills grid
            const grid = document.getElementById('activity-skills-grid');
            grid.innerHTML = CRITERIA_LIST.map(c => `
                <div style="display:flex; align-items:center; gap:5px; background:white; padding:8px; border-radius:6px;">
                    <input type="checkbox" class="act-skill-cb" data-code="${c.code}" id="act-skill-${c.code}">
                    <label for="act-skill-${c.code}" style="flex:1; font-size:0.85em; cursor:pointer;">
                        <strong>${c.code}</strong> ${c.nameTh}
                    </label>
                    <select class="act-skill-level" data-code="${c.code}" disabled style="width:60px; padding:3px;">
                        <option value="1">1</option>
                        <option value="2" selected>2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                </div>
            `).join('');
            
            // Add event listeners
            grid.querySelectorAll('.act-skill-cb').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const code = e.target.dataset.code;
                    const levelSelect = grid.querySelector(`.act-skill-level[data-code="${code}"]`);
                    levelSelect.disabled = !e.target.checked;
                });
            });
            
            document.getElementById('activity-modal').classList.add('show');
        }

        async function editActivityAdmin(activityId) {
            const activity = allActivitiesCache.find(a => a.id === activityId);
            if (!activity) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°');
                return;
            }
            
            document.getElementById('activity-modal-title').textContent = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Edit Activity';
            document.getElementById('edit-activity-id').value = activityId;
            document.getElementById('edit-activity-original-name').value = activity.name || '';
            document.getElementById('act-name').value = activity.name || '';
            document.getElementById('act-organizer').value = activity.organizer || '';
            document.getElementById('act-date').value = activity.date || '';
            document.getElementById('act-description').value = activity.description || '';
            
            // Populate skills grid
            const grid = document.getElementById('activity-skills-grid');
            grid.innerHTML = CRITERIA_LIST.map(c => {
                const existingSkill = activity.skills?.find(s => s.code === c.code);
                const checked = existingSkill ? 'checked' : '';
                const level = existingSkill?.level || 2;
                const disabled = existingSkill ? '' : 'disabled';
                
                return `
                    <div style="display:flex; align-items:center; gap:5px; background:${existingSkill ? '#e8f5e9' : 'white'}; padding:8px; border-radius:6px;">
                        <input type="checkbox" class="act-skill-cb" data-code="${c.code}" id="act-skill-${c.code}" ${checked}>
                        <label for="act-skill-${c.code}" style="flex:1; font-size:0.85em; cursor:pointer;">
                            <strong>${c.code}</strong> ${c.nameTh}
                        </label>
                        <select class="act-skill-level" data-code="${c.code}" ${disabled} style="width:60px; padding:3px;">
                            <option value="1" ${level === 1 ? 'selected' : ''}>1</option>
                            <option value="2" ${level === 2 ? 'selected' : ''}>2</option>
                            <option value="3" ${level === 3 ? 'selected' : ''}>3</option>
                            <option value="4" ${level === 4 ? 'selected' : ''}>4</option>
                        </select>
                    </div>
                `;
            }).join('');
            
            // Add event listeners
            grid.querySelectorAll('.act-skill-cb').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const code = e.target.dataset.code;
                    const levelSelect = grid.querySelector(`.act-skill-level[data-code="${code}"]`);
                    levelSelect.disabled = !e.target.checked;
                    e.target.closest('div').style.background = e.target.checked ? '#e8f5e9' : 'white';
                });
            });
            
            document.getElementById('activity-modal').classList.add('show');
        }

        function closeActivityModal() {
            document.getElementById('activity-modal').classList.remove('show');
        }

        async function saveActivityAdmin() {
            const activityId = document.getElementById('edit-activity-id').value;
            const originalName = document.getElementById('edit-activity-original-name').value;
            const name = document.getElementById('act-name').value.trim();
            const organizer = document.getElementById('act-organizer').value.trim();
            const date = document.getElementById('act-date').value;
            const description = document.getElementById('act-description').value.trim();
            
            if (!name) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Please enter activity name');
                return;
            }
            
            // Collect skills
            const skills = [];
            document.querySelectorAll('.act-skill-cb:checked').forEach(cb => {
                const code = cb.dataset.code;
                const levelSelect = document.querySelector(`.act-skill-level[data-code="${code}"]`);
                skills.push({ 
                    code, 
                    level: parseInt(levelSelect.value),
                    nameTh: CRITERIA_LIST.find(c => c.code === code)?.nameTh || ''
                });
            });
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å... | Saving...');
            
            try {
                const activityData = {
                    name,
                    organizer,
                    date,
                    description,
                    skills,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                let syncCount = 0;
                
                if (activityId) {
                    // Update existing activity
                    await db.collection('activities').doc(activityId).update(activityData);
                    
                    // Sync participation records if name or skills changed
                    const nameToSearch = originalName || name;
                    const participationQuery = await db.collection('participation')
                        .where('activityName', '==', nameToSearch)
                        .get();
                    
                    if (!participationQuery.empty) {
                        const batch = db.batch();
                        participationQuery.forEach(doc => {
                            batch.update(doc.ref, {
                                activityName: name,
                                skills: skills,
                                date: date,
                                syncedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            syncCount++;
                        });
                        await batch.commit();
                    }
                    
                    let msg = '‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ | Activity updated';
                    if (syncCount > 0) {
                        msg += `\n\nüìä ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï ${syncCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô participation`;
                    }
                    alert(msg);
                } else {
                    // Create new
                    activityData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('activities').add(activityData);
                    alert('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ | Activity added');
                }
                
                closeActivityModal();
                loadAllActivitiesAdmin();
                
            } catch (error) {
                console.error('Save activity error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        async function deleteActivityAdmin(activityId, activityName) {
            if (!confirm(`‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° "${activityName}"?\nConfirm delete this activity?`)) {
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö... | Deleting...');
            
            try {
                await db.collection('activities').doc(activityId).delete();
                alert('‚úÖ ‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ | Activity deleted');
                loadAllActivitiesAdmin();
            } catch (error) {
                console.error('Delete error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        // ============================================
        // ADMIN LOGIN / LOGOUT
        // ============================================
        let currentAdmin = null;

        async function loginAdmin() {
            const email = document.getElementById('admin-email').value.trim().toLowerCase();
            const password = document.getElementById('admin-password').value.trim();
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = '';
            
            if (!email || !email.includes('@')) { 
                errorEl.textContent = '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Email ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á | Please enter valid Email'; 
                return; 
            }
            if (!password || password.length < 4) { 
                errorEl.textContent = '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)'; 
                return; 
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö... | Logging in...');
            
            try {
                const q = await db.collection('admins').where('email', '==', email).limit(1).get();
                
                if (q.empty) {
                    // Email not found - not allowed to self-register
                    errorEl.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Email ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö | Email not found. ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå';
                    showLoading(false);
                    return;
                }
                
                const doc = q.docs[0];
                const data = doc.data();
                
                if (!data.password) {
                    // First time login - set password
                    await db.collection('admins').doc(doc.id).update({ 
                        password,
                        firstLoginAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    data.password = password;
                } else if (password !== data.password) {
                    errorEl.textContent = '‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á | Incorrect password';
                    showLoading(false);
                    return;
                }
                
                currentAdmin = { id: doc.id, email, name: data.name || email.split('@')[0], ...data };
                
                // Store session
                sessionStorage.setItem('adminSession', JSON.stringify(currentAdmin));
                
                // Update UI
                document.getElementById('admin-avatar').textContent = currentAdmin.name.charAt(0).toUpperCase();
                document.getElementById('admin-display-name').textContent = currentAdmin.name;
                document.getElementById('admin-display-email').textContent = email;
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('main-section').style.display = 'block';
                
                // Load data
                await loadAllData();
                
            } catch (e) { 
                errorEl.textContent = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î | Error: ' + e.message; 
            }
            showLoading(false);
        }

        function logoutAdmin() {
            currentAdmin = null;
            sessionStorage.removeItem('adminSession');
            document.getElementById('login-section').style.display = 'flex';
            document.getElementById('main-section').style.display = 'none';
            document.getElementById('admin-email').value = '';
            document.getElementById('admin-password').value = '';
        }

        // Check session on load
        async function checkAdminSession() {
            const session = sessionStorage.getItem('adminSession');
            if (session) {
                try {
                    currentAdmin = JSON.parse(session);
                    document.getElementById('admin-avatar').textContent = currentAdmin.name?.charAt(0).toUpperCase() || 'A';
                    document.getElementById('admin-display-name').textContent = currentAdmin.name || 'Admin';
                    document.getElementById('admin-display-email').textContent = currentAdmin.email;
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('main-section').style.display = 'block';
                    await loadAllData();
                } catch (e) {
                    sessionStorage.removeItem('adminSession');
                }
            }
        }

        // ============================================
        // ADMIN MANAGEMENT
        // ============================================
        
        async function loadAdminList() {
            const container = document.getElementById('admin-list-container');
            container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... | Loading...</div>';
            
            try {
                const snapshot = await db.collection('admins').orderBy('createdAt', 'desc').get();
                
                if (snapshot.empty) {
                    container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | No data</div>';
                    return;
                }
                
                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += `<thead>
                    <tr style="background: #f5f5f5;">
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Email</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">‡∏ä‡∏∑‡πà‡∏≠ | Name</th>
                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ | Status</th>
                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ | Action</th>
                    </tr>
                </thead><tbody>`;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const hasPassword = !!data.password;
                    const isCurrentAdmin = currentAdmin && data.email === currentAdmin.email;
                    
                    const statusBadge = hasPassword 
                        ? '<span style="background: #e8f5e9; color: #27ae60; padding: 4px 10px; border-radius: 15px; font-size: 0.85em;">‚úÖ Active</span>'
                        : '<span style="background: #fff3e0; color: #f57c00; padding: 4px 10px; border-radius: 15px; font-size: 0.85em;">‚è≥ ‡∏£‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</span>';
                    
                    const deleteBtn = isCurrentAdmin 
                        ? '<span style="color: #999; font-size: 0.85em;">(‡∏Ñ‡∏∏‡∏ì)</span>'
                        : `<button onclick="deleteAdmin('${doc.id}', '${data.email}')" style="padding: 6px 12px; background: #ffebee; color: #e53935; border: 1px solid #ef9a9a; border-radius: 6px; cursor: pointer; font-size: 0.85em;">üóëÔ∏è ‡∏•‡∏ö</button>`;
                    
                    html += `<tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 12px;">${data.email}</td>
                        <td style="padding: 12px;">${data.name || '-'}</td>
                        <td style="padding: 12px; text-align: center;">${statusBadge}</td>
                        <td style="padding: 12px; text-align: center;">${deleteBtn}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
            } catch (e) {
                container.innerHTML = `<div style="text-align: center; color: #e53935; padding: 20px;">‚ùå Error: ${e.message}</div>`;
            }
        }
        
        async function addNewAdmin() {
            const emailInput = document.getElementById('new-admin-email');
            const nameInput = document.getElementById('new-admin-name');
            const email = emailInput.value.trim().toLowerCase();
            const name = nameInput.value.trim();
            
            if (!email || !email.includes('@')) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Email ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á | Please enter valid email');
                emailInput.focus();
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° Admin... | Adding admin...');
            
            try {
                // Check if email already exists
                const existing = await db.collection('admins').where('email', '==', email).limit(1).get();
                
                if (!existing.empty) {
                    alert('‚ö†Ô∏è Email ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß | This email already exists');
                    showLoading(false);
                    return;
                }
                
                // Add new admin (without password)
                await db.collection('admins').add({
                    email: email,
                    name: name || email.split('@')[0],
                    password: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    addedBy: currentAdmin?.email || 'unknown'
                });
                
                alert('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Admin ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n' + email + ' ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß');
                
                // Clear inputs
                emailInput.value = '';
                nameInput.value = '';
                
                // Reload list
                await loadAdminList();
                
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
            
            showLoading(false);
        }
        
        async function deleteAdmin(docId, email) {
            if (!confirm(`‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö Admin?\n\nEmail: ${email}\n\n‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ!`)) {
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö... | Deleting...');
            
            try {
                await db.collection('admins').doc(docId).delete();
                alert('‚úÖ ‡∏•‡∏ö Admin ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à | Admin deleted');
                await loadAdminList();
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
            
            showLoading(false);
        }
        
        async function resetAdminPassword(docId, email) {
            if (!confirm(`üîÑ Reset Password ‡∏Ç‡∏≠‡∏á ${email}?\n\nAdmin ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ`)) {
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á Reset... | Resetting...');
            
            try {
                await db.collection('admins').doc(docId).update({
                    password: null
                });
                alert('‚úÖ Reset Password ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                await loadAdminList();
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
            
            showLoading(false);
        }

        // ============================================
        // EDIT / DELETE STUDENT ACTIVITIES
        // ============================================
        
        function openEditActivityModal(actId, source, actName, status, skillsJson, studentId) {
            document.getElementById('edit-activity-id').value = actId;
            document.getElementById('edit-activity-source').value = source;
            document.getElementById('edit-student-id').value = studentId;
            document.getElementById('edit-activity-name').value = actName;
            document.getElementById('edit-activity-status').value = status || 'Approved';
            
            // Parse skills
            let skills = [];
            try {
                skills = JSON.parse(skillsJson.replace(/&quot;/g, '"'));
            } catch (e) { skills = []; }
            
            // Render skills checkboxes
            const skillsList = document.getElementById('edit-skills-list');
            skillsList.innerHTML = CRITERIA_LIST.map(c => {
                const existingSkill = skills.find(s => s.code === c.code);
                const isChecked = !!existingSkill;
                const level = existingSkill?.level || 2;
                
                return `
                    <div class="edit-skill-item">
                        <input type="checkbox" class="edit-skill-cb" data-code="${c.code}" 
                            ${isChecked ? 'checked' : ''} onchange="updateEditSkillCounter()">
                        <span style="flex:1;">${c.code} ${c.nameTh}</span>
                        <select class="edit-skill-level" data-code="${c.code}" ${isChecked ? '' : 'disabled'}>
                            <option value="1" ${level===1?'selected':''}>Lv.1</option>
                            <option value="2" ${level===2?'selected':''}>Lv.2</option>
                            <option value="3" ${level===3?'selected':''}>Lv.3</option>
                            <option value="4" ${level===4?'selected':''}>Lv.4</option>
                        </select>
                    </div>
                `;
            }).join('');
            
            // Add checkbox change listeners
            document.querySelectorAll('.edit-skill-cb').forEach(cb => {
                cb.addEventListener('change', function() {
                    const levelSelect = document.querySelector(`.edit-skill-level[data-code="${this.dataset.code}"]`);
                    levelSelect.disabled = !this.checked;
                });
            });
            
            document.getElementById('edit-student-activity-modal').classList.add('show');
        }
        
        function closeEditActivityModal() {
            document.getElementById('edit-student-activity-modal').classList.remove('show');
        }
        
        function updateEditSkillCounter() {
            const checked = document.querySelectorAll('.edit-skill-cb:checked').length;
            if (checked > 3) {
                alert('‚ö†Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞ | Maximum 3 skills');
                event.target.checked = false;
            }
        }
        
        async function saveEditedActivity() {
            const actId = document.getElementById('edit-activity-id').value;
            const source = document.getElementById('edit-activity-source').value;
            const studentId = document.getElementById('edit-student-id').value;
            const newStatus = document.getElementById('edit-activity-status').value;
            
            // Get selected skills
            const skills = [];
            document.querySelectorAll('.edit-skill-cb:checked').forEach(cb => {
                const code = cb.dataset.code;
                const level = parseInt(document.querySelector(`.edit-skill-level[data-code="${code}"]`).value);
                skills.push({ code, level });
            });
            
            if (skills.length > 3) {
                alert('‚ö†Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞ | Maximum 3 skills');
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å... | Saving...');
            
            try {
                if (source === 'participation') {
                    await db.collection('participation').doc(actId).update({
                        status: newStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Also update activity skills if approved
                    const actName = document.getElementById('edit-activity-name').value;
                    const actQuery = await db.collection('activities').where('name', '==', actName).limit(1).get();
                    if (!actQuery.empty) {
                        await db.collection('activities').doc(actQuery.docs[0].id).update({
                            skills: skills
                        });
                    }
                } else {
                    // submission
                    await db.collection('submissions').doc(actId).update({
                        status: newStatus,
                        approvedSkills: skills,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                closeEditActivityModal();
                alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ | Saved successfully');
                
                // Refresh student search
                await refreshStudentSearch();
                
            } catch (error) {
                console.error('Save error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }
        
        function openDeleteModal(actId, source, actName, studentId) {
            document.getElementById('delete-activity-id').value = actId;
            document.getElementById('delete-activity-source').value = source;
            document.getElementById('delete-student-id-for-refresh').value = studentId;
            document.getElementById('delete-confirm-text').innerHTML = 
                `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°<br><strong>"${actName}"</strong>?`;
            document.getElementById('delete-confirm-modal').classList.add('show');
        }
        
        function closeDeleteModal() {
            document.getElementById('delete-confirm-modal').classList.remove('show');
        }
        
        async function confirmDeleteActivity() {
            const actId = document.getElementById('delete-activity-id').value;
            const source = document.getElementById('delete-activity-source').value;
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö... | Deleting...');
            closeDeleteModal();
            
            try {
                if (source === 'participation') {
                    await db.collection('participation').doc(actId).delete();
                } else {
                    await db.collection('submissions').doc(actId).delete();
                }
                
                alert('‚úÖ ‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ | Activity deleted');
                
                // Refresh student search
                await refreshStudentSearch();
                
            } catch (error) {
                console.error('Delete error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }
        
        async function refreshStudentSearch() {
            if (currentSearchedStudent) {
                const activities = await loadStudentActivitiesAdmin(
                    currentSearchedStudent.studentId, 
                    currentSearchedStudent.email
                );
                const scores = calculateScoresAdmin(activities);
                const domainScores = calculateDomainScoresAdmin(scores);
                displayStudentResult(currentSearchedStudent, activities, scores, domainScores);
            }
        }

        // Initialize - check session
        // (moved to main DOMContentLoaded handler above)
    </script>
</body>
</html>
