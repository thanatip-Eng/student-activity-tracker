<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Student Talent Development</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéì</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin-style.css">
    <style>
        /* Login Section Styles */
        .login-section {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }
        .login-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 40px 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }
        .login-card h2 { color: #1a1a2e; margin-bottom: 10px; font-size: 1.6em; }
        .login-card > p { color: #666; margin-bottom: 25px; }
        .login-form { display: flex; flex-direction: column; gap: 15px; }
        .login-form input {
            padding: 14px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s;
        }
        .login-form input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
        }
        .login-form input[type="password"] { letter-spacing: 3px; }
        .login-form button {
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .login-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        .error-message {
            color: #e74c3c;
            font-size: 0.9em;
            margin-top: 10px;
            min-height: 20px;
        }
        .first-login-info {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            text-align: left;
            border: 1px solid #a5d6a7;
        }
        .first-login-info h4 {
            color: #2e7d32;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .first-login-info ul {
            margin: 0;
            padding-left: 20px;
            color: #555;
            font-size: 0.9em;
            line-height: 1.8;
        }
        .admin-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 12px 20px;
            margin-bottom: 20px;
            color: white;
        }
        .admin-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .admin-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
        }
        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Activity action buttons */
        .act-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .btn-act-edit, .btn-act-delete {
            padding: 5px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        .btn-act-edit {
            background: #3498db;
            color: white;
        }
        .btn-act-edit:hover { background: #2980b9; }
        .btn-act-delete {
            background: #e74c3c;
            color: white;
        }
        .btn-act-delete:hover { background: #c0392b; }
        
        /* Edit Activity Modal */
        .edit-modal-content {
            text-align: left;
        }
        .edit-modal-content .form-group {
            margin-bottom: 15px;
        }
        .edit-modal-content label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        .edit-modal-content input,
        .edit-modal-content select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95em;
        }
        .edit-skills-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
        }
        .edit-skill-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        .edit-skill-item:last-child { border-bottom: none; }
        
        /* Bulk Actions Styles */
        .bulk-actions {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .bulk-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
        }
        .bulk-info input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .bulk-info label {
            cursor: pointer;
            font-weight: 500;
        }
        .selected-count {
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        .bulk-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn-bulk-approve {
            background: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-bulk-approve:hover { background: #219a52; }
        .btn-bulk-reject {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-bulk-reject:hover { background: #c0392b; }
        .btn-bulk-cancel {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        .btn-bulk-cancel:hover { background: rgba(255,255,255,0.3); }
        
        /* Checkbox in submission cards */
        .submission-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }
        .submission-card.selectable {
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        .submission-card.selectable .card-content {
            flex: 1;
            cursor: pointer;
        }
        .submission-card.selected {
            border: 2px solid #667eea;
            background: #f0f4ff;
        }
        
        /* AI Skills Preview */
        .ai-skills-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }
        .ai-skill-tag {
            background: #fff3e0;
            color: #e65100;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            display: flex;
            align-items: center;
            gap: 3px;
        }
        .ai-skill-tag::before {
            content: 'ü§ñ';
            font-size: 0.9em;
        }
        .ai-skills-label {
            font-size: 0.75em;
            color: #888;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Activity Name Filter */
        .activity-name-filter {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
        }
        .filter-input-wrap {
            display: flex;
            align-items: center;
            flex: 1;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 0 12px;
            transition: border-color 0.2s;
        }
        .filter-input-wrap:focus-within {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }
        .filter-icon {
            font-size: 1em;
            margin-right: 6px;
        }
        .filter-input-wrap input {
            flex: 1;
            border: none;
            outline: none;
            padding: 10px 0;
            font-size: 0.92em;
            font-family: inherit;
            background: transparent;
        }
        .filter-clear-btn {
            background: #e0e0e0;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            cursor: pointer;
            font-size: 0.8em;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }
        .filter-clear-btn:hover {
            background: #ccc;
        }
        .filter-result-count {
            font-size: 0.82em;
            color: #888;
            white-space: nowrap;
        }

        /* Bulk Modal Styles */
        .bulk-modal-list {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin: 15px 0;
        }
        .bulk-modal-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
        }
        .bulk-modal-item:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <img src="images/MainLogo.png" alt="Student Talent Development" class="logo-img">
                <div>
                    <h1>Admin Dashboard</h1>
                    <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activity Review System</p>
                </div>
            </div>
            <nav class="nav-links">
                <a href="index.html">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å | Home</a>
                <a href="student-portal.html">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ | Search</a>
                <a href="student-form.html">üìù ‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Submit</a>
                <a href="organizer-form.html">üë®‚Äçüíº ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î | Organizer</a>
                <a href="data-management.html">üìä ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ | Manage</a>
                <a href="research-analytics.html">üî¨ ‡∏ß‡∏¥‡∏à‡∏±‡∏¢ | Research</a>
            </nav>
        </header>

        <!-- Login Section -->
        <section id="login-section" class="login-section">
            <div class="login-card">
                <h2>üîê Admin Login</h2>
                <p>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | Login to manage data</p>
                <div class="login-form">
                    <input type="email" id="admin-email" placeholder="Admin Email">
                    <input type="password" id="admin-password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô | Password (min 4 chars)" minlength="4">
                    <button onclick="loginAdmin()">üöÄ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö | Login</button>
                </div>
                <p id="login-error" class="error-message"></p>
                
                <div class="first-login-info">
                    <h4><span class="icon">üí°</span> ‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö | How to Login</h4>
                    <ul>
                        <li>Email ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢ Admin ‡∏Å‡πà‡∏≠‡∏ô</li>
                        <li>Your email must be added by an Admin first</li>
                        <li>‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å: ‡πÉ‡∏™‡πà Email + <strong>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</strong></li>
                        <li>‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Main Content (hidden until login) -->
        <section id="main-section" style="display: none;">
            <!-- Admin Bar -->
            <div class="admin-bar">
                <div class="admin-info">
                    <div class="admin-avatar" id="admin-avatar">A</div>
                    <div>
                        <strong id="admin-display-name">Admin</strong>
                        <br><small id="admin-display-email">admin@cmu.ac.th</small>
                    </div>
                </div>
                <button class="btn-logout" onclick="logoutAdmin()">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö | Logout</button>
            </div>

            <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-card pending">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-content">
                    <span class="stat-number" id="pending-count">0</span>
                    <span class="stat-label">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö | Pending</span>
                </div>
            </div>
            <div class="stat-card approved">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-content">
                    <span class="stat-number" id="approved-count">0</span>
                    <span class="stat-label">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß | Approved</span>
                </div>
            </div>
            <div class="stat-card rejected">
                <div class="stat-icon">‚ùå</div>
                <div class="stat-content">
                    <span class="stat-number" id="rejected-count">0</span>
                    <span class="stat-label">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ | Rejected</span>
                </div>
            </div>
            <div class="stat-card total">
                <div class="stat-icon">üìä</div>
                <div class="stat-content">
                    <span class="stat-number" id="total-count">0</span>
                    <span class="stat-label">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î | Total</span>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="student-search">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏®. | Search Student</button>
            <button class="tab" data-tab="activity-search">üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Search Activity</button>
            <button class="tab" data-tab="activities-manage">üìö ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activities</button>
            <button class="tab" data-tab="student-submissions">üìù ‡∏ô‡∏®.‡πÅ‡∏à‡πâ‡∏á | Student</button>
            <button class="tab" data-tab="organizer-activities">üë®‚Äçüíº ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î | Organizer</button>
            <button class="tab" data-tab="transfer">üì§ ‡πÇ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | Transfer</button>
            <button class="tab" data-tab="organizers">üë• ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô | Organizers</button>
            <button class="tab" data-tab="merge-activities">üîÄ ‡∏£‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Merge</button>
            <button class="tab" data-tab="admin-manage">üë§ Admin</button>
            <button class="tab" data-tab="export">üì• Export CSV</button>
            <button class="tab" data-tab="skills-summary">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡∏Å‡∏©‡∏∞ | Skills Summary</button>
        </div>

        <!-- Tab: Student Search -->
        <div id="tab-student-search" class="tab-content active">
            <div class="panel">
                <h2>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ | Search Student</h2>
                <p class="panel-desc">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ Email ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ | Search by Email or Student ID</p>
                
                <div class="search-box">
                    <input type="text" id="admin-student-search" placeholder="Email ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ | Email or Student ID">
                    <button class="btn-search" onclick="searchStudentAdmin()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ | Search</button>
                </div>
                
                <div id="student-search-result" class="student-search-result" style="display: none;">
                    <!-- Student Info -->
                    <div class="student-profile">
                        <div class="profile-header">
                            <div class="profile-avatar" id="result-avatar">S</div>
                            <div class="profile-info">
                                <h3 id="result-name">-</h3>
                                <p id="result-email">-</p>
                                <p id="result-student-id">-</p>
                                <p id="result-department">-</p>
                            </div>
                        </div>
                        
                        <!-- Stats -->
                        <div class="profile-stats">
                            <div class="profile-stat">
                                <span class="stat-num" id="result-total-activities">0</span>
                                <span class="stat-lbl">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activities</span>
                            </div>
                            <div class="profile-stat">
                                <span class="stat-num" id="result-approved">0</span>
                                <span class="stat-lbl">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ | Approved</span>
                            </div>
                            <div class="profile-stat">
                                <span class="stat-num" id="result-skills-passed">0</span>
                                <span class="stat-lbl">‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ú‡πà‡∏≤‡∏ô | Skills Passed</span>
                            </div>
                            <div class="profile-stat">
                                <span class="stat-num" id="result-total-score">0</span>
                                <span class="stat-lbl">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° | Total Score</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Competency Summary -->
                    <div class="result-section">
                        <h4>üìä Competency Summary</h4>
                        <div id="result-competency" class="competency-grid">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    
                    <!-- Activities List -->
                    <div class="result-section">
                        <h4>üìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activity List</h4>
                        <div id="result-activities" class="result-activities-list">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
                
                <div id="student-not-found" class="not-found-box" style="display: none;">
                    <span class="icon">üòï</span>
                    <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ | Student not found</p>
                </div>
            </div>
        </div>

        <!-- Tab: Activity Search -->
        <div id="tab-activity-search" class="tab-content">
            <div class="panel">
                <h2>üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Search Activity</h2>
                <p class="panel-desc">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° | Search activity name and view participants</p>
                
                <div class="search-box">
                    <input type="text" id="activity-search-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏≠‡∏á, Workshop, AI..." onkeyup="if(event.key==='Enter') searchActivities()">
                    <button class="btn-search" onclick="searchActivities()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ | Search</button>
                </div>
                
                <div id="activity-search-stats" style="display: none; margin: 15px 0; padding: 15px; background: #e3f2fd; border-radius: 10px;">
                    <span id="activity-search-count" style="font-weight: 600; color: #1565c0;"></span>
                </div>
                
                <div id="activity-search-results" style="margin-top: 20px;">
                    <!-- Results will be shown here -->
                </div>
            </div>
        </div>

        <!-- Tab: Activities Management -->
        <div id="tab-activities-manage" class="tab-content">
            <div class="panel">
                <div class="panel-header">
                    <h2>üìö ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activity Management</h2>
                    <button class="btn-add-organizer" onclick="openAddActivityModal()">
                        ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà | Add Activity
                    </button>
                </div>
                <p class="panel-desc">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö | Add/Edit/Delete activities in the system</p>
                
                <!-- Search Box -->
                <div class="search-box" style="margin-bottom: 20px;">
                    <input type="text" id="activity-manage-search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°... | Search activity...">
                    <button class="btn-search" onclick="searchActivitiesAdmin()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ | Search</button>
                    <button class="btn-search" style="background: #27ae60;" onclick="loadAllActivitiesAdmin()">üìã ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î | All</button>
                </div>
                
                <!-- Activities Stats -->
                <div class="activity-manage-stats">
                    <div class="activity-stat-card">
                        <span class="activity-stat-number" id="total-activities-count">0</span>
                        <span class="activity-stat-label">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î | Total</span>
                    </div>
                    <div class="activity-stat-card has-skills">
                        <span class="activity-stat-number" id="with-skills-count">0</span>
                        <span class="activity-stat-label">‡∏°‡∏µ Skills | With Skills</span>
                    </div>
                </div>
                
                <!-- Activities Table -->
                <div class="table-container">
                    <table class="activity-table" id="activities-manage-table">
                        <thead>
                            <tr>
                                <th style="width: 30%;">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activity</th>
                                <th style="width: 15%;">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î | Organizer</th>
                                <th style="width: 12%;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà | Date</th>
                                <th style="width: 8%;">Level</th>
                                <th style="width: 25%;">Skills</th>
                                <th style="width: 10%;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="activities-manage-list">
                            <tr><td colspan="6" class="loading-cell">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" | Search or click "All"</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Student Submissions -->
        <div id="tab-student-submissions" class="tab-content">
            <div class="panel">
                <div class="panel-header">
                    <h2>üìù ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏à‡πâ‡∏á</h2>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all" data-type="student">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        <button class="filter-btn" data-filter="pending" data-type="student">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
                        <button class="filter-btn" data-filter="duplicate" data-type="student" style="color:#e67e22;">üîÑ ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î</button>
                        <button class="filter-btn" data-filter="linkedin" data-type="student" style="color:#0077b5;">üîó LinkedIn</button>
                        <button class="filter-btn" data-filter="approved" data-type="student">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</button>
                        <button class="filter-btn" data-filter="rejected" data-type="student">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                    </div>
                </div>

                <!-- Activity Name Search -->
                <div class="activity-name-filter">
                    <div class="filter-input-wrap">
                        <span class="filter-icon">üîç</span>
                        <input type="text" id="student-activity-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°..." oninput="onStudentActivitySearch()">
                        <button id="student-activity-search-clear" class="filter-clear-btn" onclick="clearStudentActivitySearch()" style="display:none;">‚úï</button>
                    </div>
                    <span id="student-filter-count" class="filter-result-count"></span>
                </div>

                <!-- Reject Reason Search (visible when filtered to rejected) -->
                <div id="student-reject-reason-filter" class="activity-name-filter" style="display:none;">
                    <div class="filter-input-wrap">
                        <span class="filter-icon">üìù</span>
                        <input type="text" id="student-reject-reason-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò..." oninput="onStudentRejectReasonSearch()">
                        <button id="student-reject-reason-search-clear" class="filter-clear-btn" onclick="clearStudentRejectReasonSearch()" style="display:none;">‚úï</button>
                    </div>
                    <span id="student-reject-reason-count" class="filter-result-count"></span>
                </div>

                <!-- Bulk Actions: Reject Duplicates -->
                <div id="student-duplicate-actions" class="bulk-actions" style="display:none; background:linear-gradient(135deg,#fff3e0,#ffe0b2);">
                    <div class="bulk-info">
                        <span id="student-duplicate-count" style="font-weight:600;color:#e67e22;">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥</span>
                    </div>
                    <div class="bulk-buttons">
                        <button class="btn-bulk-reject" onclick="confirmRejectDuplicates()" style="background:linear-gradient(135deg,#e67e22,#d35400);">üîÑ ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥</button>
                    </div>
                </div>

                <!-- Bulk Actions: LinkedIn Learning -->
                <div id="student-linkedin-actions" class="bulk-actions" style="display:none; background:linear-gradient(135deg,#e3f2fd,#bbdefb);">
                    <div class="bulk-info">
                        <span id="student-linkedin-count" style="font-weight:600;color:#0077b5;">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ LinkedIn Learning</span>
                    </div>
                    <div class="bulk-buttons">
                        <button class="btn-bulk-approve" onclick="confirmBulkApproveLinkedIn()" style="background:linear-gradient(135deg,#0077b5,#005582);">üîó ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (4.1 Lv.1)</button>
                    </div>
                </div>

                <!-- Bulk Actions for Pending -->
                <div id="student-bulk-actions" class="bulk-actions" style="display: none;">
                    <div class="bulk-info">
                        <input type="checkbox" id="student-select-all" onchange="toggleSelectAllStudent()">
                        <label for="student-select-all">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                        <span id="student-selected-count" class="selected-count">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                    </div>
                    <div class="bulk-buttons">
                        <button class="btn-bulk-approve" onclick="openBulkApproveModal('student')">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                        <button class="btn-bulk-reject" onclick="openBulkRejectModal('student')">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                        <button class="btn-bulk-cancel" onclick="clearStudentSelection()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>

                <!-- Bulk Actions for Rejected (Revert) -->
                <div id="student-bulk-revert-actions" class="bulk-actions" style="display: none; background: linear-gradient(135deg, #fff3e0, #ffe0b2);">
                    <div class="bulk-info">
                        <input type="checkbox" id="student-revert-select-all" onchange="toggleSelectAllStudentRevert()">
                        <label for="student-revert-select-all">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                        <span id="student-revert-selected-count" class="selected-count">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                    </div>
                    <div class="bulk-buttons">
                        <button class="btn-bulk-approve" onclick="bulkRevertToPending('student')" style="background:linear-gradient(135deg,#f39c12,#e67e22);">üîÑ Revert ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                        <button class="btn-bulk-cancel" onclick="clearStudentRevertSelection()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>

                <div id="student-submissions-list" class="submissions-list">
                    <div class="loading-inline">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                </div>
            </div>
        </div>

        <!-- Tab: Organizer Activities -->
        <div id="tab-organizer-activities" class="tab-content">
            <div class="panel">
                <div class="panel-header">
                    <h2>üë®‚Äçüíº ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î</h2>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all" data-type="organizer">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        <button class="filter-btn" data-filter="pending" data-type="organizer">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                        <button class="filter-btn" data-filter="approved" data-type="organizer">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</button>
                        <button class="filter-btn" data-filter="rejected" data-type="organizer">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                    </div>
                </div>

                <!-- Activity Name Search -->
                <div class="activity-name-filter">
                    <div class="filter-input-wrap">
                        <span class="filter-icon">üîç</span>
                        <input type="text" id="organizer-activity-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°..." oninput="onOrganizerActivitySearch()">
                        <button id="organizer-activity-search-clear" class="filter-clear-btn" onclick="clearOrganizerActivitySearch()" style="display:none;">‚úï</button>
                    </div>
                    <span id="organizer-filter-count" class="filter-result-count"></span>
                </div>

                <!-- Reject Reason Search (visible when filtered to rejected) -->
                <div id="organizer-reject-reason-filter" class="activity-name-filter" style="display:none;">
                    <div class="filter-input-wrap">
                        <span class="filter-icon">üìù</span>
                        <input type="text" id="organizer-reject-reason-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò..." oninput="onOrganizerRejectReasonSearch()">
                        <button id="organizer-reject-reason-search-clear" class="filter-clear-btn" onclick="clearOrganizerRejectReasonSearch()" style="display:none;">‚úï</button>
                    </div>
                    <span id="organizer-reject-reason-count" class="filter-result-count"></span>
                </div>

                <!-- Bulk Actions for Pending -->
                <div id="organizer-bulk-actions" class="bulk-actions" style="display: none;">
                    <div class="bulk-info">
                        <input type="checkbox" id="organizer-select-all" onchange="toggleSelectAllOrganizer()">
                        <label for="organizer-select-all">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                        <span id="organizer-selected-count" class="selected-count">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                    </div>
                    <div class="bulk-buttons">
                        <button class="btn-bulk-approve" onclick="openBulkApproveModal('organizer')">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                        <button class="btn-bulk-reject" onclick="openBulkRejectModal('organizer')">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                        <button class="btn-bulk-cancel" onclick="clearOrganizerSelection()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>

                <!-- Bulk Actions for Rejected (Revert) -->
                <div id="organizer-bulk-revert-actions" class="bulk-actions" style="display: none; background: linear-gradient(135deg, #fff3e0, #ffe0b2);">
                    <div class="bulk-info">
                        <input type="checkbox" id="organizer-revert-select-all" onchange="toggleSelectAllOrganizerRevert()">
                        <label for="organizer-revert-select-all">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                        <span id="organizer-revert-selected-count" class="selected-count">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                    </div>
                    <div class="bulk-buttons">
                        <button class="btn-bulk-approve" onclick="bulkRevertToPending('organizer')" style="background:linear-gradient(135deg,#f39c12,#e67e22);">üîÑ Revert ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                        <button class="btn-bulk-cancel" onclick="clearOrganizerRevertSelection()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>

                <div id="organizer-activities-list" class="submissions-list">
                    <div class="loading-inline">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                </div>
            </div>
        </div>

        <!-- Tab: Transfer Data -->
        <div id="tab-transfer" class="tab-content">
            <div class="panel">
                <h2>üì§ ‡πÇ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Master</h2>
                <p class="panel-desc">‡πÇ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏¢‡∏±‡∏á Activities ‡πÅ‡∏•‡∏∞ Participation Collection</p>
                
                <div class="transfer-stats">
                    <div class="transfer-stat">
                        <span class="transfer-number" id="transfer-ready">0</span>
                        <span class="transfer-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÇ‡∏≠‡∏ô</span>
                    </div>
                    <div class="transfer-stat">
                        <span class="transfer-number" id="transfer-done">0</span>
                        <span class="transfer-label">‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
                    </div>
                </div>
                
                <button id="transfer-btn" class="btn-transfer" onclick="transferToMaster()">
                    üöÄ ‡πÇ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
                
                <div id="transfer-log" class="transfer-log"></div>
            </div>
        </div>

        <!-- Tab: Organizers Management -->
        <div id="tab-organizers" class="tab-content">
            <div class="panel">
                <div class="panel-header">
                    <h2>üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Registered Organizers</h2>
                    <button class="btn-add-organizer" onclick="openAddOrganizerModal()">
                        ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà | Add New
                    </button>
                </div>
                <p class="panel-desc">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Organizer Portal | Anyone can register via Organizer Portal</p>
                
                <div class="organizers-stats">
                    <div class="org-stat">
                        <span class="org-stat-number" id="total-organizers">0</span>
                        <span class="org-stat-label">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î | Total</span>
                    </div>
                    <div class="org-stat">
                        <span class="org-stat-number" id="active-organizers">0</span>
                        <span class="org-stat-label">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß | Active</span>
                    </div>
                </div>

                <div id="organizers-list" class="organizers-list">
                    <div class="loading-inline">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... | Loading...</div>
                </div>
            </div>
        </div>

        <!-- Tab: Admin Management -->
        <div id="tab-admin-manage" class="tab-content">
            <div class="panel">
                <h2>üë§ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Admin | Admin Management</h2>
                <p class="panel-desc">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö Admin ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö | Add or remove system admins</p>
                
                <!-- Add New Admin -->
                <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 12px; padding: 20px; margin-bottom: 25px; border: 2px solid #a5d6a7;">
                    <h4 style="color: #2e7d32; margin-bottom: 15px;">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° Admin ‡πÉ‡∏´‡∏°‡πà | Add New Admin</h4>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Email <span style="color: #e74c3c;">*</span></label>
                            <input type="email" id="new-admin-email" placeholder="email@cmu.ac.th" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">‡∏ä‡∏∑‡πà‡∏≠ | Name</label>
                            <input type="text" id="new-admin-name" placeholder="(optional)" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                        </div>
                        <button onclick="addNewAdmin()" style="padding: 12px 25px; background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1em;">
                            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° | Add
                        </button>
                    </div>
                    <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
                        üí° Admin ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å | New admin will set password on first login
                    </p>
                </div>
                
                <!-- Admin List -->
                <div style="background: white; border-radius: 12px; border: 2px solid #e0e0e0;">
                    <div style="padding: 15px 20px; border-bottom: 2px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                        <h4 style="margin: 0; color: #333;">üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Admin | Admin List</h4>
                        <button onclick="loadAdminList()" style="padding: 8px 15px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">
                            üîÑ Refresh
                        </button>
                    </div>
                    <div id="admin-list-container" style="padding: 20px;">
                        <div style="text-align: center; color: #999; padding: 20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... | Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Merge Activities -->
        <div id="tab-merge-activities" class="tab-content">
            <div class="panel">
                <h2>üîÄ ‡∏£‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô | Merge Similar Activities</h2>
                <p class="panel-desc">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</p>

                <div style="display:flex;gap:10px;margin-bottom:20px;align-items:center;flex-wrap:wrap;">
                    <button class="btn-primary" onclick="findSimilarActivities()" style="padding:10px 20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">
                        üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô
                    </button>
                    <span id="merge-status" style="font-size:0.9em;color:#666;"></span>
                </div>

                <div id="merge-results" style="display:none;">
                    <div id="merge-groups-list"></div>
                </div>

                <div id="merge-empty" style="display:none;text-align:center;padding:40px;color:#999;">
                    <span style="font-size:2em;">‚úÖ</span>
                    <p style="margin-top:10px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô</p>
                </div>
            </div>
        </div>

        <!-- Merge Confirm Modal -->
        <div id="merge-modal" class="modal-overlay">
            <div class="modal" style="max-width: 650px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                    <h3 style="color: white;">üîÄ ‡∏£‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
                    <button class="modal-close" onclick="closeMergeModal()" style="color: white;">‚úï</button>
                </div>
                <div class="modal-body">
                    <div id="merge-modal-content"></div>
                </div>
                <div class="modal-footer" id="merge-modal-footer">
                </div>
            </div>
        </div>

        <!-- Tab: Export CSV -->
        <div id="tab-export" class="tab-content">
            <div class="panel">
                <h2>üì• Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô CSV | Export Data to CSV</h2>
                <p class="panel-desc">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö CSV | Download all data in CSV format</p>
                
                <div class="export-grid">
                    <div class="export-card">
                        <div class="export-icon">üë•</div>
                        <h4>‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ | Students</h4>
                        <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î | All student data</p>
                        <button class="btn-export" onclick="exportStudentsCSV()">
                            üì• Export Students
                        </button>
                    </div>
                    
                    <div class="export-card">
                        <div class="export-icon">üìö</div>
                        <h4>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activities</h4>
                        <p>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î | All activities</p>
                        <button class="btn-export" onclick="exportActivitiesCSV()">
                            üì• Export Activities
                        </button>
                    </div>
                    
                    <div class="export-card">
                        <div class="export-icon">üéØ</div>
                        <h4>‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° | Participation</h4>
                        <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Participation records</p>
                        <button class="btn-export" onclick="exportParticipationCSV()">
                            üì• Export Participation
                        </button>
                    </div>
                    
                    <div class="export-card">
                        <div class="export-icon">üìù</div>
                        <h4>‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Submissions</h4>
                        <p>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏à‡πâ‡∏á | Student submissions</p>
                        <button class="btn-export" onclick="exportSubmissionsCSV()">
                            üì• Export Submissions
                        </button>
                    </div>
                    
                    <div class="export-card">
                        <div class="export-icon">üë®‚Äçüíº</div>
                        <h4>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î | Organizer Activities</h4>
                        <p>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î | Organizer activities</p>
                        <button class="btn-export" onclick="exportOrganizerActivitiesCSV()">
                            üì• Export Organizer Activities
                        </button>
                    </div>
                    
                    <div class="export-card">
                        <div class="export-icon">üîê</div>
                        <h4>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Organizers</h4>
                        <p>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Organizer list</p>
                        <button class="btn-export" onclick="exportOrganizersCSV()">
                            üì• Export Organizers
                        </button>
                    </div>
                    <div class="export-card" style="border:2px solid #667eea;background:linear-gradient(135deg,#f0f4ff 0%,#e8ecff 100%);">
                        <div class="export-icon">üìä</div>
                        <h4>‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞ | Score Summary</h4>
                        <p>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞ 18 ‡∏ï‡∏±‡∏ß + 6 ‡∏î‡πâ‡∏≤‡∏ô ‡∏ï‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏î‡πÄ‡∏Å‡∏£‡∏î/Radar Chart)</p>
                        <button class="btn-export" onclick="exportStudentScoreSummaryCSV()" style="background:#667eea;">
                            üìä Export Score Summary
                        </button>
                    </div>
                </div>

                <div class="export-all">
                    <button class="btn-export-all" onclick="exportAllCSV()">
                        üì¶ Export ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î | Export All Data
                    </button>
                </div>
                
                <!-- Data Repair Section -->
                <div class="repair-section">
                    <h3>üîß ‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | Data Repair</h3>
                    <p class="panel-desc">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ skills | Fix activities without skills</p>
                    
                    <div class="repair-actions">
                        <button class="btn-repair" onclick="scanActivitiesWithoutSkills()">
                            üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Scan Activities
                        </button>
                        <button class="btn-repair warning" onclick="showAddSkillsToActivity()">
                            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° Skills ‡πÉ‡∏´‡πâ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Add Skills to Activity
                        </button>
                    </div>
                    
                    <div id="repair-result" class="repair-result" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Tab: Skills Summary Dashboard -->
        <div id="tab-skills-summary" class="tab-content">
            <div class="panel">
                <h2>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ | Student Skills Summary</h2>
                <p class="panel-desc">‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° journey ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p>

                <!-- Filter Bar -->
                <div class="skills-filter-bar">
                    <div class="skills-filter-group">
                        <label>‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ | Year</label>
                        <select id="skills-year-filter" onchange="applySkillsFilter()">
                            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î | All</option>
                        </select>
                    </div>
                    <div class="skills-filter-group">
                        <label>‡πÄ‡∏°‡πÄ‡∏à‡∏≠‡∏£‡πå | Department</label>
                        <select id="skills-dept-filter" onchange="applySkillsFilter()">
                            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î | All</option>
                        </select>
                    </div>
                    <div class="skills-filter-group" style="flex:1;min-width:200px;">
                        <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ | Search Student</label>
                        <input type="text" id="skills-student-search" placeholder="‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏®."
                            oninput="applySkillsFilter()">
                    </div>
                    <div class="skills-filter-group" style="justify-content:flex-end;">
                        <label>&nbsp;</label>
                        <button class="btn-search" onclick="loadSkillsSummary()" style="padding:10px 20px;background:#667eea;color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.95em;">
                            üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | Load Data
                        </button>
                    </div>
                </div>

                <!-- Summary Stats -->
                <div class="skills-summary-stats" id="skills-summary-stats" style="display:none;">
                    <div class="skills-stat-card">
                        <span class="skills-stat-num" id="skills-total-students">0</span>
                        <span class="skills-stat-label">‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î | Active / Total</span>
                    </div>
                    <div class="skills-stat-card">
                        <span class="skills-stat-num" id="skills-avg-score">0</span>
                        <span class="skills-stat-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ | Avg Score</span>
                    </div>
                    <div class="skills-stat-card">
                        <span class="skills-stat-num" id="skills-passed-count">0</span>
                        <span class="skills-stat-label">‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ó‡∏∏‡∏Å‡∏î‡πâ‡∏≤‡∏ô | All Passed</span>
                    </div>
                    <div class="skills-stat-card">
                        <span class="skills-stat-num" id="skills-avg-activities">0</span>
                        <span class="skills-stat-label">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ | Avg Activities</span>
                    </div>
                </div>

                <!-- Radar Chart -->
                <div class="skills-chart-section" id="skills-chart-section" style="display:none;">
                    <h3 id="skills-chart-title">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡∏Å‡∏©‡∏∞ | Skills Overview</h3>
                    <div class="skills-chart-container">
                        <canvas id="skillsSummaryChart"></canvas>
                    </div>
                </div>

                <!-- Domain Detail Table -->
                <div class="skills-table-section" id="skills-table-section" style="display:none;">
                    <h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡∏Å‡∏©‡∏∞ | Skills Detail</h3>
                    <div class="skills-table-wrapper">
                        <table class="skills-detail-table skills-year-compare-table" id="skills-detail-table">
                            <thead id="skills-detail-thead">
                                <!-- Dynamic: generated by renderSkillsDetailTable -->
                            </thead>
                            <tbody id="skills-detail-tbody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Student List Table -->
                <div class="skills-students-section" id="skills-students-section" style="display:none;">
                    <h3>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ | Student List <span id="skills-student-count-label" style="font-size:0.8em;color:#666;"></span></h3>
                    <div class="skills-table-wrapper">
                        <table class="skills-student-table" id="skills-student-table">
                            <thead>
                                <tr>
                                    <th>‡∏£‡∏´‡∏±‡∏™ | ID</th>
                                    <th>‡∏ä‡∏∑‡πà‡∏≠ | Name</th>
                                    <th>‡πÄ‡∏°‡πÄ‡∏à‡∏≠‡∏£‡πå | Dept</th>
                                    <th>‡∏õ‡∏µ | Year</th>
                                    <th>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Act.</th>
                                    <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° | Total</th>
                                    <th>‡∏ú‡πà‡∏≤‡∏ô | Domains</th>
                                    <th>‡∏î‡∏π | View</th>
                                </tr>
                            </thead>
                            <tbody id="skills-student-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Individual Student Skills Modal -->
        <div id="student-skills-modal" class="modal-overlay">
            <div class="modal" style="max-width: 850px;">
                <div class="modal-header">
                    <h3 id="modal-student-skills-title">üìä ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h3>
                    <button class="modal-close" onclick="closeStudentSkillsModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <div id="modal-student-info"></div>
                    <div class="modal-chart-container">
                        <canvas id="modalSkillsChart"></canvas>
                    </div>
                    <div id="modal-skills-table"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeStudentSkillsModal()">‡∏õ‡∏¥‡∏î | Close</button>
                </div>
            </div>
        </div>

        <!-- Add Organizer Modal -->
        <div id="add-organizer-modal" class="modal-overlay">
            <div class="modal" style="max-width: 500px;">
                <div class="modal-header">
                    <h3>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà</h3>
                    <button class="modal-close" onclick="closeAddOrganizerModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Email <span class="required">*</span></label>
                        <input type="email" id="new-org-email" placeholder="organizer@cmu.ac.th">
                    </div>
                    <div class="form-group">
                        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="required">*</span></label>
                        <input type="text" id="new-org-name" placeholder="‡∏î‡∏£.‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ">
                    </div>
                    <div class="form-group">
                        <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô/‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</label>
                        <input type="text" id="new-org-department" placeholder="‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå">
                    </div>
                    <div class="form-group">
                        <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
                        <input type="tel" id="new-org-phone" placeholder="08x-xxx-xxxx">
                    </div>
                    <p class="form-note">üí° ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å</p>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeAddOrganizerModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button class="btn-primary" onclick="addNewOrganizer()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î</button>
                </div>
            </div>
        </div>

        <!-- Detail Modal -->
        <div id="detail-modal" class="modal-overlay">
            <div class="modal detail-modal">
                <div class="modal-header">
                    <h3 id="modal-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
                    <button class="modal-close" onclick="closeDetailModal()">‚úï</button>
                </div>
                <div class="modal-body" id="modal-body">
                    <!-- Filled by JS -->
                </div>
                <div class="modal-footer" id="modal-footer">
                    <!-- Filled by JS -->
                </div>
            </div>
        </div>

        <!-- Reject Reason Modal -->
        <div id="reject-modal" class="modal-overlay">
            <div class="modal reject-modal">
                <div class="modal-header">
                    <h3>‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
                    <button class="modal-close" onclick="closeRejectModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <label>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò:</label>
                    <textarea id="reject-reason" rows="4" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•..."></textarea>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeRejectModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button class="btn-danger" onclick="confirmReject()">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                </div>
            </div>
        </div>

        <!-- Bulk Reject Modal -->
        <div id="bulk-reject-modal" class="modal-overlay">
            <div class="modal" style="max-width: 500px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                    <h3 style="color: white;">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
                    <button class="modal-close" onclick="closeBulkRejectModal()" style="color: white;">‚úï</button>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom: 10px;"><strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (<span id="bulk-reject-count">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£):</strong></p>
                    <div id="bulk-reject-list" class="bulk-modal-list"></div>
                    
                    <label style="font-weight: 600; margin-top: 15px; display: block;">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£):</label>
                    <textarea id="bulk-reject-reason" rows="4" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 8px;"></textarea>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeBulkRejectModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button class="btn-danger" onclick="confirmBulkReject()">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                </div>
            </div>
        </div>

        <!-- Bulk Approve Modal -->
        <div id="bulk-approve-modal" class="modal-overlay">
            <div class="modal" style="max-width: 650px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #27ae60, #219a52);">
                    <h3 style="color: white;">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
                    <button class="modal-close" onclick="closeBulkApproveModal()" style="color: white;">‚úï</button>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom: 10px;"><strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (<span id="bulk-approve-count">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£):</strong></p>
                    <div id="bulk-approve-list" class="bulk-modal-list"></div>

                    <!-- Skill Mode Selector -->
                    <div style="margin-top: 20px; display: flex; gap: 8px; flex-wrap: wrap;">
                        <button id="bulk-mode-same" class="bulk-mode-btn active" onclick="setBulkApproveMode('same')" style="flex:1;min-width:180px;padding:10px;border:2px solid #27ae60;background:#e8f5e9;color:#27ae60;border-radius:8px;font-weight:600;cursor:pointer;">
                            üéØ ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                        </button>
                        <button id="bulk-mode-individual" class="bulk-mode-btn" onclick="setBulkApproveMode('individual')" style="flex:1;min-width:180px;padding:10px;border:2px solid #ddd;background:white;color:#666;border-radius:8px;font-weight:600;cursor:pointer;">
                            ü§ñ ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏à‡∏≤‡∏Å AI/‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î
                        </button>
                    </div>

                    <!-- Mode: Same skills for all -->
                    <div id="bulk-skills-same-section" style="margin-top: 15px; padding: 15px; background: #f0f8ff; border-radius: 10px;">
                        <h4 style="margin-bottom: 10px;">üéØ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞ (‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</h4>
                        <p style="font-size: 0.85em; color: #666; margin-bottom: 15px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞)</p>
                        <div id="bulk-skills-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px; max-height: 250px; overflow-y: auto;"></div>
                    </div>

                    <!-- Mode: Individual AI/Organizer skills -->
                    <div id="bulk-skills-individual-section" style="margin-top: 15px; display: none;">
                        <div style="padding: 12px; background: #fff8e1; border-radius: 10px; border-left: 3px solid #ff9800;">
                            <h4 style="margin-bottom: 8px;">ü§ñ ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏à‡∏≤‡∏Å AI/‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡πÄ‡∏î‡∏¥‡∏°</h4>
                            <p style="font-size: 0.85em; color: #666; margin-bottom: 10px;">‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏ß‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ</p>
                            <div id="bulk-individual-preview" style="max-height: 250px; overflow-y: auto;"></div>
                            <div id="bulk-individual-warning" style="display:none;margin-top:10px;padding:8px;background:#ffebee;border-radius:6px;color:#c62828;font-size:0.85em;">
                                ‚ö†Ô∏è ‡∏°‡∏µ‡∏ö‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏à‡∏≤‡∏Å AI/‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeBulkApproveModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button class="btn-success" onclick="confirmBulkApprove()">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                </div>
            </div>
        </div>

        <!-- Activity Management Modal -->
        <div id="activity-modal" class="modal-overlay">
            <div class="modal" style="max-width: 700px;">
                <div class="modal-header">
                    <h3 id="activity-modal-title">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Add Activity</h3>
                    <button class="modal-close" onclick="closeActivityModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-activity-id">
                    <input type="hidden" id="edit-activity-original-name">
                    
                    <div class="form-group">
                        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activity Name <span style="color:red">*</span></label>
                        <input type="text" id="act-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°">
                    </div>
                    
                    <div class="form-row" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div class="form-group">
                            <label>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î | Organizer</label>
                            <input type="text" id="act-organizer" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô">
                        </div>
                        <div class="form-group">
                            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà | Date</label>
                            <input type="date" id="act-date">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î | Description</label>
                        <textarea id="act-description" rows="2" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>üéØ ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö | Skills & Levels</label>
                        <p style="font-size:0.85em; color:#666; margin-bottom:10px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö (1-4) | Select skills and set levels</p>
                        <div id="activity-skills-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:8px; max-height:300px; overflow-y:auto; padding:10px; background:#f8f9fa; border-radius:8px;">
                            <!-- Skills will be populated by JS -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeActivityModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å | Cancel</button>
                    <button class="btn-primary" onclick="saveActivityAdmin()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å | Save</button>
                </div>
            </div>
        </div>

        </section><!-- End main-section -->

        <!-- Edit Student Activity Modal -->
        <div id="edit-student-activity-modal" class="modal-overlay">
            <div class="modal" style="max-width: 500px;">
                <div class="modal-header">
                    <h3>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Edit Activity</h3>
                </div>
                <div class="modal-body edit-modal-content">
                    <input type="hidden" id="edit-activity-id">
                    <input type="hidden" id="edit-activity-source">
                    <input type="hidden" id="edit-student-id">
                    
                    <div class="form-group">
                        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activity Name</label>
                        <input type="text" id="edit-activity-name" readonly style="background:#f5f5f5;">
                    </div>
                    
                    <div class="form-group">
                        <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ | Status</label>
                        <select id="edit-activity-status">
                            <option value="Approved">‚úÖ Approved (‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</option>
                            <option value="Pending Review">‚è≥ Pending (‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)</option>
                            <option value="Rejected">‚ùå Rejected (‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>üéØ ‡∏ó‡∏±‡∏Å‡∏©‡∏∞ | Skills (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3)</label>
                        <div class="edit-skills-list" id="edit-skills-list">
                            <!-- Skills checkboxes will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeEditActivityModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å | Cancel</button>
                    <button class="btn-primary" onclick="saveEditedActivity()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å | Save</button>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="delete-confirm-modal" class="modal-overlay">
            <div class="modal" style="max-width: 400px; text-align: center;">
                <div class="modal-icon" style="font-size: 3em;">‚ö†Ô∏è</div>
                <h3>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö | Confirm Delete</h3>
                <p id="delete-confirm-text" style="margin: 20px 0; color: #666;">
                    ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ?
                </p>
                <input type="hidden" id="delete-activity-id">
                <input type="hidden" id="delete-activity-source">
                <input type="hidden" id="delete-student-id-for-refresh">
                <div class="modal-footer" style="justify-content: center;">
                    <button class="btn-secondary" onclick="closeDeleteModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å | Cancel</button>
                    <button class="btn-danger" onclick="confirmDeleteActivity()">üóëÔ∏è ‡∏•‡∏ö | Delete</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay">
            <div class="loading-box">
                <div class="spinner"></div>
                <p id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // ============================================
        // CRITERIA DEFINITIONS
        // ============================================
        const CRITERIA_LIST = [
            { code: "1.1", name: "Analytical Reasoning", nameTh: "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå", domain: "Critical Thinking" },
            { code: "1.2", name: "Problem Solving", nameTh: "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö", domain: "Critical Thinking" },
            { code: "1.3", name: "Systems Thinking", nameTh: "‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡πÄ‡∏ä‡∏¥‡∏á‡∏£‡∏∞‡∏ö‡∏ö", domain: "Critical Thinking" },
            { code: "2.1", name: "Presentation", nameTh: "‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠", domain: "Communication" },
            { code: "2.2", name: "Listening", nameTh: "‡∏Å‡∏≤‡∏£‡∏ü‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à", domain: "Communication" },
            { code: "2.3", name: "English", nameTh: "‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©", domain: "Communication" },
            { code: "3.1", name: "Role Understanding", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÉ‡∏ô‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó", domain: "Teamwork" },
            { code: "3.2", name: "Task Management", nameTh: "‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô", domain: "Teamwork" },
            { code: "3.3", name: "Collaboration", nameTh: "‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô", domain: "Teamwork" },
            { code: "4.1", name: "Learning Agility", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ", domain: "Digital & Learning" },
            { code: "4.2", name: "Digital Literacy", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•", domain: "Digital & Learning" },
            { code: "4.3", name: "Tool Proficiency", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠", domain: "Digital & Learning" },
            { code: "5.1", name: "Human-Centered Design", nameTh: "‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏¢‡∏∂‡∏î‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á", domain: "Innovation" },
            { code: "5.2", name: "Project Management", nameTh: "‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£", domain: "Innovation" },
            { code: "5.3", name: "Business Awareness", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏£‡∏∞‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏≤‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à", domain: "Innovation" },
            { code: "6.1", name: "Personal Growth", nameTh: "‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•", domain: "Self Development" },
            { code: "6.2", name: "Resilience", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß", domain: "Self Development" },
            { code: "6.3", name: "Empathy", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏à", domain: "Self Development" }
        ];

        const DOMAINS = [
            { id: 1, name: "Critical Thinking", nameTh: "‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå", color: "#667eea" },
            { id: 2, name: "Communication", nameTh: "‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£", color: "#27ae60" },
            { id: 3, name: "Teamwork", nameTh: "‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡∏°", color: "#f39c12" },
            { id: 4, name: "Digital & Learning", nameTh: "‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ", color: "#e74c3c" },
            { id: 5, name: "Innovation", nameTh: "‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°", color: "#9b59b6" },
            { id: 6, name: "Self Development", nameTh: "‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡∏ô‡πÄ‡∏≠‡∏á", color: "#1abc9c" }
        ];

        // ============================================
        // COMPUTED YEAR LEVEL FROM STUDENT ID
        // ============================================
        function getYearLevelFromId(studentId) {
            if (!studentId || studentId.length < 2) return null;
            const prefix = parseInt(studentId.substring(0, 2), 10);
            // BE year prefixes are typically 50+ (2507 BE = 1964 CE onwards)
            if (isNaN(prefix) || prefix < 50) return null;
            // Buddhist year: Gregorian + 543. e.g. 2026 ‚Üí 2569 ‚Üí last 2 digits = 69
            const currentBELast2 = (new Date().getFullYear() + 543) % 100;
            const yearLevel = currentBELast2 - prefix;
            // Valid range: 1-8 (support extended programs)
            return (yearLevel >= 1 && yearLevel <= 8) ? yearLevel : null;
        }

        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let studentSubmissions = [];
        let organizerActivities = [];
        let currentItem = null;
        let currentType = null;
        let studentFilter = 'all';
        let organizerFilter = 'all';
        let studentActivitySearch = '';
        let organizerActivitySearch = '';
        let studentRejectReasonSearch = '';
        let organizerRejectReasonSearch = '';

        // Participation cross-reference index: studentId ‚Üí [{activityName (normalized), activityNameOriginal, skills, source}]
        let participationIndex = {};

        // Skills Summary Dashboard state
        let skillsSummaryData = null;   // cached results from computeAllStudentScores()
        let skillsSummaryLoaded = false;
        let skillsSummaryChart = null;  // Chart.js instance (main radar)
        let modalSkillsChart = null;    // Chart.js instance (modal radar)

        // Bulk selection state
        let selectedStudentItems = new Set();
        let selectedOrganizerItems = new Set();
        let selectedStudentRevertItems = new Set();
        let selectedOrganizerRevertItems = new Set();
        let bulkType = null; // 'student' or 'organizer'
        let bulkApproveMode = 'same'; // 'same' or 'individual'

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            checkAdminSession();
            setupTabs();
            setupFilters();
            
            // Enter key for login
            document.getElementById('admin-password')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loginAdmin();
            });
        });

        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
                    
                    // Load organizers when tab is clicked
                    if (tab.dataset.tab === 'organizers') {
                        loadOrganizers();
                    }
                    
                    // Load admin list when tab is clicked
                    if (tab.dataset.tab === 'admin-manage') {
                        loadAdminList();
                    }
                    
                    // Load activities management when tab is clicked
                    if (tab.dataset.tab === 'activities-manage') {
                        if (allActivitiesCache.length === 0) {
                            loadAllActivitiesAdmin();
                        }
                    }

                    // No auto-load for merge tab - user clicks button to scan

                    // Lazy load skills summary when tab is clicked
                    if (tab.dataset.tab === 'skills-summary') {
                        if (!skillsSummaryLoaded) {
                            loadSkillsSummary();
                        }
                    }

                });
            });
        }

        function setupFilters() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const type = btn.dataset.type;
                    const filter = btn.dataset.filter;
                    
                    // Update active state
                    btn.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    if (type === 'student') {
                        studentFilter = filter;
                        renderStudentSubmissions();
                    } else {
                        organizerFilter = filter;
                        renderOrganizerActivities();
                    }
                });
            });
        }

        // ============================================
        // EXTRACT SKILLS FROM ACTIVITY (various formats)
        // ============================================
        function extractSkillsAdmin(activity) {
            let skills = [];
            
            // Format 1: Check for skills array
            if (activity.skills && Array.isArray(activity.skills) && activity.skills.length > 0) {
                skills = [...activity.skills];
            } else if (typeof CRITERIA_LIST !== 'undefined') {
                // Format 2: Check for direct code format (e.g., "1.1": 2 or "1_1": 2)
                CRITERIA_LIST.forEach(criteria => {
                    const value = activity[criteria.code] || activity[criteria.code.replace('.', '_')];
                    if (value && value > 0) {
                        skills.push({
                            code: criteria.code,
                            level: parseInt(value)
                        });
                    }
                });
            }
            
            // For student view - limit to top 3 skills
            if (skills.length > 3) {
                skills.sort((a, b) => b.level - a.level);
                skills = skills.slice(0, 3);
            }
            
            return skills;
        }

        // ============================================
        // ADMIN STUDENT SEARCH
        // ============================================
        async function searchStudentAdmin() {
            const searchInput = document.getElementById('admin-student-search').value.trim().toLowerCase();
            
            if (!searchInput) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Email ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ | Please enter Email or Student ID');
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤... | Searching...');
            
            document.getElementById('student-search-result').style.display = 'none';
            document.getElementById('student-not-found').style.display = 'none';
            
            try {
                // Search by email first
                let studentDoc = null;
                let studentData = null;
                
                let query = await db.collection('students').where('email', '==', searchInput).limit(1).get();
                
                if (query.empty) {
                    // Try search by studentId
                    query = await db.collection('students').where('studentId', '==', searchInput).limit(1).get();
                }
                
                if (query.empty) {
                    // Try partial match - search all and filter
                    const allStudents = await db.collection('students').get();
                    for (const doc of allStudents.docs) {
                        const data = doc.data();
                        if (data.email?.toLowerCase().includes(searchInput) || 
                            data.studentId?.toLowerCase().includes(searchInput) ||
                            data.name?.toLowerCase().includes(searchInput)) {
                            studentDoc = doc;
                            studentData = data;
                            break;
                        }
                    }
                } else {
                    studentDoc = query.docs[0];
                    studentData = studentDoc.data();
                }
                
                if (!studentData) {
                    document.getElementById('student-not-found').style.display = 'block';
                    showLoading(false);
                    return;
                }
                
                // Load student activities
                const activities = await loadStudentActivitiesAdmin(studentData.studentId, studentData.email);
                
                // Calculate scores
                const scores = calculateScoresAdmin(activities);
                const domainScores = calculateDomainScoresAdmin(scores);
                
                // Display results
                displayStudentResult(studentData, activities, scores, domainScores);
                
            } catch (error) {
                console.error('Search error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î | Error: ' + error.message);
            }
            
            showLoading(false);
        }

        // ============================================
        // ACTIVITY SEARCH WITH PARTICIPANTS
        // ============================================
        
        let activitySearchCache = [];
        let participationCache = [];
        
        async function searchActivities() {
            const searchInput = document.getElementById('activity-search-input').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('activity-search-results');
            const statsDiv = document.getElementById('activity-search-stats');
            
            if (!searchInput) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Please enter activity name');
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤... | Searching...');
            
            try {
                // Load activities if not cached
                if (activitySearchCache.length === 0) {
                    const activitiesSnap = await db.collection('activities').get();
                    activitySearchCache = activitiesSnap.docs.map(doc => ({ id: doc.id, ...doc.data(), source: 'activities' }));
                    
                    const orgActivitiesSnap = await db.collection('organizerActivities').get();
                    const orgActivities = orgActivitiesSnap.docs.map(doc => ({ id: doc.id, ...doc.data(), source: 'organizerActivities' }));
                    activitySearchCache = [...activitySearchCache, ...orgActivities];
                }
                
                // Load participation if not cached
                if (participationCache.length === 0) {
                    const participationSnap = await db.collection('participation').get();
                    participationCache = participationSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
                
                // Filter activities by name
                const matchedActivities = activitySearchCache.filter(act => {
                    const name = (act.name || act.activityName || act.activityNameBase || '').toLowerCase();
                    return name.includes(searchInput);
                });
                
                // Sort by date (newest first)
                matchedActivities.sort((a, b) => {
                    const dateA = a.date || a.startDate || a.activityDate || '';
                    const dateB = b.date || b.startDate || b.activityDate || '';
                    return dateB.localeCompare(dateA);
                });
                
                // Show stats
                statsDiv.style.display = 'block';
                document.getElementById('activity-search-count').textContent = 
                    `‡∏û‡∏ö ${matchedActivities.length} ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Found ${matchedActivities.length} activities`;
                
                if (matchedActivities.length === 0) {
                    resultsDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <span style="font-size: 3em;">üòï</span>
                            <p style="margin-top: 15px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "${searchInput}"</p>
                        </div>
                    `;
                    showLoading(false);
                    return;
                }
                
                // Render results
                resultsDiv.innerHTML = matchedActivities.map(act => {
                    const actName = act.name || act.activityName || act.activityNameBase || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
                    const actDate = act.date || act.startDate || act.activityDate || '-';
                    const actOrganizer = act.organizer || act.organizerName || '-';
                    const skills = act.skills || act.approvedSkills || [];
                    const source = act.source === 'organizerActivities' ? 'üë®‚Äçüíº ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î' : 'üìù ‡∏£‡∏∞‡∏ö‡∏ö';
                    
                    // Find participants
                    let participants = [];
                    
                    // From organizerActivities studentIds
                    if (act.studentIds && act.studentIds.length > 0) {
                        participants = act.studentIds.map(id => ({ studentId: id, source: 'studentIds' }));
                    }
                    
                    // From participation collection
                    const participationRecords = participationCache.filter(p => {
                        const pName = (p.activityName || '').toLowerCase();
                        return pName === actName.toLowerCase() || pName.includes(actName.toLowerCase().substring(0, 20));
                    });
                    
                    participationRecords.forEach(p => {
                        if (!participants.find(x => x.studentId === p.studentId)) {
                            participants.push({ studentId: p.studentId, source: 'participation', status: p.status });
                        }
                    });
                    
                    const skillsHtml = skills.length > 0 
                        ? skills.map(s => `<span style="background:#e3f2fd;color:#1565c0;padding:3px 8px;border-radius:12px;font-size:0.8em;margin-right:5px;">${s.code} Lv.${s.level}</span>`).join('')
                        : '<span style="color:#999;font-size:0.85em;">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ó‡∏±‡∏Å‡∏©‡∏∞</span>';
                    
                    const participantsHtml = participants.length > 0
                        ? `<div style="margin-top: 10px; padding: 15px; background: #f5f5f5; border-radius: 10px;">
                            <strong style="color: #333;">üë• ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° (${participants.length} ‡∏Ñ‡∏ô):</strong>
                            <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;">
                                ${participants.map(p => `
                                    <span style="background: white; border: 1px solid #ddd; padding: 5px 12px; border-radius: 20px; font-family: monospace; font-size: 0.9em; cursor: pointer;" 
                                          onclick="searchStudentFromActivity('${p.studentId}')" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤">
                                        ${p.studentId}
                                    </span>
                                `).join('')}
                            </div>
                           </div>`
                        : `<div style="margin-top: 10px; padding: 15px; background: #fff3e0; border-radius: 10px; color: #e65100;">
                            ‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
                           </div>`;
                    
                    return `
                        <div style="background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px;">
                                <div style="flex: 1;">
                                    <h3 style="color: #1a472a; margin-bottom: 8px; font-size: 1.1em;">${actName}</h3>
                                    <p style="color: #666; font-size: 0.9em; margin-bottom: 10px;">
                                        üìÖ ${actDate} | üè¢ ${actOrganizer} | ${source}
                                    </p>
                                    <div>${skillsHtml}</div>
                                </div>
                                <button onclick="editActivityFromSearch('${act.id}', '${act.source}')" 
                                        style="padding: 8px 15px; background: #e3f2fd; color: #1565c0; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85em;">
                                    ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                </button>
                            </div>
                            ${participantsHtml}
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Activity search error:', error);
                resultsDiv.innerHTML = `<div style="color: #e53935; padding: 20px;">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</div>`;
            }
            
            showLoading(false);
        }
        
        function searchStudentFromActivity(studentId) {
            // Switch to student search tab and search
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="student-search"]').classList.add('active');
            document.getElementById('tab-student-search').classList.add('active');
            
            document.getElementById('admin-student-search').value = studentId;
            searchStudentAdmin();
        }
        
        function editActivityFromSearch(activityId, source) {
            if (source === 'organizerActivities') {
                alert('‚ö†Ô∏è ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö "üë®‚Äçüíº ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î | Organizer"');
                // Switch to organizer tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector('[data-tab="organizer-activities"]').classList.add('active');
                document.getElementById('tab-organizer-activities').classList.add('active');
            } else {
                // Switch to activities manage tab and edit
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector('[data-tab="activities-manage"]').classList.add('active');
                document.getElementById('tab-activities-manage').classList.add('active');
                
                // Load activities first if needed
                if (allActivitiesCache.length === 0) {
                    loadAllActivitiesAdmin().then(() => {
                        editActivityAdmin(activityId);
                    });
                } else {
                    editActivityAdmin(activityId);
                }
            }
        }
        
        // Clear cache when needed
        function clearActivitySearchCache() {
            activitySearchCache = [];
            participationCache = [];
        }

        async function loadStudentActivitiesAdmin(studentId, email) {
            const activities = [];
            
            // Load from participation
            const participationQuery = await db.collection('participation')
                .where('studentId', '==', studentId)
                .get();
            
            for (const doc of participationQuery.docs) {
                const participation = doc.data();

                // Use skills from participation record first (set during approval)
                let participationSkills = participation.skills || [];
                // Do NOT fallback here ‚Äî wait until after submission merge

                let activityData = {
                    id: doc.id,
                    name: participation.activityName,
                    status: participation.status || 'Approved',
                    date: participation.date || '',
                    skills: participationSkills,
                    source: 'participation'
                };

                activities.push(activityData);
            }

            // Load from submissions
            const submissionsQuery = await db.collection('submissions')
                .where('studentEmail', '==', email)
                .get();

            for (const doc of submissionsQuery.docs) {
                const submission = doc.data();

                const existingActivity = activities.find(a =>
                    a.name.toLowerCase() === submission.activityName?.toLowerCase()
                );

                if (!existingActivity) {
                    activities.push({
                        id: doc.id,
                        name: submission.activityName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                        status: submission.status || 'Pending',
                        date: submission.activityDate || submission.startDate || '',
                        skills: submission.approvedSkills || submission.skills || [],
                        source: 'submission'
                    });
                } else if ((!existingActivity.skills || existingActivity.skills.length === 0) && (submission.approvedSkills?.length > 0 || submission.skills?.length > 0)) {
                    // Participation has empty skills ‚Äî merge from submission's approvedSkills
                    existingActivity.skills = submission.approvedSkills || submission.skills || [];
                }
            }

            // Final fallback: query activity doc for entries STILL without skills (last resort)
            for (const activity of activities) {
                if ((!activity.skills || activity.skills.length === 0) && activity.name) {
                    try {
                        const activityQuery = await db.collection('activities')
                            .where('name', '==', activity.name)
                            .limit(1)
                            .get();
                        if (!activityQuery.empty) {
                            activity.skills = extractSkillsAdmin(activityQuery.docs[0].data());
                        }
                    } catch (e) {
                        console.warn(`[loadStudentActivities] Fallback query failed for "${activity.name}":`, e);
                    }
                }
            }

            return activities;
        }

        function calculateScoresAdmin(activities) {
            const scores = {};
            CRITERIA_LIST.forEach(c => scores[c.code] = 0);
            
            const approved = activities.filter(a => a.status?.toLowerCase().includes('approved'));
            approved.forEach(activity => {
                if (activity.skills) {
                    activity.skills.forEach(skill => {
                        if (skill.code) {
                            const lvl = parseInt(skill.level);
                            if (!isNaN(lvl) && lvl >= 0) {
                                scores[skill.code] = Math.max(scores[skill.code], lvl);
                            }
                        }
                    });
                }
            });
            
            return scores;
        }

        function calculateDomainScoresAdmin(scores) {
            const domainScores = {};
            
            DOMAINS.forEach(domain => {
                const domainCriteria = CRITERIA_LIST.filter(c => c.domain === domain.name);
                const domainLevels = domainCriteria.map(c => scores[c.code] || 0);
                
                const total = domainLevels.reduce((a, b) => a + b, 0);
                const avg = domainLevels.length > 0 ? total / domainLevels.length : 0;
                
                domainScores[domain.name] = {
                    total,
                    avg: Math.round(avg * 10) / 10,
                    levels: domainLevels,
                    color: domain.color
                };
            });
            
            return domainScores;
        }

        // Store current searched student for refresh
        let currentSearchedStudent = null;

        function displayStudentResult(student, activities, scores, domainScores) {
            // Store for refresh after edit/delete
            currentSearchedStudent = student;
            
            // Update profile info
            document.getElementById('result-avatar').textContent = student.name?.charAt(0) || 'S';
            document.getElementById('result-name').textContent = student.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠';
            document.getElementById('result-email').textContent = student.email || '-';
            document.getElementById('result-student-id').textContent = `‡∏£‡∏´‡∏±‡∏™ | ID: ${student.studentId || '-'}`;
            document.getElementById('result-department').textContent = student.department || '';
            
            // Update stats
            const approved = activities.filter(a => a.status?.toLowerCase().includes('approved'));
            const totalScore = Object.values(scores).reduce((a, b) => a + b, 0);
            const skillsPassed = DOMAINS.filter(d => domainScores[d.name].avg >= 2).length;
            
            document.getElementById('result-total-activities').textContent = activities.length;
            document.getElementById('result-approved').textContent = approved.length;
            document.getElementById('result-skills-passed').textContent = `${skillsPassed}/6`;
            document.getElementById('result-total-score').textContent = totalScore;
            
            // Render competency grid
            const compContainer = document.getElementById('result-competency');
            compContainer.innerHTML = DOMAINS.map(domain => {
                const ds = domainScores[domain.name];
                const statusClass = ds.avg >= 3 ? 'excellent' : ds.avg >= 2 ? 'good' : ds.avg >= 1 ? 'developing' : 'none';
                const statusText = ds.avg >= 3 ? '‚≠ê Excellent' : ds.avg >= 2 ? '‚úÖ Passed' : ds.avg >= 1 ? 'üìà Developing' : '‚Äî';
                
                return `
                    <div class="comp-card" style="border-left: 4px solid ${domain.color}">
                        <div class="comp-header">
                            <span class="comp-name">${domain.name}</span>
                            <span class="comp-level ${statusClass}">Lv.${ds.avg}</span>
                        </div>
                        <div class="comp-status ${statusClass}">${statusText}</div>
                    </div>
                `;
            }).join('');
            
            // Render activities list with edit/delete buttons
            const actContainer = document.getElementById('result-activities');
            if (activities.length === 0) {
                actContainer.innerHTML = '<div class="empty-msg">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | No activities</div>';
            } else {
                actContainer.innerHTML = activities.map(act => {
                    const statusClass = act.status?.toLowerCase().includes('approved') ? 'approved' : 
                                       act.status?.toLowerCase().includes('rejected') ? 'rejected' : 'pending';
                    const statusText = act.status?.toLowerCase().includes('approved') ? '‚úÖ Approved' : 
                                      act.status?.toLowerCase().includes('rejected') ? '‚ùå Rejected' : '‚è≥ Pending';
                    
                    const skillsHtml = act.skills?.map(s => 
                        `<span class="skill-mini">${s.code}: Lv.${s.level}</span>`
                    ).join('') || '';
                    
                    // Create JSON string for skills (escape quotes)
                    const skillsJson = JSON.stringify(act.skills || []).replace(/"/g, '&quot;');
                    
                    return `
                        <div class="result-activity ${statusClass}">
                            <div class="act-main">
                                <span class="act-name">${act.name}</span>
                                <span class="act-status ${statusClass}">${statusText}</span>
                            </div>
                            <div class="act-meta">
                                <span>üìÖ ${act.date || '-'}</span>
                                <span>üìÅ ${act.source === 'submission' ? '‡∏ô‡∏®.‡πÅ‡∏à‡πâ‡∏á' : '‡∏£‡∏∞‡∏ö‡∏ö'}</span>
                            </div>
                            ${skillsHtml ? `<div class="act-skills">${skillsHtml}</div>` : ''}
                            <div class="act-actions">
                                <button class="btn-act-edit" onclick="openEditActivityModal('${act.id}', '${act.source}', '${act.name}', '${act.status || ''}', '${skillsJson}', '${student.studentId}')">
                                    ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                </button>
                                <button class="btn-act-delete" onclick="openDeleteModal('${act.id}', '${act.source}', '${act.name}', '${student.studentId}')">
                                    üóëÔ∏è ‡∏•‡∏ö
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('student-search-result').style.display = 'block';
        }

        // Enter key handler for student search
        document.getElementById('admin-student-search')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchStudentAdmin();
        });

        // ============================================
        // LOAD DATA
        // ============================================
        async function loadAllData() {
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');

            // Clear activity search cache
            clearActivitySearchCache();

            try {
                // Load all three collections in PARALLEL
                const [submissionsQuery, activitiesQuery, participationQuery] = await Promise.all([
                    db.collection('submissions').get(),
                    db.collection('organizerActivities').get(),
                    db.collection('participation').get()
                ]);

                // Build participation index: studentId ‚Üí [{activityName, skills, source}]
                participationIndex = {};
                participationQuery.docs.forEach(doc => {
                    const p = doc.data();
                    if (!p.studentId || !p.activityName) return;
                    const sid = p.studentId.trim();
                    if (!participationIndex[sid]) participationIndex[sid] = [];
                    participationIndex[sid].push({
                        activityName: p.activityName,
                        activityNameNorm: normalizeForCompare(p.activityName),
                        skills: p.skills || [],
                        source: p.source || '',
                        status: p.status || ''
                    });
                });
                console.log('üìä Participation index built:', Object.keys(participationIndex).length, 'students');

                // Process submissions
                studentSubmissions = submissionsQuery.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                studentSubmissions.sort((a, b) => {
                    const timeA = a.submittedAt?.toMillis?.() || a.submittedAt || 0;
                    const timeB = b.submittedAt?.toMillis?.() || b.submittedAt || 0;
                    return timeB - timeA;
                });

                // Tag submissions: cross-reference with participation
                tagSubmissionsWithParticipation();

                // Process organizer activities
                organizerActivities = activitiesQuery.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                organizerActivities.sort((a, b) => {
                    const timeA = a.updatedAt?.toMillis?.() || a.createdAt?.toMillis?.() || 0;
                    const timeB = b.updatedAt?.toMillis?.() || b.createdAt?.toMillis?.() || 0;
                    return timeB - timeA;
                });

                // Update stats
                updateStats();

                // Render lists
                renderStudentSubmissions();
                renderOrganizerActivities();
                updateTransferStats();

                console.log('‚úÖ Data loaded:', studentSubmissions.length, 'submissions,', organizerActivities.length, 'activities');

            } catch (error) {
                console.error('Load error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
            }

            showLoading(false);
        }

        // Tag each pending student submission if student already has participation for similar activity
        function tagSubmissionsWithParticipation() {
            let taggedCount = 0;
            studentSubmissions.forEach(sub => {
                sub._alreadyInParticipation = false;
                sub._matchedParticipation = null;

                if (!sub.status?.toLowerCase().includes('pending')) return;

                const sid = (sub.studentId || '').trim();
                const records = participationIndex[sid];
                if (!records || records.length === 0) return;

                const subNameNorm = normalizeForCompare(sub.activityName || '');
                for (const rec of records) {
                    if (areSimilar(sub.activityName || '', rec.activityName)) {
                        sub._alreadyInParticipation = true;
                        sub._matchedParticipation = rec;
                        taggedCount++;
                        break;
                    }
                }
            });
            console.log('üè∑Ô∏è Tagged', taggedCount, 'submissions as already in participation');
        }

        // Detect LinkedIn Learning from activity name or flag
        function isLikelyLinkedInLearning(item) {
            if (item.isLinkedInLearning) return true;
            const name = (item.activityName || '').toLowerCase();
            if (name.includes('linkedin')) return true;
            // Pattern: all English name, no Thai chars, typical course name patterns
            const hasThai = /[\u0E00-\u0E7F]/.test(item.activityName || '');
            const hasColon = name.includes(':');
            const looksLikeCourse = /^[a-z0-9\s:,\-\.\(\)&\/\+]+$/i.test((item.activityName || '').trim());
            if (!hasThai && looksLikeCourse && (hasColon || name.split(' ').length >= 3)) {
                return true;
            }
            return false;
        }

        function updateStats() {
            const allItems = [...studentSubmissions, ...organizerActivities];
            
            const pending = allItems.filter(i => i.status?.toLowerCase().includes('pending')).length;
            const approved = allItems.filter(i => i.status?.toLowerCase() === 'approved').length;
            const rejected = allItems.filter(i => i.status?.toLowerCase().includes('rejected')).length;
            
            document.getElementById('pending-count').textContent = pending;
            document.getElementById('approved-count').textContent = approved;
            document.getElementById('rejected-count').textContent = rejected;
            document.getElementById('total-count').textContent = allItems.length;
        }

        // ============================================
        // ACTIVITY NAME SEARCH HANDLERS
        // ============================================
        function onStudentActivitySearch() {
            const input = document.getElementById('student-activity-search');
            const clearBtn = document.getElementById('student-activity-search-clear');
            studentActivitySearch = input.value.trim().toLowerCase();
            clearBtn.style.display = studentActivitySearch ? 'flex' : 'none';
            renderStudentSubmissions();
        }
        function clearStudentActivitySearch() {
            document.getElementById('student-activity-search').value = '';
            studentActivitySearch = '';
            document.getElementById('student-activity-search-clear').style.display = 'none';
            document.getElementById('student-filter-count').textContent = '';
            renderStudentSubmissions();
        }
        function onOrganizerActivitySearch() {
            const input = document.getElementById('organizer-activity-search');
            const clearBtn = document.getElementById('organizer-activity-search-clear');
            organizerActivitySearch = input.value.trim().toLowerCase();
            clearBtn.style.display = organizerActivitySearch ? 'flex' : 'none';
            renderOrganizerActivities();
        }
        function clearOrganizerActivitySearch() {
            document.getElementById('organizer-activity-search').value = '';
            organizerActivitySearch = '';
            document.getElementById('organizer-activity-search-clear').style.display = 'none';
            document.getElementById('organizer-filter-count').textContent = '';
            renderOrganizerActivities();
        }

        // ============================================
        // REJECT REASON SEARCH FUNCTIONS
        // ============================================
        function onStudentRejectReasonSearch() {
            const input = document.getElementById('student-reject-reason-search');
            const clearBtn = document.getElementById('student-reject-reason-search-clear');
            studentRejectReasonSearch = input.value.trim().toLowerCase();
            clearBtn.style.display = studentRejectReasonSearch ? 'flex' : 'none';
            renderStudentSubmissions();
        }
        function clearStudentRejectReasonSearch() {
            document.getElementById('student-reject-reason-search').value = '';
            studentRejectReasonSearch = '';
            document.getElementById('student-reject-reason-search-clear').style.display = 'none';
            document.getElementById('student-reject-reason-count').textContent = '';
            renderStudentSubmissions();
        }
        function onOrganizerRejectReasonSearch() {
            const input = document.getElementById('organizer-reject-reason-search');
            const clearBtn = document.getElementById('organizer-reject-reason-search-clear');
            organizerRejectReasonSearch = input.value.trim().toLowerCase();
            clearBtn.style.display = organizerRejectReasonSearch ? 'flex' : 'none';
            renderOrganizerActivities();
        }
        function clearOrganizerRejectReasonSearch() {
            document.getElementById('organizer-reject-reason-search').value = '';
            organizerRejectReasonSearch = '';
            document.getElementById('organizer-reject-reason-search-clear').style.display = 'none';
            document.getElementById('organizer-reject-reason-count').textContent = '';
            renderOrganizerActivities();
        }

        // ============================================
        // REVERT SELECTION FUNCTIONS
        // ============================================
        function toggleStudentRevertSelection(id) {
            if (selectedStudentRevertItems.has(id)) {
                selectedStudentRevertItems.delete(id);
            } else {
                selectedStudentRevertItems.add(id);
            }
            updateStudentRevertSelectedCount();
            renderStudentSubmissions();
        }
        function toggleOrganizerRevertSelection(id) {
            if (selectedOrganizerRevertItems.has(id)) {
                selectedOrganizerRevertItems.delete(id);
            } else {
                selectedOrganizerRevertItems.add(id);
            }
            updateOrganizerRevertSelectedCount();
            renderOrganizerActivities();
        }
        function toggleSelectAllStudentRevert() {
            const allChecked = document.getElementById('student-revert-select-all').checked;
            const rejectedItems = studentSubmissions.filter(s => s.status?.toLowerCase().includes('rejected'));
            // Apply text filters too
            let filtered = rejectedItems;
            if (studentActivitySearch) {
                filtered = filtered.filter(s => (s.activityName || '').toLowerCase().includes(studentActivitySearch));
            }
            if (studentRejectReasonSearch) {
                filtered = filtered.filter(s => (s.rejectReason || '').toLowerCase().includes(studentRejectReasonSearch));
            }
            if (allChecked) {
                filtered.forEach(s => selectedStudentRevertItems.add(s.id));
            } else {
                selectedStudentRevertItems.clear();
            }
            updateStudentRevertSelectedCount();
            renderStudentSubmissions();
        }
        function toggleSelectAllOrganizerRevert() {
            const allChecked = document.getElementById('organizer-revert-select-all').checked;
            const rejectedItems = organizerActivities.filter(a => a.status?.toLowerCase().includes('rejected'));
            let filtered = rejectedItems;
            if (organizerActivitySearch) {
                filtered = filtered.filter(a => (a.activityName || '').toLowerCase().includes(organizerActivitySearch));
            }
            if (organizerRejectReasonSearch) {
                filtered = filtered.filter(a => (a.rejectReason || '').toLowerCase().includes(organizerRejectReasonSearch));
            }
            if (allChecked) {
                filtered.forEach(a => selectedOrganizerRevertItems.add(a.id));
            } else {
                selectedOrganizerRevertItems.clear();
            }
            updateOrganizerRevertSelectedCount();
            renderOrganizerActivities();
        }
        function updateStudentRevertSelectedCount() {
            const el = document.getElementById('student-revert-selected-count');
            if (el) el.textContent = `${selectedStudentRevertItems.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        }
        function updateOrganizerRevertSelectedCount() {
            const el = document.getElementById('organizer-revert-selected-count');
            if (el) el.textContent = `${selectedOrganizerRevertItems.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        }
        function clearStudentRevertSelection() {
            selectedStudentRevertItems.clear();
            const selectAllEl = document.getElementById('student-revert-select-all');
            if (selectAllEl) selectAllEl.checked = false;
            updateStudentRevertSelectedCount();
            renderStudentSubmissions();
        }
        function clearOrganizerRevertSelection() {
            selectedOrganizerRevertItems.clear();
            const selectAllEl = document.getElementById('organizer-revert-select-all');
            if (selectAllEl) selectAllEl.checked = false;
            updateOrganizerRevertSelectedCount();
            renderOrganizerActivities();
        }

        // ============================================
        // REVERT TO PENDING FUNCTIONS
        // ============================================
        async function revertToPending(id, type) {
            if (!confirm('üîÑ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Revert ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;

            const collection = type === 'student' ? 'submissions' : 'organizerActivities';
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á Revert...');

            try {
                await db.collection(collection).doc(id).update({
                    status: 'Pending',
                    rejectReason: firebase.firestore.FieldValue.delete(),
                    reviewedAt: firebase.firestore.FieldValue.delete()
                });

                // Update local state
                const items = type === 'student' ? studentSubmissions : organizerActivities;
                const index = items.findIndex(i => i.id === id);
                if (index !== -1) {
                    items[index].status = 'Pending';
                    delete items[index].rejectReason;
                    delete items[index].reviewedAt;
                }

                closeDetailModal();
                showLoading(false);

                if (type === 'student') renderStudentSubmissions();
                else renderOrganizerActivities();

                updateStats();
                alert('üîÑ Revert ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
            } catch (error) {
                console.error('Revert error:', error);
                showLoading(false);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        async function bulkRevertToPending(type) {
            const selectedIds = type === 'student' ? selectedStudentRevertItems : selectedOrganizerRevertItems;
            const totalCount = selectedIds.size;

            if (totalCount === 0) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            if (!confirm(`üîÑ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Revert ${totalCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô "‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

            const collection = type === 'student' ? 'submissions' : 'organizerActivities';
            const items = type === 'student' ? studentSubmissions : organizerActivities;

            showLoading(true, `‡∏Å‡∏≥‡∏•‡∏±‡∏á Revert ${totalCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...`);

            try {
                const batch = db.batch();

                selectedIds.forEach(id => {
                    const ref = db.collection(collection).doc(id);
                    batch.update(ref, {
                        status: 'Pending',
                        rejectReason: firebase.firestore.FieldValue.delete(),
                        reviewedAt: firebase.firestore.FieldValue.delete()
                    });
                });

                await batch.commit();

                // Update local state
                selectedIds.forEach(id => {
                    const index = items.findIndex(i => i.id === id);
                    if (index !== -1) {
                        items[index].status = 'Pending';
                        delete items[index].rejectReason;
                        delete items[index].reviewedAt;
                    }
                });

                // Clear selection
                if (type === 'student') {
                    clearStudentRevertSelection();
                    renderStudentSubmissions();
                } else {
                    clearOrganizerRevertSelection();
                    renderOrganizerActivities();
                }

                updateStats();
                showLoading(false);
                alert(`üîÑ Revert ${totalCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);

            } catch (error) {
                console.error('Bulk revert error:', error);
                showLoading(false);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        // ============================================
        // REJECT DUPLICATES (with confirmation)
        // ============================================
        async function confirmRejectDuplicates() {
            const duplicates = studentSubmissions.filter(s =>
                s.status?.toLowerCase().includes('pending') && s._alreadyInParticipation
            );

            if (duplicates.length === 0) {
                alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥');
                return;
            }

            // Build summary for confirmation
            const summary = duplicates.slice(0, 10).map(d =>
                `‚Ä¢ ${d.studentName || d.studentId} ‚Üí "${d.activityName}" (‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö: "${d._matchedParticipation?.activityName || '-'}")`
            ).join('\n');
            const moreText = duplicates.length > 10 ? `\n... ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${duplicates.length - 10} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£` : '';

            const confirmed = confirm(
                `üîÑ ‡∏û‡∏ö ${duplicates.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î\n\n` +
                `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò:\n${summary}${moreText}\n\n` +
                `‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: "‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß"\n\n` +
                `‡∏Å‡∏î OK ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î`
            );

            if (!confirmed) return;

            const reason = '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß';
            const totalCount = duplicates.length;
            showLoading(true, `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò ${totalCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥...`);

            try {
                const batch = db.batch();
                duplicates.forEach(d => {
                    const ref = db.collection('submissions').doc(d.id);
                    batch.update(ref, {
                        status: 'Rejected',
                        rejectReason: reason,
                        reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                await batch.commit();

                // Update local state
                duplicates.forEach(d => {
                    const index = studentSubmissions.findIndex(s => s.id === d.id);
                    if (index !== -1) {
                        studentSubmissions[index].status = 'Rejected';
                        studentSubmissions[index].rejectReason = reason;
                        studentSubmissions[index]._alreadyInParticipation = false;
                    }
                });

                updateStats();
                renderStudentSubmissions();
                showLoading(false);
                alert(`‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò ${totalCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
            } catch (error) {
                console.error('Reject duplicates error:', error);
                showLoading(false);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        // ============================================
        // BULK APPROVE LINKEDIN LEARNING
        // ============================================
        async function confirmBulkApproveLinkedIn() {
            const linkedInItems = studentSubmissions.filter(s =>
                s.status?.toLowerCase().includes('pending') && isLikelyLinkedInLearning(s)
            );

            if (linkedInItems.length === 0) {
                alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ LinkedIn Learning');
                return;
            }

            const summary = linkedInItems.slice(0, 10).map(d =>
                `‚Ä¢ ${d.studentName || d.studentId} ‚Üí "${d.activityName}"`
            ).join('\n');
            const moreText = linkedInItems.length > 10 ? `\n... ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${linkedInItems.length - 10} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£` : '';

            const confirmed = confirm(
                `üîó ‡∏û‡∏ö ${linkedInItems.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ LinkedIn Learning\n\n` +
                `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:\n${summary}${moreText}\n\n` +
                `‡∏ó‡∏±‡∏Å‡∏©‡∏∞: 4.1 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ (Learning Agility) Lv.1\n\n` +
                `‡∏Å‡∏î OK ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î`
            );

            if (!confirmed) return;

            const skills = [{
                code: '4.1',
                level: 1,
                nameTh: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ',
                nameEn: 'Learning Agility'
            }];

            const totalCount = linkedInItems.length;
            showLoading(true, `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ${totalCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ LinkedIn Learning...`);

            try {
                const batch = db.batch();

                for (const item of linkedInItems) {
                    const ref = db.collection('submissions').doc(item.id);
                    batch.update(ref, {
                        status: 'Approved',
                        approvedSkills: skills,
                        approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Create participation record
                    if (item.studentId) {
                        const participationRef = db.collection('participation').doc();
                        batch.set(participationRef, {
                            studentId: item.studentId,
                            activityName: item.activityName,
                            status: 'Approved',
                            date: item.startDate || '',
                            skills: skills,
                            source: 'student-submission-linkedin-bulk',
                            addedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }

                await batch.commit();

                // Update local state
                linkedInItems.forEach(item => {
                    const index = studentSubmissions.findIndex(s => s.id === item.id);
                    if (index !== -1) {
                        studentSubmissions[index].status = 'Approved';
                        studentSubmissions[index].approvedSkills = skills;
                    }
                });

                updateStats();
                renderStudentSubmissions();
                showLoading(false);
                alert(`‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ${totalCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ LinkedIn Learning ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (4.1 Lv.1)`);
            } catch (error) {
                console.error('Bulk approve LinkedIn error:', error);
                showLoading(false);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        // ============================================
        // RENDER STUDENT SUBMISSIONS
        // ============================================
        function renderStudentSubmissions() {
            const container = document.getElementById('student-submissions-list');

            let filtered = studentSubmissions;
            // Status filter
            if (studentFilter !== 'all') {
                filtered = filtered.filter(s => {
                    const status = s.status?.toLowerCase() || '';
                    if (studentFilter === 'pending') return status.includes('pending');
                    if (studentFilter === 'approved') return status === 'approved';
                    if (studentFilter === 'rejected') return status.includes('rejected');
                    if (studentFilter === 'duplicate') return status.includes('pending') && s._alreadyInParticipation;
                    if (studentFilter === 'linkedin') return status.includes('pending') && isLikelyLinkedInLearning(s);
                    return true;
                });
            }
            // Activity name text filter
            if (studentActivitySearch) {
                filtered = filtered.filter(s =>
                    (s.activityName || '').toLowerCase().includes(studentActivitySearch)
                );
            }
            // Reject reason text filter
            if (studentRejectReasonSearch) {
                filtered = filtered.filter(s =>
                    (s.rejectReason || '').toLowerCase().includes(studentRejectReasonSearch)
                );
            }
            // Update count label
            const countEl = document.getElementById('student-filter-count');
            if (countEl) {
                countEl.textContent = (studentActivitySearch || studentRejectReasonSearch) ? `${filtered.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£` : '';
            }
            // Update reject reason count
            const rejectCountEl = document.getElementById('student-reject-reason-count');
            if (rejectCountEl) {
                rejectCountEl.textContent = studentRejectReasonSearch ? `${filtered.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£` : '';
            }

            // Show/hide reject reason search bar
            const isRejectedFilter = studentFilter === 'rejected';
            document.getElementById('student-reject-reason-filter').style.display = isRejectedFilter ? 'flex' : 'none';

            // Show/hide bulk actions based on pending items
            const isDuplicateFilter = studentFilter === 'duplicate';
            const isLinkedInFilter = studentFilter === 'linkedin';
            const hasPending = filtered.some(s => s.status?.toLowerCase().includes('pending'));
            document.getElementById('student-bulk-actions').style.display = (hasPending && !isDuplicateFilter && !isLinkedInFilter) ? 'flex' : 'none';

            // Show/hide duplicate actions
            document.getElementById('student-duplicate-actions').style.display = isDuplicateFilter ? 'flex' : 'none';
            if (isDuplicateFilter) {
                document.getElementById('student-duplicate-count').textContent = `${filtered.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î`;
            }

            // Show/hide LinkedIn actions
            document.getElementById('student-linkedin-actions').style.display = isLinkedInFilter ? 'flex' : 'none';
            if (isLinkedInFilter) {
                document.getElementById('student-linkedin-count').textContent = `${filtered.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ LinkedIn Learning`;
            }

            // Show/hide bulk revert actions based on rejected items
            const hasRejected = filtered.some(s => s.status?.toLowerCase().includes('rejected'));
            document.getElementById('student-bulk-revert-actions').style.display = (isRejectedFilter && hasRejected) ? 'flex' : 'none';

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="icon">üì≠</span>
                        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(item => {
                const statusClass = getStatusClass(item.status);
                const statusText = getStatusText(item.status);
                const date = item.submittedAt?.toDate?.() || new Date();
                const isPending = item.status?.toLowerCase().includes('pending');
                const isRejected = item.status?.toLowerCase().includes('rejected');
                const isSelected = isPending ? selectedStudentItems.has(item.id) : (isRejected ? selectedStudentRevertItems.has(item.id) : false);
                const isSelectable = isPending || isRejected;

                // Duplicate badge
                const isDuplicate = item._alreadyInParticipation;
                const duplicateBadgeHtml = isDuplicate
                    ? `<span style="display:inline-block;background:#e67e22;color:white;font-size:0.7em;padding:2px 8px;border-radius:10px;margin-left:6px;">üîÑ ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>`
                    : '';

                // LinkedIn Learning badge
                const isLinkedIn = isLikelyLinkedInLearning(item);
                const linkedInBadgeHtml = isLinkedIn
                    ? `<span style="display:inline-block;background:#0077b5;color:white;font-size:0.7em;padding:2px 8px;border-radius:10px;margin-left:6px;">üîó LinkedIn Learning</span>`
                    : '';

                // AI suggested skills preview
                const aiSkills = item.aiSuggestedSkills || [];
                const aiSkillsHtml = aiSkills.length > 0
                    ? `<div class="ai-skills-preview">
                        <span class="ai-skills-label">AI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</span>
                        ${aiSkills.slice(0, 3).map(s => {
                            const c = CRITERIA_LIST.find(cr => cr.code === s.code);
                            return `<span class="ai-skill-tag">${s.code} ${c?.nameTh || ''} Lv.${s.level}</span>`;
                        }).join('')}
                        ${aiSkills.length > 3 ? `<span class="ai-skill-tag" style="background:#e0e0e0;color:#666;">+${aiSkills.length - 3}</span>` : ''}
                       </div>`
                    : '';

                // Matched participation info
                const matchInfoHtml = isDuplicate && item._matchedParticipation
                    ? `<div style="margin-top:4px;font-size:0.82em;color:#e67e22;background:#fff3e0;padding:4px 8px;border-radius:6px;border-left:3px solid #e67e22;">
                        üîÑ ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö: "${item._matchedParticipation.activityName}" (${item._matchedParticipation.source || 'organizer'})
                       </div>`
                    : '';

                // Reject reason preview
                const rejectReasonHtml = isRejected && item.rejectReason
                    ? `<div class="reject-reason-preview" style="margin-top:4px;font-size:0.85em;color:#e74c3c;background:#ffeaea;padding:4px 8px;border-radius:6px;border-left:3px solid #e74c3c;">
                        üìù ${item.rejectReason}
                       </div>`
                    : '';

                // Checkbox logic
                let checkboxHtml = '';
                if (isPending) {
                    checkboxHtml = `<input type="checkbox" class="submission-checkbox" data-id="${item.id}" data-type="student" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleStudentSelection('${item.id}')">`;
                } else if (isRejected && isRejectedFilter) {
                    checkboxHtml = `<input type="checkbox" class="submission-checkbox revert-checkbox" data-id="${item.id}" data-type="student-revert" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleStudentRevertSelection('${item.id}')">`;
                }

                return `
                    <div class="submission-card ${isSelectable ? 'selectable' : ''} ${isSelected ? 'selected' : ''}">
                        ${checkboxHtml}
                        <div class="card-content" onclick="showStudentDetail('${item.id}')">
                            <div class="submission-main">
                                <h4>${item.activityName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}${duplicateBadgeHtml}${linkedInBadgeHtml}</h4>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                            <div class="submission-info">
                                <span>üë§ ${item.studentName || '-'} (${item.studentId || '-'})</span>
                                <span>üìÖ ${item.startDate || '-'}</span>
                                <span>üìä Level ${item.activityLevel || '-'}</span>
                            </div>
                            ${aiSkillsHtml}
                            ${matchInfoHtml}
                            ${rejectReasonHtml}
                            <div class="submission-date">
                                ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${date.toLocaleDateString('th-TH')} ${date.toLocaleTimeString('th-TH')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            updateStudentSelectedCount();
        }

        // ============================================
        // RENDER ORGANIZER ACTIVITIES
        // ============================================
        function renderOrganizerActivities() {
            const container = document.getElementById('organizer-activities-list');

            let filtered = organizerActivities;
            // Status filter
            if (organizerFilter !== 'all') {
                filtered = filtered.filter(a => {
                    const status = a.status?.toLowerCase() || '';
                    if (organizerFilter === 'pending') return status === 'pending';
                    if (organizerFilter === 'approved') return status === 'approved';
                    if (organizerFilter === 'rejected') return status.includes('rejected');
                    return true;
                });
            }
            // Activity name text filter
            if (organizerActivitySearch) {
                filtered = filtered.filter(a =>
                    (a.activityName || '').toLowerCase().includes(organizerActivitySearch)
                );
            }
            // Reject reason text filter
            if (organizerRejectReasonSearch) {
                filtered = filtered.filter(a =>
                    (a.rejectReason || '').toLowerCase().includes(organizerRejectReasonSearch)
                );
            }
            // Update count label
            const countEl = document.getElementById('organizer-filter-count');
            if (countEl) {
                countEl.textContent = (organizerActivitySearch || organizerRejectReasonSearch) ? `${filtered.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£` : '';
            }
            // Update reject reason count
            const rejectCountEl2 = document.getElementById('organizer-reject-reason-count');
            if (rejectCountEl2) {
                rejectCountEl2.textContent = organizerRejectReasonSearch ? `${filtered.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£` : '';
            }

            // Show/hide reject reason search bar
            const isOrgRejectedFilter = organizerFilter === 'rejected';
            document.getElementById('organizer-reject-reason-filter').style.display = isOrgRejectedFilter ? 'flex' : 'none';

            // Show/hide bulk actions based on pending items
            const hasPending = filtered.some(a => a.status?.toLowerCase() === 'pending');
            document.getElementById('organizer-bulk-actions').style.display = hasPending ? 'flex' : 'none';

            // Show/hide bulk revert actions based on rejected items
            const hasRejected = filtered.some(a => a.status?.toLowerCase().includes('rejected'));
            document.getElementById('organizer-bulk-revert-actions').style.display = (isOrgRejectedFilter && hasRejected) ? 'flex' : 'none';

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="icon">üì≠</span>
                        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(item => {
                const statusClass = getStatusClass(item.status);
                const statusText = getStatusText(item.status);
                const isPending = item.status?.toLowerCase() === 'pending';
                const isRejected = item.status?.toLowerCase().includes('rejected');
                const isSelected = isPending ? selectedOrganizerItems.has(item.id) : (isRejected ? selectedOrganizerRevertItems.has(item.id) : false);
                const isSelectable = isPending || isRejected;

                // Get participant count from different possible fields
                const participantCount = item.studentCount ||
                                        (item.studentIds?.length) ||
                                        (item.studentEmails?.length) ||
                                        (item.participants?.length) || 0;

                // Get date from different possible fields
                const activityDate = item.activityDate || item.startDate || '-';

                // AI suggested skills (from organizer's AI suggestion)
                const aiSkills = item.aiSuggestedSkills || [];
                const aiSkillsHtml = aiSkills.length > 0
                    ? `<div class="ai-skills-preview" style="margin-top: 5px;">
                        <span class="ai-skills-label">AI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</span>
                        ${aiSkills.slice(0, 3).map(s => {
                            const c = CRITERIA_LIST.find(cr => cr.code === s.code);
                            return `<span class="ai-skill-tag">${s.code} ${c?.nameTh || ''} Lv.${s.level}</span>`;
                        }).join('')}
                        ${aiSkills.length > 3 ? `<span class="ai-skill-tag" style="background:#e0e0e0;color:#666;">+${aiSkills.length - 3}</span>` : ''}
                       </div>`
                    : '';

                // Reject reason preview
                const rejectReasonHtml = isRejected && item.rejectReason
                    ? `<div class="reject-reason-preview" style="margin-top:4px;font-size:0.85em;color:#e74c3c;background:#ffeaea;padding:4px 8px;border-radius:6px;border-left:3px solid #e74c3c;">
                        üìù ${item.rejectReason}
                       </div>`
                    : '';

                // Checkbox logic
                let checkboxHtml = '';
                if (isPending) {
                    checkboxHtml = `<input type="checkbox" class="submission-checkbox" data-id="${item.id}" data-type="organizer" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleOrganizerSelection('${item.id}')">`;
                } else if (isRejected && isOrgRejectedFilter) {
                    checkboxHtml = `<input type="checkbox" class="submission-checkbox revert-checkbox" data-id="${item.id}" data-type="organizer-revert" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleOrganizerRevertSelection('${item.id}')">`;
                }

                return `
                    <div class="submission-card organizer-card ${isSelectable ? 'selectable' : ''} ${isSelected ? 'selected' : ''}">
                        ${checkboxHtml}
                        <div class="card-content" onclick="showOrganizerDetail('${item.id}')">
                            <div class="submission-main">
                                <h4>${item.activityName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</h4>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                            <div class="submission-info">
                                <span>üë®‚Äçüíº ${item.organizerName || '-'}</span>
                                <span>üìÖ ${activityDate}</span>
                                <span>üë• ${participantCount} ‡∏Ñ‡∏ô</span>
                            </div>
                            <div class="submission-skills">
                                ${(item.skills || []).slice(0, 5).map(s => `
                                    <span class="skill-mini">${s.code} Lv.${s.level}</span>
                                `).join('')}
                                ${(item.skills || []).length > 5 ? `<span class="skill-more">+${item.skills.length - 5}</span>` : ''}
                            </div>
                            ${aiSkillsHtml}
                            ${rejectReasonHtml}
                        </div>
                    </div>
                `;
            }).join('');

            updateOrganizerSelectedCount();
        }

        // ============================================
        // SHOW DETAIL MODALS
        // ============================================
        function showStudentDetail(id) {
            const item = studentSubmissions.find(s => s.id === id);
            if (!item) return;
            
            currentItem = item;
            currentType = 'student';
            
            document.getElementById('modal-title').textContent = 'üìù ' + (item.activityName || '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°');
            
            // AI suggested skills
            const aiSkills = item.aiSuggestedSkills || [];

            // Cross-reference section: show if organizer already submitted
            let crossRefHtml = '';
            if (item._alreadyInParticipation && item._matchedParticipation) {
                const mp = item._matchedParticipation;
                const mpSkillsHtml = (mp.skills || []).map(s => {
                    const c = CRITERIA_LIST.find(cr => cr.code === s.code);
                    return `<span style="display:inline-block;background:#27ae60;color:white;padding:2px 8px;border-radius:10px;font-size:0.8em;margin:2px;">${s.code} ${c?.nameTh || ''} Lv.${s.level}</span>`;
                }).join('') || '<span style="color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏±‡∏Å‡∏©‡∏∞</span>';
                crossRefHtml = `
                <div class="detail-section" style="background:#fff3e0;border:2px solid #e67e22;border-radius:12px;padding:15px;">
                    <h4 style="color:#e67e22;">üîÑ ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î</h4>
                    <div style="margin-top:8px;">
                        <div><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á:</strong> ${mp.activityName}</div>
                        <div><strong>‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤:</strong> ${mp.source || 'organizer'}</div>
                        <div style="margin-top:6px;"><strong>‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ:</strong> ${mpSkillsHtml}</div>
                    </div>
                    <p style="margin-top:10px;font-size:0.85em;color:#e67e22;">
                        ‚ö†Ô∏è ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏≠‡∏≤‡∏à‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÑ‡∏î‡πâ
                    </p>
                </div>
                `;
            }

            // LinkedIn Learning section
            let linkedInHtml = '';
            if (isLikelyLinkedInLearning(item)) {
                linkedInHtml = `
                <div class="detail-section" style="background:#e3f2fd;border:2px solid #0077b5;border-radius:12px;padding:15px;">
                    <h4 style="color:#0077b5;">üîó LinkedIn Learning / Online Course</h4>
                    <p style="font-size:0.9em;margin-top:6px;">
                        ${item.isLinkedInLearning ? '‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™ LinkedIn Learning' : '‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏ß‡πà‡∏≤‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≠‡∏£‡πå‡∏™‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)'}
                    </p>
                    <p style="font-size:0.85em;color:#0077b5;margin-top:6px;">
                        üí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏ó‡∏±‡∏Å‡∏©‡∏∞ 4.1 ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ (Learning Agility) Lv.1
                    </p>
                </div>
                `;
            }

            // Reflection section HTML
            const reflectionHtml = (item.role || item.activities || item.learnings) ? `
                <div class="detail-section">
                    <h4>üìù ‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏Ñ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h4>
                    <div class="reflection-display">
                        <div class="reflection-item">
                            <label>üë§ ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÉ‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</label>
                            <p>${item.role || '-'}</p>
                        </div>
                        <div class="reflection-item">
                            <label>‚ö° ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥:</label>
                            <p>${item.activities || '-'}</p>
                        </div>
                        <div class="reflection-item">
                            <label>üí° ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</label>
                            <p>${item.learnings || '-'}</p>
                        </div>
                    </div>
                </div>
            ` : (item.description ? `
                <div class="detail-section">
                    <h4>üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h4>
                    <p class="description-text">${item.description}</p>
                </div>
            ` : '');
            
            // AI Analysis section
            const aiAnalysisHtml = `
                <div class="detail-section">
                    <h4>ü§ñ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏±‡∏Å‡∏©‡∏∞</h4>
                    ${aiSkills.length > 0 ? `
                        <div class="ai-skills-display">
                            ${aiSkills.map(s => {
                                const criteria = CRITERIA_LIST.find(c => c.code === s.code);
                                return `<div class="ai-skill-badge">
                                    <div class="skill-main">
                                        <span class="skill-code">${s.code}</span>
                                        <span class="skill-name">${criteria?.nameTh || ''}</span>
                                        <span class="skill-level">Lv.${s.level}</span>
                                    </div>
                                    ${s.reason ? `<div class="skill-reason">üí° ${s.reason}</div>` : ''}
                                </div>`;
                            }).join('')}
                        </div>
                    ` : '<p style="color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å AI</p>'}
                </div>
            `;
            
            document.getElementById('modal-body').innerHTML = `
                <div class="detail-section">
                    <h4>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <span>${item.studentName || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                            <span>${item.studentId || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>Email</label>
                            <span>${item.studentEmail || '-'}</span>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                            <span>${item.activityName || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î</label>
                            <span>${item.activityOrganizer || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <span>${item.startDate || '-'} - ${item.endDate || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</label>
                            <span>${item.duration || '-'} ${item.durationUnit || ''}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                            <span class="activity-level-badge">Level ${item.activityLevel || '-'}</span>
                        </div>
                    </div>
                </div>

                ${crossRefHtml}
                ${linkedInHtml}

                ${reflectionHtml}

                ${item.evidenceLink ? `
                <div class="detail-section">
                    <h4>üìé ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</h4>
                    <a href="${item.evidenceLink}" target="_blank" class="evidence-link">
                        üîó ${item.evidenceDescription || '‡∏î‡∏π‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô'}
                    </a>
                </div>
                ` : ''}
                
                ${aiAnalysisHtml}
                
                <div class="detail-section">
                    <h4>üéØ ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Admin ‡∏Å‡∏≥‡∏´‡∏ô‡∏î) <span style="font-size:0.8em;color:#666;">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞</span></h4>
                    <div class="skills-editor" id="skills-editor">
                        ${renderSkillsEditor(item)}
                    </div>
                </div>
                
                <!-- AI Feedback for Research -->
                <div class="detail-section" id="ai-feedback-section" style="background:#f8f9fa;border-radius:10px;padding:15px;margin-top:15px;">
                    <h4 style="margin-bottom:10px;">üìä ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô AI (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏à‡∏±‡∏¢)</h4>
                    <div style="display:flex;gap:15px;flex-wrap:wrap;align-items:center;">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <span style="font-size:0.9em;">AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥:</span>
                            <select id="ai-accuracy-rating" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:0.9em;">
                                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                                <option value="5">5 - ‡πÅ‡∏°‡πà‡∏ô‡∏°‡∏≤‡∏Å (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ)</option>
                                <option value="4">4 - ‡πÅ‡∏°‡πà‡∏ô (‡πÅ‡∏Å‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢)</option>
                                <option value="3">3 - ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
                                <option value="2">2 - ‡πÑ‡∏°‡πà‡πÅ‡∏°‡πà‡∏ô</option>
                                <option value="1">1 - ‡∏ú‡∏¥‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            </select>
                        </label>
                        <label style="display:flex;align-items:center;gap:5px;cursor:pointer;">
                            <input type="checkbox" id="ai-modified-checkbox" style="width:18px;height:18px;">
                            <span style="font-size:0.9em;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏à‡∏≤‡∏Å AI</span>
                        </label>
                    </div>
                </div>
            `;
            
            // Footer buttons based on status
            let footerHtml = '';
            if (item.status?.toLowerCase().includes('pending')) {
                footerHtml = `
                    <button class="btn-danger" onclick="rejectItem()">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                    <button class="btn-success" onclick="approveStudentSubmission()">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                `;
            } else if (item.status?.toLowerCase().includes('rejected')) {
                footerHtml = `
                    <span class="status-badge ${getStatusClass(item.status)}">${getStatusText(item.status)}</span>
                    ${item.rejectReason ? `<span style="font-size:0.85em;color:#e74c3c;max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${item.rejectReason}">üìù ${item.rejectReason}</span>` : ''}
                    <button class="btn-warning" onclick="revertToPending('${item.id}', 'student')" style="background:linear-gradient(135deg,#f39c12,#e67e22);color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">üîÑ Revert ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                    <button class="btn-secondary" onclick="closeDetailModal()">‡∏õ‡∏¥‡∏î</button>
                `;
            } else {
                footerHtml = `
                    <span class="status-badge ${getStatusClass(item.status)}">${getStatusText(item.status)}</span>
                    <button class="btn-secondary" onclick="closeDetailModal()">‡∏õ‡∏¥‡∏î</button>
                `;
            }
            document.getElementById('modal-footer').innerHTML = footerHtml;

            document.getElementById('detail-modal').classList.add('show');
        }

        function showOrganizerDetail(id) {
            const item = organizerActivities.find(a => a.id === id);
            if (!item) return;
            
            currentItem = item;
            currentType = 'organizer';
            
            document.getElementById('modal-title').textContent = 'üë®‚Äçüíº ' + (item.activityName || '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°');
            
            // Get participant count from different possible fields
            const participantCount = item.studentCount || 
                                    (item.studentIds?.length) || 
                                    (item.studentEmails?.length) || 
                                    (item.participants?.length) || 0;
            
            // Get date from different possible fields  
            const activityDate = item.activityDate || item.startDate || '-';
            
            document.getElementById('modal-body').innerHTML = `
                <div class="detail-section">
                    <h4>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î</label>
                            <span>${item.organizerName || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                            <span>${item.department || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>Email</label>
                            <span>${item.organizerEmail || '-'}</span>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                            <span>${item.activityName || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <span>${activityDate}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</label>
                            <span>${item.duration || '-'} ${item.durationUnit || ''}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
                            <span>Level ${item.activityLevel || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</label>
                            <span>${participantCount} ‡∏Ñ‡∏ô</span>
                        </div>
                    </div>
                    <div class="detail-item full">
                        <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                        <p class="description-text">${item.description || '-'}</p>
                    </div>
                    <div class="detail-item full">
                        <label>‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label>
                        <p class="description-text">${item.learningOutcomes || '-'}</p>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>üéØ ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≥‡∏´‡∏ô‡∏î</h4>
                    <div class="skills-display" style="margin-bottom: 15px; padding: 10px; background: rgba(102,126,234,0.1); border-radius: 10px;">
                        ${(item.skills || []).map(s => `
                            <span class="skill-tag" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                ${s.code} ${s.nameTh || ''} <strong>Lv.${s.level}</strong>
                            </span>
                        `).join('') || '<span class="no-skills">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏±‡∏Å‡∏©‡∏∞</span>'}
                    </div>
                </div>
                
                ${item.status?.toLowerCase() === 'pending' ? `
                <div class="detail-section">
                    <h4>‚úèÔ∏è ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Admin ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ) <span style="font-size:0.8em;color:#666;">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞</span></h4>
                    <div class="skills-editor" id="organizer-skills-editor">
                        ${renderOrganizerSkillsEditor(item)}
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ñ‡∏∂‡∏á‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</h4>
                    <textarea id="admin-note-to-organizer" rows="3" 
                        placeholder="‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î ‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÅ‡∏•‡πâ‡∏ß, ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞..."
                        style="width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;font-family:inherit;font-size:0.95em;resize:vertical;"
                    >${item.adminNote || ''}</textarea>
                </div>
                ` : (item.adminNote ? `
                <div class="detail-section">
                    <h4>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å Admin</h4>
                    <div style="background:#f8f9fa;padding:15px;border-radius:10px;border-left:4px solid #667eea;">
                        ${item.adminNote}
                    </div>
                </div>
                ` : '')}
                
                ${item.studentIds?.length > 0 ? `
                <div class="detail-section">
                    <h4>üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (${item.studentIds.length} ‡∏Ñ‡∏ô)</h4>
                    <div class="student-ids-list">
                        ${item.studentIds.join(', ')}
                    </div>
                </div>
                ` : ''}
            `;
            
            // Footer buttons based on status
            let footerHtml = '';
            if (item.status?.toLowerCase() === 'pending') {
                footerHtml = `
                    <button class="btn-danger" onclick="rejectItem()">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                    <button class="btn-success" onclick="approveOrganizerActivity()">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                `;
            } else if (item.status?.toLowerCase().includes('rejected')) {
                footerHtml = `
                    <span class="status-badge ${getStatusClass(item.status)}">${getStatusText(item.status)}</span>
                    ${item.rejectReason ? `<span style="font-size:0.85em;color:#e74c3c;max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${item.rejectReason}">üìù ${item.rejectReason}</span>` : ''}
                    <button class="btn-warning" onclick="revertToPending('${item.id}', 'organizer')" style="background:linear-gradient(135deg,#f39c12,#e67e22);color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;">üîÑ Revert ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                    <button class="btn-secondary" onclick="closeDetailModal()">‡∏õ‡∏¥‡∏î</button>
                `;
            } else {
                footerHtml = `
                    <span class="status-badge ${getStatusClass(item.status)}">${getStatusText(item.status)}</span>
                    <button class="btn-secondary" onclick="closeDetailModal()">‡∏õ‡∏¥‡∏î</button>
                `;
            }
            document.getElementById('modal-footer').innerHTML = footerHtml;

            document.getElementById('detail-modal').classList.add('show');
        }

        function renderSkillsEditor(item) {
            const aiSkills = item.aiSuggestedSkills || [];

            // Create a map of AI suggested skills for easy lookup
            const aiSkillMap = {};
            aiSkills.forEach(s => { aiSkillMap[s.code] = s.level; });

            // Schedule initialization after DOM update
            setTimeout(() => {
                updateAdminSkillCounter();
                initSkillCheckboxListeners();
            }, 100);

            return `
                <div class="skill-limit-note" style="background:#fff3cd;padding:10px;border-radius:8px;margin-bottom:15px;font-size:0.9em;">
                    <strong>üìå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞</strong> | ‡∏£‡∏∞‡∏î‡∏±‡∏ö 1-4 (Admin ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ)
                    <span id="admin-skill-counter" style="float:right;background:#667eea;color:white;padding:2px 10px;border-radius:15px;">0/3</span>
                </div>
                <div class="skill-editor-list">
                    ${CRITERIA_LIST.map(c => {
                        const isAISuggested = aiSkillMap.hasOwnProperty(c.code);
                        const aiLevel = aiSkillMap[c.code] || 2;
                        return `
                        <div class="skill-editor-item ${isAISuggested ? 'ai-suggested' : ''}" style="${isAISuggested ? 'background:#e8f5e9;border-left:3px solid #27ae60;' : ''}">
                            <label>
                                <input type="checkbox" class="skill-checkbox" data-code="${c.code}"
                                    ${isAISuggested ? 'checked' : ''} onchange="updateAdminSkillCounter()">
                                <span>${c.code} ${c.nameTh}</span>
                                ${isAISuggested ? '<span style="background:#27ae60;color:white;padding:1px 6px;border-radius:10px;font-size:0.7em;margin-left:5px;">AI</span>' : ''}
                            </label>
                            <select class="skill-level-select" data-code="${c.code}" ${isAISuggested ? '' : 'disabled'}>
                                ${[1,2,3,4].map(l => `
                                    <option value="${l}" ${l === aiLevel && isAISuggested ? 'selected' : ''}>Lv.${l}</option>
                                `).join('')}
                            </select>
                        </div>
                    `}).join('')}
                </div>
            `;
        }
        
        // Render skills editor for organizer activities (uses organizer's skills as default)
        function renderOrganizerSkillsEditor(item) {
            const organizerSkills = item.skills || [];

            // Create a map of organizer suggested skills for easy lookup
            const organizerSkillMap = {};
            organizerSkills.forEach(s => { organizerSkillMap[s.code] = s.level; });

            // Schedule initialization after DOM update
            setTimeout(() => {
                updateOrganizerSkillCounter();
                initOrganizerSkillCheckboxListeners();
            }, 100);

            return `
                <div class="skill-limit-note" style="background:#e8f4fd;padding:10px;border-radius:8px;margin-bottom:15px;font-size:0.9em;">
                    <strong>üìå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞</strong> | ‡∏£‡∏∞‡∏î‡∏±‡∏ö 1-4 (Admin ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ)
                    <span id="organizer-skill-counter" style="float:right;background:#667eea;color:white;padding:2px 10px;border-radius:15px;">0/3</span>
                </div>
                <div class="skill-editor-list">
                    ${CRITERIA_LIST.map(c => {
                        const isOrganizerSuggested = organizerSkillMap.hasOwnProperty(c.code);
                        const suggestedLevel = organizerSkillMap[c.code] || 2;
                        return `
                        <div class="skill-editor-item organizer-skill-item ${isOrganizerSuggested ? 'organizer-suggested' : ''}" style="${isOrganizerSuggested ? 'background:#e3f2fd;border-left:3px solid #2196f3;' : ''}">
                            <label>
                                <input type="checkbox" class="organizer-skill-checkbox" data-code="${c.code}"
                                    ${isOrganizerSuggested ? 'checked' : ''} onchange="updateOrganizerSkillCounter()">
                                <span>${c.code} ${c.nameTh}</span>
                                ${isOrganizerSuggested ? '<span style="background:#2196f3;color:white;padding:1px 6px;border-radius:10px;font-size:0.7em;margin-left:5px;">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î</span>' : ''}
                            </label>
                            <select class="organizer-skill-level-select" data-code="${c.code}" ${isOrganizerSuggested ? '' : 'disabled'}>
                                ${[1,2,3,4].map(l => `
                                    <option value="${l}" ${l === suggestedLevel && isOrganizerSuggested ? 'selected' : ''}>Lv.${l}</option>
                                `).join('')}
                            </select>
                        </div>
                    `}).join('')}
                </div>
            `;
        }
        
        function initOrganizerSkillCheckboxListeners() {
            document.querySelectorAll('.organizer-skill-checkbox').forEach(cb => {
                cb.addEventListener('change', function() {
                    const levelSelect = document.querySelector('.organizer-skill-level-select[data-code="' + this.dataset.code + '"]');
                    if (levelSelect) levelSelect.disabled = !this.checked;
                });
            });
        }
        
        function updateOrganizerSkillCounter() {
            const checkedCount = document.querySelectorAll('.organizer-skill-checkbox:checked').length;
            const counter = document.getElementById('organizer-skill-counter');
            if (counter) {
                counter.textContent = checkedCount + '/3';
                counter.style.background = checkedCount > 3 ? '#e74c3c' : (checkedCount === 3 ? '#f39c12' : '#667eea');
            }
            
            // Disable unchecked checkboxes if limit reached
            if (checkedCount >= 3) {
                document.querySelectorAll('.organizer-skill-checkbox:not(:checked)').forEach(cb => {
                    cb.disabled = true;
                    cb.closest('.organizer-skill-item').style.opacity = '0.5';
                });
            } else {
                document.querySelectorAll('.organizer-skill-checkbox').forEach(cb => {
                    cb.disabled = false;
                    cb.closest('.organizer-skill-item').style.opacity = '1';
                });
            }
        }
        
        function initSkillCheckboxListeners() {
            document.querySelectorAll('.skill-checkbox').forEach(cb => {
                cb.addEventListener('change', function() {
                    const levelSelect = document.querySelector('.skill-level-select[data-code="' + this.dataset.code + '"]');
                    if (levelSelect) levelSelect.disabled = !this.checked;
                });
            });
        }
        
        function updateAdminSkillCounter() {
            const checkedCount = document.querySelectorAll('.skill-checkbox:checked').length;
            const counter = document.getElementById('admin-skill-counter');
            if (counter) {
                counter.textContent = checkedCount + '/3';
                counter.style.background = checkedCount > 3 ? '#e74c3c' : (checkedCount === 3 ? '#f39c12' : '#667eea');
            }
            
            // Disable unchecked checkboxes if limit reached
            if (checkedCount >= 3) {
                document.querySelectorAll('.skill-checkbox:not(:checked)').forEach(cb => {
                    cb.disabled = true;
                    cb.closest('.skill-editor-item').style.opacity = '0.5';
                });
            } else {
                document.querySelectorAll('.skill-checkbox').forEach(cb => {
                    cb.disabled = false;
                    cb.closest('.skill-editor-item').style.opacity = '1';
                });
            }
        }

        function closeDetailModal() {
            document.getElementById('detail-modal').classList.remove('show');
            currentItem = null;
            currentType = null;
        }

        // ============================================
        // APPROVE / REJECT FUNCTIONS
        // ============================================
        async function approveStudentSubmission() {
            if (!currentItem) return;
            
            // Get selected skills
            const skills = [];
            document.querySelectorAll('.skill-checkbox:checked').forEach(cb => {
                const code = cb.dataset.code;
                const levelSelect = document.querySelector(`.skill-level-select[data-code="${code}"]`);
                skills.push({
                    code: code,
                    level: parseInt(levelSelect.value)
                });
            });
            
            if (skills.length === 0) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞');
                return;
            }
            
            if (skills.length > 3) {
                alert('‚ö†Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞ | Maximum 3 skills allowed');
                return;
            }
            
            const itemId = currentItem.id;
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥...');
            
            try {
                // Use batch write for better performance
                const batch = db.batch();
                
                // === Research Data Collection ===
                const aiAccuracyRating = document.getElementById('ai-accuracy-rating')?.value || null;
                const adminModified = document.getElementById('ai-modified-checkbox')?.checked || false;
                
                // Compare AI suggestions with approved skills
                const aiSkills = currentItem.aiSuggestedSkills || [];
                const aiSkillCodes = aiSkills.map(s => s.code);
                const approvedSkillCodes = skills.map(s => s.code);
                
                // Calculate skill match
                const matchedSkills = approvedSkillCodes.filter(code => aiSkillCodes.includes(code));
                const skillMatchRate = aiSkillCodes.length > 0 ? (matchedSkills.length / aiSkillCodes.length) : 0;
                
                // Calculate level accuracy
                let levelMatchCount = 0;
                skills.forEach(approved => {
                    const aiSkill = aiSkills.find(ai => ai.code === approved.code);
                    if (aiSkill && aiSkill.level === approved.level) {
                        levelMatchCount++;
                    }
                });
                const levelMatchRate = matchedSkills.length > 0 ? (levelMatchCount / matchedSkills.length) : 0;
                
                // 1. Update submission status with research data
                const submissionRef = db.collection('submissions').doc(itemId);
                batch.update(submissionRef, {
                    status: 'Approved',
                    approvedSkills: skills,
                    reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    '_research.adminReview': {
                        aiAccuracyRating: aiAccuracyRating ? parseInt(aiAccuracyRating) : null,
                        adminModifiedSkills: adminModified,
                        skillMatchRate: skillMatchRate,
                        levelMatchRate: levelMatchRate,
                        matchedSkillCount: matchedSkills.length,
                        aiSkillCount: aiSkillCodes.length,
                        approvedSkillCount: approvedSkillCodes.length,
                        reviewTimestamp: new Date().toISOString()
                    }
                });
                
                // 2. Add to participation
                const participationRef = db.collection('participation').doc();
                batch.set(participationRef, {
                    studentId: currentItem.studentId,
                    activityName: currentItem.activityName,
                    status: 'Approved',
                    date: currentItem.startDate,
                    skills: skills,
                    source: 'student-submission',
                    addedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 3. Check existing activity (single query)
                const existingActivity = await db.collection('activities')
                    .where('name', '==', currentItem.activityName)
                    .limit(1)
                    .get();
                
                if (existingActivity.empty) {
                    // Add new activity
                    const activityRef = db.collection('activities').doc();
                    batch.set(activityRef, {
                        name: currentItem.activityName,
                        level: currentItem.activityLevel,
                        organizer: currentItem.activityOrganizer || '',
                        date: currentItem.startDate || '',
                        description: currentItem.description || '',
                        skills: skills,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    // Update existing activity skills if empty
                    const existingData = existingActivity.docs[0].data();
                    if (!existingData.skills || existingData.skills.length === 0) {
                        batch.update(existingActivity.docs[0].ref, { skills: skills });
                    }
                }
                
                // Commit all operations at once
                await batch.commit();
                
                // Update local state instead of reloading all data
                const index = studentSubmissions.findIndex(s => s.id === itemId);
                if (index !== -1) {
                    studentSubmissions[index].status = 'Approved';
                    studentSubmissions[index].approvedSkills = skills;
                }
                
                // Update UI
                updateStats();
                renderStudentSubmissions();
                
                closeDetailModal();
                showLoading(false);
                
                alert('‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß | Approved successfully');
                
            } catch (error) {
                console.error('Approve error:', error);
                showLoading(false);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        async function approveOrganizerActivity() {
            if (!currentItem) return;
            
            // Get selected skills from editor
            const skills = [];
            document.querySelectorAll('.organizer-skill-checkbox:checked').forEach(cb => {
                const code = cb.dataset.code;
                const levelSelect = document.querySelector(`.organizer-skill-level-select[data-code="${code}"]`);
                const criteria = CRITERIA_LIST.find(c => c.code === code);
                skills.push({
                    code: code,
                    level: parseInt(levelSelect.value),
                    nameTh: criteria?.nameTh || '',
                    nameEn: criteria?.nameEn || ''
                });
            });
            
            if (skills.length === 0) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞');
                return;
            }
            
            if (skills.length > 3) {
                alert('‚ö†Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞ | Maximum 3 skills allowed');
                return;
            }
            
            // Get admin note
            const adminNote = document.getElementById('admin-note-to-organizer')?.value?.trim() || '';
            
            const studentIds = currentItem.studentIds || [];
            const itemId = currentItem.id;
            showLoading(true, `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥... (${studentIds.length} ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤)`);
            
            try {
                // Use batch write for better performance
                const batch = db.batch();
                
                // 1. Update organizerActivities status
                const orgActivityRef = db.collection('organizerActivities').doc(itemId);
                batch.update(orgActivityRef, {
                    status: 'Approved',
                    approvedSkills: skills,
                    originalSkills: currentItem.skills || [],
                    adminNote: adminNote,
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 2. Check if activity exists (single query)
                const existingActivity = await db.collection('activities')
                    .where('name', '==', currentItem.activityName)
                    .limit(1)
                    .get();
                
                if (existingActivity.empty) {
                    // Add new activity
                    const newActivityRef = db.collection('activities').doc();
                    batch.set(newActivityRef, {
                        name: currentItem.activityName,
                        organizer: currentItem.organizerName || currentItem.department || '',
                        date: currentItem.activityDate || currentItem.startDate || '',
                        level: currentItem.activityLevel || 2,
                        description: currentItem.description || '',
                        skills: skills,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    // Update existing activity
                    batch.update(existingActivity.docs[0].ref, { skills: skills });
                }
                
                // 3. Get existing participation records in one query
                let existingParticipation = new Set();
                if (studentIds.length > 0) {
                    const participationQuery = await db.collection('participation')
                        .where('activityName', '==', currentItem.activityName)
                        .get();
                    participationQuery.forEach(doc => {
                        existingParticipation.add(doc.data().studentId);
                    });
                }
                
                // 4. Add participation for new students only (batch)
                let addedCount = 0;
                for (const studentId of studentIds) {
                    if (!existingParticipation.has(studentId)) {
                        const newParticipationRef = db.collection('participation').doc();
                        batch.set(newParticipationRef, {
                            studentId: studentId,
                            activityName: currentItem.activityName,
                            status: 'Approved',
                            date: currentItem.activityDate || currentItem.startDate || '',
                            skills: skills,
                            source: 'organizer',
                            addedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        addedCount++;
                    }
                }
                
                // Commit all operations at once
                await batch.commit();
                
                // Update local state instead of reloading all data
                const index = organizerActivities.findIndex(a => a.id === itemId);
                if (index !== -1) {
                    organizerActivities[index].status = 'Approved';
                    organizerActivities[index].approvedSkills = skills;
                    organizerActivities[index].adminNote = adminNote;
                }
                
                // Update UI
                updateStats();
                renderOrganizerActivities();
                
                closeDetailModal();
                showLoading(false);
                
                alert(`‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!\n\nüìä ‡πÄ‡∏û‡∏¥‡πà‡∏° ${addedCount} ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÉ‡∏ô participation\n‚è≠Ô∏è ‡∏Ç‡πâ‡∏≤‡∏° ${studentIds.length - addedCount} ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`);
                
            } catch (error) {
                console.error('Approve error:', error);
                showLoading(false);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        function rejectItem() {
            document.getElementById('reject-reason').value = '';
            document.getElementById('reject-modal').classList.add('show');
        }

        function closeRejectModal() {
            document.getElementById('reject-modal').classList.remove('show');
        }

        async function confirmReject() {
            const reason = document.getElementById('reject-reason').value.trim();
            
            if (!reason) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•');
                return;
            }
            
            const itemId = currentItem.id;
            const itemType = currentType;
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò...');
            
            try {
                const collection = itemType === 'student' ? 'submissions' : 'organizerActivities';
                
                await db.collection(collection).doc(itemId).update({
                    status: 'Rejected',
                    rejectReason: reason,
                    reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local state instead of reloading all data
                if (itemType === 'student') {
                    const index = studentSubmissions.findIndex(s => s.id === itemId);
                    if (index !== -1) {
                        studentSubmissions[index].status = 'Rejected';
                        studentSubmissions[index].rejectReason = reason;
                    }
                    renderStudentSubmissions();
                } else {
                    const index = organizerActivities.findIndex(a => a.id === itemId);
                    if (index !== -1) {
                        organizerActivities[index].status = 'Rejected';
                        organizerActivities[index].rejectReason = reason;
                    }
                    renderOrganizerActivities();
                }
                
                // Update stats
                updateStats();
                
                closeRejectModal();
                closeDetailModal();
                showLoading(false);
                
                alert('‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                
            } catch (error) {
                console.error('Reject error:', error);
                showLoading(false);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        // ============================================
        // BULK SELECTION FUNCTIONS
        // ============================================
        
        function toggleStudentSelection(id) {
            if (selectedStudentItems.has(id)) {
                selectedStudentItems.delete(id);
            } else {
                selectedStudentItems.add(id);
            }
            updateStudentSelectedCount();
            renderStudentSubmissions();
        }
        
        function toggleOrganizerSelection(id) {
            if (selectedOrganizerItems.has(id)) {
                selectedOrganizerItems.delete(id);
            } else {
                selectedOrganizerItems.add(id);
            }
            updateOrganizerSelectedCount();
            renderOrganizerActivities();
        }
        
        function toggleSelectAllStudent() {
            const pendingItems = studentSubmissions.filter(s => s.status?.toLowerCase().includes('pending'));
            const allSelected = pendingItems.every(s => selectedStudentItems.has(s.id));
            
            if (allSelected) {
                selectedStudentItems.clear();
            } else {
                pendingItems.forEach(s => selectedStudentItems.add(s.id));
            }
            updateStudentSelectedCount();
            renderStudentSubmissions();
        }
        
        function toggleSelectAllOrganizer() {
            const pendingItems = organizerActivities.filter(a => a.status?.toLowerCase() === 'pending');
            const allSelected = pendingItems.every(a => selectedOrganizerItems.has(a.id));
            
            if (allSelected) {
                selectedOrganizerItems.clear();
            } else {
                pendingItems.forEach(a => selectedOrganizerItems.add(a.id));
            }
            updateOrganizerSelectedCount();
            renderOrganizerActivities();
        }
        
        function clearStudentSelection() {
            selectedStudentItems.clear();
            document.getElementById('student-select-all').checked = false;
            updateStudentSelectedCount();
            renderStudentSubmissions();
        }
        
        function clearOrganizerSelection() {
            selectedOrganizerItems.clear();
            document.getElementById('organizer-select-all').checked = false;
            updateOrganizerSelectedCount();
            renderOrganizerActivities();
        }
        
        function updateStudentSelectedCount() {
            document.getElementById('student-selected-count').textContent = `${selectedStudentItems.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        }
        
        function updateOrganizerSelectedCount() {
            document.getElementById('organizer-selected-count').textContent = `${selectedOrganizerItems.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        }

        // ============================================
        // BULK REJECT FUNCTIONS
        // ============================================
        
        function openBulkRejectModal(type) {
            bulkType = type;
            const selectedIds = type === 'student' ? selectedStudentItems : selectedOrganizerItems;
            const items = type === 'student' ? studentSubmissions : organizerActivities;
            
            if (selectedIds.size === 0) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }
            
            // Populate list with AI skills info
            const listHtml = Array.from(selectedIds).map(id => {
                const item = items.find(i => i.id === id);
                const aiSkills = item?.aiSuggestedSkills || [];
                const aiHtml = aiSkills.length > 0
                    ? `<div style="margin-top:3px;display:flex;flex-wrap:wrap;gap:3px;">
                        ${aiSkills.slice(0, 3).map(s => {
                            const c = CRITERIA_LIST.find(cr => cr.code === s.code);
                            return `<span style="background:#fff3e0;color:#e65100;padding:1px 5px;border-radius:8px;font-size:0.7em;">ü§ñ ${s.code} ${c?.nameTh || ''} Lv.${s.level}</span>`;
                        }).join('')}
                       </div>`
                    : '';
                return `<div class="bulk-modal-item">üìù ${item?.activityName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}${aiHtml}</div>`;
            }).join('');

            document.getElementById('bulk-reject-list').innerHTML = listHtml;
            document.getElementById('bulk-reject-count').textContent = selectedIds.size;
            document.getElementById('bulk-reject-reason').value = '';
            document.getElementById('bulk-reject-modal').classList.add('show');
        }
        
        function closeBulkRejectModal() {
            document.getElementById('bulk-reject-modal').classList.remove('show');
        }
        
        async function confirmBulkReject() {
            const reason = document.getElementById('bulk-reject-reason').value.trim();

            if (!reason) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•');
                return;
            }

            const selectedIds = bulkType === 'student' ? selectedStudentItems : selectedOrganizerItems;
            const totalCount = selectedIds.size; // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô clear
            const collection = bulkType === 'student' ? 'submissions' : 'organizerActivities';

            showLoading(true, `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò ${totalCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...`);
            
            try {
                const batch = db.batch();
                
                selectedIds.forEach(id => {
                    const ref = db.collection(collection).doc(id);
                    batch.update(ref, {
                        status: 'Rejected',
                        rejectReason: reason,
                        reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                
                await batch.commit();
                
                // Update local state
                if (bulkType === 'student') {
                    selectedIds.forEach(id => {
                        const index = studentSubmissions.findIndex(s => s.id === id);
                        if (index !== -1) {
                            studentSubmissions[index].status = 'Rejected';
                            studentSubmissions[index].rejectReason = reason;
                        }
                    });
                    clearStudentSelection();
                    renderStudentSubmissions();
                } else {
                    selectedIds.forEach(id => {
                        const index = organizerActivities.findIndex(a => a.id === id);
                        if (index !== -1) {
                            organizerActivities[index].status = 'Rejected';
                            organizerActivities[index].rejectReason = reason;
                        }
                    });
                    clearOrganizerSelection();
                    renderOrganizerActivities();
                }
                
                updateStats();
                closeBulkRejectModal();
                showLoading(false);
                
                alert(`‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò ${totalCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
                
            } catch (error) {
                console.error('Bulk reject error:', error);
                showLoading(false);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        // ============================================
        // BULK APPROVE FUNCTIONS
        // ============================================

        function setBulkApproveMode(mode) {
            bulkApproveMode = mode;
            const sameBtn = document.getElementById('bulk-mode-same');
            const indBtn = document.getElementById('bulk-mode-individual');
            const sameSection = document.getElementById('bulk-skills-same-section');
            const indSection = document.getElementById('bulk-skills-individual-section');

            if (mode === 'same') {
                sameBtn.style.border = '2px solid #27ae60';
                sameBtn.style.background = '#e8f5e9';
                sameBtn.style.color = '#27ae60';
                indBtn.style.border = '2px solid #ddd';
                indBtn.style.background = 'white';
                indBtn.style.color = '#666';
                sameSection.style.display = 'block';
                indSection.style.display = 'none';
            } else {
                indBtn.style.border = '2px solid #ff9800';
                indBtn.style.background = '#fff8e1';
                indBtn.style.color = '#e65100';
                sameBtn.style.border = '2px solid #ddd';
                sameBtn.style.background = 'white';
                sameBtn.style.color = '#666';
                sameSection.style.display = 'none';
                indSection.style.display = 'block';
            }
        }

        function openBulkApproveModal(type) {
            bulkType = type;
            const selectedIds = type === 'student' ? selectedStudentItems : selectedOrganizerItems;
            const items = type === 'student' ? studentSubmissions : organizerActivities;
            
            if (selectedIds.size === 0) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }
            
            // Collect AI suggested skills across all selected items
            const aiSkillFrequency = {};
            const aiSkillMaxLevel = {};

            // Populate list with AI skills summary per item
            const listHtml = Array.from(selectedIds).map(id => {
                const item = items.find(i => i.id === id);
                const aiSkills = item?.aiSuggestedSkills || [];

                // Aggregate AI skills frequency
                aiSkills.forEach(s => {
                    aiSkillFrequency[s.code] = (aiSkillFrequency[s.code] || 0) + 1;
                    aiSkillMaxLevel[s.code] = Math.max(aiSkillMaxLevel[s.code] || 0, s.level);
                });

                const aiHtml = aiSkills.length > 0
                    ? `<div style="margin-top:4px;display:flex;flex-wrap:wrap;gap:3px;">
                        ${aiSkills.slice(0, 3).map(s => {
                            const c = CRITERIA_LIST.find(cr => cr.code === s.code);
                            return `<span style="background:#fff3e0;color:#e65100;padding:1px 6px;border-radius:8px;font-size:0.7em;">ü§ñ ${s.code} ${c?.nameTh || ''} Lv.${s.level}</span>`;
                        }).join('')}
                        ${aiSkills.length > 3 ? `<span style="background:#e0e0e0;color:#666;padding:1px 6px;border-radius:8px;font-size:0.7em;">+${aiSkills.length - 3}</span>` : ''}
                       </div>`
                    : '';

                return `<div class="bulk-modal-item">üìù ${item?.activityName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}${aiHtml}</div>`;
            }).join('');

            // Build AI summary section
            const sortedAiSkills = Object.entries(aiSkillFrequency)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const aiSummaryHtml = sortedAiSkills.length > 0
                ? `<div style="margin-top:12px;padding:10px;background:#fff8e1;border-radius:8px;border-left:3px solid #ff9800;">
                    <strong style="font-size:0.85em;">ü§ñ ‡∏™‡∏£‡∏∏‡∏õ AI ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£):</strong>
                    <div style="display:flex;flex-wrap:wrap;gap:5px;margin-top:6px;">
                        ${sortedAiSkills.map(([code, count]) => {
                            const c = CRITERIA_LIST.find(cr => cr.code === code);
                            return `<span style="background:#fff3e0;color:#e65100;padding:3px 8px;border-radius:10px;font-size:0.8em;cursor:pointer;"
                                onclick="document.getElementById('bulk-skill-${code}').click()" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å">
                                ü§ñ ${code} ${c?.nameTh || ''} (${count}/${selectedIds.size}‡∏Ñ‡∏£‡∏±‡πâ‡∏á, max Lv.${aiSkillMaxLevel[code]})
                            </span>`;
                        }).join('')}
                    </div>
                   </div>`
                : '';

            document.getElementById('bulk-approve-list').innerHTML = listHtml + aiSummaryHtml;
            document.getElementById('bulk-approve-count').textContent = selectedIds.size;

            // Populate skills grid
            const grid = document.getElementById('bulk-skills-grid');
            grid.innerHTML = CRITERIA_LIST.map(c => {
                const freq = aiSkillFrequency[c.code] || 0;
                const isAiRecommended = freq > 0;
                const highlightStyle = isAiRecommended ? 'background:#e8f5e9;border:1px solid #a5d6a7;' : 'background:white;border:1px solid #eee;';
                const aiLabel = isAiRecommended ? `<span style="background:#ff9800;color:white;padding:0 4px;border-radius:4px;font-size:0.65em;margin-left:3px;">AI√ó${freq}</span>` : '';
                return `
                <div style="display:flex; align-items:center; gap:5px; ${highlightStyle} padding:8px; border-radius:6px;">
                    <input type="checkbox" class="bulk-skill-cb" data-code="${c.code}" id="bulk-skill-${c.code}">
                    <label for="bulk-skill-${c.code}" style="flex:1; font-size:0.8em; cursor:pointer;">
                        <strong>${c.code}</strong> ${c.nameTh}${aiLabel}
                    </label>
                    <select class="bulk-skill-level" data-code="${c.code}" disabled style="width:50px; padding:2px;">
                        <option value="1">1</option>
                        <option value="2" ${!isAiRecommended ? 'selected' : ''}>2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                </div>`;
            }).join('');

            // Pre-select AI recommended level for highlighted skills
            Object.entries(aiSkillMaxLevel).forEach(([code, level]) => {
                const sel = grid.querySelector(`.bulk-skill-level[data-code="${code}"]`);
                if (sel) sel.value = level;
            });
            
            // Add event listeners for checkboxes
            grid.querySelectorAll('.bulk-skill-cb').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const code = e.target.dataset.code;
                    const levelSelect = grid.querySelector(`.bulk-skill-level[data-code="${code}"]`);
                    levelSelect.disabled = !e.target.checked;
                    
                    // Check max 3 skills
                    const checkedCount = grid.querySelectorAll('.bulk-skill-cb:checked').length;
                    if (checkedCount > 3) {
                        e.target.checked = false;
                        levelSelect.disabled = true;
                        alert('‚ö†Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞');
                    }
                });
            });
            
            // Populate individual preview
            let hasItemWithoutSkills = false;
            const individualPreview = document.getElementById('bulk-individual-preview');
            individualPreview.innerHTML = Array.from(selectedIds).map(id => {
                const item = items.find(i => i.id === id);
                // For student: use aiSuggestedSkills; for organizer: prefer skills (organizer-set), fallback to aiSuggestedSkills
                const itemSkills = type === 'student'
                    ? (item?.aiSuggestedSkills || [])
                    : (item?.skills?.length > 0 ? item.skills : (item?.aiSuggestedSkills || []));
                const source = type === 'student'
                    ? 'AI'
                    : (item?.skills?.length > 0 ? '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î' : (item?.aiSuggestedSkills?.length > 0 ? 'AI' : ''));

                if (itemSkills.length === 0) hasItemWithoutSkills = true;

                const skillTags = itemSkills.slice(0, 3).map(s => {
                    const c = CRITERIA_LIST.find(cr => cr.code === s.code);
                    return `<span style="background:#e8f5e9;color:#2e7d32;padding:2px 6px;border-radius:8px;font-size:0.75em;">${s.code} ${c?.nameTh || ''} Lv.${s.level}</span>`;
                }).join(' ');

                const noSkillMsg = itemSkills.length === 0
                    ? '<span style="color:#e74c3c;font-size:0.8em;">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏±‡∏Å‡∏©‡∏∞ - ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ç‡πâ‡∏≤‡∏°</span>'
                    : '';
                const sourceTag = source ? `<span style="background:#e3f2fd;color:#1565c0;padding:1px 5px;border-radius:6px;font-size:0.7em;">${source}</span>` : '';

                return `<div style="padding:8px;border-bottom:1px solid #eee;display:flex;flex-direction:column;gap:4px;">
                    <div style="display:flex;align-items:center;gap:6px;">
                        <strong style="font-size:0.85em;">${item?.activityName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</strong>
                        ${sourceTag}
                    </div>
                    <div style="display:flex;flex-wrap:wrap;gap:4px;">${skillTags || noSkillMsg}</div>
                </div>`;
            }).join('');

            document.getElementById('bulk-individual-warning').style.display = hasItemWithoutSkills ? 'block' : 'none';

            // Reset mode to 'same'
            bulkApproveMode = 'same';
            setBulkApproveMode('same');

            document.getElementById('bulk-approve-modal').classList.add('show');
        }

        function closeBulkApproveModal() {
            document.getElementById('bulk-approve-modal').classList.remove('show');
        }
        
        async function confirmBulkApprove() {
            const selectedIds = bulkType === 'student' ? selectedStudentItems : selectedOrganizerItems;
            const totalCount = selectedIds.size; // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô clear
            const items = bulkType === 'student' ? studentSubmissions : organizerActivities;
            const collection = bulkType === 'student' ? 'submissions' : 'organizerActivities';

            if (bulkApproveMode === 'same') {
                // === Mode: Same skills for all ===
                const skills = [];
                document.querySelectorAll('.bulk-skill-cb:checked').forEach(cb => {
                    const code = cb.dataset.code;
                    const levelSelect = document.querySelector(`.bulk-skill-level[data-code="${code}"]`);
                    const criteria = CRITERIA_LIST.find(c => c.code === code);
                    skills.push({
                        code: code,
                        level: parseInt(levelSelect.value),
                        nameTh: criteria?.nameTh || '',
                        nameEn: criteria?.nameEn || ''
                    });
                });

                if (skills.length === 0) {
                    alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞');
                    return;
                }

                showLoading(true, `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ${totalCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...`);

                try {
                    const batch = db.batch();

                    for (const id of selectedIds) {
                        const item = items.find(i => i.id === id);
                        if (!item) continue;

                        const ref = db.collection(collection).doc(id);
                        batch.update(ref, {
                            status: 'Approved',
                            approvedSkills: skills,
                            approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        if (bulkType === 'student') {
                            const participationRef = db.collection('participation').doc();
                            batch.set(participationRef, {
                                studentId: item.studentId,
                                activityName: item.activityName,
                                status: 'Approved',
                                date: item.startDate || '',
                                skills: skills,
                                source: 'student-submission-bulk',
                                addedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }

                        if (bulkType === 'organizer') {
                            const studentIds = item.studentIds || [];
                            for (const studentId of studentIds) {
                                const participationRef = db.collection('participation').doc();
                                batch.set(participationRef, {
                                    studentId: studentId,
                                    activityName: item.activityName,
                                    status: 'Approved',
                                    date: item.activityDate || item.startDate || '',
                                    skills: skills,
                                    source: 'organizer-bulk',
                                    addedAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }
                        }
                    }

                    await batch.commit();

                    selectedIds.forEach(id => {
                        if (bulkType === 'student') {
                            const index = studentSubmissions.findIndex(s => s.id === id);
                            if (index !== -1) {
                                studentSubmissions[index].status = 'Approved';
                                studentSubmissions[index].approvedSkills = skills;
                            }
                        } else {
                            const index = organizerActivities.findIndex(a => a.id === id);
                            if (index !== -1) {
                                organizerActivities[index].status = 'Approved';
                                organizerActivities[index].approvedSkills = skills;
                            }
                        }
                    });

                    if (bulkType === 'student') { clearStudentSelection(); renderStudentSubmissions(); }
                    else { clearOrganizerSelection(); renderOrganizerActivities(); }

                    updateStats();
                    closeBulkApproveModal();
                    showLoading(false);
                    alert(`‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ${totalCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);

                } catch (error) {
                    console.error('Bulk approve error:', error);
                    showLoading(false);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                }

            } else {
                // === Mode: Individual AI/Organizer skills ===
                showLoading(true, `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ${totalCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏à‡∏≤‡∏Å AI/‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î)...`);

                try {
                    const batch = db.batch();
                    let approvedCount = 0;
                    let skippedCount = 0;

                    for (const id of selectedIds) {
                        const item = items.find(i => i.id === id);
                        if (!item) continue;

                        // Determine skills for this item
                        let itemSkills;
                        if (bulkType === 'student') {
                            itemSkills = (item.aiSuggestedSkills || []).slice(0, 3);
                        } else {
                            itemSkills = (item.skills?.length > 0 ? item.skills : (item.aiSuggestedSkills || [])).slice(0, 3);
                        }

                        // Normalize skills format
                        itemSkills = itemSkills.map(s => ({
                            code: s.code,
                            level: s.level || 2,
                            nameTh: s.nameTh || CRITERIA_LIST.find(c => c.code === s.code)?.nameTh || '',
                            nameEn: s.nameEn || CRITERIA_LIST.find(c => c.code === s.code)?.nameEn || ''
                        }));

                        if (itemSkills.length === 0) {
                            skippedCount++;
                            continue;
                        }

                        const ref = db.collection(collection).doc(id);
                        batch.update(ref, {
                            status: 'Approved',
                            approvedSkills: itemSkills,
                            approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        if (bulkType === 'student') {
                            const participationRef = db.collection('participation').doc();
                            batch.set(participationRef, {
                                studentId: item.studentId,
                                activityName: item.activityName,
                                status: 'Approved',
                                date: item.startDate || '',
                                skills: itemSkills,
                                source: 'student-submission-bulk',
                                addedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }

                        if (bulkType === 'organizer') {
                            const studentIds = item.studentIds || [];
                            for (const studentId of studentIds) {
                                const participationRef = db.collection('participation').doc();
                                batch.set(participationRef, {
                                    studentId: studentId,
                                    activityName: item.activityName,
                                    status: 'Approved',
                                    date: item.activityDate || item.startDate || '',
                                    skills: itemSkills,
                                    source: 'organizer-bulk',
                                    addedAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            }
                        }

                        approvedCount++;

                        // Update local state
                        if (bulkType === 'student') {
                            const index = studentSubmissions.findIndex(s => s.id === id);
                            if (index !== -1) {
                                studentSubmissions[index].status = 'Approved';
                                studentSubmissions[index].approvedSkills = itemSkills;
                            }
                        } else {
                            const index = organizerActivities.findIndex(a => a.id === id);
                            if (index !== -1) {
                                organizerActivities[index].status = 'Approved';
                                organizerActivities[index].approvedSkills = itemSkills;
                            }
                        }
                    }

                    await batch.commit();

                    if (bulkType === 'student') { clearStudentSelection(); renderStudentSubmissions(); }
                    else { clearOrganizerSelection(); renderOrganizerActivities(); }

                    updateStats();
                    closeBulkApproveModal();
                    showLoading(false);

                    let msg = `‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ ${approvedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏à‡∏≤‡∏Å AI/‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î)`;
                    if (skippedCount > 0) msg += `\n‚ö†Ô∏è ‡∏Ç‡πâ‡∏≤‡∏° ${skippedCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏±‡∏Å‡∏©‡∏∞`;
                    alert(msg);

                } catch (error) {
                    console.error('Bulk approve (individual) error:', error);
                    showLoading(false);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                }
            }
        }

        // ============================================
        // TRANSFER TO MASTER
        // ============================================
        function updateTransferStats() {
            const approvedSubmissions = studentSubmissions.filter(s => 
                s.status === 'Approved' && !s.transferred
            );
            const approvedActivities = organizerActivities.filter(a => 
                a.status === 'Approved' && !a.transferred
            );
            
            const total = approvedSubmissions.length + approvedActivities.length;
            document.getElementById('transfer-ready').textContent = total;
            
            const doneSubmissions = studentSubmissions.filter(s => s.transferred).length;
            const doneActivities = organizerActivities.filter(a => a.transferred).length;
            document.getElementById('transfer-done').textContent = doneSubmissions + doneActivities;
        }

        async function transferToMaster() {
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            const logEl = document.getElementById('transfer-log');
            logEl.innerHTML = '';
            
            let successCount = 0;
            
            try {
                // Transfer approved student submissions
                const approvedSubmissions = studentSubmissions.filter(s => 
                    s.status === 'Approved' && !s.transferred
                );
                
                for (const sub of approvedSubmissions) {
                    await db.collection('submissions').doc(sub.id).update({
                        transferred: true,
                        transferredAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    logEl.innerHTML += `<div class="log-success">‚úÖ ${sub.activityName} (${sub.studentId})</div>`;
                    successCount++;
                }
                
                // Transfer approved organizer activities
                const approvedActivities = organizerActivities.filter(a => 
                    a.status === 'Approved' && !a.transferred
                );
                
                for (const act of approvedActivities) {
                    await db.collection('organizerActivities').doc(act.id).update({
                        transferred: true,
                        transferredAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    logEl.innerHTML += `<div class="log-success">‚úÖ ${act.activityName} (${act.studentCount} ‡∏Ñ‡∏ô)</div>`;
                    successCount++;
                }
                
                logEl.innerHTML += `<div class="log-complete">üéâ ‡πÇ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`;
                
                await loadAllData();
                
            } catch (error) {
                console.error('Transfer error:', error);
                logEl.innerHTML += `<div class="log-error">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</div>`;
            }
            
            showLoading(false);
        }

        // ============================================
        // MERGE ACTIVITIES
        // ============================================

        function normalizeForCompare(str) {
            return str.toLowerCase()
                .replace(/\s+/g, ' ')
                .replace(/["""'']/g, '')
                .replace(/\(.*?\)/g, '')
                .trim();
        }

        function areSimilar(a, b) {
            const na = normalizeForCompare(a);
            const nb = normalizeForCompare(b);
            if (na === nb) return true;
            if (na.includes(nb) || nb.includes(na)) return true;

            // Token overlap check
            const tokensA = na.split(/\s+/).filter(t => t.length > 1);
            const tokensB = nb.split(/\s+/).filter(t => t.length > 1);
            if (tokensA.length === 0 || tokensB.length === 0) return false;
            const overlap = tokensA.filter(t => tokensB.includes(t)).length;
            const minLen = Math.min(tokensA.length, tokensB.length);
            return minLen >= 2 && overlap / minLen >= 0.6;
        }

        async function findSimilarActivities() {
            const statusEl = document.getElementById('merge-status');
            statusEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...';

            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô...');

            try {
                // Load all activities
                const query = await db.collection('activities').get();
                const activities = query.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Group similar activities
                const groups = [];
                const used = new Set();

                for (let i = 0; i < activities.length; i++) {
                    if (used.has(i)) continue;
                    const group = [activities[i]];
                    used.add(i);

                    for (let j = i + 1; j < activities.length; j++) {
                        if (used.has(j)) continue;
                        if (areSimilar(activities[i].name, activities[j].name)) {
                            group.push(activities[j]);
                            used.add(j);
                        }
                    }

                    if (group.length > 1) {
                        groups.push(group);
                    }
                }

                showLoading(false);

                if (groups.length === 0) {
                    document.getElementById('merge-results').style.display = 'none';
                    document.getElementById('merge-empty').style.display = 'block';
                    statusEl.textContent = `‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ${activities.length} ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° - ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô`;
                    return;
                }

                document.getElementById('merge-empty').style.display = 'none';
                document.getElementById('merge-results').style.display = 'block';
                statusEl.textContent = `‡∏û‡∏ö ${groups.length} ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô (‡∏à‡∏≤‡∏Å ${activities.length} ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°)`;

                const container = document.getElementById('merge-groups-list');
                container.innerHTML = groups.map((group, gIdx) => {
                    const itemsHtml = group.map(a => {
                        const skills = (a.skills || []).slice(0, 3).map(s => {
                            const c = CRITERIA_LIST.find(cr => cr.code === s.code);
                            return `<span style="background:#e3f2fd;color:#1565c0;padding:1px 6px;border-radius:8px;font-size:0.75em;">${s.code} ${c?.nameTh || ''} Lv.${s.level}</span>`;
                        }).join(' ');
                        return `<div style="padding:8px 12px;background:white;border-radius:6px;border:1px solid #eee;margin-bottom:4px;">
                            <div style="font-weight:600;font-size:0.9em;">${a.name}</div>
                            <div style="font-size:0.8em;color:#888;margin-top:2px;">${a.organizer ? 'üë®‚Äçüíº ' + a.organizer : ''}${a.date ? ' | üìÖ ' + a.date : ''}</div>
                            ${skills ? '<div style="margin-top:4px;">' + skills + '</div>' : ''}
                        </div>`;
                    }).join('');

                    return `<div style="margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:10px;border-left:3px solid #667eea;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                            <h4 style="margin:0;font-size:1em;">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà ${gIdx + 1} (${group.length} ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°)</h4>
                            <button onclick="openMergeModal(${gIdx})" style="padding:6px 14px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.85em;font-weight:600;">üîÄ ‡∏£‡∏ß‡∏°</button>
                        </div>
                        ${itemsHtml}
                    </div>`;
                }).join('');

                // Store groups for modal use
                window._mergeGroups = groups;

            } catch (error) {
                showLoading(false);
                console.error('Find similar error:', error);
                statusEl.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message;
            }
        }

        function openMergeModal(groupIndex) {
            const group = window._mergeGroups[groupIndex];
            if (!group) return;

            const namesHtml = group.map((a, i) => `
                <label style="display:flex;align-items:center;gap:8px;padding:8px;background:${i === 0 ? '#e8f5e9' : 'white'};border-radius:6px;cursor:pointer;border:1px solid #eee;">
                    <input type="radio" name="merge-source-name" value="${i}" ${i === 0 ? 'checked' : ''}>
                    <span style="font-size:0.9em;">${a.name}</span>
                </label>
            `).join('');

            const content = document.getElementById('merge-modal-content');
            content.innerHTML = `
                <div style="margin-bottom:15px;">
                    <h4 style="margin-bottom:8px;">üìã ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏ß‡∏°:</h4>
                    ${group.map(a => `<div style="padding:4px 0;font-size:0.9em;">‚Ä¢ ${a.name}</div>`).join('')}
                </div>

                <div style="margin-bottom:15px;">
                    <h4 style="margin-bottom:8px;">‚úèÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏•‡∏±‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà:</h4>
                    ${namesHtml}
                    <label style="display:flex;align-items:center;gap:8px;padding:8px;background:white;border-radius:6px;cursor:pointer;border:1px solid #eee;margin-top:4px;">
                        <input type="radio" name="merge-source-name" value="custom">
                        <span style="font-size:0.9em;">‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà:</span>
                    </label>
                    <input type="text" id="merge-custom-name" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà..." style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:6px;margin-top:6px;font-size:0.9em;">
                </div>

                <div id="merge-affected-students" style="display:none;margin-top:15px;">
                    <div style="padding:10px;background:#fff8e1;border-radius:8px;border-left:3px solid #ff9800;">
                        <strong>üë• ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö:</strong>
                        <div id="merge-students-info" style="margin-top:6px;font-size:0.85em;"></div>
                    </div>
                </div>
            `;

            window._currentMergeGroup = group;

            document.getElementById('merge-modal-footer').innerHTML = `
                <button class="btn-secondary" onclick="closeMergeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn-primary" onclick="previewMerge()" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;">
                    üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö & ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
                </button>
            `;

            document.getElementById('merge-modal').classList.add('show');
        }

        function closeMergeModal() {
            document.getElementById('merge-modal').classList.remove('show');
        }

        async function previewMerge() {
            const group = window._currentMergeGroup;
            if (!group) return;

            // Get target name
            const selectedRadio = document.querySelector('input[name="merge-source-name"]:checked');
            let targetName;
            if (selectedRadio.value === 'custom') {
                targetName = document.getElementById('merge-custom-name').value.trim();
                if (!targetName) {
                    alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà');
                    return;
                }
            } else {
                targetName = group[parseInt(selectedRadio.value)].name;
            }

            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á...');

            try {
                // Find all participation records with these activity names
                const activityNames = group.map(a => a.name);
                let affectedStudents = new Map(); // studentId -> [activityName, ...]

                for (const name of activityNames) {
                    if (name === targetName) continue;
                    const query = await db.collection('participation')
                        .where('activityName', '==', name)
                        .get();
                    query.docs.forEach(doc => {
                        const data = doc.data();
                        const key = data.studentId;
                        if (!affectedStudents.has(key)) {
                            affectedStudents.set(key, []);
                        }
                        affectedStudents.get(key).push({ docId: doc.id, activityName: name });
                    });
                }

                // Also check submissions and organizerActivities
                let affectedSubmissions = [];
                for (const name of activityNames) {
                    if (name === targetName) continue;
                    const subQuery = await db.collection('submissions')
                        .where('activityName', '==', name)
                        .get();
                    subQuery.docs.forEach(doc => {
                        affectedSubmissions.push({ docId: doc.id, name: name, collection: 'submissions' });
                    });

                    const orgQuery = await db.collection('organizerActivities')
                        .where('activityName', '==', name)
                        .get();
                    orgQuery.docs.forEach(doc => {
                        affectedSubmissions.push({ docId: doc.id, name: name, collection: 'organizerActivities' });
                    });
                }

                showLoading(false);

                const infoEl = document.getElementById('merge-students-info');
                const totalParticipation = Array.from(affectedStudents.values()).reduce((sum, arr) => sum + arr.length, 0);

                infoEl.innerHTML = `
                    <div>üìä ${affectedStudents.size} ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (${totalParticipation} participation records)</div>
                    <div>üìù ${affectedSubmissions.length} submissions/organizer records</div>
                    <div style="margin-top:6px;color:#e65100;"><strong>‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô: "${targetName}"</strong></div>
                `;
                document.getElementById('merge-affected-students').style.display = 'block';

                // Store for execution
                window._mergeData = {
                    targetName,
                    group,
                    affectedStudents,
                    affectedSubmissions,
                    activityNames
                };

                // Update footer with confirm button
                document.getElementById('merge-modal-footer').innerHTML = `
                    <button class="btn-secondary" onclick="closeMergeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button onclick="executeMerge(false)" style="padding:10px 16px;background:#ff9800;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">
                        üîÄ ‡∏£‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
                    </button>
                    ${(affectedStudents.size > 0 || affectedSubmissions.length > 0) ? `
                    <button onclick="executeMerge(true)" style="padding:10px 16px;background:linear-gradient(135deg,#27ae60,#219a52);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">
                        ‚úÖ ‡∏£‡∏ß‡∏° & ‡∏õ‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏®.‡∏î‡πâ‡∏ß‡∏¢
                    </button>` : ''}
                `;

            } catch (error) {
                showLoading(false);
                console.error('Preview merge error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        async function executeMerge(updateStudents) {
            const data = window._mergeData;
            if (!data) return;

            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...');

            try {
                const batch = db.batch();

                // 1. Create new activity with target name (or update existing)
                const existingQuery = await db.collection('activities')
                    .where('name', '==', data.targetName)
                    .limit(1)
                    .get();

                if (existingQuery.empty) {
                    // Create new activity using first group item's data as base
                    const base = data.group[0];
                    const newRef = db.collection('activities').doc();
                    batch.set(newRef, {
                        name: data.targetName,
                        organizer: base.organizer || '',
                        date: base.date || '',
                        level: base.level || 2,
                        description: base.description || '',
                        skills: base.skills || [],
                        mergedFrom: data.activityNames,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                // 2. Optionally update student records
                if (updateStudents) {
                    // Update participation records
                    for (const [studentId, records] of data.affectedStudents) {
                        for (const rec of records) {
                            const ref = db.collection('participation').doc(rec.docId);
                            batch.update(ref, { activityName: data.targetName });
                        }
                    }

                    // Update submissions and organizer activities
                    for (const sub of data.affectedSubmissions) {
                        const ref = db.collection(sub.collection).doc(sub.docId);
                        batch.update(ref, { activityName: data.targetName });
                    }
                }

                await batch.commit();

                showLoading(false);
                closeMergeModal();

                let msg = `‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° "${data.targetName}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢\n(‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å ${data.activityNames.length} ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°)`;
                if (updateStudents) {
                    const totalUpdated = Array.from(data.affectedStudents.values()).reduce((s, a) => s + a.length, 0) + data.affectedSubmissions.length;
                    msg += `\nüìù ‡∏õ‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡πâ ${totalUpdated} records`;
                }
                alert(msg);

                // Reload data
                await loadAllData();
                findSimilarActivities();

            } catch (error) {
                showLoading(false);
                console.error('Execute merge error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        }

        // ============================================
        // HELPERS
        // ============================================
        function getStatusClass(status) {
            if (!status) return 'draft';
            const s = status.toLowerCase();
            if (s === 'approved') return 'approved';
            if (s.includes('rejected')) return 'rejected';
            if (s.includes('pending')) return 'pending';
            return 'draft';
        }

        function getStatusText(status) {
            if (!status) return 'üìù ‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á';
            const s = status.toLowerCase();
            if (s === 'approved') return '‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß';
            if (s.includes('rejected')) return '‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
            if (s.includes('pending')) return '‚è≥ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
            return 'üìù ‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á';
        }

        function showLoading(show, text = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') {
            const overlay = document.getElementById('loading-overlay');
            document.getElementById('loading-text').textContent = text;
            if (show) {
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }
        }

        // ============================================
        // ORGANIZERS MANAGEMENT
        // ============================================
        let allOrganizers = [];

        async function loadOrganizers() {
            const container = document.getElementById('organizers-list');
            
            try {
                const query = await db.collection('organizers').get();
                
                allOrganizers = query.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Sort by email client-side
                allOrganizers.sort((a, b) => (a.email || '').localeCompare(b.email || ''));
                
                // Update stats
                document.getElementById('total-organizers').textContent = allOrganizers.length;
                document.getElementById('active-organizers').textContent = 
                    allOrganizers.filter(o => o.password).length;
                
                if (allOrganizers.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <span class="icon">üë•</span>
                            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                            <button class="btn-add-organizer" onclick="openAddOrganizerModal()">
                                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å
                            </button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = allOrganizers.map(org => `
                    <div class="organizer-card">
                        <div class="org-avatar">${(org.name || org.email).charAt(0).toUpperCase()}</div>
                        <div class="org-info">
                            <div class="org-name">${org.name || '-'}</div>
                            <div class="org-email">${org.email}</div>
                            ${org.department ? `<div class="org-dept">üè¢ ${org.department}</div>` : ''}
                            ${org.phone ? `<div class="org-phone">üìû ${org.phone}</div>` : ''}
                        </div>
                        <div class="org-status">
                            ${org.password 
                                ? '<span class="status-badge active">‚úÖ ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>' 
                                : '<span class="status-badge pending">‚è≥ ‡∏£‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>'}
                        </div>
                        <div class="org-actions">
                            ${org.password ? `
                                <button class="btn-small btn-reset" onclick="resetOrganizerPassword('${org.id}', '${org.email}')">
                                    üîÑ Reset Password
                                </button>
                            ` : ''}
                            <button class="btn-small btn-delete" onclick="deleteOrganizer('${org.id}', '${org.email}')">
                                üóëÔ∏è ‡∏•‡∏ö
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Load organizers error:', error);
                container.innerHTML = `<div class="error-state">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</div>`;
            }
        }

        function openAddOrganizerModal() {
            document.getElementById('new-org-email').value = '';
            document.getElementById('new-org-name').value = '';
            document.getElementById('new-org-department').value = '';
            document.getElementById('new-org-phone').value = '';
            document.getElementById('add-organizer-modal').classList.add('show');
        }

        function closeAddOrganizerModal() {
            document.getElementById('add-organizer-modal').classList.remove('show');
        }

        async function addNewOrganizer() {
            const email = document.getElementById('new-org-email').value.trim().toLowerCase();
            const name = document.getElementById('new-org-name').value.trim();
            const department = document.getElementById('new-org-department').value.trim();
            const phone = document.getElementById('new-org-phone').value.trim();
            
            if (!email || !email.includes('@')) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Email ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }
            
            if (!name) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•');
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î...');
            
            try {
                // Check if email already exists
                const existing = await db.collection('organizers')
                    .where('email', '==', email)
                    .get();
                
                if (!existing.empty) {
                    alert('‚ö†Ô∏è Email ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
                    showLoading(false);
                    return;
                }
                
                // Add new organizer
                await db.collection('organizers').add({
                    email: email,
                    name: name,
                    department: department,
                    phone: phone,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: 'admin'
                });
                
                alert('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                closeAddOrganizerModal();
                await loadOrganizers();
                
            } catch (error) {
                console.error('Add organizer error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        async function resetOrganizerPassword(id, email) {
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Reset Password ‡∏Ç‡∏≠‡∏á ${email}?\n\n‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ`)) {
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á Reset Password...');
            
            try {
                await db.collection('organizers').doc(id).update({
                    password: firebase.firestore.FieldValue.delete()
                });
                
                alert('‚úÖ Reset Password ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                await loadOrganizers();
                
            } catch (error) {
                console.error('Reset password error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        async function deleteOrganizer(id, email) {
            if (!confirm(`‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î ${email}?\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`)) {
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î...');
            
            try {
                await db.collection('organizers').doc(id).delete();
                
                alert('‚úÖ ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                await loadOrganizers();
                
            } catch (error) {
                console.error('Delete organizer error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        // ============================================
        // CSV EXPORT FUNCTIONS
        // ============================================
        function convertToCSV(data, headers) {
            if (!data || data.length === 0) return '';
            
            const csvHeaders = headers.join(',');
            const csvRows = data.map(row => {
                return headers.map(header => {
                    let value = (row[header] !== undefined && row[header] !== null) ? row[header] : '';
                    // Handle arrays
                    if (Array.isArray(value)) {
                        value = JSON.stringify(value);
                    }
                    // Handle objects
                    if (typeof value === 'object' && value !== null) {
                        value = JSON.stringify(value);
                    }
                    // Escape quotes and wrap in quotes if contains comma
                    value = String(value).replace(/"/g, '""');
                    if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                        value = `"${value}"`;
                    }
                    return value;
                }).join(',');
            });
            
            return [csvHeaders, ...csvRows].join('\n');
        }

        function downloadCSV(csvContent, filename) {
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function exportStudentsCSV() {
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤...');
            
            try {
                const snapshot = await db.collection('students').get();
                const data = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    password: '***' // Hide password
                }));
                
                const headers = ['studentId', 'name', 'email', 'department', 'year', 'createdAt'];
                const csv = convertToCSV(data, headers);
                downloadCSV(csv, `students_${new Date().toISOString().slice(0,10)}.csv`);
                
                alert(`‚úÖ Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        async function exportActivitiesCSV() {
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...');
            
            try {
                const snapshot = await db.collection('activities').get();
                const data = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                const headers = ['name', 'organizer', 'date', 'level', 'status', 'description'];
                const csv = convertToCSV(data, headers);
                downloadCSV(csv, `activities_${new Date().toISOString().slice(0,10)}.csv`);
                
                alert(`‚úÖ Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        async function exportParticipationCSV() {
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°...');
            
            try {
                const snapshot = await db.collection('participation').get();
                const data = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                const headers = ['studentId', 'activityName', 'date', 'status', 'skills'];
                const csv = convertToCSV(data, headers);
                downloadCSV(csv, `participation_${new Date().toISOString().slice(0,10)}.csv`);
                
                alert(`‚úÖ Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        async function exportSubmissionsCSV() {
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...');
            
            try {
                const snapshot = await db.collection('submissions').get();
                const data = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                const headers = ['studentId', 'studentName', 'studentEmail', 'activityName', 'activityOrganizer', 'startDate', 'endDate', 'activityLevel', 'status', 'submittedAt'];
                const csv = convertToCSV(data, headers);
                downloadCSV(csv, `submissions_${new Date().toISOString().slice(0,10)}.csv`);
                
                alert(`‚úÖ Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        async function exportOrganizerActivitiesCSV() {
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î...');
            
            try {
                const snapshot = await db.collection('organizerActivities').get();
                const data = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                const headers = ['activityName', 'organizerName', 'organizerEmail', 'department', 'activityDate', 'status', 'studentIds', 'skills'];
                const csv = convertToCSV(data, headers);
                downloadCSV(csv, `organizer_activities_${new Date().toISOString().slice(0,10)}.csv`);
                
                alert(`‚úÖ Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        async function exportOrganizersCSV() {
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î...');
            
            try {
                const snapshot = await db.collection('organizers').get();
                const data = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    password: '***' // Hide password
                }));
                
                const headers = ['email', 'name', 'department', 'phone', 'createdAt'];
                const csv = convertToCSV(data, headers);
                downloadCSV(csv, `organizers_${new Date().toISOString().slice(0,10)}.csv`);
                
                alert(`‚úÖ Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            } catch (error) {
                console.error('Export error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        async function exportAllCSV() {
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...');
            
            try {
                // Export each collection
                await exportStudentsCSV();
                await exportActivitiesCSV();
                await exportParticipationCSV();
                await exportSubmissionsCSV();
                await exportOrganizerActivitiesCSV();
                await exportOrganizersCSV();
                
                alert('‚úÖ Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            } catch (error) {
                console.error('Export all error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        // ============================================
        // SKILLS SUMMARY DASHBOARD + SCORE EXPORT
        // ============================================

        async function computeAllStudentScores() {
            // Load all 4 collections in parallel for bulk computation
            const [studentsSnap, participationSnap, submissionsSnap, activitiesSnap] = await Promise.all([
                db.collection('students').get(),
                db.collection('participation').get(),
                db.collection('submissions').get(),
                db.collection('activities').get()
            ]);

            console.log(`[Skills Summary] Loaded: ${studentsSnap.size} students, ${participationSnap.size} participation, ${submissionsSnap.size} submissions, ${activitiesSnap.size} activities`);

            // Build activity name ‚Üí skills map (fallback when participation has no skills)
            // Limit to top 3 skills ‚Äî matching extractSkillsAdmin() behavior used in Dashboard
            const activitySkillsMap = {};
            activitiesSnap.docs.forEach(doc => {
                const data = doc.data();
                if (!data.name) return;
                let skills = [];
                if (data.skills && Array.isArray(data.skills)) {
                    skills = [...data.skills];
                } else {
                    CRITERIA_LIST.forEach(c => {
                        const val = data[c.code] || data[c.code.replace('.', '_')];
                        if (val && val > 0) skills.push({ code: c.code, level: parseInt(val) });
                    });
                }
                // Top 3 by level (matching extractSkillsAdmin)
                if (skills.length > 3) {
                    skills.sort((a, b) => (b.level || 0) - (a.level || 0));
                    skills = skills.slice(0, 3);
                }
                activitySkillsMap[data.name.toLowerCase().trim()] = skills;
            });

            // Diagnostic: activitySkillsMap stats
            const mapWithSkills = Object.values(activitySkillsMap).filter(s => s.length > 0).length;
            console.log(`[Skills Summary] activitySkillsMap: ${Object.keys(activitySkillsMap).length} activities, ${mapWithSkills} with skills`);

            // Build email‚ÜístudentId map for fallback matching
            const emailToSid = {};
            studentsSnap.docs.forEach(doc => {
                const s = doc.data();
                if (s.email && s.studentId) {
                    emailToSid[s.email.toLowerCase().trim()] = s.studentId.trim();
                }
            });

            // ========== Student View Map: replicates student portal loading logic ==========
            // Difference from admin path: (1) immediate fallback for empty skills,
            // (2) submissions only ADD new entries, never merge into existing ones.
            const studentViewMap = {};

            // Step A: Participation with IMMEDIATE fallback (matching student portal app.js:185-187)
            participationSnap.docs.forEach(doc => {
                const p = doc.data();
                const sid = (p.studentId || '').trim();
                if (!sid) return;
                if (!studentViewMap[sid]) studentViewMap[sid] = [];

                let skills = p.skills || [];
                // Student portal does immediate fallback if no skills
                if (skills.length === 0 && p.activityName) {
                    skills = activitySkillsMap[p.activityName.toLowerCase().trim()] || [];
                }

                studentViewMap[sid].push({
                    name: p.activityName || '',
                    status: p.status || 'Approved',
                    skills: skills
                });
            });

            // Step B: Add submissions NOT already in participation (no merge ‚Äî matching student portal app.js:206-227)
            submissionsSnap.docs.forEach(doc => {
                const s = doc.data();
                let sid = (s.studentId || '').trim();
                if (!sid && s.studentEmail) {
                    sid = emailToSid[s.studentEmail.toLowerCase().trim()] || '';
                }
                if (!sid) return;
                if (!studentViewMap[sid]) studentViewMap[sid] = [];

                const nameNorm = (s.activityName || '').toLowerCase().trim();
                const exists = studentViewMap[sid].find(a =>
                    (a.name || '').toLowerCase().trim() === nameNorm
                );
                if (!exists) {
                    studentViewMap[sid].push({
                        name: s.activityName || '',
                        status: s.status || 'Pending',
                        skills: s.approvedSkills?.length > 0 ? s.approvedSkills : (s.skills || [])
                    });
                }
            });

            console.log(`[Skills Summary] studentViewMap: ${Object.keys(studentViewMap).length} students for student-dashboard-score replication`);

            // Build studentId ‚Üí activities array from participation + submissions
            const studentActivitiesMap = {};

            // 1. Participation records (primary source ‚Äî NO fallback here, wait for submission merge)
            let partWithSkills = 0, partWithoutSkills = 0;
            participationSnap.docs.forEach(doc => {
                const p = doc.data();
                const sid = (p.studentId || '').trim();
                if (!sid) return;
                if (!studentActivitiesMap[sid]) studentActivitiesMap[sid] = [];

                const skills = p.skills || [];
                if (skills.length > 0) partWithSkills++;
                else partWithoutSkills++;

                studentActivitiesMap[sid].push({
                    name: p.activityName || '',
                    status: p.status || 'Approved',
                    skills: skills,
                    source: 'participation'
                });
            });
            console.log(`[Skills Summary] Participation: ${partWithSkills} with skills, ${partWithoutSkills} without skills`);

            // 2. Submissions (ALL statuses ‚Äî matching Dashboard behavior)
            // Dashboard loads all submissions; scoring loop filters approved later
            let subMergedCount = 0, subMergedNonApproved = 0;
            const studentNotesMap = {}; // sid ‚Üí [note strings]
            submissionsSnap.docs.forEach(doc => {
                const s = doc.data();
                const isApproved = s.status?.toLowerCase().includes('approved');

                // Try studentId first, then fallback to email‚ÜístudentId mapping
                let sid = (s.studentId || '').trim();
                if (!sid && s.studentEmail) {
                    sid = emailToSid[s.studentEmail.toLowerCase().trim()] || '';
                }
                if (!sid) return;

                if (!studentActivitiesMap[sid]) studentActivitiesMap[sid] = [];
                if (!studentNotesMap[sid]) studentNotesMap[sid] = [];

                // Dedup: skip if participation already has this activity
                const nameNorm = (s.activityName || '').toLowerCase().trim();
                const existingEntry = studentActivitiesMap[sid].find(a =>
                    a.name && a.name.toLowerCase().trim() === nameNorm
                );

                if (!existingEntry) {
                    studentActivitiesMap[sid].push({
                        name: s.activityName || '',
                        status: s.status || 'Pending',
                        skills: s.approvedSkills || s.skills || [],
                        source: 'submission'
                    });
                } else if ((!existingEntry.skills || existingEntry.skills.length === 0) && (s.approvedSkills?.length > 0 || s.skills?.length > 0)) {
                    // Participation record has empty skills ‚Äî merge from submission
                    existingEntry.skills = s.approvedSkills || s.skills || [];
                    subMergedCount++;
                    if (!isApproved) {
                        subMergedNonApproved++;
                        studentNotesMap[sid].push(`skills merged from non-approved submission: "${s.activityName}" (status: ${s.status})`);
                    }
                }
            });

            // Diagnostic: submissions stats
            const approvedSubCount = submissionsSnap.docs.filter(d => d.data().status?.toLowerCase().includes('approved')).length;
            const subWithApprovedSkills = submissionsSnap.docs.filter(d => { const s = d.data(); return s.status?.toLowerCase().includes('approved') && s.approvedSkills?.length > 0; }).length;
            console.log(`[Skills Summary] Submissions: ${approvedSubCount} approved, ${subWithApprovedSkills} with approvedSkills, ${subMergedCount} merged (${subMergedNonApproved} from non-approved)`);

            // 2.5 Final fallback: apply activitySkillsMap ONLY for entries still without skills
            // (after submissions had a chance to merge their approvedSkills)
            let fallbackCount = 0;
            Object.entries(studentActivitiesMap).forEach(([sid, activities]) => {
                let studentFallbackCount = 0;
                activities.forEach(activity => {
                    if ((!activity.skills || activity.skills.length === 0) && activity.name) {
                        const fallbackSkills = activitySkillsMap[activity.name.toLowerCase().trim()] || [];
                        if (fallbackSkills.length > 0) {
                            activity.skills = fallbackSkills;
                            fallbackCount++;
                            studentFallbackCount++;
                        }
                    }
                });
                if (studentFallbackCount > 0) {
                    if (!studentNotesMap[sid]) studentNotesMap[sid] = [];
                    studentNotesMap[sid].push(`skills from activity document fallback (${studentFallbackCount} activities)`);
                }
            });
            console.log(`[Skills Summary] Final fallback: ${fallbackCount} entries got skills from activitySkillsMap (after submission merge)`);

            // Diagnostic: show first 3 students with activities and their skills detail
            const sampleStudents = Object.entries(studentActivitiesMap).slice(0, 3);
            sampleStudents.forEach(([sid, acts]) => {
                console.log(`[Skills Summary] Student ${sid}: ${acts.length} activities ‚Üí ${acts.map(a => `"${a.name}" (${a.source}, skills:${a.skills?.length || 0}, status:${a.status})`).join(', ')}`);
            });

            // 3. Compute scores per student
            const results = [];
            let matchedCount = 0;
            studentsSnap.docs.forEach(doc => {
                const student = doc.data();
                // Compute year level from student ID prefix (65=‡∏õ‡∏µ4, 66=‡∏õ‡∏µ3, etc.)
                const originalYear = student.year;
                student.year = getYearLevelFromId(student.studentId) || student.year || '';
                // Log first 3 students for debugging
                if (results.length < 3) {
                    console.log(`[Skills Summary] Student ID: "${student.studentId}" ‚Üí computed: ${getYearLevelFromId(student.studentId)}, stored: "${originalYear}", final: "${student.year}"`);
                }
                const sid = (student.studentId || '').trim();
                const activities = studentActivitiesMap[sid] || [];

                if (activities.length > 0) matchedCount++;

                const scores = {};
                const frequency = {};
                CRITERIA_LIST.forEach(c => {
                    scores[c.code] = 0;
                    frequency[c.code] = 0;
                });

                const approved = activities.filter(a =>
                    a.status?.toLowerCase().includes('approved')
                );

                // Track approved activities with no skills for notes
                const approvedNoSkills = approved.filter(a => !a.skills || a.skills.length === 0);
                if (approvedNoSkills.length > 0) {
                    if (!studentNotesMap[sid]) studentNotesMap[sid] = [];
                    studentNotesMap[sid].push(`${approvedNoSkills.length} approved activities have no skills`);
                }

                approved.forEach(activity => {
                    if (activity.skills && Array.isArray(activity.skills)) {
                        activity.skills.forEach(skill => {
                            if (skill.code) {
                                const lvl = parseInt(skill.level);
                                if (!isNaN(lvl) && lvl >= 0) {
                                    scores[skill.code] = Math.max(scores[skill.code], lvl);
                                    frequency[skill.code]++;
                                }
                            }
                        });
                    }
                });

                const domainScores = calculateDomainScoresAdmin(scores);
                const totalScore = Object.values(scores).reduce((a, b) => a + b, 0);
                const notes = (studentNotesMap[sid] || []).join('; ');

                // Student dashboard score: SUM ALL skill levels (duplicates counted)
                // Replicates student portal app.js:371-378
                const studentViewActivities = studentViewMap[sid] || [];
                const studentViewApproved = studentViewActivities.filter(a =>
                    a.status?.toLowerCase().includes('approved')
                );
                let studentDashboardScore = 0;
                studentViewApproved.forEach(activity => {
                    if (activity.skills && Array.isArray(activity.skills)) {
                        activity.skills.forEach(skill => {
                            studentDashboardScore += (skill.level || 0);
                        });
                    }
                });

                results.push({
                    student,
                    scores,
                    frequency,
                    domainScores,
                    totalScore,
                    studentDashboardScore,
                    activityCount: activities.length,
                    approvedCount: approved.length,
                    notes: notes
                });
            });

            console.log(`[Skills Summary] ${matchedCount}/${results.length} students have activities. Activities map has ${Object.keys(studentActivitiesMap).length} entries.`);

            // Diagnostic: count students with approved activities but zero total score
            const activeWithZero = results.filter(r => r.approvedCount > 0 && r.totalScore === 0);
            const activeWithScore = results.filter(r => r.approvedCount > 0 && r.totalScore > 0);
            console.log(`[Skills Summary] Active students: ${activeWithScore.length} with scores, ${activeWithZero.length} with approved but ZERO score`);
            if (activeWithZero.length > 0 && activeWithZero.length <= 5) {
                activeWithZero.forEach(r => {
                    const acts = studentActivitiesMap[(r.student.studentId || '').trim()] || [];
                    const approvedActs = acts.filter(a => a.status?.toLowerCase().includes('approved'));
                    console.log(`[Skills Summary] ZERO-SCORE student ${r.student.studentId}: ${r.approvedCount} approved, skills per activity: [${approvedActs.map(a => a.skills?.length || 0).join(',')}]`);
                });
            }

            return results;
        }

        // --- CSV Export: Score Summary ---
        async function exportStudentScoreSummaryCSV() {
            showLoading(true, 'üìä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...');

            try {
                // Use cached data if available (avoids Firestore connection issues)
                let results;
                if (skillsSummaryData && skillsSummaryData.length > 0) {
                    results = skillsSummaryData;
                    console.log('[CSV Export] Using cached skillsSummaryData');
                } else {
                    results = await computeAllStudentScores();
                    console.log('[CSV Export] Fetched fresh data from Firestore');
                }

                // Guard: no data loaded (Firestore connection issue)
                if (!results || results.length === 0) {
                    showLoading(false);
                    alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‚Äî ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firestore\n\n‡∏•‡∏≠‡∏á:\n1. ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤ (Ctrl+Shift+R)\n2. ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö ‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡∏Å‡∏©‡∏∞ ‡∏Å‡πà‡∏≠‡∏ô\n3. ‡∏Å‡∏î Export ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                    return;
                }

                // Filter to only students with approved activities
                const activeResults = results.filter(r => r.approvedCount > 0);
                console.log(`[CSV Export] ${results.length} total students, ${activeResults.length} with activities`);

                if (activeResults.length === 0) {
                    showLoading(false);
                    alert(`‚ö†Ô∏è ‡∏û‡∏ö ${results.length} ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß`);
                    return;
                }

                const data = activeResults.map(r => {
                    const row = {
                        studentId: r.student.studentId || '',
                        name: r.student.name || '',
                        email: r.student.email || '',
                        department: r.student.department || '',
                        year: r.student.year || '',
                        activityCount: r.activityCount,
                        approvedCount: r.approvedCount
                    };

                    // 18 criteria: maxLevel + frequency
                    CRITERIA_LIST.forEach(c => {
                        row[`skill_${c.code}_maxLevel`] = r.scores[c.code] ?? 0;
                        row[`skill_${c.code}_freq`] = r.frequency[c.code] ?? 0;
                    });

                    // 6 domain averages
                    DOMAINS.forEach(d => {
                        row[`domain_${d.id}_${d.name.replace(/\s+/g, '_')}_avg`] = r.domainScores[d.name]?.avg ?? 0;
                    });

                    row.totalScore = r.totalScore;
                    row.studentDashboardScore = r.studentDashboardScore;
                    row.notes = r.notes || '';
                    return row;
                });

                // Build headers
                const headers = ['studentId', 'name', 'email', 'department', 'year', 'activityCount', 'approvedCount'];
                CRITERIA_LIST.forEach(c => {
                    headers.push(`skill_${c.code}_maxLevel`);
                    headers.push(`skill_${c.code}_freq`);
                });
                DOMAINS.forEach(d => {
                    headers.push(`domain_${d.id}_${d.name.replace(/\s+/g, '_')}_avg`);
                });
                headers.push('totalScore');
                headers.push('studentDashboardScore');
                headers.push('notes');

                const csv = convertToCSV(data, headers);
                downloadCSV(csv, `student_score_summary_${new Date().toISOString().slice(0, 10)}.csv`);

                alert(`‚úÖ Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ${data.length} ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤`);
            } catch (error) {
                console.error('Export score summary error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }

            showLoading(false);
        }

        // --- Skills Summary Dashboard Functions ---
        async function loadSkillsSummary() {
            showLoading(true, 'üìä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡∏Å‡∏©‡∏∞...');

            try {
                skillsSummaryData = await computeAllStudentScores();
                skillsSummaryLoaded = true;

                // Populate department dropdown from actual data
                populateDeptFilter(skillsSummaryData);

                // Show load status
                const withActivities = skillsSummaryData.filter(r => r.activityCount > 0).length;
                const withScores = skillsSummaryData.filter(r => r.totalScore > 0).length;
                console.log(`[Skills Summary] Render: ${skillsSummaryData.length} students, ${withActivities} with activities, ${withScores} with scores > 0`);

                // Apply initial filter and render
                applySkillsFilter();
            } catch (error) {
                console.error('Load skills summary error:', error);
                alert('‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message);
                // Show sections with error message so user knows something happened
                document.getElementById('skills-summary-stats').style.display = 'grid';
                document.getElementById('skills-total-students').textContent = '‚ùå';
                document.getElementById('skills-avg-score').textContent = '0';
                document.getElementById('skills-passed-count').textContent = '0';
                document.getElementById('skills-avg-activities').textContent = '0';
            }

            showLoading(false);
        }

        function populateDeptFilter(data) {
            const depts = new Set();
            const years = new Set();
            let hasEmptyDept = false;
            let hasEmptyYear = false;

            data.forEach(r => {
                if (r.student.department) depts.add(r.student.department);
                else hasEmptyDept = true;
                if (r.student.year) years.add(String(r.student.year));
                else hasEmptyYear = true;
            });

            // Populate department dropdown
            const deptSelect = document.getElementById('skills-dept-filter');
            deptSelect.innerHTML = '<option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î | All</option>';
            [...depts].sort().forEach(dept => {
                const opt = document.createElement('option');
                opt.value = dept;
                opt.textContent = dept;
                deptSelect.appendChild(opt);
            });
            if (hasEmptyDept) {
                const opt = document.createElement('option');
                opt.value = '_empty_';
                opt.textContent = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ | N/A';
                deptSelect.appendChild(opt);
            }

            // Populate year dropdown from actual data
            const yearSelect = document.getElementById('skills-year-filter');
            yearSelect.innerHTML = '<option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î | All</option>';
            [...years].sort((a, b) => parseInt(a) - parseInt(b)).forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = `‡∏õ‡∏µ ${y} | Year ${y}`;
                yearSelect.appendChild(opt);
            });
            if (hasEmptyYear) {
                const opt = document.createElement('option');
                opt.value = '_empty_';
                opt.textContent = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ | N/A';
                yearSelect.appendChild(opt);
            }
        }

        function applySkillsFilter() {
            if (!skillsSummaryData) {
                // Data not loaded yet ‚Äî show helpful message
                document.getElementById('skills-summary-stats').style.display = 'grid';
                document.getElementById('skills-total-students').textContent = '-';
                document.getElementById('skills-avg-score').textContent = '-';
                document.getElementById('skills-passed-count').textContent = '-';
                document.getElementById('skills-avg-activities').textContent = '-';
                return;
            }

            const yearFilter = document.getElementById('skills-year-filter').value;
            const deptFilter = document.getElementById('skills-dept-filter').value;
            const searchTerm = document.getElementById('skills-student-search').value.trim().toLowerCase();

            let filtered = skillsSummaryData;
            if (yearFilter === '_empty_') {
                filtered = filtered.filter(r => !r.student.year);
            } else if (yearFilter !== 'all') {
                filtered = filtered.filter(r => String(r.student.year) === yearFilter);
            }
            if (deptFilter === '_empty_') {
                filtered = filtered.filter(r => !r.student.department);
            } else if (deptFilter !== 'all') {
                filtered = filtered.filter(r => r.student.department === deptFilter);
            }
            if (searchTerm) {
                filtered = filtered.filter(r =>
                    (r.student.name || '').toLowerCase().includes(searchTerm) ||
                    (r.student.studentId || '').toLowerCase().includes(searchTerm)
                );
            }

            renderSkillsSummary(filtered);
        }

        function renderSkillsSummary(filteredData) {
            // Show sections
            document.getElementById('skills-summary-stats').style.display = 'grid';
            document.getElementById('skills-chart-section').style.display = 'block';
            document.getElementById('skills-table-section').style.display = 'block';
            document.getElementById('skills-students-section').style.display = 'block';

            const count = filteredData.length;
            // Only include students with approved activities for aggregation
            const activeData = filteredData.filter(r => r.approvedCount > 0);
            const activeCount = activeData.length;

            if (count === 0) {
                document.getElementById('skills-total-students').textContent = '0 / 0';
                document.getElementById('skills-avg-score').textContent = '0';
                document.getElementById('skills-passed-count').textContent = '0';
                document.getElementById('skills-avg-activities').textContent = '0';
                document.getElementById('skills-detail-thead').innerHTML = '';
                document.getElementById('skills-detail-tbody').innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
                document.getElementById('skills-student-tbody').innerHTML = '<tr><td colspan="8" style="text-align:center;color:#999;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</td></tr>';
                if (skillsSummaryChart) { skillsSummaryChart.destroy(); skillsSummaryChart = null; }
                return;
            }

            // Aggregate domain averages across ACTIVE students only
            const aggDomainTotals = {};
            const aggCriteriaTotals = {};
            const aggCriteriaMax = {};
            DOMAINS.forEach(d => aggDomainTotals[d.name] = 0);
            CRITERIA_LIST.forEach(c => {
                aggCriteriaTotals[c.code] = 0;
                aggCriteriaMax[c.code] = 0;
            });

            let totalScoreSum = 0;
            let totalActivitiesSum = 0;
            let passedCount = 0;

            activeData.forEach(r => {
                totalScoreSum += r.totalScore;
                totalActivitiesSum += r.approvedCount;

                CRITERIA_LIST.forEach(c => {
                    aggCriteriaTotals[c.code] += r.scores[c.code] || 0;
                    aggCriteriaMax[c.code] = Math.max(aggCriteriaMax[c.code], r.scores[c.code] || 0);
                });

                DOMAINS.forEach(d => {
                    aggDomainTotals[d.name] += r.domainScores[d.name]?.avg || 0;
                });

                // Check if all 6 domains >= 2 avg (passed criteria)
                const allPassed = DOMAINS.every(d => (r.domainScores[d.name]?.avg || 0) >= 2);
                if (allPassed) passedCount++;
            });

            // Per-year-level aggregation ‚Äî only active students
            const yearLevels = new Set();
            const yearAgg = {}; // { yearLevel: { code: { sum, count, min, max } } }

            activeData.forEach(r => {
                const yl = r.student.year ? String(r.student.year) : null;
                if (!yl) return;
                yearLevels.add(yl);

                if (!yearAgg[yl]) {
                    yearAgg[yl] = {};
                    CRITERIA_LIST.forEach(c => {
                        yearAgg[yl][c.code] = { sum: 0, count: 0, min: Infinity, max: 0 };
                    });
                }

                CRITERIA_LIST.forEach(c => {
                    const val = r.scores[c.code] || 0;
                    yearAgg[yl][c.code].sum += val;
                    yearAgg[yl][c.code].count++;
                    yearAgg[yl][c.code].min = Math.min(yearAgg[yl][c.code].min, val);
                    yearAgg[yl][c.code].max = Math.max(yearAgg[yl][c.code].max, val);
                });
            });

            // Also collect year levels from ALL students for the dropdown
            filteredData.forEach(r => {
                const yl = r.student.year ? String(r.student.year) : null;
                if (yl) yearLevels.add(yl);
            });

            const sortedYears = [...yearLevels].sort((a, b) => parseInt(a) - parseInt(b));

            // Summary stats (averages use activeCount)
            const avgScore = activeCount > 0 ? Math.round((totalScoreSum / activeCount) * 10) / 10 : 0;
            const avgActivities = activeCount > 0 ? Math.round((totalActivitiesSum / activeCount) * 10) / 10 : 0;
            document.getElementById('skills-total-students').textContent = `${activeCount} / ${count}`;
            document.getElementById('skills-avg-score').textContent = avgScore;
            document.getElementById('skills-passed-count').textContent = passedCount;
            document.getElementById('skills-avg-activities').textContent = avgActivities;

            // Radar chart: aggregated domain averages (active students only)
            const radarLabels = DOMAINS.map(d => d.nameTh);
            const radarData = DOMAINS.map(d =>
                activeCount > 0
                    ? Math.round((aggDomainTotals[d.name] / activeCount) * 100) / 100
                    : 0
            );

            const titleSuffix = activeCount === 1
                ? activeData[0].student.name
                : `${activeCount} ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°)`;
            try {
                renderSkillsRadarChart(radarLabels, radarData, `‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡∏Å‡∏©‡∏∞ ‚Äî ${titleSuffix}`);
            } catch (chartErr) {
                console.error('[Skills Summary] Chart render error:', chartErr);
                document.getElementById('skills-chart-title').textContent = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÑ‡∏î‡πâ';
            }

            // Skills detail table (year comparison) ‚Äî uses activeCount
            renderSkillsDetailTable(aggCriteriaTotals, aggCriteriaMax, activeCount, yearAgg, sortedYears);

            // Student list shows ALL students (active + inactive)
            document.getElementById('skills-student-count-label').textContent = `(${count} ‡∏Ñ‡∏ô, ‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ${activeCount} ‡∏Ñ‡∏ô)`;
            renderSkillsStudentTable(filteredData);
        }

        function renderSkillsRadarChart(labels, data, title) {
            document.getElementById('skills-chart-title').textContent = title;
            const ctx = document.getElementById('skillsSummaryChart').getContext('2d');

            if (skillsSummaryChart) {
                skillsSummaryChart.destroy();
            }

            skillsSummaryChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ | Avg Level',
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: '#667eea',
                        borderWidth: 2,
                        pointBackgroundColor: DOMAINS.map(d => d.color),
                        pointBorderColor: '#fff',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 4,
                            ticks: {
                                stepSize: 1,
                                font: { size: 11 },
                                backdropColor: 'transparent'
                            },
                            pointLabels: {
                                font: { size: 13, family: 'Sarabun' },
                                color: '#333'
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.08)' },
                            angleLines: { color: 'rgba(0, 0, 0, 0.08)' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Level: ${context.parsed.r.toFixed(2)} / 4`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderSkillsDetailTable(aggTotals, aggMax, count, yearAgg, sortedYears) {
            const thead = document.getElementById('skills-detail-thead');
            const tbody = document.getElementById('skills-detail-tbody');

            const hasYears = sortedYears && sortedYears.length > 0;

            // Build dynamic thead
            let theadHtml = '<tr>';
            theadHtml += '<th rowspan="2" class="sticky-col">Domain</th>';
            theadHtml += '<th rowspan="2" class="sticky-col-2">Skill</th>';
            theadHtml += '<th colspan="3" class="year-group-header overall-header">Overall</th>';
            if (hasYears) {
                sortedYears.forEach(y => {
                    const yearCount = yearAgg[y] ? yearAgg[y][CRITERIA_LIST[0].code].count : 0;
                    theadHtml += `<th colspan="3" class="year-group-header year-${y}-header">Year ${y} (${yearCount})</th>`;
                });
            }
            theadHtml += '</tr><tr>';
            // Sub-headers for Overall
            theadHtml += '<th class="sub-header">Min</th><th class="sub-header">Avg</th><th class="sub-header">Max</th>';
            // Sub-headers per year
            if (hasYears) {
                sortedYears.forEach(() => {
                    theadHtml += '<th class="sub-header">Min</th><th class="sub-header">Avg</th><th class="sub-header">Max</th>';
                });
            }
            theadHtml += '</tr>';
            thead.innerHTML = theadHtml;

            // Build tbody
            let html = '';
            let prevDomain = '';

            // Compute overall min from all individual student scores
            const aggCriteriaMin = {};
            CRITERIA_LIST.forEach(c => { aggCriteriaMin[c.code] = Infinity; });
            if (hasYears) {
                sortedYears.forEach(y => {
                    if (yearAgg[y]) {
                        CRITERIA_LIST.forEach(c => {
                            if (yearAgg[y][c.code].count > 0) {
                                aggCriteriaMin[c.code] = Math.min(aggCriteriaMin[c.code], yearAgg[y][c.code].min);
                            }
                        });
                    }
                });
            }
            CRITERIA_LIST.forEach(c => {
                if (aggCriteriaMin[c.code] === Infinity) aggCriteriaMin[c.code] = 0;
            });

            CRITERIA_LIST.forEach(c => {
                const overallAvg = count > 0 ? Math.round((aggTotals[c.code] / count) * 100) / 100 : 0;
                const overallMax = aggMax[c.code] || 0;
                const overallMin = aggCriteriaMin[c.code];
                const domainColor = DOMAINS.find(d => d.name === c.domain)?.color || '#333';
                const showDomain = c.domain !== prevDomain;
                prevDomain = c.domain;
                const domainCriteriaCount = CRITERIA_LIST.filter(x => x.domain === c.domain).length;

                html += '<tr>';
                if (showDomain) {
                    html += `<td rowspan="${domainCriteriaCount}" class="sticky-col" style="font-weight:600;color:${domainColor};vertical-align:top;">${c.domain}</td>`;
                }
                html += `<td class="sticky-col-2">${c.code} ${c.nameTh}<br><small style="color:#666;">${c.name}</small></td>`;

                // Overall columns
                const oAvgClass = overallAvg >= 3 ? 'level-high' : overallAvg >= 2 ? 'level-mid' : overallAvg >= 1 ? 'level-low' : 'level-none';
                html += `<td class="num-cell">${overallMin}</td>`;
                html += `<td class="num-cell ${oAvgClass}"><strong>${overallAvg.toFixed(2)}</strong></td>`;
                html += `<td class="num-cell">${overallMax}</td>`;

                // Per-year columns
                if (hasYears) {
                    sortedYears.forEach(y => {
                        if (yearAgg[y] && yearAgg[y][c.code].count > 0) {
                            const yMin = yearAgg[y][c.code].min;
                            const yAvg = Math.round((yearAgg[y][c.code].sum / yearAgg[y][c.code].count) * 100) / 100;
                            const yMax = yearAgg[y][c.code].max;
                            const yClass = yAvg >= 3 ? 'level-high' : yAvg >= 2 ? 'level-mid' : yAvg >= 1 ? 'level-low' : 'level-none';

                            html += `<td class="num-cell">${yMin}</td>`;
                            html += `<td class="num-cell ${yClass}"><strong>${yAvg.toFixed(2)}</strong></td>`;
                            html += `<td class="num-cell">${yMax}</td>`;
                        } else {
                            html += '<td class="num-cell dim">-</td><td class="num-cell dim">-</td><td class="num-cell dim">-</td>';
                        }
                    });
                }

                html += '</tr>';
            });

            tbody.innerHTML = html;
        }

        function renderSkillsStudentTable(filteredData) {
            const tbody = document.getElementById('skills-student-tbody');
            const sorted = [...filteredData].sort((a, b) => b.totalScore - a.totalScore);

            tbody.innerHTML = sorted.map((r, idx) => {
                const passedDomains = DOMAINS.filter(d => (r.domainScores[d.name]?.avg || 0) >= 2).length;
                const passedClass = passedDomains === 6 ? 'excellent' : passedDomains >= 3 ? 'good' : passedDomains >= 1 ? 'developing' : 'none';

                return `
                    <tr>
                        <td>${r.student.studentId || '-'}</td>
                        <td>${r.student.name || '-'}</td>
                        <td>${r.student.department || '-'}</td>
                        <td>${r.student.year || '-'}</td>
                        <td>${r.approvedCount}</td>
                        <td><strong>${r.totalScore}</strong></td>
                        <td><span class="skills-status-badge ${passedClass}">${passedDomains}/6</span></td>
                        <td>
                            <button class="btn-mini-chart" onclick="showStudentSkillsModal('${(r.student.studentId || '').replace(/'/g, "\\'")}')">
                                üìä ‡∏î‡∏π
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showStudentSkillsModal(studentId) {
            const r = skillsSummaryData.find(x => x.student.studentId === studentId);
            if (!r) return;

            document.getElementById('modal-student-skills-title').textContent =
                `üìä ${r.student.name || studentId}`;

            // Student info
            document.getElementById('modal-student-info').innerHTML = `
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-bottom:20px;padding:15px;background:#f8f9ff;border-radius:10px;">
                    <div><strong>‡∏£‡∏´‡∏±‡∏™:</strong> ${r.student.studentId || '-'}</div>
                    <div><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${r.student.name || '-'}</div>
                    <div><strong>‡πÄ‡∏°‡πÄ‡∏à‡∏≠‡∏£‡πå:</strong> ${r.student.department || '-'}</div>
                    <div><strong>‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ:</strong> ${r.student.year || '-'}</div>
                    <div><strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°:</strong> <span style="color:#667eea;font-weight:700;font-size:1.1em;">${r.totalScore}</span></div>
                    <div><strong>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</strong> ${r.approvedCount} approved / ${r.activityCount} total</div>
                </div>
            `;

            // Modal radar chart
            const ctx = document.getElementById('modalSkillsChart').getContext('2d');
            if (modalSkillsChart) modalSkillsChart.destroy();

            const radarLabels = DOMAINS.map(d => d.nameTh);
            const radarData = DOMAINS.map(d => r.domainScores[d.name]?.avg || 0);

            modalSkillsChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: radarLabels,
                    datasets: [{
                        label: r.student.name || studentId,
                        data: radarData,
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: '#667eea',
                        borderWidth: 2,
                        pointBackgroundColor: DOMAINS.map(d => d.color),
                        pointBorderColor: '#fff',
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 4,
                            ticks: { stepSize: 1, font: { size: 11 }, backdropColor: 'transparent' },
                            pointLabels: { font: { size: 13, family: 'Sarabun' }, color: '#333' },
                            grid: { color: 'rgba(0, 0, 0, 0.08)' },
                            angleLines: { color: 'rgba(0, 0, 0, 0.08)' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Level: ${context.parsed.r.toFixed(2)} / 4`;
                                }
                            }
                        }
                    }
                }
            });

            // Skills breakdown table
            document.getElementById('modal-skills-table').innerHTML = `
                <table class="skills-detail-table" style="margin-top:20px;">
                    <thead>
                        <tr>
                            <th>‡∏î‡πâ‡∏≤‡∏ô | Domain</th>
                            <th>‡∏ó‡∏±‡∏Å‡∏©‡∏∞ | Skill</th>
                            <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö | Level</th>
                            <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activities</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${CRITERIA_LIST.map(c => {
                            const level = r.scores[c.code] || 0;
                            const freq = r.frequency[c.code] || 0;
                            const domainColor = DOMAINS.find(d => d.name === c.domain)?.color || '#333';
                            return `
                                <tr>
                                    <td style="color:${domainColor};font-weight:600;">${c.domain}</td>
                                    <td>${c.code} ${c.nameTh}</td>
                                    <td><span class="level-badge level-${level}">Lv.${level}</span></td>
                                    <td>${freq}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('student-skills-modal').classList.add('show');
        }

        function closeStudentSkillsModal() {
            document.getElementById('student-skills-modal').classList.remove('show');
            if (modalSkillsChart) {
                modalSkillsChart.destroy();
                modalSkillsChart = null;
            }
        }

        // ============================================
        // DATA REPAIR FUNCTIONS
        // ============================================
        async function scanActivitiesWithoutSkills() {
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...');
            const resultEl = document.getElementById('repair-result');
            
            try {
                const activitiesSnapshot = await db.collection('activities').get();
                const withSkills = [];
                const withoutSkills = [];
                
                activitiesSnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const hasSkillsArray = data.skills && Array.isArray(data.skills) && data.skills.length > 0;
                    
                    // Check for old format (direct code keys like "1.1": 2)
                    let hasOldFormat = false;
                    CRITERIA_LIST.forEach(c => {
                        if (data[c.code] || data[c.code.replace('.', '_')]) {
                            hasOldFormat = true;
                        }
                    });
                    
                    if (hasSkillsArray || hasOldFormat) {
                        withSkills.push({ id: doc.id, name: data.name, hasArray: hasSkillsArray, hasOld: hasOldFormat });
                    } else {
                        withoutSkills.push({ id: doc.id, name: data.name });
                    }
                });
                
                resultEl.innerHTML = `
                    <h4>üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö | Scan Results</h4>
                    <div class="scan-stats">
                        <span class="scan-good">‚úÖ ‡∏°‡∏µ Skills: ${withSkills.length} ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</span>
                        <span class="scan-bad">‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ Skills: ${withoutSkills.length} ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</span>
                    </div>
                    ${withoutSkills.length > 0 ? `
                        <div class="scan-list">
                            <h5>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ Skills:</h5>
                            <ul>
                                ${withoutSkills.map(a => `
                                    <li>
                                        <span>${a.name}</span>
                                        <button class="btn-mini" onclick="editActivitySkills('${a.id}', '${a.name.replace(/'/g, "\\'")}')">
                                            ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                        </button>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : '<p class="scan-success">‚úÖ ‡∏ó‡∏∏‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏°‡∏µ Skills ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!</p>'}
                `;
                resultEl.style.display = 'block';
                
            } catch (error) {
                console.error('Scan error:', error);
                resultEl.innerHTML = `<p class="scan-error">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</p>`;
                resultEl.style.display = 'block';
            }
            
            showLoading(false);
        }

        let editingActivityId = null;

        function showAddSkillsToActivity() {
            const activityName = prompt('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° Skills:\nEnter activity name to add skills:');
            if (!activityName) return;
            
            // Search for activity
            db.collection('activities').where('name', '==', activityName).get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ä‡∏∑‡πà‡∏≠: ' + activityName);
                        return;
                    }
                    const doc = snapshot.docs[0];
                    editActivitySkills(doc.id, activityName);
                })
                .catch(err => alert('Error: ' + err.message));
        }

        function editActivitySkills(activityId, activityName) {
            editingActivityId = activityId;
            
            const skillsHtml = CRITERIA_LIST.map(c => `
                <label class="skill-checkbox-item">
                    <input type="checkbox" class="repair-skill-cb" data-code="${c.code}">
                    <span>${c.code} - ${c.name}</span>
                    <select class="repair-skill-level" data-code="${c.code}">
                        <option value="1">Lv.1</option>
                        <option value="2" selected>Lv.2</option>
                        <option value="3">Lv.3</option>
                        <option value="4">Lv.4</option>
                    </select>
                </label>
            `).join('');
            
            const resultEl = document.getElementById('repair-result');
            resultEl.innerHTML = `
                <h4>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Skills: ${activityName}</h4>
                <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°:</p>
                <div class="skills-edit-grid">
                    ${skillsHtml}
                </div>
                <div class="repair-buttons">
                    <button class="btn-repair" onclick="saveActivitySkills('${activityId}')">
                        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å | Save
                    </button>
                    <button class="btn-repair secondary" onclick="cancelEditSkills()">
                        ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å | Cancel
                    </button>
                </div>
            `;
            resultEl.style.display = 'block';
        }

        async function saveActivitySkills(activityId) {
            const skills = [];
            
            document.querySelectorAll('.repair-skill-cb:checked').forEach(cb => {
                const code = cb.dataset.code;
                const levelSelect = document.querySelector(`.repair-skill-level[data-code="${code}"]`);
                const level = parseInt(levelSelect.value);
                skills.push({ code, level });
            });
            
            if (skills.length === 0) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞ | Please select at least 1 skill');
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
            
            try {
                await db.collection('activities').doc(activityId).update({
                    skills: skills,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏û‡∏¥‡πà‡∏° ${skills.length} ‡∏ó‡∏±‡∏Å‡∏©‡∏∞`);
                cancelEditSkills();
                scanActivitiesWithoutSkills(); // Refresh scan
                
            } catch (error) {
                console.error('Save error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        function cancelEditSkills() {
            editingActivityId = null;
            document.getElementById('repair-result').style.display = 'none';
        }

        // Enable skill level select when checkbox is checked
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('skill-checkbox')) {
                const code = e.target.dataset.code;
                const levelSelect = document.querySelector(`.skill-level-select[data-code="${code}"]`);
                levelSelect.disabled = !e.target.checked;
            }
        });

        // ============================================
        // ACTIVITY MANAGEMENT FUNCTIONS
        // ============================================
        let allActivitiesCache = [];

        async function loadAllActivitiesAdmin() {
            const list = document.getElementById('activities-manage-list');
            if (!list) return;
            
            list.innerHTML = '<tr><td colspan="6" class="loading-cell">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... | Loading...</td></tr>';
            
            try {
                const snapshot = await db.collection('activities').get();
                allActivitiesCache = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    allActivitiesCache.push({ id: doc.id, ...data });
                });
                
                // Sort by name
                allActivitiesCache.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                
                // Stats are updated inside renderActivitiesAdminList
                renderActivitiesAdminList(allActivitiesCache);
                
            } catch (error) {
                console.error('Load activities error:', error);
                list.innerHTML = `<tr><td colspan="6" class="empty-cell">‚ùå Error: ${error.message}</td></tr>`;
            }
        }

        function searchActivitiesAdmin() {
            const searchTerm = document.getElementById('activity-manage-search-input').value.trim().toLowerCase();
            if (!searchTerm) {
                loadAllActivitiesAdmin();
                return;
            }
            
            const filtered = allActivitiesCache.filter(a => 
                (a.name || '').toLowerCase().includes(searchTerm) ||
                (a.organizer || '').toLowerCase().includes(searchTerm)
            );
            
            renderActivitiesAdminList(filtered);
        }

        // extractSkillsAdmin is defined earlier around line 858
        // For activity management list, we use a separate function that shows all skills
        function extractAllSkillsAdmin(activity) {
            let skills = [];
            
            // Format 1: Check for skills array
            if (activity.skills && Array.isArray(activity.skills) && activity.skills.length > 0) {
                skills = [...activity.skills];
            } else if (typeof CRITERIA_LIST !== 'undefined') {
                // Format 2: Check for direct code format (e.g., "1.1": 2 or "1_1": 2)
                CRITERIA_LIST.forEach(criteria => {
                    const value = activity[criteria.code] || activity[criteria.code.replace('.', '_')];
                    if (value && value > 0) {
                        skills.push({
                            code: criteria.code,
                            level: parseInt(value)
                        });
                    }
                });
            }
            
            // Return ALL skills for admin view (display will show warning if > 3)
            return skills;
        }

        function renderActivitiesAdminList(activities) {
            const list = document.getElementById('activities-manage-list');
            
            if (!list) {
                console.warn('activities-manage-list element not found');
                return;
            }
            
            if (activities.length === 0) {
                list.innerHTML = `<tr><td colspan="6" class="empty-cell">üì≠ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | No activities found</td></tr>`;
                return;
            }
            
            // Count activities with/without skills
            let withSkills = 0;
            
            const html = activities.map((act, index) => {
                const skills = extractAllSkillsAdmin(act);
                const hasSkills = skills.length > 0;
                
                if (hasSkills) withSkills++;
                
                // Warning if more than 3 skills
                const overLimitWarning = skills.length > 3 
                    ? `<span class="skill-warning">‚ö†Ô∏è ${skills.length}</span>` 
                    : '';
                
                const skillsHtml = hasSkills 
                    ? skills.slice(0, 4).map(s => `<span class="skill-badge">${s.code}:${s.level}</span>`).join('') + 
                      (skills.length > 4 ? `<span class="skill-more">+${skills.length - 4}</span>` : '') +
                      overLimitWarning
                    : '<span class="no-skill">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ</span>';
                
                const rowClass = hasSkills ? '' : 'no-skills-row';
                
                return `
                    <tr class="${rowClass}">
                        <td class="activity-name-cell">
                            <span class="row-num">${index + 1}.</span>
                            ${act.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}
                        </td>
                        <td>${act.organizer || '-'}</td>
                        <td>${act.date || '-'}</td>
                        <td class="center">${act.level || '-'}</td>
                        <td class="skills-cell">${skillsHtml}</td>
                        <td class="actions-cell">
                            <button class="btn-table-edit" onclick="editActivityAdmin('${act.id}')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
                            <button class="btn-table-delete" onclick="deleteActivityAdmin('${act.id}', '${(act.name || '').replace(/'/g, "\\'")}')" title="‡∏•‡∏ö">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Update stats (with null check)
            const totalEl = document.getElementById('total-activities-count');
            const skillsEl = document.getElementById('with-skills-count');
            if (totalEl) totalEl.textContent = activities.length;
            if (skillsEl) skillsEl.textContent = withSkills;
            
            list.innerHTML = html;
        }

        function openAddActivityModal() {
            document.getElementById('activity-modal-title').textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Add Activity';
            document.getElementById('edit-activity-id').value = '';
            document.getElementById('edit-activity-original-name').value = '';
            document.getElementById('act-name').value = '';
            document.getElementById('act-organizer').value = '';
            document.getElementById('act-date').value = '';
            document.getElementById('act-description').value = '';
            
            // Populate skills grid
            const grid = document.getElementById('activity-skills-grid');
            grid.innerHTML = CRITERIA_LIST.map(c => `
                <div style="display:flex; align-items:center; gap:5px; background:white; padding:8px; border-radius:6px;">
                    <input type="checkbox" class="act-skill-cb" data-code="${c.code}" id="act-skill-${c.code}">
                    <label for="act-skill-${c.code}" style="flex:1; font-size:0.85em; cursor:pointer;">
                        <strong>${c.code}</strong> ${c.nameTh}
                    </label>
                    <select class="act-skill-level" data-code="${c.code}" disabled style="width:60px; padding:3px;">
                        <option value="1">1</option>
                        <option value="2" selected>2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                </div>
            `).join('');
            
            // Add event listeners
            grid.querySelectorAll('.act-skill-cb').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const code = e.target.dataset.code;
                    const levelSelect = grid.querySelector(`.act-skill-level[data-code="${code}"]`);
                    levelSelect.disabled = !e.target.checked;
                });
            });
            
            document.getElementById('activity-modal').classList.add('show');
        }

        async function editActivityAdmin(activityId) {
            const activity = allActivitiesCache.find(a => a.id === activityId);
            if (!activity) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°');
                return;
            }
            
            document.getElementById('activity-modal-title').textContent = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Edit Activity';
            document.getElementById('edit-activity-id').value = activityId;
            document.getElementById('edit-activity-original-name').value = activity.name || '';
            document.getElementById('act-name').value = activity.name || '';
            document.getElementById('act-organizer').value = activity.organizer || '';
            document.getElementById('act-date').value = activity.date || '';
            document.getElementById('act-description').value = activity.description || '';
            
            // Populate skills grid
            const grid = document.getElementById('activity-skills-grid');
            grid.innerHTML = CRITERIA_LIST.map(c => {
                const existingSkill = activity.skills?.find(s => s.code === c.code);
                const checked = existingSkill ? 'checked' : '';
                const level = existingSkill?.level || 2;
                const disabled = existingSkill ? '' : 'disabled';
                
                return `
                    <div style="display:flex; align-items:center; gap:5px; background:${existingSkill ? '#e8f5e9' : 'white'}; padding:8px; border-radius:6px;">
                        <input type="checkbox" class="act-skill-cb" data-code="${c.code}" id="act-skill-${c.code}" ${checked}>
                        <label for="act-skill-${c.code}" style="flex:1; font-size:0.85em; cursor:pointer;">
                            <strong>${c.code}</strong> ${c.nameTh}
                        </label>
                        <select class="act-skill-level" data-code="${c.code}" ${disabled} style="width:60px; padding:3px;">
                            <option value="1" ${level === 1 ? 'selected' : ''}>1</option>
                            <option value="2" ${level === 2 ? 'selected' : ''}>2</option>
                            <option value="3" ${level === 3 ? 'selected' : ''}>3</option>
                            <option value="4" ${level === 4 ? 'selected' : ''}>4</option>
                        </select>
                    </div>
                `;
            }).join('');
            
            // Add event listeners
            grid.querySelectorAll('.act-skill-cb').forEach(cb => {
                cb.addEventListener('change', (e) => {
                    const code = e.target.dataset.code;
                    const levelSelect = grid.querySelector(`.act-skill-level[data-code="${code}"]`);
                    levelSelect.disabled = !e.target.checked;
                    e.target.closest('div').style.background = e.target.checked ? '#e8f5e9' : 'white';
                });
            });
            
            document.getElementById('activity-modal').classList.add('show');
        }

        function closeActivityModal() {
            document.getElementById('activity-modal').classList.remove('show');
        }

        async function saveActivityAdmin() {
            const activityId = document.getElementById('edit-activity-id').value;
            const originalName = document.getElementById('edit-activity-original-name').value;
            const name = document.getElementById('act-name').value.trim();
            const organizer = document.getElementById('act-organizer').value.trim();
            const date = document.getElementById('act-date').value;
            const description = document.getElementById('act-description').value.trim();
            
            if (!name) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Please enter activity name');
                return;
            }
            
            // Collect skills
            const skills = [];
            document.querySelectorAll('.act-skill-cb:checked').forEach(cb => {
                const code = cb.dataset.code;
                const levelSelect = document.querySelector(`.act-skill-level[data-code="${code}"]`);
                skills.push({ 
                    code, 
                    level: parseInt(levelSelect.value),
                    nameTh: CRITERIA_LIST.find(c => c.code === code)?.nameTh || ''
                });
            });
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å... | Saving...');
            
            try {
                const activityData = {
                    name,
                    organizer,
                    date,
                    description,
                    skills,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                let syncCount = 0;
                
                if (activityId) {
                    // Update existing activity
                    await db.collection('activities').doc(activityId).update(activityData);
                    
                    // Sync participation records if name or skills changed
                    const nameToSearch = originalName || name;
                    const participationQuery = await db.collection('participation')
                        .where('activityName', '==', nameToSearch)
                        .get();
                    
                    if (!participationQuery.empty) {
                        const batch = db.batch();
                        participationQuery.forEach(doc => {
                            batch.update(doc.ref, {
                                activityName: name,
                                skills: skills,
                                date: date,
                                syncedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            syncCount++;
                        });
                        await batch.commit();
                    }
                    
                    let msg = '‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ | Activity updated';
                    if (syncCount > 0) {
                        msg += `\n\nüìä ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï ${syncCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô participation`;
                    }
                    alert(msg);
                } else {
                    // Create new
                    activityData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('activities').add(activityData);
                    alert('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ | Activity added');
                }
                
                closeActivityModal();
                loadAllActivitiesAdmin();
                
            } catch (error) {
                console.error('Save activity error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        async function deleteActivityAdmin(activityId, activityName) {
            if (!confirm(`‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° "${activityName}"?\nConfirm delete this activity?`)) {
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö... | Deleting...');
            
            try {
                await db.collection('activities').doc(activityId).delete();
                alert('‚úÖ ‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ | Activity deleted');
                loadAllActivitiesAdmin();
            } catch (error) {
                console.error('Delete error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        // ============================================
        // ADMIN LOGIN / LOGOUT
        // ============================================
        let currentAdmin = null;

        async function loginAdmin() {
            const email = document.getElementById('admin-email').value.trim().toLowerCase();
            const password = document.getElementById('admin-password').value.trim();
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = '';
            
            if (!email || !email.includes('@')) { 
                errorEl.textContent = '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Email ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á | Please enter valid Email'; 
                return; 
            }
            if (!password || password.length < 4) { 
                errorEl.textContent = '‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)'; 
                return; 
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö... | Logging in...');
            
            try {
                const q = await db.collection('admins').where('email', '==', email).limit(1).get();
                
                if (q.empty) {
                    // Email not found - not allowed to self-register
                    errorEl.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Email ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö | Email not found. ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå';
                    showLoading(false);
                    return;
                }
                
                const doc = q.docs[0];
                const data = doc.data();
                
                if (!data.password) {
                    // First time login - set password
                    await db.collection('admins').doc(doc.id).update({ 
                        password,
                        firstLoginAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    data.password = password;
                } else if (password !== data.password) {
                    errorEl.textContent = '‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á | Incorrect password';
                    showLoading(false);
                    return;
                }
                
                currentAdmin = { id: doc.id, email, name: data.name || email.split('@')[0], ...data };
                
                // Store session
                sessionStorage.setItem('adminSession', JSON.stringify(currentAdmin));
                
                // Update UI
                document.getElementById('admin-avatar').textContent = currentAdmin.name.charAt(0).toUpperCase();
                document.getElementById('admin-display-name').textContent = currentAdmin.name;
                document.getElementById('admin-display-email').textContent = email;
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('main-section').style.display = 'block';
                
                // Load data
                await loadAllData();
                
            } catch (e) { 
                errorEl.textContent = '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î | Error: ' + e.message; 
            }
            showLoading(false);
        }

        function logoutAdmin() {
            currentAdmin = null;
            sessionStorage.removeItem('adminSession');
            document.getElementById('login-section').style.display = 'flex';
            document.getElementById('main-section').style.display = 'none';
            document.getElementById('admin-email').value = '';
            document.getElementById('admin-password').value = '';
        }

        // Check session on load
        async function checkAdminSession() {
            const session = sessionStorage.getItem('adminSession');
            if (session) {
                try {
                    currentAdmin = JSON.parse(session);
                    document.getElementById('admin-avatar').textContent = currentAdmin.name?.charAt(0).toUpperCase() || 'A';
                    document.getElementById('admin-display-name').textContent = currentAdmin.name || 'Admin';
                    document.getElementById('admin-display-email').textContent = currentAdmin.email;
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('main-section').style.display = 'block';
                    await loadAllData();
                } catch (e) {
                    sessionStorage.removeItem('adminSession');
                }
            }
        }

        // ============================================
        // ADMIN MANAGEMENT
        // ============================================
        
        async function loadAdminList() {
            const container = document.getElementById('admin-list-container');
            container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... | Loading...</div>';
            
            try {
                const snapshot = await db.collection('admins').get();
                
                if (snapshot.empty) {
                    container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | No data</div>';
                    return;
                }
                
                // Sort by createdAt (newest first) client-side
                const admins = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                admins.sort((a, b) => {
                    const timeA = a.createdAt?.toMillis?.() || 0;
                    const timeB = b.createdAt?.toMillis?.() || 0;
                    return timeB - timeA;
                });
                
                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += `<thead>
                    <tr style="background: #f5f5f5;">
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Email</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">‡∏ä‡∏∑‡πà‡∏≠ | Name</th>
                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ | Status</th>
                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ | Action</th>
                    </tr>
                </thead><tbody>`;
                
                admins.forEach(data => {
                    const hasPassword = !!data.password;
                    const isCurrentAdmin = currentAdmin && data.email === currentAdmin.email;
                    
                    const statusBadge = hasPassword 
                        ? '<span style="background: #e8f5e9; color: #27ae60; padding: 4px 10px; border-radius: 15px; font-size: 0.85em;">‚úÖ Active</span>'
                        : '<span style="background: #fff3e0; color: #f57c00; padding: 4px 10px; border-radius: 15px; font-size: 0.85em;">‚è≥ ‡∏£‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</span>';
                    
                    const deleteBtn = isCurrentAdmin 
                        ? '<span style="color: #999; font-size: 0.85em;">(‡∏Ñ‡∏∏‡∏ì)</span>'
                        : `<button onclick="deleteAdmin('${data.id}', '${data.email}')" style="padding: 6px 12px; background: #ffebee; color: #e53935; border: 1px solid #ef9a9a; border-radius: 6px; cursor: pointer; font-size: 0.85em;">üóëÔ∏è ‡∏•‡∏ö</button>`;
                    
                    html += `<tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 12px;">${data.email}</td>
                        <td style="padding: 12px;">${data.name || '-'}</td>
                        <td style="padding: 12px; text-align: center;">${statusBadge}</td>
                        <td style="padding: 12px; text-align: center;">${deleteBtn}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
            } catch (e) {
                container.innerHTML = `<div style="text-align: center; color: #e53935; padding: 20px;">‚ùå Error: ${e.message}</div>`;
            }
        }
        
        async function addNewAdmin() {
            const emailInput = document.getElementById('new-admin-email');
            const nameInput = document.getElementById('new-admin-name');
            const email = emailInput.value.trim().toLowerCase();
            const name = nameInput.value.trim();
            
            if (!email || !email.includes('@')) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Email ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á | Please enter valid email');
                emailInput.focus();
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° Admin... | Adding admin...');
            
            try {
                // Check if email already exists
                const existing = await db.collection('admins').where('email', '==', email).limit(1).get();
                
                if (!existing.empty) {
                    alert('‚ö†Ô∏è Email ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß | This email already exists');
                    showLoading(false);
                    return;
                }
                
                // Add new admin (without password)
                await db.collection('admins').add({
                    email: email,
                    name: name || email.split('@')[0],
                    password: null,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    addedBy: currentAdmin?.email || 'unknown'
                });
                
                alert('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Admin ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n' + email + ' ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß');
                
                // Clear inputs
                emailInput.value = '';
                nameInput.value = '';
                
                // Reload list
                await loadAdminList();
                
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
            
            showLoading(false);
        }
        
        async function deleteAdmin(docId, email) {
            if (!confirm(`‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö Admin?\n\nEmail: ${email}\n\n‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ!`)) {
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö... | Deleting...');
            
            try {
                await db.collection('admins').doc(docId).delete();
                alert('‚úÖ ‡∏•‡∏ö Admin ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à | Admin deleted');
                await loadAdminList();
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
            
            showLoading(false);
        }
        
        async function resetAdminPassword(docId, email) {
            if (!confirm(`üîÑ Reset Password ‡∏Ç‡∏≠‡∏á ${email}?\n\nAdmin ‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ`)) {
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á Reset... | Resetting...');
            
            try {
                await db.collection('admins').doc(docId).update({
                    password: null
                });
                alert('‚úÖ Reset Password ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                await loadAdminList();
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            }
            
            showLoading(false);
        }

        // ============================================
        // EDIT / DELETE STUDENT ACTIVITIES
        // ============================================
        
        function openEditActivityModal(actId, source, actName, status, skillsJson, studentId) {
            document.getElementById('edit-activity-id').value = actId;
            document.getElementById('edit-activity-source').value = source;
            document.getElementById('edit-student-id').value = studentId;
            document.getElementById('edit-activity-name').value = actName;
            document.getElementById('edit-activity-status').value = status || 'Approved';
            
            // Parse skills
            let skills = [];
            try {
                skills = JSON.parse(skillsJson.replace(/&quot;/g, '"'));
            } catch (e) { skills = []; }
            
            // Render skills checkboxes
            const skillsList = document.getElementById('edit-skills-list');
            skillsList.innerHTML = CRITERIA_LIST.map(c => {
                const existingSkill = skills.find(s => s.code === c.code);
                const isChecked = !!existingSkill;
                const level = existingSkill?.level || 2;
                
                return `
                    <div class="edit-skill-item">
                        <input type="checkbox" class="edit-skill-cb" data-code="${c.code}" 
                            ${isChecked ? 'checked' : ''} onchange="updateEditSkillCounter()">
                        <span style="flex:1;">${c.code} ${c.nameTh}</span>
                        <select class="edit-skill-level" data-code="${c.code}" ${isChecked ? '' : 'disabled'}>
                            <option value="1" ${level===1?'selected':''}>Lv.1</option>
                            <option value="2" ${level===2?'selected':''}>Lv.2</option>
                            <option value="3" ${level===3?'selected':''}>Lv.3</option>
                            <option value="4" ${level===4?'selected':''}>Lv.4</option>
                        </select>
                    </div>
                `;
            }).join('');
            
            // Add checkbox change listeners
            document.querySelectorAll('.edit-skill-cb').forEach(cb => {
                cb.addEventListener('change', function() {
                    const levelSelect = document.querySelector(`.edit-skill-level[data-code="${this.dataset.code}"]`);
                    levelSelect.disabled = !this.checked;
                });
            });
            
            document.getElementById('edit-student-activity-modal').classList.add('show');
        }
        
        function closeEditActivityModal() {
            document.getElementById('edit-student-activity-modal').classList.remove('show');
        }
        
        function updateEditSkillCounter() {
            const checked = document.querySelectorAll('.edit-skill-cb:checked').length;
            if (checked > 3) {
                alert('‚ö†Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞ | Maximum 3 skills');
                event.target.checked = false;
            }
        }
        
        async function saveEditedActivity() {
            const actId = document.getElementById('edit-activity-id').value;
            const source = document.getElementById('edit-activity-source').value;
            const studentId = document.getElementById('edit-student-id').value;
            const newStatus = document.getElementById('edit-activity-status').value;
            
            // Get selected skills
            const skills = [];
            document.querySelectorAll('.edit-skill-cb:checked').forEach(cb => {
                const code = cb.dataset.code;
                const level = parseInt(document.querySelector(`.edit-skill-level[data-code="${code}"]`).value);
                skills.push({ code, level });
            });
            
            if (skills.length > 3) {
                alert('‚ö†Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞ | Maximum 3 skills');
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å... | Saving...');
            
            try {
                if (source === 'participation') {
                    await db.collection('participation').doc(actId).update({
                        status: newStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Also update activity skills if approved
                    const actName = document.getElementById('edit-activity-name').value;
                    const actQuery = await db.collection('activities').where('name', '==', actName).limit(1).get();
                    if (!actQuery.empty) {
                        await db.collection('activities').doc(actQuery.docs[0].id).update({
                            skills: skills
                        });
                    }
                } else {
                    // submission
                    await db.collection('submissions').doc(actId).update({
                        status: newStatus,
                        approvedSkills: skills,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                closeEditActivityModal();
                alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ | Saved successfully');
                
                // Refresh student search
                await refreshStudentSearch();
                
            } catch (error) {
                console.error('Save error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }
        
        function openDeleteModal(actId, source, actName, studentId) {
            document.getElementById('delete-activity-id').value = actId;
            document.getElementById('delete-activity-source').value = source;
            document.getElementById('delete-student-id-for-refresh').value = studentId;
            document.getElementById('delete-confirm-text').innerHTML = 
                `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°<br><strong>"${actName}"</strong>?`;
            document.getElementById('delete-confirm-modal').classList.add('show');
        }
        
        function closeDeleteModal() {
            document.getElementById('delete-confirm-modal').classList.remove('show');
        }
        
        async function confirmDeleteActivity() {
            const actId = document.getElementById('delete-activity-id').value;
            const source = document.getElementById('delete-activity-source').value;
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö... | Deleting...');
            closeDeleteModal();
            
            try {
                if (source === 'participation') {
                    await db.collection('participation').doc(actId).delete();
                } else {
                    await db.collection('submissions').doc(actId).delete();
                }
                
                alert('‚úÖ ‡∏•‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ | Activity deleted');
                
                // Refresh student search
                await refreshStudentSearch();
                
            } catch (error) {
                console.error('Delete error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }
        
        async function refreshStudentSearch() {
            if (currentSearchedStudent) {
                const activities = await loadStudentActivitiesAdmin(
                    currentSearchedStudent.studentId, 
                    currentSearchedStudent.email
                );
                const scores = calculateScoresAdmin(activities);
                const domainScores = calculateDomainScoresAdmin(scores);
                displayStudentResult(currentSearchedStudent, activities, scores, domainScores);
            }
        }

        // Initialize - check session
        // (moved to main DOMContentLoaded handler above)
    </script>
</body>
</html>
