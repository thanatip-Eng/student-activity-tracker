<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Activity Review System</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin-style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <span class="logo-icon">‚öôÔ∏è</span>
                <div>
                    <h1>Admin Dashboard</h1>
                    <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
                </div>
            </div>
            <nav class="nav-links">
                <a href="index.html">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</a>
                <a href="student-form.html">üìù ‡∏ô‡∏®.‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</a>
                <a href="organizer-form.html">üë®‚Äçüíº ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</a>
                <a href="data-management.html">üìä ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</a>
            </nav>
        </header>

        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-card pending">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-content">
                    <span class="stat-number" id="pending-count">0</span>
                    <span class="stat-label">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>
                </div>
            </div>
            <div class="stat-card approved">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-content">
                    <span class="stat-number" id="approved-count">0</span>
                    <span class="stat-label">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>
                </div>
            </div>
            <div class="stat-card rejected">
                <div class="stat-icon">‚ùå</div>
                <div class="stat-content">
                    <span class="stat-number" id="rejected-count">0</span>
                    <span class="stat-label">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
                </div>
            </div>
            <div class="stat-card total">
                <div class="stat-icon">üìä</div>
                <div class="stat-content">
                    <span class="stat-number" id="total-count">0</span>
                    <span class="stat-label">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="student-submissions">üìù ‡∏ô‡∏®.‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
            <button class="tab" data-tab="organizer-activities">üë®‚Äçüíº ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î</button>
            <button class="tab" data-tab="transfer">üì§ ‡πÇ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button class="tab" data-tab="organizers">üîê ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î</button>
        </div>

        <!-- Tab: Student Submissions -->
        <div id="tab-student-submissions" class="tab-content active">
            <div class="panel">
                <div class="panel-header">
                    <h2>üìù ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏à‡πâ‡∏á</h2>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all" data-type="student">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        <button class="filter-btn" data-filter="pending" data-type="student">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
                        <button class="filter-btn" data-filter="approved" data-type="student">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</button>
                        <button class="filter-btn" data-filter="rejected" data-type="student">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                    </div>
                </div>
                <div id="student-submissions-list" class="submissions-list">
                    <div class="loading-inline">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                </div>
            </div>
        </div>

        <!-- Tab: Organizer Activities -->
        <div id="tab-organizer-activities" class="tab-content">
            <div class="panel">
                <div class="panel-header">
                    <h2>üë®‚Äçüíº ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î</h2>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all" data-type="organizer">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        <button class="filter-btn" data-filter="pending" data-type="organizer">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                        <button class="filter-btn" data-filter="approved" data-type="organizer">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</button>
                        <button class="filter-btn" data-filter="rejected" data-type="organizer">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                    </div>
                </div>
                <div id="organizer-activities-list" class="submissions-list">
                    <div class="loading-inline">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                </div>
            </div>
        </div>

        <!-- Tab: Transfer Data -->
        <div id="tab-transfer" class="tab-content">
            <div class="panel">
                <h2>üì§ ‡πÇ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Master</h2>
                <p class="panel-desc">‡πÇ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏¢‡∏±‡∏á Activities ‡πÅ‡∏•‡∏∞ Participation Collection</p>
                
                <div class="transfer-stats">
                    <div class="transfer-stat">
                        <span class="transfer-number" id="transfer-ready">0</span>
                        <span class="transfer-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÇ‡∏≠‡∏ô</span>
                    </div>
                    <div class="transfer-stat">
                        <span class="transfer-number" id="transfer-done">0</span>
                        <span class="transfer-label">‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
                    </div>
                </div>
                
                <button id="transfer-btn" class="btn-transfer" onclick="transferToMaster()">
                    üöÄ ‡πÇ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
                
                <div id="transfer-log" class="transfer-log"></div>
            </div>
        </div>

        <!-- Tab: Organizers Management -->
        <div id="tab-organizers" class="tab-content">
            <div class="panel">
                <div class="panel-header">
                    <h2>üîê ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h2>
                    <button class="btn-add-organizer" onclick="openAddOrganizerModal()">
                        ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>
                
                <div class="organizers-stats">
                    <div class="org-stat">
                        <span class="org-stat-number" id="total-organizers">0</span>
                        <span class="org-stat-label">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                    </div>
                    <div class="org-stat">
                        <span class="org-stat-number" id="active-organizers">0</span>
                        <span class="org-stat-label">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
                    </div>
                </div>

                <div id="organizers-list" class="organizers-list">
                    <div class="loading-inline">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                </div>
            </div>
        </div>

        <!-- Add Organizer Modal -->
        <div id="add-organizer-modal" class="modal-overlay">
            <div class="modal" style="max-width: 500px;">
                <div class="modal-header">
                    <h3>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà</h3>
                    <button class="modal-close" onclick="closeAddOrganizerModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Email <span class="required">*</span></label>
                        <input type="email" id="new-org-email" placeholder="organizer@cmu.ac.th">
                    </div>
                    <div class="form-group">
                        <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="required">*</span></label>
                        <input type="text" id="new-org-name" placeholder="‡∏î‡∏£.‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ">
                    </div>
                    <div class="form-group">
                        <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô/‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</label>
                        <input type="text" id="new-org-department" placeholder="‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå">
                    </div>
                    <div class="form-group">
                        <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
                        <input type="tel" id="new-org-phone" placeholder="08x-xxx-xxxx">
                    </div>
                    <p class="form-note">üí° ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å</p>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeAddOrganizerModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button class="btn-primary" onclick="addNewOrganizer()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î</button>
                </div>
            </div>
        </div>

        <!-- Detail Modal -->
        <div id="detail-modal" class="modal-overlay">
            <div class="modal detail-modal">
                <div class="modal-header">
                    <h3 id="modal-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
                    <button class="modal-close" onclick="closeDetailModal()">‚úï</button>
                </div>
                <div class="modal-body" id="modal-body">
                    <!-- Filled by JS -->
                </div>
                <div class="modal-footer" id="modal-footer">
                    <!-- Filled by JS -->
                </div>
            </div>
        </div>

        <!-- Reject Reason Modal -->
        <div id="reject-modal" class="modal-overlay">
            <div class="modal reject-modal">
                <div class="modal-header">
                    <h3>‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
                    <button class="modal-close" onclick="closeRejectModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <label>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò:</label>
                    <textarea id="reject-reason" rows="4" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•..."></textarea>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeRejectModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button class="btn-danger" onclick="confirmReject()">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay">
            <div class="loading-box">
                <div class="spinner"></div>
                <p id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    
    <script>
        // ============================================
        // CRITERIA DEFINITIONS
        // ============================================
        const CRITERIA_LIST = [
            { code: "1.1", name: "Analytical Reasoning", nameTh: "‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå" },
            { code: "1.2", name: "Problem Solving", nameTh: "‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö" },
            { code: "1.3", name: "Systems Thinking", nameTh: "‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡πÄ‡∏ä‡∏¥‡∏á‡∏£‡∏∞‡∏ö‡∏ö" },
            { code: "2.1", name: "Presentation", nameTh: "‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏™‡∏ô‡∏≠" },
            { code: "2.2", name: "Listening", nameTh: "‡∏Å‡∏≤‡∏£‡∏ü‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à" },
            { code: "2.3", name: "English", nameTh: "‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©" },
            { code: "3.1", name: "Role Understanding", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÉ‡∏ô‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó" },
            { code: "3.2", name: "Task Management", nameTh: "‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô" },
            { code: "3.3", name: "Collaboration", nameTh: "‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô" },
            { code: "4.1", name: "Learning Agility", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ" },
            { code: "4.2", name: "Digital Literacy", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•" },
            { code: "4.3", name: "Tool Proficiency", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠" },
            { code: "5.1", name: "Human-Centered Design", nameTh: "‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏¢‡∏∂‡∏î‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á" },
            { code: "5.2", name: "Project Management", nameTh: "‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£" },
            { code: "5.3", name: "Business Awareness", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏£‡∏∞‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏≤‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à" },
            { code: "6.1", name: "Personal Growth", nameTh: "‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•" },
            { code: "6.2", name: "Resilience", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß" },
            { code: "6.3", name: "Empathy", nameTh: "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏Å‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏à" }
        ];

        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let studentSubmissions = [];
        let organizerActivities = [];
        let currentItem = null;
        let currentType = null;
        let studentFilter = 'all';
        let organizerFilter = 'all';

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            loadAllData();
            setupTabs();
            setupFilters();
        });

        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
                    
                    // Load organizers when tab is clicked
                    if (tab.dataset.tab === 'organizers') {
                        loadOrganizers();
                    }
                });
            });
        }

        function setupFilters() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const type = btn.dataset.type;
                    const filter = btn.dataset.filter;
                    
                    // Update active state
                    btn.parentElement.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    if (type === 'student') {
                        studentFilter = filter;
                        renderStudentSubmissions();
                    } else {
                        organizerFilter = filter;
                        renderOrganizerActivities();
                    }
                });
            });
        }

        // ============================================
        // LOAD DATA
        // ============================================
        async function loadAllData() {
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            
            try {
                // Load student submissions
                const submissionsQuery = await db.collection('submissions')
                    .orderBy('submittedAt', 'desc')
                    .get();
                studentSubmissions = submissionsQuery.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Load organizer activities
                const activitiesQuery = await db.collection('organizerActivities')
                    .orderBy('updatedAt', 'desc')
                    .get();
                organizerActivities = activitiesQuery.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Update stats
                updateStats();
                
                // Render lists
                renderStudentSubmissions();
                renderOrganizerActivities();
                updateTransferStats();
                
            } catch (error) {
                console.error('Load error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            }
            
            showLoading(false);
        }

        function updateStats() {
            const allItems = [...studentSubmissions, ...organizerActivities];
            
            const pending = allItems.filter(i => i.status?.toLowerCase().includes('pending')).length;
            const approved = allItems.filter(i => i.status?.toLowerCase() === 'approved').length;
            const rejected = allItems.filter(i => i.status?.toLowerCase().includes('rejected')).length;
            
            document.getElementById('pending-count').textContent = pending;
            document.getElementById('approved-count').textContent = approved;
            document.getElementById('rejected-count').textContent = rejected;
            document.getElementById('total-count').textContent = allItems.length;
        }

        // ============================================
        // RENDER STUDENT SUBMISSIONS
        // ============================================
        function renderStudentSubmissions() {
            const container = document.getElementById('student-submissions-list');
            
            let filtered = studentSubmissions;
            if (studentFilter !== 'all') {
                filtered = studentSubmissions.filter(s => {
                    const status = s.status?.toLowerCase() || '';
                    if (studentFilter === 'pending') return status.includes('pending');
                    if (studentFilter === 'approved') return status === 'approved';
                    if (studentFilter === 'rejected') return status.includes('rejected');
                    return true;
                });
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="icon">üì≠</span>
                        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(item => {
                const statusClass = getStatusClass(item.status);
                const statusText = getStatusText(item.status);
                const date = item.submittedAt?.toDate?.() || new Date();
                
                return `
                    <div class="submission-card" onclick="showStudentDetail('${item.id}')">
                        <div class="submission-main">
                            <h4>${item.activityName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</h4>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="submission-info">
                            <span>üë§ ${item.studentName || '-'} (${item.studentId || '-'})</span>
                            <span>üìÖ ${item.startDate || '-'}</span>
                            <span>üìä Level ${item.activityLevel || '-'}</span>
                        </div>
                        <div class="submission-date">
                            ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${date.toLocaleDateString('th-TH')} ${date.toLocaleTimeString('th-TH')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // RENDER ORGANIZER ACTIVITIES
        // ============================================
        function renderOrganizerActivities() {
            const container = document.getElementById('organizer-activities-list');
            
            let filtered = organizerActivities;
            if (organizerFilter !== 'all') {
                filtered = organizerActivities.filter(a => {
                    const status = a.status?.toLowerCase() || '';
                    if (organizerFilter === 'pending') return status === 'pending';
                    if (organizerFilter === 'approved') return status === 'approved';
                    if (organizerFilter === 'rejected') return status.includes('rejected');
                    return true;
                });
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="icon">üì≠</span>
                        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(item => {
                const statusClass = getStatusClass(item.status);
                const statusText = getStatusText(item.status);
                
                return `
                    <div class="submission-card organizer-card" onclick="showOrganizerDetail('${item.id}')">
                        <div class="submission-main">
                            <h4>${item.activityName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</h4>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="submission-info">
                            <span>üë®‚Äçüíº ${item.organizerName || '-'}</span>
                            <span>üìÖ ${item.startDate || '-'} - ${item.endDate || '-'}</span>
                            <span>üë• ${item.studentCount || 0} ‡∏Ñ‡∏ô</span>
                        </div>
                        <div class="submission-skills">
                            ${(item.skills || []).slice(0, 5).map(s => `
                                <span class="skill-mini">${s.code} Lv.${s.level}</span>
                            `).join('')}
                            ${(item.skills || []).length > 5 ? `<span class="skill-more">+${item.skills.length - 5}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // SHOW DETAIL MODALS
        // ============================================
        function showStudentDetail(id) {
            const item = studentSubmissions.find(s => s.id === id);
            if (!item) return;
            
            currentItem = item;
            currentType = 'student';
            
            document.getElementById('modal-title').textContent = 'üìù ' + (item.activityName || '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°');
            
            document.getElementById('modal-body').innerHTML = `
                <div class="detail-section">
                    <h4>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <span>${item.studentName || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                            <span>${item.studentId || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>Email</label>
                            <span>${item.studentEmail || '-'}</span>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                            <span>${item.activityName || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î</label>
                            <span>${item.activityOrganizer || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <span>${item.startDate || '-'} - ${item.endDate || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</label>
                            <span>${item.duration || '-'} ${item.durationUnit || ''}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
                            <span>Level ${item.activityLevel || '-'}</span>
                        </div>
                    </div>
                    <div class="detail-item full">
                        <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                        <p class="description-text">${item.description || '-'}</p>
                    </div>
                </div>
                
                ${item.evidenceLink ? `
                <div class="detail-section">
                    <h4>üìé ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</h4>
                    <a href="${item.evidenceLink}" target="_blank" class="evidence-link">
                        üîó ${item.evidenceDescription || '‡∏î‡∏π‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô'}
                    </a>
                </div>
                ` : ''}
                
                <div class="detail-section">
                    <h4>üéØ ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö (‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏î‡∏¢ Admin)</h4>
                    <div class="skills-editor" id="skills-editor">
                        ${renderSkillsEditor(item)}
                    </div>
                </div>
            `;
            
            // Footer buttons based on status
            let footerHtml = '';
            if (item.status?.toLowerCase().includes('pending')) {
                footerHtml = `
                    <button class="btn-danger" onclick="rejectItem()">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                    <button class="btn-success" onclick="approveStudentSubmission()">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                `;
            } else {
                footerHtml = `
                    <span class="status-badge ${getStatusClass(item.status)}">${getStatusText(item.status)}</span>
                    <button class="btn-secondary" onclick="closeDetailModal()">‡∏õ‡∏¥‡∏î</button>
                `;
            }
            document.getElementById('modal-footer').innerHTML = footerHtml;
            
            document.getElementById('detail-modal').classList.add('show');
        }

        function showOrganizerDetail(id) {
            const item = organizerActivities.find(a => a.id === id);
            if (!item) return;
            
            currentItem = item;
            currentType = 'organizer';
            
            document.getElementById('modal-title').textContent = 'üë®‚Äçüíº ' + (item.activityName || '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°');
            
            document.getElementById('modal-body').innerHTML = `
                <div class="detail-section">
                    <h4>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î</label>
                            <span>${item.organizerName || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                            <span>${item.department || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>Email</label>
                            <span>${item.organizerEmail || '-'}</span>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                            <span>${item.activityName || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                            <span>${item.startDate || '-'} - ${item.endDate || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</label>
                            <span>${item.duration || '-'} ${item.durationUnit || ''}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
                            <span>Level ${item.activityLevel || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</label>
                            <span>${item.studentCount || 0} ‡∏Ñ‡∏ô</span>
                        </div>
                    </div>
                    <div class="detail-item full">
                        <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                        <p class="description-text">${item.description || '-'}</p>
                    </div>
                    <div class="detail-item full">
                        <label>‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label>
                        <p class="description-text">${item.learningOutcomes || '-'}</p>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>üéØ ‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</h4>
                    <div class="skills-display">
                        ${(item.skills || []).map(s => `
                            <span class="skill-tag">${s.code} ${s.nameTh || ''} <strong>Lv.${s.level}</strong></span>
                        `).join('') || '<span class="no-skills">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏±‡∏Å‡∏©‡∏∞</span>'}
                    </div>
                </div>
                
                ${item.studentIds?.length > 0 ? `
                <div class="detail-section">
                    <h4>üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (${item.studentIds.length} ‡∏Ñ‡∏ô)</h4>
                    <div class="student-ids-list">
                        ${item.studentIds.join(', ')}
                    </div>
                </div>
                ` : ''}
            `;
            
            // Footer buttons based on status
            let footerHtml = '';
            if (item.status?.toLowerCase() === 'pending') {
                footerHtml = `
                    <button class="btn-danger" onclick="rejectItem()">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                    <button class="btn-success" onclick="approveOrganizerActivity()">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                `;
            } else {
                footerHtml = `
                    <span class="status-badge ${getStatusClass(item.status)}">${getStatusText(item.status)}</span>
                    <button class="btn-secondary" onclick="closeDetailModal()">‡∏õ‡∏¥‡∏î</button>
                `;
            }
            document.getElementById('modal-footer').innerHTML = footerHtml;
            
            document.getElementById('detail-modal').classList.add('show');
        }

        function renderSkillsEditor(item) {
            const maxLevel = item.activityLevel || 4;
            
            return `
                <div class="skill-editor-list">
                    ${CRITERIA_LIST.map(c => `
                        <div class="skill-editor-item">
                            <label>
                                <input type="checkbox" class="skill-checkbox" data-code="${c.code}">
                                <span>${c.code} ${c.nameTh}</span>
                            </label>
                            <select class="skill-level-select" data-code="${c.code}" disabled>
                                ${[1,2,3,4].map(l => `
                                    <option value="${l}" ${l > maxLevel ? 'disabled' : ''}>Lv.${l}</option>
                                `).join('')}
                            </select>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function closeDetailModal() {
            document.getElementById('detail-modal').classList.remove('show');
            currentItem = null;
            currentType = null;
        }

        // ============================================
        // APPROVE / REJECT FUNCTIONS
        // ============================================
        async function approveStudentSubmission() {
            if (!currentItem) return;
            
            // Get selected skills
            const skills = [];
            document.querySelectorAll('.skill-checkbox:checked').forEach(cb => {
                const code = cb.dataset.code;
                const levelSelect = document.querySelector(`.skill-level-select[data-code="${code}"]`);
                skills.push({
                    code: code,
                    level: parseInt(levelSelect.value)
                });
            });
            
            if (skills.length === 0) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ó‡∏±‡∏Å‡∏©‡∏∞');
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥...');
            
            try {
                // Update submission status
                await db.collection('submissions').doc(currentItem.id).update({
                    status: 'Approved',
                    approvedSkills: skills,
                    reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Add to participation
                await db.collection('participation').add({
                    studentId: currentItem.studentId,
                    activityName: currentItem.activityName,
                    status: 'Approved',
                    date: currentItem.startDate,
                    source: 'student-submission',
                    addedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Add/update activity
                const existingActivity = await db.collection('activities')
                    .where('name', '==', currentItem.activityName)
                    .get();
                
                if (existingActivity.empty) {
                    const activityData = {
                        name: currentItem.activityName,
                        level: currentItem.activityLevel
                    };
                    skills.forEach(s => {
                        activityData[s.code] = s.level;
                    });
                    await db.collection('activities').add(activityData);
                }
                
                alert('‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                closeDetailModal();
                await loadAllData();
                
            } catch (error) {
                console.error('Approve error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        async function approveOrganizerActivity() {
            if (!currentItem) return;
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥...');
            
            try {
                // Update status
                await db.collection('organizerActivities').doc(currentItem.id).update({
                    status: 'Approved',
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Add activity to master
                const existingActivity = await db.collection('activities')
                    .where('name', '==', currentItem.activityName)
                    .get();
                
                if (existingActivity.empty) {
                    const activityData = {
                        name: currentItem.activityName,
                        level: currentItem.activityLevel,
                        description: currentItem.description
                    };
                    (currentItem.skills || []).forEach(s => {
                        activityData[s.code] = s.level;
                    });
                    await db.collection('activities').add(activityData);
                }
                
                // Add students to participation
                const studentIds = currentItem.studentIds || [];
                for (const studentId of studentIds) {
                    const existing = await db.collection('participation')
                        .where('studentId', '==', studentId)
                        .where('activityName', '==', currentItem.activityName)
                        .get();
                    
                    if (existing.empty) {
                        await db.collection('participation').add({
                            studentId: studentId,
                            activityName: currentItem.activityName,
                            status: 'Approved',
                            date: currentItem.startDate,
                            source: 'organizer',
                            addedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }
                
                alert('‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                closeDetailModal();
                await loadAllData();
                
            } catch (error) {
                console.error('Approve error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        function rejectItem() {
            document.getElementById('reject-reason').value = '';
            document.getElementById('reject-modal').classList.add('show');
        }

        function closeRejectModal() {
            document.getElementById('reject-modal').classList.remove('show');
        }

        async function confirmReject() {
            const reason = document.getElementById('reject-reason').value.trim();
            
            if (!reason) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•');
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò...');
            
            try {
                const collection = currentType === 'student' ? 'submissions' : 'organizerActivities';
                
                await db.collection(collection).doc(currentItem.id).update({
                    status: 'Rejected',
                    rejectReason: reason,
                    reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert('‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                closeRejectModal();
                closeDetailModal();
                await loadAllData();
                
            } catch (error) {
                console.error('Reject error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        // ============================================
        // TRANSFER TO MASTER
        // ============================================
        function updateTransferStats() {
            const approvedSubmissions = studentSubmissions.filter(s => 
                s.status === 'Approved' && !s.transferred
            );
            const approvedActivities = organizerActivities.filter(a => 
                a.status === 'Approved' && !a.transferred
            );
            
            const total = approvedSubmissions.length + approvedActivities.length;
            document.getElementById('transfer-ready').textContent = total;
            
            const doneSubmissions = studentSubmissions.filter(s => s.transferred).length;
            const doneActivities = organizerActivities.filter(a => a.transferred).length;
            document.getElementById('transfer-done').textContent = doneSubmissions + doneActivities;
        }

        async function transferToMaster() {
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            const logEl = document.getElementById('transfer-log');
            logEl.innerHTML = '';
            
            let successCount = 0;
            
            try {
                // Transfer approved student submissions
                const approvedSubmissions = studentSubmissions.filter(s => 
                    s.status === 'Approved' && !s.transferred
                );
                
                for (const sub of approvedSubmissions) {
                    await db.collection('submissions').doc(sub.id).update({
                        transferred: true,
                        transferredAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    logEl.innerHTML += `<div class="log-success">‚úÖ ${sub.activityName} (${sub.studentId})</div>`;
                    successCount++;
                }
                
                // Transfer approved organizer activities
                const approvedActivities = organizerActivities.filter(a => 
                    a.status === 'Approved' && !a.transferred
                );
                
                for (const act of approvedActivities) {
                    await db.collection('organizerActivities').doc(act.id).update({
                        transferred: true,
                        transferredAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    logEl.innerHTML += `<div class="log-success">‚úÖ ${act.activityName} (${act.studentCount} ‡∏Ñ‡∏ô)</div>`;
                    successCount++;
                }
                
                logEl.innerHTML += `<div class="log-complete">üéâ ‡πÇ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`;
                
                await loadAllData();
                
            } catch (error) {
                console.error('Transfer error:', error);
                logEl.innerHTML += `<div class="log-error">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</div>`;
            }
            
            showLoading(false);
        }

        // ============================================
        // HELPERS
        // ============================================
        function getStatusClass(status) {
            if (!status) return 'draft';
            const s = status.toLowerCase();
            if (s === 'approved') return 'approved';
            if (s.includes('rejected')) return 'rejected';
            if (s.includes('pending')) return 'pending';
            return 'draft';
        }

        function getStatusText(status) {
            if (!status) return 'üìù ‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á';
            const s = status.toLowerCase();
            if (s === 'approved') return '‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß';
            if (s.includes('rejected')) return '‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
            if (s.includes('pending')) return '‚è≥ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
            return 'üìù ‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á';
        }

        function showLoading(show, text = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') {
            const overlay = document.getElementById('loading-overlay');
            document.getElementById('loading-text').textContent = text;
            if (show) {
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }
        }

        // ============================================
        // ORGANIZERS MANAGEMENT
        // ============================================
        let allOrganizers = [];

        async function loadOrganizers() {
            const container = document.getElementById('organizers-list');
            
            try {
                const query = await db.collection('organizers').orderBy('email').get();
                
                allOrganizers = query.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Update stats
                document.getElementById('total-organizers').textContent = allOrganizers.length;
                document.getElementById('active-organizers').textContent = 
                    allOrganizers.filter(o => o.password).length;
                
                if (allOrganizers.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <span class="icon">üë•</span>
                            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
                            <button class="btn-add-organizer" onclick="openAddOrganizerModal()">
                                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å
                            </button>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = allOrganizers.map(org => `
                    <div class="organizer-card">
                        <div class="org-avatar">${(org.name || org.email).charAt(0).toUpperCase()}</div>
                        <div class="org-info">
                            <div class="org-name">${org.name || '-'}</div>
                            <div class="org-email">${org.email}</div>
                            ${org.department ? `<div class="org-dept">üè¢ ${org.department}</div>` : ''}
                            ${org.phone ? `<div class="org-phone">üìû ${org.phone}</div>` : ''}
                        </div>
                        <div class="org-status">
                            ${org.password 
                                ? '<span class="status-badge active">‚úÖ ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>' 
                                : '<span class="status-badge pending">‚è≥ ‡∏£‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>'}
                        </div>
                        <div class="org-actions">
                            ${org.password ? `
                                <button class="btn-small btn-reset" onclick="resetOrganizerPassword('${org.id}', '${org.email}')">
                                    üîÑ Reset Password
                                </button>
                            ` : ''}
                            <button class="btn-small btn-delete" onclick="deleteOrganizer('${org.id}', '${org.email}')">
                                üóëÔ∏è ‡∏•‡∏ö
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Load organizers error:', error);
                container.innerHTML = `<div class="error-state">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</div>`;
            }
        }

        function openAddOrganizerModal() {
            document.getElementById('new-org-email').value = '';
            document.getElementById('new-org-name').value = '';
            document.getElementById('new-org-department').value = '';
            document.getElementById('new-org-phone').value = '';
            document.getElementById('add-organizer-modal').classList.add('show');
        }

        function closeAddOrganizerModal() {
            document.getElementById('add-organizer-modal').classList.remove('show');
        }

        async function addNewOrganizer() {
            const email = document.getElementById('new-org-email').value.trim().toLowerCase();
            const name = document.getElementById('new-org-name').value.trim();
            const department = document.getElementById('new-org-department').value.trim();
            const phone = document.getElementById('new-org-phone').value.trim();
            
            if (!email || !email.includes('@')) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Email ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }
            
            if (!name) {
                alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•');
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î...');
            
            try {
                // Check if email already exists
                const existing = await db.collection('organizers')
                    .where('email', '==', email)
                    .get();
                
                if (!existing.empty) {
                    alert('‚ö†Ô∏è Email ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
                    showLoading(false);
                    return;
                }
                
                // Add new organizer
                await db.collection('organizers').add({
                    email: email,
                    name: name,
                    department: department,
                    phone: phone,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: 'admin'
                });
                
                alert('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                closeAddOrganizerModal();
                await loadOrganizers();
                
            } catch (error) {
                console.error('Add organizer error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        async function resetOrganizerPassword(id, email) {
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Reset Password ‡∏Ç‡∏≠‡∏á ${email}?\n\n‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ`)) {
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á Reset Password...');
            
            try {
                await db.collection('organizers').doc(id).update({
                    password: firebase.firestore.FieldValue.delete()
                });
                
                alert('‚úÖ Reset Password ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                await loadOrganizers();
                
            } catch (error) {
                console.error('Reset password error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        async function deleteOrganizer(id, email) {
            if (!confirm(`‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î ${email}?\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`)) {
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î...');
            
            try {
                await db.collection('organizers').doc(id).delete();
                
                alert('‚úÖ ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                await loadOrganizers();
                
            } catch (error) {
                console.error('Delete organizer error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
            
            showLoading(false);
        }

        // Enable skill level select when checkbox is checked
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('skill-checkbox')) {
                const code = e.target.dataset.code;
                const levelSelect = document.querySelector(`.skill-level-select[data-code="${code}"]`);
                levelSelect.disabled = !e.target.checked;
            }
        });
    </script>
</body>
</html>
