<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Management - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin-style.css">
    <style>
        .upload-section {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .upload-section h2 {
            color: #1a1a2e;
            margin-bottom: 10px;
        }

        .upload-section .description {
            color: #666;
            margin-bottom: 20px;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-area .icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-area p {
            color: #666;
            margin-bottom: 10px;
        }

        .upload-area .hint {
            font-size: 0.85em;
            color: #999;
        }

        .template-section {
            background: #f0f8ff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .template-section h4 {
            color: #1a1a2e;
            margin-bottom: 10px;
        }

        .template-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn-template {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
        }

        .btn-template:hover {
            background: #667eea;
            color: white;
        }

        .preview-section {
            margin-top: 20px;
        }

        .preview-section h4 {
            color: #1a1a2e;
            margin-bottom: 15px;
        }

        .preview-table-wrapper {
            max-height: 300px;
            overflow: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .preview-table th,
        .preview-table td {
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .preview-table th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .preview-table tr:hover {
            background: #f8f9ff;
        }

        .preview-stats {
            display: flex;
            gap: 30px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .preview-stat {
            text-align: center;
        }

        .preview-stat .number {
            display: block;
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
        }

        .preview-stat .label {
            color: #666;
            font-size: 0.9em;
        }

        .import-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn-import {
            padding: 15px 30px;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-import:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(39, 174, 96, 0.4);
        }

        .btn-import:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-clear {
            padding: 15px 30px;
            background: #f8f9fa;
            color: #333;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-clear:hover {
            background: #e9ecef;
        }

        .import-log {
            background: #1a1a2e;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-height: 250px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85em;
            display: none;
        }

        .import-log.show {
            display: block;
        }

        .log-item {
            margin-bottom: 5px;
        }

        .log-success { color: #2ecc71; }
        .log-error { color: #e74c3c; }
        .log-info { color: #3498db; }
        .log-warning { color: #f39c12; }
        .log-complete { color: #f39c12; margin-top: 10px; font-weight: bold; }

        .error-list {
            background: #fff5f5;
            border: 1px solid #ffcdd2;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 150px;
            overflow-y: auto;
        }

        .error-list h5 {
            color: #c62828;
            margin-bottom: 10px;
        }

        .error-list ul {
            margin: 0;
            padding-left: 20px;
            color: #c62828;
            font-size: 0.9em;
        }

        .format-guide {
            background: #fffbf0;
            border: 1px solid #ffe082;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .format-guide h5 {
            color: #f57c00;
            margin-bottom: 10px;
        }

        .format-guide code {
            background: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .format-guide ul {
            margin: 10px 0 0 20px;
            color: #666;
        }

        .current-data {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .current-data h3 {
            color: #1a1a2e;
            margin-bottom: 15px;
        }

        .data-summary {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .summary-card {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 20px 30px;
            text-align: center;
            min-width: 150px;
        }

        .summary-card .count {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
        }

        .summary-card .label {
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <img src="images/MainLogo.png" alt="Student Talent Development" class="logo-img">
                <div>
                    <h1>Data Management | ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h1>
                    <p>Import/Export data via CSV | ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢ CSV</p>
                </div>
            </div>
            <nav class="nav-links">
                <a href="index.html">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å | Home</a>
                <a href="student-portal.html">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ | Search</a>
                <a href="admin-dashboard.html">‚öôÔ∏è Admin</a>
                <a href="setup.html">üîß Setup</a>
            </nav>
        </header>

        <!-- Section 1: Import Students -->
        <section class="upload-section">
            <h2>üë• 1. ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ | Import Students</h2>
            <p class="description">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ | Upload CSV to add student data</p>

            <!-- Template Download -->
            <div class="template-section">
                <h4>üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Template | Download Template</h4>
                <div class="template-buttons">
                    <a href="#" class="btn-template" onclick="downloadStudentTemplate(); return false;">
                        üìÑ students_template.csv
                    </a>
                    <a href="#" class="btn-template" onclick="downloadStudentSample(); return false;">
                        üìã students_sample.csv (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á | Sample)
                    </a>
                </div>
            </div>

            <!-- Format Guide -->
            <div class="format-guide">
                <h5>üìù ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV | CSV Format</h5>
                <p>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ | Required: <code>studentId</code>, <code>name</code>, <code>email</code></p>
                <p>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° | Optional: <code>department</code>, <code>faculty</code>, <code>year</code></p>
                <ul>
                    <li>‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô header | First row must be header</li>
                    <li>‡πÉ‡∏ä‡πâ comma (,) ‡∏Ñ‡∏±‡πà‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå | Use comma separator</li>
                    <li>‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö UTF-8 encoding (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢) | UTF-8 encoding supported</li>
                </ul>
            </div>

            <!-- Upload Area -->
            <div class="upload-area" id="student-upload-area" onclick="document.getElementById('student-file-input').click()">
                <div class="icon">üìÅ</div>
                <p><strong>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå | Click to select file</strong></p>
                <p class="hint">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå .csv ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô | .csv files only</p>
                <input type="file" id="student-file-input" accept=".csv" onchange="handleStudentFile(this.files[0])">
            </div>

            <!-- Preview -->
            <div id="student-preview" class="preview-section" style="display: none;">
                <h4>üëÅÔ∏è ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | Preview</h4>
                <div class="preview-stats" id="student-preview-stats"></div>
                <div class="preview-table-wrapper">
                    <table class="preview-table" id="student-preview-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="student-errors" class="error-list" style="display: none;"></div>
                <div class="import-actions">
                    <button class="btn-import" id="btn-import-students" onclick="importStudents()">
                        ‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | Import
                    </button>
                    <button class="btn-clear" onclick="clearStudentPreview()">
                        üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á | Clear
                    </button>
                </div>
                <div class="import-log" id="student-import-log"></div>
            </div>
        </section>

        <!-- Section 2: Import Activities -->
        <section class="upload-section">
            <h2>üìö 2. ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Import Activities</h2>
            <p class="description">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö | Upload CSV to add activities</p>

            <!-- Template Download -->
            <div class="template-section">
                <h4>üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Template | Download Template</h4>
                <div class="template-buttons">
                    <a href="#" class="btn-template" onclick="downloadActivityTemplate(); return false;">
                        üìÑ activities_template.csv
                    </a>
                    <a href="#" class="btn-template" onclick="downloadActivitySample(); return false;">
                        üìã activities_sample.csv (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á | Sample)
                    </a>
                </div>
            </div>

            <!-- Format Guide -->
            <div class="format-guide">
                <h5>üìù ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV | CSV Format</h5>
                <p>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ | Required: <code>name</code>, <code>organizer</code>, <code>date</code></p>
                <p>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° | Optional: <code>level</code>, <code>description</code>, <code>skills</code></p>
                <ul>
                    <li><strong>name</strong> = ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activity name</li>
                    <li><strong>organizer</strong> = ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô/‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î | Organizer name</li>
                    <li><strong>date</strong> = ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î (YYYY-MM-DD) | Activity date</li>
                    <li><strong>level</strong> = ‡∏£‡∏∞‡∏î‡∏±‡∏ö 1-4 | Level (default: 2)</li>
                    <li><strong>description</strong> = ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î | Description</li>
                    <li><strong>skills</strong> = ‡∏ó‡∏±‡∏Å‡∏©‡∏∞ ‡πÄ‡∏ä‡πà‡∏ô "1.1:2,2.1:3,4.2:2" | Skills format: code:level</li>
                </ul>
            </div>

            <!-- Upload Area -->
            <div class="upload-area" id="activity-upload-area" onclick="document.getElementById('activity-file-input').click()">
                <div class="icon">üìÅ</div>
                <p><strong>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå | Click to select file</strong></p>
                <p class="hint">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå .csv ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô | .csv files only</p>
                <input type="file" id="activity-file-input" accept=".csv" onchange="handleActivityFile(this.files[0])">
            </div>

            <!-- Preview -->
            <div id="activity-preview" class="preview-section" style="display: none;">
                <h4>üëÅÔ∏è ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | Preview</h4>
                <div class="preview-stats" id="activity-preview-stats"></div>
                <div class="preview-table-wrapper">
                    <table class="preview-table" id="activity-preview-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="activity-errors" class="error-list" style="display: none;"></div>
                <div class="import-actions">
                    <button class="btn-import" id="btn-import-activities" onclick="importActivities()">
                        ‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | Import
                    </button>
                    <button class="btn-clear" onclick="clearActivityPreview()">
                        üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á | Clear
                    </button>
                </div>
                <div class="import-log" id="activity-import-log"></div>
            </div>
        </section>

        <!-- Section 3: Import Participation -->
        <section class="upload-section">
            <h2>üìù 3. ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Import Participation</h2>
            <p class="description">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Upload CSV to add student participation</p>

            <!-- Template Download -->
            <div class="template-section">
                <h4>üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Template | Download Template</h4>
                <div class="template-buttons">
                    <a href="#" class="btn-template" onclick="downloadParticipationTemplate(); return false;">
                        üìÑ participation_template.csv
                    </a>
                    <a href="#" class="btn-template" onclick="downloadParticipationSample(); return false;">
                        üìã participation_sample.csv (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á | Sample)
                    </a>
                </div>
            </div>

            <!-- Format Guide -->
            <div class="format-guide">
                <h5>üìù ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV | CSV Format</h5>
                <p>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ | Required: <code>studentId</code>, <code>activityName</code></p>
                <p>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° | Optional: <code>date</code>, <code>status</code></p>
                <ul>
                    <li>studentId = ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ | Student ID (must exist in system)</li>
                    <li>activityName = ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activity name (must match)</li>
                    <li>status = Approved (default) ‡∏´‡∏£‡∏∑‡∏≠ | or Pending</li>
                </ul>
            </div>

            <!-- Upload Area -->
            <div class="upload-area" id="participation-upload-area" onclick="document.getElementById('participation-file-input').click()">
                <div class="icon">üìÅ</div>
                <p><strong>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå | Click to select file</strong></p>
                <p class="hint">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå .csv ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô | .csv files only</p>
                <input type="file" id="participation-file-input" accept=".csv" onchange="handleParticipationFile(this.files[0])">
            </div>

            <!-- Preview -->
            <div id="participation-preview" class="preview-section" style="display: none;">
                <h4>üëÅÔ∏è ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | Preview</h4>
                <div class="preview-stats" id="participation-preview-stats"></div>
                <div class="preview-table-wrapper">
                    <table class="preview-table" id="participation-preview-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="participation-errors" class="error-list" style="display: none;"></div>
                <div class="import-actions">
                    <button class="btn-import" id="btn-import-participation" onclick="importParticipation()">
                        ‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | Import
                    </button>
                    <button class="btn-clear" onclick="clearParticipationPreview()">
                        üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á | Clear
                    </button>
                </div>
                <div class="import-log" id="participation-import-log"></div>
            </div>
        </section>

        <!-- Current Data Summary -->
        <section class="upload-section">
            <h2>üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö | System Data Summary</h2>
            <div class="data-summary" id="data-summary">
                <div class="summary-card">
                    <span class="count" id="total-students">-</span>
                    <span class="label">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ | Students</span>
                </div>
                <div class="summary-card">
                    <span class="count" id="total-activities">-</span>
                    <span class="label">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Activities</span>
                </div>
                <div class="summary-card">
                    <span class="count" id="total-participation">-</span>
                    <span class="label">‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° | Participation</span>
                </div>
            </div>
            <button class="btn-template" style="margin-top: 20px;" onclick="loadDataSummary()">
                üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | Refresh
            </button>
        </section>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay">
            <div class="loading-box">
                <div class="spinner"></div>
                <p id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    
    <script>
        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let studentData = [];
        let participationData = [];

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            setupDragDrop('student-upload-area', handleStudentFile);
            setupDragDrop('activity-upload-area', handleActivityFile);
            setupDragDrop('participation-upload-area', handleParticipationFile);
            loadDataSummary();
        });

        function setupDragDrop(elementId, handler) {
            const area = document.getElementById(elementId);
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
                area.addEventListener(event, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            ['dragenter', 'dragover'].forEach(event => {
                area.addEventListener(event, () => area.classList.add('dragover'));
            });

            ['dragleave', 'drop'].forEach(event => {
                area.addEventListener(event, () => area.classList.remove('dragover'));
            });

            area.addEventListener('drop', (e) => {
                const file = e.dataTransfer.files[0];
                if (file && file.name.endsWith('.csv')) {
                    handler(file);
                } else {
                    alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå .csv ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                }
            });
        }

        // ============================================
        // CSV PARSING
        // ============================================
        function parseCSV(text) {
            const lines = text.split(/\r?\n/).filter(line => line.trim());
            if (lines.length < 2) return { headers: [], data: [] };

            // Parse header
            const headers = parseCSVLine(lines[0]);
            
            // Parse data
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header.trim()] = values[index].trim();
                    });
                    data.push(row);
                }
            }

            return { headers, data };
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);

            return result.map(val => val.replace(/^"|"$/g, '').trim());
        }

        // ============================================
        // TEMPLATE DOWNLOADS
        // ============================================
        function downloadStudentTemplate() {
            const csv = 'studentId,name,email,department,faculty,year\n';
            downloadCSV(csv, 'students_template.csv');
        }

        function downloadStudentSample() {
            const csv = `studentId,name,email,department,faculty,year
640610001,‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ,somchai@cmu.ac.th,Computer Engineering,Engineering,2
640610002,‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,somying@cmu.ac.th,Electrical Engineering,Engineering,2
640610003,‡∏ô‡∏≤‡∏¢‡∏ó‡∏î‡∏™‡∏≠‡∏ö ‡∏£‡∏∞‡∏ö‡∏ö,test@cmu.ac.th,Mechanical Engineering,Engineering,3`;
            downloadCSV(csv, 'students_sample.csv');
        }

        function downloadParticipationTemplate() {
            const csv = 'studentId,activityName,date,status\n';
            downloadCSV(csv, 'participation_template.csv');
        }

        function downloadParticipationSample() {
            const csv = `studentId,activityName,date,status
640610001,Workshop AI for Beginners,2024-01-15,Approved
640610001,English Communication Camp,2024-02-20,Approved
640610002,Leadership Development Program,2024-01-25,Approved
640610002,Workshop AI for Beginners,2024-03-20,Pending
640610003,English Communication Camp,2024-02-20,Approved`;
            downloadCSV(csv, 'participation_sample.csv');
        }

        function downloadActivityTemplate() {
            const csv = 'name,organizer,date,level,description,skills\n';
            downloadCSV(csv, 'activities_template.csv');
        }

        function downloadActivitySample() {
            const csv = `name,organizer,date,level,description,skills
Workshop AI for Beginners,Student Development Unit,2024-01-15,2,‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô AI ‡πÅ‡∏•‡∏∞ Machine Learning,"1.1:2,4.1:2,4.2:2"
English Communication Camp,Language Center,2024-02-20,2,‡∏Ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£,"2.1:2,2.2:2,2.3:3"
Leadership Development Program,Engineering Student Union,2024-01-25,3,‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏†‡∏≤‡∏ß‡∏∞‡∏ú‡∏π‡πâ‡∏ô‡∏≥,"3.1:3,3.2:2,6.1:2"
Hackathon 2024,Computer Engineering Dept,2024-03-10,3,‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ã‡∏≠‡∏ü‡∏ï‡πå‡πÅ‡∏ß‡∏£‡πå,"1.1:3,1.2:3,4.2:3,5.2:2"
Design Thinking Workshop,Innovation Hub,2024-04-05,2,Workshop ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏î‡πÄ‡∏ä‡∏¥‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö,"5.1:2,1.3:2,3.3:2"`;
            downloadCSV(csv, 'activities_sample.csv');
        }

        function downloadCSV(content, filename) {
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        // ============================================
        // STUDENT FILE HANDLING
        // ============================================
        function handleStudentFile(file) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const { headers, data } = parseCSV(text);

                // Validate required columns
                const required = ['studentId', 'name', 'email'];
                const missing = required.filter(col => !headers.includes(col));

                if (missing.length > 0) {
                    alert(`‚ö†Ô∏è ‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≤‡∏î‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô: ${missing.join(', ')}`);
                    return;
                }

                // Validate data
                const errors = [];
                const validData = [];

                data.forEach((row, index) => {
                    const rowErrors = [];
                    
                    if (!row.studentId) rowErrors.push('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤');
                    if (!row.name) rowErrors.push('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠');
                    if (!row.email) rowErrors.push('‡πÑ‡∏°‡πà‡∏°‡∏µ email');
                    if (row.email && !row.email.includes('@')) rowErrors.push('email ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');

                    if (rowErrors.length > 0) {
                        errors.push(`‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ${index + 2}: ${rowErrors.join(', ')}`);
                    } else {
                        validData.push(row);
                    }
                });

                studentData = validData;
                showStudentPreview(headers, validData, errors);
            };
            reader.readAsText(file, 'UTF-8');
        }

        function showStudentPreview(headers, data, errors) {
            const preview = document.getElementById('student-preview');
            const statsEl = document.getElementById('student-preview-stats');
            const tableHead = document.querySelector('#student-preview-table thead');
            const tableBody = document.querySelector('#student-preview-table tbody');
            const errorsEl = document.getElementById('student-errors');

            // Stats
            statsEl.innerHTML = `
                <div class="preview-stat">
                    <span class="number">${data.length}</span>
                    <span class="label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>
                </div>
                <div class="preview-stat">
                    <span class="number" style="color: ${errors.length > 0 ? '#e74c3c' : '#27ae60'}">${errors.length}</span>
                    <span class="label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</span>
                </div>
            `;

            // Table header
            const displayHeaders = ['studentId', 'name', 'email', 'department'];
            tableHead.innerHTML = `<tr>${displayHeaders.map(h => `<th>${h}</th>`).join('')}</tr>`;

            // Table body (show first 10)
            const previewData = data.slice(0, 10);
            tableBody.innerHTML = previewData.map(row => `
                <tr>
                    ${displayHeaders.map(h => `<td>${row[h] || '-'}</td>`).join('')}
                </tr>
            `).join('');

            if (data.length > 10) {
                tableBody.innerHTML += `<tr><td colspan="${displayHeaders.length}" style="text-align:center;color:#999;">... ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${data.length - 10} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>`;
            }

            // Errors
            if (errors.length > 0) {
                errorsEl.innerHTML = `
                    <h5>‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (${errors.length})</h5>
                    <ul>${errors.slice(0, 10).map(e => `<li>${e}</li>`).join('')}</ul>
                    ${errors.length > 10 ? `<p>... ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${errors.length - 10} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>` : ''}
                `;
                errorsEl.style.display = 'block';
            } else {
                errorsEl.style.display = 'none';
            }

            // Enable/disable import button
            document.getElementById('btn-import-students').disabled = data.length === 0;

            preview.style.display = 'block';
        }

        function clearStudentPreview() {
            studentData = [];
            document.getElementById('student-preview').style.display = 'none';
            document.getElementById('student-file-input').value = '';
            document.getElementById('student-import-log').classList.remove('show');
        }

        // ============================================
        // ACTIVITY FILE HANDLING
        // ============================================
        let activityData = [];

        function handleActivityFile(file) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const { headers, data } = parseCSV(text);

                // Validate required columns
                const required = ['name', 'organizer', 'date'];
                const missing = required.filter(col => !headers.includes(col));

                if (missing.length > 0) {
                    alert(`‚ö†Ô∏è ‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≤‡∏î‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô | Missing columns: ${missing.join(', ')}`);
                    return;
                }

                // Validate data
                const errors = [];
                const validData = [];

                data.forEach((row, index) => {
                    const rowErrors = [];
                    
                    if (!row.name) rowErrors.push('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° | Missing name');
                    if (!row.organizer) rowErrors.push('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î | Missing organizer');
                    if (!row.date) rowErrors.push('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà | Missing date');

                    if (rowErrors.length > 0) {
                        errors.push({ row: index + 2, errors: rowErrors });
                    } else {
                        // Parse skills if present
                        let skills = [];
                        if (row.skills) {
                            // Format: "1.1:2,2.1:3,4.2:2"
                            const skillParts = row.skills.split(',');
                            skillParts.forEach(part => {
                                const [code, level] = part.trim().split(':');
                                if (code && level) {
                                    skills.push({ code: code.trim(), level: parseInt(level) || 2 });
                                }
                            });
                        }

                        validData.push({
                            name: row.name.trim(),
                            organizer: row.organizer.trim(),
                            date: row.date.trim(),
                            level: parseInt(row.level) || 2,
                            description: row.description?.trim() || '',
                            skills: skills,
                            status: 'Active'
                        });
                    }
                });

                activityData = validData;
                showActivityPreview(validData, errors);
            };
            reader.readAsText(file, 'UTF-8');
        }

        function showActivityPreview(data, errors) {
            const preview = document.getElementById('activity-preview');
            const statsEl = document.getElementById('activity-preview-stats');
            const tableEl = document.getElementById('activity-preview-table');
            const errorsEl = document.getElementById('activity-errors');

            // Stats
            statsEl.innerHTML = `
                <span class="stat-good">‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á | Valid: ${data.length} ‡πÅ‡∏ñ‡∏ß</span>
                <span class="stat-bad">${errors.length > 0 ? `‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î | Errors: ${errors.length} ‡πÅ‡∏ñ‡∏ß` : ''}</span>
            `;

            // Table preview
            const headers = ['name', 'organizer', 'date', 'level', 'skills'];
            tableEl.querySelector('thead').innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
            tableEl.querySelector('tbody').innerHTML = data.slice(0, 10).map(row => `
                <tr>
                    <td>${row.name}</td>
                    <td>${row.organizer}</td>
                    <td>${row.date}</td>
                    <td>${row.level}</td>
                    <td>${row.skills.map(s => `${s.code}:${s.level}`).join(', ') || '-'}</td>
                </tr>
            `).join('');

            // Errors
            if (errors.length > 0) {
                errorsEl.innerHTML = errors.slice(0, 5).map(e => 
                    `<div class="error-item">‡πÅ‡∏ñ‡∏ß ${e.row}: ${e.errors.join(', ')}</div>`
                ).join('');
                errorsEl.style.display = 'block';
            } else {
                errorsEl.style.display = 'none';
            }

            preview.style.display = 'block';
        }

        function clearActivityPreview() {
            activityData = [];
            document.getElementById('activity-preview').style.display = 'none';
            document.getElementById('activity-file-input').value = '';
            document.getElementById('activity-import-log').classList.remove('show');
        }

        async function importActivities() {
            if (activityData.length === 0) {
                alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ | No data to import');
                return;
            }

            const logEl = document.getElementById('activity-import-log');
            logEl.innerHTML = '';
            logEl.classList.add('show');

            let success = 0;
            let skipped = 0;
            let failed = 0;

            for (const activity of activityData) {
                try {
                    // Check if activity already exists
                    const existing = await db.collection('activities')
                        .where('name', '==', activity.name)
                        .limit(1)
                        .get();

                    if (!existing.empty) {
                        logEl.innerHTML += `<div class="log-skip">‚è≠Ô∏è ‡∏Ç‡πâ‡∏≤‡∏° | Skip: ${activity.name} (‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß | exists)</div>`;
                        skipped++;
                        continue;
                    }

                    // Add activity
                    const docRef = await db.collection('activities').add({
                        ...activity,
                        createdAt: new Date().toISOString()
                    });

                    logEl.innerHTML += `<div class="log-success">‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° | Added: ${activity.name}</div>`;
                    success++;

                } catch (error) {
                    logEl.innerHTML += `<div class="log-error">‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î | Error: ${activity.name} - ${error.message}</div>`;
                    failed++;
                }
            }

            // Summary
            logEl.innerHTML += `
                <div class="log-summary">
                    üìä ‡∏™‡∏£‡∏∏‡∏õ | Summary: ‡πÄ‡∏û‡∏¥‡πà‡∏° ${success} | ‡∏Ç‡πâ‡∏≤‡∏° ${skipped} | ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ${failed}
                </div>
            `;

            if (success > 0) {
                alert(`‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${success} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ | Successfully imported ${success} activities`);
            }
        }

        // ============================================
        // PARTICIPATION FILE HANDLING
        // ============================================
        function handleParticipationFile(file) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const { headers, data } = parseCSV(text);

                // Validate required columns
                const required = ['studentId', 'activityName'];
                const missing = required.filter(col => !headers.includes(col));

                if (missing.length > 0) {
                    alert(`‚ö†Ô∏è ‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≤‡∏î‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô: ${missing.join(', ')}`);
                    return;
                }

                // Validate data
                const errors = [];
                const validData = [];

                data.forEach((row, index) => {
                    const rowErrors = [];
                    
                    if (!row.studentId) rowErrors.push('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤');
                    if (!row.activityName) rowErrors.push('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°');

                    if (rowErrors.length > 0) {
                        errors.push(`‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ${index + 2}: ${rowErrors.join(', ')}`);
                    } else {
                        // Set default status
                        row.status = row.status || 'Approved';
                        validData.push(row);
                    }
                });

                participationData = validData;
                showParticipationPreview(headers, validData, errors);
            };
            reader.readAsText(file, 'UTF-8');
        }

        function showParticipationPreview(headers, data, errors) {
            const preview = document.getElementById('participation-preview');
            const statsEl = document.getElementById('participation-preview-stats');
            const tableHead = document.querySelector('#participation-preview-table thead');
            const tableBody = document.querySelector('#participation-preview-table tbody');
            const errorsEl = document.getElementById('participation-errors');

            // Count unique students and activities
            const uniqueStudents = new Set(data.map(r => r.studentId)).size;
            const uniqueActivities = new Set(data.map(r => r.activityName)).size;

            // Stats
            statsEl.innerHTML = `
                <div class="preview-stat">
                    <span class="number">${data.length}</span>
                    <span class="label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                </div>
                <div class="preview-stat">
                    <span class="number">${uniqueStudents}</span>
                    <span class="label">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</span>
                </div>
                <div class="preview-stat">
                    <span class="number">${uniqueActivities}</span>
                    <span class="label">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</span>
                </div>
                <div class="preview-stat">
                    <span class="number" style="color: ${errors.length > 0 ? '#e74c3c' : '#27ae60'}">${errors.length}</span>
                    <span class="label">‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</span>
                </div>
            `;

            // Table header
            const displayHeaders = ['studentId', 'activityName', 'date', 'status'];
            tableHead.innerHTML = `<tr>${displayHeaders.map(h => `<th>${h}</th>`).join('')}</tr>`;

            // Table body (show first 10)
            const previewData = data.slice(0, 10);
            tableBody.innerHTML = previewData.map(row => `
                <tr>
                    ${displayHeaders.map(h => `<td>${row[h] || '-'}</td>`).join('')}
                </tr>
            `).join('');

            if (data.length > 10) {
                tableBody.innerHTML += `<tr><td colspan="${displayHeaders.length}" style="text-align:center;color:#999;">... ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${data.length - 10} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>`;
            }

            // Errors
            if (errors.length > 0) {
                errorsEl.innerHTML = `
                    <h5>‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ (${errors.length})</h5>
                    <ul>${errors.slice(0, 10).map(e => `<li>${e}</li>`).join('')}</ul>
                    ${errors.length > 10 ? `<p>... ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${errors.length - 10} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>` : ''}
                `;
                errorsEl.style.display = 'block';
            } else {
                errorsEl.style.display = 'none';
            }

            // Enable/disable import button
            document.getElementById('btn-import-participation').disabled = data.length === 0;

            preview.style.display = 'block';
        }

        function clearParticipationPreview() {
            participationData = [];
            document.getElementById('participation-preview').style.display = 'none';
            document.getElementById('participation-file-input').value = '';
            document.getElementById('participation-import-log').classList.remove('show');
        }

        // ============================================
        // IMPORT FUNCTIONS
        // ============================================
        async function importStudents() {
            if (studentData.length === 0) return;

            const logEl = document.getElementById('student-import-log');
            logEl.innerHTML = '';
            logEl.classList.add('show');

            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤...');

            let successCount = 0;
            let skipCount = 0;
            let errorCount = 0;

            log(logEl, `üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${studentData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...`, 'info');

            for (const student of studentData) {
                try {
                    // Check if student already exists
                    const existing = await db.collection('students')
                        .where('studentId', '==', student.studentId)
                        .get();

                    if (!existing.empty) {
                        log(logEl, `‚è≠Ô∏è ${student.studentId} - ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (‡∏Ç‡πâ‡∏≤‡∏°)`, 'warning');
                        skipCount++;
                        continue;
                    }

                    // Add student
                    await db.collection('students').add({
                        studentId: student.studentId,
                        name: student.name,
                        email: student.email.toLowerCase(),
                        department: student.department || '',
                        faculty: student.faculty || '',
                        year: student.year || '',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    log(logEl, `‚úÖ ${student.studentId} - ${student.name}`, 'success');
                    successCount++;

                } catch (error) {
                    log(logEl, `‚ùå ${student.studentId} - ${error.message}`, 'error');
                    errorCount++;
                }
            }

            log(logEl, `üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô: ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${successCount}, ‡∏Ç‡πâ‡∏≤‡∏° ${skipCount}, ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ${errorCount}`, 'complete');

            showLoading(false);
            loadDataSummary();
        }

        async function importParticipation() {
            if (participationData.length === 0) return;

            const logEl = document.getElementById('participation-import-log');
            logEl.innerHTML = '';
            logEl.classList.add('show');

            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°...');

            let successCount = 0;
            let skipCount = 0;
            let errorCount = 0;

            log(logEl, `üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${participationData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...`, 'info');

            for (const record of participationData) {
                try {
                    // Check if participation already exists
                    const existing = await db.collection('participation')
                        .where('studentId', '==', record.studentId)
                        .where('activityName', '==', record.activityName)
                        .get();

                    if (!existing.empty) {
                        log(logEl, `‚è≠Ô∏è ${record.studentId} - ${record.activityName} (‡∏ã‡πâ‡∏≥)`, 'warning');
                        skipCount++;
                        continue;
                    }

                    // Add participation
                    await db.collection('participation').add({
                        studentId: record.studentId,
                        activityName: record.activityName,
                        date: record.date || '',
                        status: record.status || 'Approved',
                        source: 'csv-import',
                        addedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    log(logEl, `‚úÖ ${record.studentId} ‚Üí ${record.activityName}`, 'success');
                    successCount++;

                } catch (error) {
                    log(logEl, `‚ùå ${record.studentId} - ${error.message}`, 'error');
                    errorCount++;
                }
            }

            log(logEl, `üéâ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô: ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${successCount}, ‡∏Ç‡πâ‡∏≤‡∏° ${skipCount}, ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ${errorCount}`, 'complete');

            showLoading(false);
            loadDataSummary();
        }

        // ============================================
        // DATA SUMMARY
        // ============================================
        async function loadDataSummary() {
            try {
                const [students, activities, participation] = await Promise.all([
                    db.collection('students').get(),
                    db.collection('activities').get(),
                    db.collection('participation').get()
                ]);

                document.getElementById('total-students').textContent = students.size;
                document.getElementById('total-activities').textContent = activities.size;
                document.getElementById('total-participation').textContent = participation.size;

            } catch (error) {
                console.error('Load summary error:', error);
            }
        }

        // ============================================
        // HELPERS
        // ============================================
        function log(element, message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-item log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            element.appendChild(entry);
            element.scrollTop = element.scrollHeight;
        }

        function showLoading(show, text = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') {
            const overlay = document.getElementById('loading-overlay');
            document.getElementById('loading-text').textContent = text;
            if (show) {
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }
        }
    </script>
</body>
</html>
